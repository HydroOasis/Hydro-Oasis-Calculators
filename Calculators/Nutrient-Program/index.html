<!-- Nutrient Program Calculator (Shopify-embed safe) -->
<link rel="stylesheet" href="../../shared/styles/calculators.css">
<div id="npcalc">
  <!-- SDKs (auto-disabled locally to prevent 404 spam) -->
  <script>
    (function(){
      var isShopDomain = location.host.includes("myshopify") || location.host.includes("hydrooasis.com.au");
      if (isShopDomain) {
        document.write('<script src="/_sdk/element_sdk.js"><\/script>');
        document.write('<script src="/_sdk/data_sdk.js"><\/script>');
      } else {
        console.warn("SDK disabled (local environment detected)");
      }
    })();
  </script>

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

 

  <div class="container">
    <div class="calc-shell">
      <h1 class="calc-title">Nutrient Program Calculator</h1>
      <p class="calc-subtitle">Build a week-by-week feed chart with ml/L and per-reservoir totals, then export to PDF.</p>

      <div class="config-section">
        <label for="configSelect">Configuration</label>
        <select id="configSelect">
          <option value="custom" selected>Custom</option>
          <!-- Presets will be injected here -->
        </select>
      </div>

      <div class="stages-container">
        <div class="stage" data-stage="vegetative">
          <div class="stage-header">
            <h2 class="stage-title">Vegetative</h2>
            <button class="add-week-btn" onclick="addWeek('vegetative')">+ Add Week</button>
          </div>
          <div class="weeks-container" id="vegetativeWeeks"></div>
        </div>

        <div class="stage" data-stage="flowering">
          <div class="stage-header">
            <h2 class="stage-title">Flowering</h2>
            <button class="add-week-btn" onclick="addWeek('flowering')">+ Add Week</button>
          </div>
          <div class="weeks-container" id="floweringWeeks"></div>
        </div>
      </div>

      <div class="reservoir-section">
        <label for="reservoirSize">Reservoir Size (L)</label>
        <input type="number" id="reservoirSize" placeholder="Enter reservoir size" min="0" step="0.1" inputmode="decimal">
      </div>

      <button class="calculate-btn" onclick="calculate()">Calculate</button>

      <div id="errorMessage" class="error-message" style="display:none;"></div>

      <!-- Results -->
      <div id="resultsSection" class="results-section" style="display:none;">
        <div id="resultsMatrix"></div>
        <div id="resultsMobile" class="mobile-feed-list"></div>
      </div>

      <button id="downloadBtn" class="download-btn" style="display:none;" onclick="downloadPDF()">Download PDF</button>

      <img class="mascot-watermark" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true" decoding="async" loading="lazy">
    </div>
  </div>

  <div id="ho-watermark">Hydro Oasis • Nutrient Program Calculator</div>

  <script>
  /* ===========================================================
     CONFIG + SDK HANDLING
  =========================================================== */
  const defaultConfig = {
    page_title: "Nutrient Program Calculator",
    page_subtitle: "Build a week-by-week feed chart with ml/L and per-reservoir totals, then export to PDF."
  };
  let config = { ...defaultConfig };

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: (newCfg)=>{ config = { ...config, ...newCfg }; },
      mapToCapabilities: () => ({})
    });
  }

  /* ===========================================================
     PRESET LOADER
  =========================================================== */
  const PRESET_URL = "https://cdn.shopify.com/s/files/1/0709/5261/6094/files/test2.json?v=1762649994";
  window.EMBEDDED_PRESETS = window.EMBEDDED_PRESETS || {};

  function parseJsonLoose(text){
    if (typeof text !== 'string') return {};
    text = text.replace(/^\uFEFF/, '');
    text = text.replace(/\/\*[\s\S]*?\*\//g, '');
    text = text.replace(/(^|[^:])\/\/.*$/gm, '$1');
    text = text.replace(/,\s*([}\]])/g, '$1');
    return JSON.parse(text);
  }

  function flattenPrograms(input, out = {}, path = []) {
    if (!input || typeof input !== 'object') return out;
    const looksLikeProgram =
      (Array.isArray(input.vegetative) || Array.isArray(input.flowering)) &&
      ((input.vegetative && input.vegetative.some(w => w && w.products)) ||
       (input.flowering && input.flowering.some(w => w && w.products)));
    if (looksLikeProgram) {
      const key = path.join('__') || (input.name || 'program');
      out[key] = input;
      return out;
    }
    for (const [k, v] of Object.entries(input)) {
      if (k.startsWith('_')) continue;
      if (v && typeof v === 'object') flattenPrograms(v, out, path.concat(k));
    }
    return out;
  }

  let presets = {};

  async function loadExternalPresets() {
    const sel = document.getElementById("configSelect");
    try {
      const res = await fetch(PRESET_URL + "?cb=" + Date.now(), { cache: "no-store", credentials: "omit", mode: "cors" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const txt = await res.text();
      let json;
      try { json = JSON.parse(txt); } catch { json = parseJsonLoose(txt); }
      if (!json || typeof json !== 'object') throw new Error("Invalid JSON root");
      presets = flattenPrograms(json);
    } catch (e) {
      console.warn("CDN preset load failed, using fallback if present.", e);
      presets = flattenPrograms(window.EMBEDDED_PRESETS || {});
    }

    sel.innerHTML = '<option value="custom" selected>Custom</option>';
    const entries = Object.entries(presets)
      .map(([key,obj]) => {
        const friendly = (obj && obj.name) ? String(obj.name) : key.replace(/__/g, " ▸ ");
        return { key, name: friendly };
      })
      .sort((a,b)=> a.name.localeCompare(b.name, undefined, { sensitivity:'base', numeric:true }));

    for (const {key, name} of entries) {
      const o = document.createElement("option");
      o.value = key;
      o.textContent = name;
      sel.appendChild(o);
    }
  }

  /* ===========================================================
     WEEK / PRODUCT MANAGEMENT
  =========================================================== */
  let weekCounters = { vegetative: 0, flowering: 0 };

  function addWeek(stage){
    weekCounters[stage]++;
    const n = weekCounters[stage];
    const container = document.getElementById(stage+"Weeks");

    const card = document.createElement("div");
    card.className = "week-card";
    card.dataset.stage = stage;
    card.dataset.week = n;

    card.innerHTML = `
      <div class="week-header">
        <h3 class="week-title">Week ${n}</h3>
        <div class="week-controls">
          <button class="toggle-btn" onclick="toggleWeek(this)">Hide</button>
          <button class="remove-week-btn" onclick="removeWeek(this)">Remove</button>
        </div>
      </div>
      <div class="week-body">
        <div class="products-container"></div>
        <button class="add-product-btn" onclick="addProduct(this)">+ Add Product</button>
      </div>
    `;

    container.appendChild(card);
    addProduct(card.querySelector(".add-product-btn"));
  }

  function toggleWeek(btn){
    const body = btn.closest(".week-card").querySelector(".week-body");
    const isHidden = body.classList.toggle("hidden");
    btn.textContent = isHidden ? "Show" : "Hide";
  }

  function addProduct(btn){
    const wrap = btn.closest(".week-card").querySelector(".products-container");
    const row = document.createElement("div");
    row.className = "product-row";
    row.innerHTML = `
      <div class="product-fields">
        <div class="field-group">
          <label>Nutrient Name</label>
          <input type="text" class="product-name" placeholder="Enter nutrient name" autocapitalize="words" autocomplete="off">
        </div>
        <div class="field-group">
          <label>Dilution Rate (ml/L)</label>
          <input type="number" class="product-rate" min="0" step="0.1" inputmode="decimal" placeholder="0.0">
        </div>
        <button class="remove-product-btn" onclick="removeProduct(this)">Remove</button>
      </div>`;
    wrap.appendChild(row);
  }

  function removeProduct(btn){ btn.closest(".product-row").remove(); }

  function removeWeek(btn){
    const card = btn.closest(".week-card");
    const stage = card.dataset.stage;
    card.remove();
    const weeks = document.getElementById(stage+'Weeks').querySelectorAll('.week-card');
    weeks.forEach((w,i)=>{ w.dataset.week=i+1; w.querySelector('.week-title').textContent=`Week ${i+1}`; });
    weekCounters[stage] = weeks.length;
  }

  document.getElementById("configSelect").addEventListener("change", e => {
    const key = e.target.value;
    if (key === "custom") return;

    const preset = presets[key];
    if (!preset) return;

    ["vegetative","flowering"].forEach(stage=>{
      document.getElementById(stage+"Weeks").innerHTML="";
      weekCounters[stage]=0;
    });

    ["vegetative","flowering"].forEach(stage=>{
      const weeks = Array.isArray(preset[stage]) ? preset[stage].slice().sort((a,b)=> (a.week||0)-(b.week||0)) : [];
      weeks.forEach(week => {
        addWeek(stage);
        const card = document.querySelector(`#${stage}Weeks .week-card:last-of-type`);
        const wrap = card.querySelector(".products-container");
        wrap.innerHTML="";
        (week.products || []).forEach(p=>{
          const row = document.createElement("div");
          row.className="product-row";
          row.innerHTML=`
            <div class="product-fields">
              <div class="field-group">
                <label>Nutrient Name</label>
                <input type="text" class="product-name" value="${(p.name ?? '').toString().replace(/"/g,'&quot;')}">
              </div>
              <div class="field-group">
                <label>Dilution Rate (ml/L)</label>
                <input type="number" class="product-rate" min="0" step="0.1" inputmode="decimal" value="${(p.rate ?? '').toString()}">
              </div>
              <button class="remove-product-btn" onclick="removeProduct(this)">Remove</button>
            </div>`;
          wrap.appendChild(row);
        });
      });
    });
  });

  /* ===========================================================
     CALCULATION ENGINE
  =========================================================== */
  let calculationResults = null;

  function calculate(){
    const resSize = parseFloat(document.getElementById("reservoirSize").value);
    const err = document.getElementById("errorMessage");
    const resultsWrap = document.getElementById("resultsSection");
    const dl = document.getElementById("downloadBtn");

    err.style.display="none";
    resultsWrap.style.display="none";
    dl.style.display="none";

    if (!resSize || resSize <= 0){
      err.textContent="Please enter a valid reservoir size.";
      err.style.display="block";
      return;
    }

    const data = { vegetative:[], flowering:[] };

    ["vegetative","flowering"].forEach(stage=>{
      document.querySelectorAll(`#${stage}Weeks .week-card`).forEach(card=>{
        const week = parseInt(card.dataset.week);
        const prods = [];
        card.querySelectorAll(".product-row").forEach(r=>{
          const name = (r.querySelector(".product-name").value || '').trim();
          const rate = parseFloat(r.querySelector(".product-rate").value);
          if (!name || !rate || rate<=0) return;
          prods.push({name,rate});
        });
        if (prods.length>0) data[stage].push({week, products:prods});
      });
    });

    if (data.vegetative.length===0 && data.flowering.length===0){
      err.textContent="Please add at least one week with products.";
      err.style.display="block";
      return;
    }

    calculationResults = { reservoirSize:resSize, data };
    displayResults();
    dl.style.display="block";
  }

  /* ===========================================================
     RESULTS TABLE (desktop) + STACKED LIST (mobile)
  =========================================================== */
  function formatValue(v){
    const n = parseFloat(v);
    if (isNaN(n)) return "-";
    return Number.isInteger(n) ? n.toString() : parseFloat(n.toFixed(2)).toString().replace(/\.0+$/,"");
  }

  function displayResults(){
    const resSize = calculationResults.reservoirSize;
    const data = calculationResults.data;

    const allWeeks=[];
    const allNutrients=new Set();

    (data.vegetative||[]).forEach(w=>{
      allWeeks.push({stage:"veg", week:w.week, label:`Veg ${w.week}`, products:w.products});
      w.products.forEach(p=>allNutrients.add(p.name));
    });

    (data.flowering||[]).forEach(w=>{
      allWeeks.push({stage:"flower", week:w.week, label:`Flower ${w.week}`, products:w.products});
      w.products.forEach(p=>allNutrients.add(p.name));
    });

    allWeeks.sort((a,b)=> a.stage!==b.stage ? (a.stage==='veg'?-1:1) : (a.week-b.week));

    const nutrients = Array.from(allNutrients).map(name=>{
      const rates={};
      allWeeks.forEach(w=>{
        const hit = w.products.find(p=>p.name===name);
        if(hit) rates[`${w.stage}_${w.week}`]=hit.rate;
      });
      return { name, rates };
    });

    // Desktop matrix
    const matrixMount = document.getElementById("resultsMatrix");
    matrixMount.innerHTML = "";
    const section=document.createElement("div");
    section.className="stage-results";
    section.innerHTML=`<h2 style="text-align:center;font-family:'Inter',system-ui,sans-serif;color:var(--heading);font-weight:800;margin:0 0 12px;font-size:1.25em;">Complete Feed Chart (ml per reservoir)</h2>`;
    const tableBox=document.createElement("div");
    tableBox.className="feed-chart-matrix";

    let html = `<table><thead><tr><th class="matrix-nutrient-header">Nutrient</th>${allWeeks.map(w=>`<th class="matrix-week-header">${w.label}</th>`).join('')}</tr></thead><tbody>`;
    nutrients.forEach(n=>{
      html+=`<tr><td class="matrix-nutrient-name">${n.name}</td>`;
      allWeeks.forEach(w=>{
        const r = n.rates[`${w.stage}_${w.week}`];
        if(r){
          const total = r * resSize;
          html+=`<td class="matrix-data-cell" title="Tap to copy"><div class="matrix-rate-value">${formatValue(total)} ml</div></td>`;
        } else {
          html+=`<td class="matrix-empty-cell">-</td>`;
        }
      });
      html+=`</tr>`;
    });
    html+=`</tbody></table>`;
    tableBox.innerHTML=html;

    tableBox.addEventListener('click',e=>{
      const cell=e.target.closest('.matrix-data-cell'); if(!cell) return;
      const txt=cell.innerText.replace(/\s+/g,' ').trim(); if(navigator.clipboard) navigator.clipboard.writeText(txt);
    });

    section.appendChild(tableBox);
    matrixMount.appendChild(section);

    // Mobile stacked cards
    const mobileMount = document.getElementById("resultsMobile");
    mobileMount.innerHTML = "";
    allWeeks.forEach(w=>{
      const card = document.createElement("div");
      card.className = "week-summary";
      const items = [];
      nutrients.forEach(n=>{
        const r = n.rates[`${w.stage}_${w.week}`];
        if (r){ items.push(`<li><span class="n-name">${n.name}</span><span class="n-val">${formatValue(r*resSize)} ml</span></li>`); }
      });
      card.innerHTML = `<h3>${w.label} — per reservoir</h3>${items.length ? `<ul>${items.join('')}</ul>` : `<div style="color:#777;">No products recorded for this week.</div>`}`;
      mobileMount.appendChild(card);
    });

    document.getElementById("resultsSection").style.display="block";
    calculationResults.gridData = { allWeeks, nutrients };
  }

  /* ===========================================================
     PDF EXPORT
  =========================================================== */
  function downloadPDF(){
    if (!calculationResults || !window.jspdf) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');

    const title = "Nutrient Program Calculator";
    const subtitle = "Build a week-by-week feed chart with per-reservoir totals, then export to PDF.";

    doc.setFontSize(20); doc.setFont(undefined,'bold');
    doc.text(title,148,16,{align:'center'});
    doc.setFontSize(11); doc.setFont(undefined,'normal');
    doc.text(subtitle,148,24,{align:'center'});
    doc.text(`Reservoir Size: ${calculationResults.reservoirSize} L`,148,32,{align:'center'});

    let y=42;
    if(calculationResults.gridData?.allWeeks?.length){
      doc.setFontSize(16); doc.setFont(undefined,'bold');
      doc.text('Complete Feed Chart (ml per reservoir)',14,y); y+=8;

      const grid = calculationResults.gridData;
      const head = ['Nutrient', ...grid.allWeeks.map(w=>w.label)];
      const body = grid.nutrients.map(n=>[
        n.name,
        ...grid.allWeeks.map(w=>{
          const r=n.rates[`${w.stage}_${w.week}`];
          return r ? `${formatValue(r*calculationResults.reservoirSize)} ml` : '-';
        })
      ]);

      doc.autoTable({
        startY:y, head:[head], body,
        theme:'grid',
        headStyles:{ fillColor:[53,88,74], textColor:[255,255,255], fontStyle:'bold' },
        styles:{ fontSize:8, cellPadding:3, halign:'center' },
        columnStyles:{ 0:{ halign:'left', fontStyle:'bold' } },
        margin:{ left:14, right:14 }
      });
    }
    doc.save(`${title.replace(/[^a-z0-9]/gi,'_')}.pdf`);
  }

  /* ===========================================================
     INIT
  =========================================================== */
  loadExternalPresets();

  // Expose fns to inline handlers
  window.addWeek = addWeek;
  window.toggleWeek = toggleWeek;
  window.removeWeek = removeWeek;
  window.addProduct = addProduct;
  window.removeProduct = removeProduct;
  window.calculate = calculate;
  window.downloadPDF = downloadPDF;

  // Remove lingering focus after taps
  document.getElementById('npcalc').addEventListener('click', function (e) {
    if (e.target.matches('button, [role="button"]')) {
      setTimeout(() => e.target.blur(), 0);
    }
  });
  </script>

  <!-- Small fallback: if the browser doesn't support :has(), clamp only the nearest Shopify wrapper -->
  <script>
  (function(){
    try {
      if (CSS && CSS.supports && CSS.supports(':has(*)')) return; // CSS already clamps wrapper
    } catch(e){ /* older browsers */ }
    var calc = document.getElementById('npcalc');
    if (!calc) return;
    var el = calc.parentElement, clampTarget = null;
    while (el) {
      if (el.id === 'MainContent' ||
          (el.classList && el.classList.contains('shopify-section')) ||
          (el.classList && el.classList.contains('page-width'))) { clampTarget = el; break; }
      el = el.parentElement;
    }
    (clampTarget || calc.parentElement).style.overflowX = 'hidden';
    (clampTarget || calc.parentElement).style.maxWidth  = '100%';
  })();
  </script>
</div>