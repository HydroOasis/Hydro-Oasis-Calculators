<!-- Nutrient Program Calculator (Shopify-embed safe) -->
<div id="npcalc">
  <!-- SDKs (auto-disabled locally to prevent 404 spam) -->
  <script>
    (function(){
      var isShopDomain = location.host.includes("myshopify") || location.host.includes("hydrooasis.com.au");
      if (isShopDomain) {
        document.write('<script src="/_sdk/element_sdk.js"><\/script>');
        document.write('<script src="/_sdk/data_sdk.js"><\/script>');
      } else {
        console.warn("SDK disabled (local environment detected)");
      }
    })();
  </script>

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

 <style>
  /* Import fonts safely inside CSS for Shopify embeds */
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Inter:wght@500;600;700;800&display=swap');

  /* ========= Hydro Oasis scoped theme ========= */
  #npcalc{
    --bg:#FDFBF4; --text:#333; --heading:#2D5C4E;
    --btn:#2D5C4E; --btn-hover:#A76DAB; --btn-text:#fff;
    --card:#fff; --card-border:#E7E5DC; --icon:#2D5C4E; --err:#BE5C4C;
    --sec-border:#D9E2DE; --sec-head-bg:#F3F7F5;

    position:relative;
    /* Match Harvest: let theme bg show */
    background:transparent;
    color:var(--text);
    font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
    line-height:1.6;

    /* Page gutters like Harvest */
    padding-left:clamp(12px,4vw,24px);
    padding-right:clamp(12px,4vw,24px);
    padding-top:28px; padding-bottom:28px;

    /* Overflow guards */
    width:100%; max-width:100vw; overflow-x:hidden;
  }
  #npcalc *{ box-sizing:border-box; }

  /* ---- Container / shell (fully scoped) ---- */
  #npcalc .container{
    width:100%;
    max-width:1100px;
    margin:0 auto;
    padding:0;
  }
  #npcalc .calc-shell{
    position:relative;
    background:var(--card);
    border:1px solid var(--card-border);
    border-radius:16px;
    box-shadow:0 6px 20px rgba(0,0,0,.06);
    padding:24px;
    overflow:hidden;  /* keep watermark & children inside */
  }
  #npcalc .mascot-watermark{
    position:absolute; right:10px; bottom:10px;
    width:min(140px,22%); opacity:.12; pointer-events:none;
  }

  /* ---- Titles ---- */
  #npcalc .calc-title{
    font-family:'Inter',system-ui,sans-serif;
    font-weight:800; letter-spacing:.2px; color:var(--heading);
    text-align:center; margin:2px 0 4px;
    font-size:clamp(24px,4.2vw,40px);
  }
  #npcalc .calc-subtitle{
    text-align:center; color:#56645d; font-family:'Inter',system-ui,sans-serif;
    font-weight:500; font-size:clamp(12px,2.6vw,14px); margin:0 0 18px;
  }

  /* ---- Config ---- */
  #npcalc .config-section{ margin:8px 0 10px; text-align:center; }
  #npcalc .config-section label{
    display:block; font-weight:800; color:var(--heading); margin-bottom:8px; font-size:1.05em;
  }
  #npcalc .config-section select{
    padding:12px 14px; font-size:1em; background:#fff; border:1px solid #c4c8b8; border-radius:10px; color:#31473a;
    min-width:280px; max-width:100%; cursor:pointer;
  }
  #npcalc .config-section select:focus{ outline:none; border-color:var(--heading); box-shadow:0 0 0 3px rgba(45,92,78,.18); }

  /* ---- Stages / Weeks ---- */
  #npcalc .stages-container{ display:flex; flex-direction:column; gap:22px; margin-bottom:22px; }
  #npcalc .stage{
    background:#f7f5eb; padding:18px; border-radius:14px; box-shadow:0 2px 8px rgba(49,71,58,.08);
  }
  #npcalc .stage-header{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:14px; }
  #npcalc .stage-title{ font-size:clamp(18px,3.8vw,24px); font-weight:800; color:var(--heading); margin:0; }

  #npcalc .add-week-btn{
    background:var(--btn) !important; color:#fff !important; border:none; padding:10px 16px; border-radius:20px;
    font-weight:700; cursor:pointer; transition: background-color .12s ease, box-shadow .08s ease, transform .05s ease;
    -webkit-appearance:none; appearance:none;
  }
  #npcalc .add-week-btn:hover,#npcalc .add-week-btn:focus-visible{
    background:var(--btn-hover) !important; color:#fff !important; box-shadow:0 0 0 3px rgba(45,92,78,.18);
  }
  #npcalc .add-week-btn:active{ transform:translateY(1px); }

  /* ---- Week card ---- */
  #npcalc .week-card{
    background:#fcfaf3; border-radius:12px; padding:14px; margin-bottom:12px;
    border:1px solid #e3e2d7; box-shadow:0 2px 6px rgba(49,71,58,.06);
  }
  #npcalc .week-header{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
  #npcalc .week-title{ font-size:1.1em; font-weight:800; color:var(--heading); margin:0; }
  #npcalc .week-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #npcalc .toggle-btn,#npcalc .remove-week-btn{
    border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; font-size:.9em;
  }
  #npcalc .toggle-btn{ background:#e3e2d7; color:var(--heading); }
  #npcalc .toggle-btn:hover{ background:#d5d4c9; }
  #npcalc .remove-week-btn{ background:#b54848; color:#fff; }
  #npcalc .remove-week-btn:hover{ background:#a03d3d; }
  #npcalc .week-body{ display:block; }
  #npcalc .week-body.hidden{ display:none; }

  /* ---- Products ---- */
  #npcalc .product-row{
    background:#fff; border:1px solid #dddcd2; border-radius:8px; padding:12px; margin-bottom:10px; box-shadow:0 2px 4px rgba(49,71,58,.06);
  }
  #npcalc .product-fields{ display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:end; }
  #npcalc .field-group{ display:flex; flex-direction:column; }
  #npcalc .field-group label{ font-weight:800; color:var(--heading); margin-bottom:6px; font-size:.95em; }
  #npcalc .field-group input{
    padding:10px 12px; font-size:1em; background:#fff; border:1px solid #c4c8b8; border-radius:8px; color:#31473a; width:100%;
  }
  #npcalc .remove-product-btn{
    background:#b03d3c; color:#fff; border:none; padding:10px 12px; border-radius:8px; font-weight:700; cursor:pointer; white-space:nowrap;
  }
  #npcalc .add-product-btn{
    background:transparent; color:var(--heading); border:2px dashed #c4c8b8; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; width:100%; margin-top:8px;
  }
  #npcalc .add-product-btn:hover{ border-color:var(--heading); background:rgba(53,88,74,.05); }

  /* ---- Reservoir ---- */
  #npcalc .reservoir-section{
    background:#f7f5eb; padding:18px; border-radius:14px; margin-bottom:20px; box-shadow:0 2px 8px rgba(49,71,58,.08);
  }
  #npcalc .reservoir-section label{ display:block; font-weight:800; color:var(--heading); margin-bottom:8px; font-size:1.05em; }
  #npcalc .reservoir-section input{
    padding:12px 14px; font-size:1.05em; background:#fff; border:1px solid #c4c8b8; border-radius:10px; color:#31473a; max-width:360px; width:100%;
  }

  /* ---- Buttons ---- */
  #npcalc .calculate-btn,#npcalc .download-btn{
    background:var(--btn); color:#fff; border:none; padding:14px 32px; border-radius:12px; font-weight:800; cursor:pointer;
    font-size:1.05em; display:block; margin:22px auto; box-shadow:0 4px 12px rgba(53,88,74,.2);
    transition:transform .05s ease, box-shadow .08s ease, background-color .12s ease;
  }
  #npcalc .calculate-btn:hover,#npcalc .download-btn:hover{ background:var(--btn-hover); color:#fff; }
  #npcalc .calculate-btn:focus,#npcalc .download-btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(45,92,78,.18); }
  #npcalc .calculate-btn:active,#npcalc .download-btn:active{ transform:translateY(1px); box-shadow:inset 0 2px 6px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.06); }

  /* ---- Errors & Results ---- */
  #npcalc .error-message{ color:var(--err); font-weight:800; text-align:center; margin:14px 0; font-size:1.02em; }
  #npcalc .results-section{ margin-top:22px; }

  /* ---- Desktop Matrix ---- */
  #npcalc .feed-chart-matrix{
    overflow-x:auto; border-radius:10px; border:1px solid #c4c8b8; background:#fff;
    -webkit-overflow-scrolling:touch; scroll-snap-type:x proximity; position:relative; max-width:100%;
  }
  #npcalc .feed-chart-matrix table{ width:100%; border-collapse:collapse; background:#fff; table-layout:fixed; }
  #npcalc .feed-chart-matrix th,#npcalc .feed-chart-matrix td{ border:1px solid #c4c8b8; padding:10px; text-align:center; vertical-align:middle; }
  #npcalc .feed-chart-matrix thead th{ position:sticky; top:0; z-index:8; background:var(--heading); color:#fff; font-weight:800; }
  #npcalc .matrix-week-header{ min-width:110px; white-space:nowrap; }
  #npcalc .matrix-nutrient-header{ text-align:left; min-width:200px; position:sticky; left:0; z-index:12; }
  #npcalc .matrix-nutrient-name{ background:#f7f5eb; font-weight:700; text-align:left; color:var(--heading); min-width:200px; position:sticky; left:0; z-index:10; border-right:2px solid #c4c8b8; }
  #npcalc .matrix-data-cell{ background:#fff; min-width:100px; scroll-snap-align:start; }
  #npcalc .matrix-rate-value{ font-weight:800; color:#2D5C4E; font-size:.95em; line-height:1.2; }
  #npcalc .matrix-empty-cell{ background:#f9f9f9; color:#999; font-style:italic; font-size:1.02em; }

  /* ---- Mobile Results ---- */
  #npcalc .mobile-feed-list{ display:none; }
  #npcalc .week-summary{
    background:#fff; border:1px solid #c4c8b8; border-radius:12px; padding:14px; margin-bottom:12px;
  }
  #npcalc .week-summary h3{
    margin:0 0 10px; font-family:'Inter',system-ui,sans-serif; color:var(--heading);
    font-size:1.05em; font-weight:800;
  }
  #npcalc .week-summary ul{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
  #npcalc .week-summary li{ display:flex; justify-content:space-between; gap:12px; padding:8px 10px; border:1px solid #eceae0; border-radius:8px; background:#fcfaf3; }
  #npcalc .week-summary .n-name{ font-weight:700; color:#2D5C4E; }
  #npcalc .week-summary .n-val{ font-family:'Inter',system-ui,sans-serif; font-weight:800; }

  /* ---- Watermark ---- */
  #npcalc #ho-watermark{
    position:fixed; right:12px; bottom:10px; background:rgba(45,92,78,.08); color:#2D5C4E;
    border:1px solid #E7E5DC; border-radius:10px; padding:6px 10px; font:600 12px/1 'Inter',system-ui,sans-serif; backdrop-filter:blur(2px); z-index:50;
  }

  /* ---- Focus polish (prevent theme hijack) ---- */
  #npcalc button,#npcalc input,#npcalc select{ -webkit-tap-highlight-color:transparent; }
  #npcalc .add-week-btn,#npcalc .remove-week-btn,#npcalc .toggle-btn,#npcalc .remove-product-btn,#npcalc .add-product-btn,#npcalc .calculate-btn,#npcalc .download-btn{
    outline:none; box-shadow:none; filter:none; transform:none;
  }
  #npcalc .add-week-btn:focus,#npcalc .remove-week-btn:focus,#npcalc .toggle-btn:focus,#npcalc .remove-product-btn:focus,#npcalc .add-product-btn:focus,
  #npcalc .calculate-btn:focus,#npcalc .download-btn:focus,#npcalc input:focus,#npcalc select:focus{
    outline:none; box-shadow:0 0 0 3px rgba(45,92,78,.18); border-color:var(--heading);
  }
  #npcalc button:focus-visible,#npcalc input:focus-visible,#npcalc select:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(45,92,78,.18); }

  /* ========= Responsive tweaks (match Harvest) ========= */
  @media (max-width:1024px){
    #npcalc .container{ padding:0 6px; }
  }
  @media (max-width:820px){
    #npcalc .product-fields{ grid-template-columns:1fr 1fr; }
    #npcalc .remove-product-btn{ justify-self:start; }
  }
  @media (max-width:700px){
    #npcalc .calc-shell{ padding:16px; }
    #npcalc .config-section select{ min-width:0; width:100%; }
    #npcalc .stage{ padding:14px; }
    #npcalc .reservoir-section{ padding:14px; }
    #npcalc .product-fields{ grid-template-columns:1fr; }
    #npcalc .remove-product-btn{ width:100%; }
    /* Disable sticky headers/columns on small screens */
    #npcalc .feed-chart-matrix thead th,
    #npcalc .matrix-nutrient-header,
    #npcalc .matrix-nutrient-name{ position:static; left:auto; top:auto; }
    /* Switch to mobile list view */
    #npcalc .feed-chart-matrix{ display:none; }
    #npcalc .mobile-feed-list{ display:block; }
    #npcalc .matrix-data-cell{ min-width:84px; }
  }
  @media (max-width:480px){
    #npcalc{ padding-left:12px; padding-right:12px; }
    #npcalc .calculate-btn,#npcalc .download-btn{ width:100%; }
    #npcalc .week-controls{ width:100%; }
    #npcalc .toggle-btn,#npcalc .remove-week-btn{ flex:1 1 48%; text-align:center; }
  }

  /* ---- Clamp only the Shopify wrapper that contains #npcalc ---- */
  #MainContent:has(#npcalc),
  .shopify-section:has(#npcalc),
  .page-width:has(#npcalc),
  .template-page .page-width:has(#npcalc){
    overflow-x:hidden;
    max-width:100%;
  }
</style>

  <div class="container">
    <div class="calc-shell">
      <h1 class="calc-title">Nutrient Program Calculator</h1>
      <p class="calc-subtitle">Build a week-by-week feed chart with ml/L and per-reservoir totals, then export to PDF.</p>

      <div class="config-section">
        <label for="configSelect">Configuration</label>
        <select id="configSelect">
          <option value="custom" selected>Custom</option>
          <!-- Presets will be injected here -->
        </select>
      </div>

      <div class="stages-container">
        <div class="stage" data-stage="vegetative">
          <div class="stage-header">
            <h2 class="stage-title">Vegetative</h2>
            <button class="add-week-btn" onclick="addWeek('vegetative')">+ Add Week</button>
          </div>
          <div class="weeks-container" id="vegetativeWeeks"></div>
        </div>

        <div class="stage" data-stage="flowering">
          <div class="stage-header">
            <h2 class="stage-title">Flowering</h2>
            <button class="add-week-btn" onclick="addWeek('flowering')">+ Add Week</button>
          </div>
          <div class="weeks-container" id="floweringWeeks"></div>
        </div>
      </div>

      <div class="reservoir-section">
        <label for="reservoirSize">Reservoir Size (L)</label>
        <input type="number" id="reservoirSize" placeholder="Enter reservoir size" min="0" step="0.1" inputmode="decimal">
      </div>

      <button class="calculate-btn" onclick="calculate()">Calculate</button>

      <div id="errorMessage" class="error-message" style="display:none;"></div>

      <!-- Results -->
      <div id="resultsSection" class="results-section" style="display:none;">
        <div id="resultsMatrix"></div>
        <div id="resultsMobile" class="mobile-feed-list"></div>
      </div>

      <button id="downloadBtn" class="download-btn" style="display:none;" onclick="downloadPDF()">Download PDF</button>

      <img class="mascot-watermark" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true" decoding="async" loading="lazy">
    </div>
  </div>

  <div id="ho-watermark">Hydro Oasis • Nutrient Program Calculator</div>

  <script>
  /* ===========================================================
     CONFIG + SDK HANDLING
  =========================================================== */
  const defaultConfig = {
    page_title: "Nutrient Program Calculator",
    page_subtitle: "Build a week-by-week feed chart with ml/L and per-reservoir totals, then export to PDF."
  };
  let config = { ...defaultConfig };

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: (newCfg)=>{ config = { ...config, ...newCfg }; },
      mapToCapabilities: () => ({})
    });
  }

  /* ===========================================================
     PRESET LOADER
  =========================================================== */
  const PRESET_URL = "https://cdn.shopify.com/s/files/1/0709/5261/6094/files/test2.json?v=1762649994";
  window.EMBEDDED_PRESETS = window.EMBEDDED_PRESETS || {};

  function parseJsonLoose(text){
    if (typeof text !== 'string') return {};
    text = text.replace(/^\uFEFF/, '');
    text = text.replace(/\/\*[\s\S]*?\*\//g, '');
    text = text.replace(/(^|[^:])\/\/.*$/gm, '$1');
    text = text.replace(/,\s*([}\]])/g, '$1');
    return JSON.parse(text);
  }

  function flattenPrograms(input, out = {}, path = []) {
    if (!input || typeof input !== 'object') return out;
    const looksLikeProgram =
      (Array.isArray(input.vegetative) || Array.isArray(input.flowering)) &&
      ((input.vegetative && input.vegetative.some(w => w && w.products)) ||
       (input.flowering && input.flowering.some(w => w && w.products)));
    if (looksLikeProgram) {
      const key = path.join('__') || (input.name || 'program');
      out[key] = input;
      return out;
    }
    for (const [k, v] of Object.entries(input)) {
      if (k.startsWith('_')) continue;
      if (v && typeof v === 'object') flattenPrograms(v, out, path.concat(k));
    }
    return out;
  }

  let presets = {};

  async function loadExternalPresets() {
    const sel = document.getElementById("configSelect");
    try {
      const res = await fetch(PRESET_URL + "?cb=" + Date.now(), { cache: "no-store", credentials: "omit", mode: "cors" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const txt = await res.text();
      let json;
      try { json = JSON.parse(txt); } catch { json = parseJsonLoose(txt); }
      if (!json || typeof json !== 'object') throw new Error("Invalid JSON root");
      presets = flattenPrograms(json);
    } catch (e) {
      console.warn("CDN preset load failed, using fallback if present.", e);
      presets = flattenPrograms(window.EMBEDDED_PRESETS || {});
    }

    sel.innerHTML = '<option value="custom" selected>Custom</option>';
    const entries = Object.entries(presets)
      .map(([key,obj]) => {
        const friendly = (obj && obj.name) ? String(obj.name) : key.replace(/__/g, " ▸ ");
        return { key, name: friendly };
      })
      .sort((a,b)=> a.name.localeCompare(b.name, undefined, { sensitivity:'base', numeric:true }));

    for (const {key, name} of entries) {
      const o = document.createElement("option");
      o.value = key;
      o.textContent = name;
      sel.appendChild(o);
    }
  }

  /* ===========================================================
     WEEK / PRODUCT MANAGEMENT
  =========================================================== */
  let weekCounters = { vegetative: 0, flowering: 0 };

  function addWeek(stage){
    weekCounters[stage]++;
    const n = weekCounters[stage];
    const container = document.getElementById(stage+"Weeks");

    const card = document.createElement("div");
    card.className = "week-card";
    card.dataset.stage = stage;
    card.dataset.week = n;

    card.innerHTML = `
      <div class="week-header">
        <h3 class="week-title">Week ${n}</h3>
        <div class="week-controls">
          <button class="toggle-btn" onclick="toggleWeek(this)">Hide</button>
          <button class="remove-week-btn" onclick="removeWeek(this)">Remove</button>
        </div>
      </div>
      <div class="week-body">
        <div class="products-container"></div>
        <button class="add-product-btn" onclick="addProduct(this)">+ Add Product</button>
      </div>
    `;

    container.appendChild(card);
    addProduct(card.querySelector(".add-product-btn"));
  }

  function toggleWeek(btn){
    const body = btn.closest(".week-card").querySelector(".week-body");
    const isHidden = body.classList.toggle("hidden");
    btn.textContent = isHidden ? "Show" : "Hide";
  }

  function addProduct(btn){
    const wrap = btn.closest(".week-card").querySelector(".products-container");
    const row = document.createElement("div");
    row.className = "product-row";
    row.innerHTML = `
      <div class="product-fields">
        <div class="field-group">
          <label>Nutrient Name</label>
          <input type="text" class="product-name" placeholder="Enter nutrient name" autocapitalize="words" autocomplete="off">
        </div>
        <div class="field-group">
          <label>Dilution Rate (ml/L)</label>
          <input type="number" class="product-rate" min="0" step="0.1" inputmode="decimal" placeholder="0.0">
        </div>
        <button class="remove-product-btn" onclick="removeProduct(this)">Remove</button>
      </div>`;
    wrap.appendChild(row);
  }

  function removeProduct(btn){ btn.closest(".product-row").remove(); }

  function removeWeek(btn){
    const card = btn.closest(".week-card");
    const stage = card.dataset.stage;
    card.remove();
    const weeks = document.getElementById(stage+'Weeks').querySelectorAll('.week-card');
    weeks.forEach((w,i)=>{ w.dataset.week=i+1; w.querySelector('.week-title').textContent=`Week ${i+1}`; });
    weekCounters[stage] = weeks.length;
  }

  document.getElementById("configSelect").addEventListener("change", e => {
    const key = e.target.value;
    if (key === "custom") return;

    const preset = presets[key];
    if (!preset) return;

    ["vegetative","flowering"].forEach(stage=>{
      document.getElementById(stage+"Weeks").innerHTML="";
      weekCounters[stage]=0;
    });

    ["vegetative","flowering"].forEach(stage=>{
      const weeks = Array.isArray(preset[stage]) ? preset[stage].slice().sort((a,b)=> (a.week||0)-(b.week||0)) : [];
      weeks.forEach(week => {
        addWeek(stage);
        const card = document.querySelector(`#${stage}Weeks .week-card:last-of-type`);
        const wrap = card.querySelector(".products-container");
        wrap.innerHTML="";
        (week.products || []).forEach(p=>{
          const row = document.createElement("div");
          row.className="product-row";
          row.innerHTML=`
            <div class="product-fields">
              <div class="field-group">
                <label>Nutrient Name</label>
                <input type="text" class="product-name" value="${(p.name ?? '').toString().replace(/"/g,'&quot;')}">
              </div>
              <div class="field-group">
                <label>Dilution Rate (ml/L)</label>
                <input type="number" class="product-rate" min="0" step="0.1" inputmode="decimal" value="${(p.rate ?? '').toString()}">
              </div>
              <button class="remove-product-btn" onclick="removeProduct(this)">Remove</button>
            </div>`;
          wrap.appendChild(row);
        });
      });
    });
  });

  /* ===========================================================
     CALCULATION ENGINE
  =========================================================== */
  let calculationResults = null;

  function calculate(){
    const resSize = parseFloat(document.getElementById("reservoirSize").value);
    const err = document.getElementById("errorMessage");
    const resultsWrap = document.getElementById("resultsSection");
    const dl = document.getElementById("downloadBtn");

    err.style.display="none";
    resultsWrap.style.display="none";
    dl.style.display="none";

    if (!resSize || resSize <= 0){
      err.textContent="Please enter a valid reservoir size.";
      err.style.display="block";
      return;
    }

    const data = { vegetative:[], flowering:[] };

    ["vegetative","flowering"].forEach(stage=>{
      document.querySelectorAll(`#${stage}Weeks .week-card`).forEach(card=>{
        const week = parseInt(card.dataset.week);
        const prods = [];
        card.querySelectorAll(".product-row").forEach(r=>{
          const name = (r.querySelector(".product-name").value || '').trim();
          const rate = parseFloat(r.querySelector(".product-rate").value);
          if (!name || !rate || rate<=0) return;
          prods.push({name,rate});
        });
        if (prods.length>0) data[stage].push({week, products:prods});
      });
    });

    if (data.vegetative.length===0 && data.flowering.length===0){
      err.textContent="Please add at least one week with products.";
      err.style.display="block";
      return;
    }

    calculationResults = { reservoirSize:resSize, data };
    displayResults();
    dl.style.display="block";
  }

  /* ===========================================================
     RESULTS TABLE (desktop) + STACKED LIST (mobile)
  =========================================================== */
  function formatValue(v){
    const n = parseFloat(v);
    if (isNaN(n)) return "-";
    return Number.isInteger(n) ? n.toString() : parseFloat(n.toFixed(2)).toString().replace(/\.0+$/,"");
  }

  function displayResults(){
    const resSize = calculationResults.reservoirSize;
    const data = calculationResults.data;

    const allWeeks=[];
    const allNutrients=new Set();

    (data.vegetative||[]).forEach(w=>{
      allWeeks.push({stage:"veg", week:w.week, label:`Veg ${w.week}`, products:w.products});
      w.products.forEach(p=>allNutrients.add(p.name));
    });

    (data.flowering||[]).forEach(w=>{
      allWeeks.push({stage:"flower", week:w.week, label:`Flower ${w.week}`, products:w.products});
      w.products.forEach(p=>allNutrients.add(p.name));
    });

    allWeeks.sort((a,b)=> a.stage!==b.stage ? (a.stage==='veg'?-1:1) : (a.week-b.week));

    const nutrients = Array.from(allNutrients).map(name=>{
      const rates={};
      allWeeks.forEach(w=>{
        const hit = w.products.find(p=>p.name===name);
        if(hit) rates[`${w.stage}_${w.week}`]=hit.rate;
      });
      return { name, rates };
    });

    // Desktop matrix
    const matrixMount = document.getElementById("resultsMatrix");
    matrixMount.innerHTML = "";
    const section=document.createElement("div");
    section.className="stage-results";
    section.innerHTML=`<h2 style="text-align:center;font-family:'Inter',system-ui,sans-serif;color:var(--heading);font-weight:800;margin:0 0 12px;font-size:1.25em;">Complete Feed Chart (ml per reservoir)</h2>`;
    const tableBox=document.createElement("div");
    tableBox.className="feed-chart-matrix";

    let html = `<table><thead><tr><th class="matrix-nutrient-header">Nutrient</th>${allWeeks.map(w=>`<th class="matrix-week-header">${w.label}</th>`).join('')}</tr></thead><tbody>`;
    nutrients.forEach(n=>{
      html+=`<tr><td class="matrix-nutrient-name">${n.name}</td>`;
      allWeeks.forEach(w=>{
        const r = n.rates[`${w.stage}_${w.week}`];
        if(r){
          const total = r * resSize;
          html+=`<td class="matrix-data-cell" title="Tap to copy"><div class="matrix-rate-value">${formatValue(total)} ml</div></td>`;
        } else {
          html+=`<td class="matrix-empty-cell">-</td>`;
        }
      });
      html+=`</tr>`;
    });
    html+=`</tbody></table>`;
    tableBox.innerHTML=html;

    tableBox.addEventListener('click',e=>{
      const cell=e.target.closest('.matrix-data-cell'); if(!cell) return;
      const txt=cell.innerText.replace(/\s+/g,' ').trim(); if(navigator.clipboard) navigator.clipboard.writeText(txt);
    });

    section.appendChild(tableBox);
    matrixMount.appendChild(section);

    // Mobile stacked cards
    const mobileMount = document.getElementById("resultsMobile");
    mobileMount.innerHTML = "";
    allWeeks.forEach(w=>{
      const card = document.createElement("div");
      card.className = "week-summary";
      const items = [];
      nutrients.forEach(n=>{
        const r = n.rates[`${w.stage}_${w.week}`];
        if (r){ items.push(`<li><span class="n-name">${n.name}</span><span class="n-val">${formatValue(r*resSize)} ml</span></li>`); }
      });
      card.innerHTML = `<h3>${w.label} — per reservoir</h3>${items.length ? `<ul>${items.join('')}</ul>` : `<div style="color:#777;">No products recorded for this week.</div>`}`;
      mobileMount.appendChild(card);
    });

    document.getElementById("resultsSection").style.display="block";
    calculationResults.gridData = { allWeeks, nutrients };
  }

  /* ===========================================================
     PDF EXPORT
  =========================================================== */
  function downloadPDF(){
    if (!calculationResults || !window.jspdf) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');

    const title = "Nutrient Program Calculator";
    const subtitle = "Build a week-by-week feed chart with per-reservoir totals, then export to PDF.";

    doc.setFontSize(20); doc.setFont(undefined,'bold');
    doc.text(title,148,16,{align:'center'});
    doc.setFontSize(11); doc.setFont(undefined,'normal');
    doc.text(subtitle,148,24,{align:'center'});
    doc.text(`Reservoir Size: ${calculationResults.reservoirSize} L`,148,32,{align:'center'});

    let y=42;
    if(calculationResults.gridData?.allWeeks?.length){
      doc.setFontSize(16); doc.setFont(undefined,'bold');
      doc.text('Complete Feed Chart (ml per reservoir)',14,y); y+=8;

      const grid = calculationResults.gridData;
      const head = ['Nutrient', ...grid.allWeeks.map(w=>w.label)];
      const body = grid.nutrients.map(n=>[
        n.name,
        ...grid.allWeeks.map(w=>{
          const r=n.rates[`${w.stage}_${w.week}`];
          return r ? `${formatValue(r*calculationResults.reservoirSize)} ml` : '-';
        })
      ]);

      doc.autoTable({
        startY:y, head:[head], body,
        theme:'grid',
        headStyles:{ fillColor:[53,88,74], textColor:[255,255,255], fontStyle:'bold' },
        styles:{ fontSize:8, cellPadding:3, halign:'center' },
        columnStyles:{ 0:{ halign:'left', fontStyle:'bold' } },
        margin:{ left:14, right:14 }
      });
    }
    doc.save(`${title.replace(/[^a-z0-9]/gi,'_')}.pdf`);
  }

  /* ===========================================================
     INIT
  =========================================================== */
  loadExternalPresets();

  // Expose fns to inline handlers
  window.addWeek = addWeek;
  window.toggleWeek = toggleWeek;
  window.removeWeek = removeWeek;
  window.addProduct = addProduct;
  window.removeProduct = removeProduct;
  window.calculate = calculate;
  window.downloadPDF = downloadPDF;

  // Remove lingering focus after taps
  document.getElementById('npcalc').addEventListener('click', function (e) {
    if (e.target.matches('button, [role="button"]')) {
      setTimeout(() => e.target.blur(), 0);
    }
  });
  </script>

  <!-- Small fallback: if the browser doesn't support :has(), clamp only the nearest Shopify wrapper -->
  <script>
  (function(){
    try {
      if (CSS && CSS.supports && CSS.supports(':has(*)')) return; // CSS already clamps wrapper
    } catch(e){ /* older browsers */ }
    var calc = document.getElementById('npcalc');
    if (!calc) return;
    var el = calc.parentElement, clampTarget = null;
    while (el) {
      if (el.id === 'MainContent' ||
          (el.classList && el.classList.contains('shopify-section')) ||
          (el.classList && el.classList.contains('page-width'))) { clampTarget = el; break; }
      el = el.parentElement;
    }
    (clampTarget || calc.parentElement).style.overflowX = 'hidden';
    (clampTarget || calc.parentElement).style.maxWidth  = '100%';
  })();
  </script>
</div>
