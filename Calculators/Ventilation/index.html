<body>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ventilation Calculator</title>
  <link rel="stylesheet" href="../../shared/styles/calculators.css">



<div id="vent-calc">
  <div class="vc-wrap">

    <div class="card with-watermark">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true" decoding="async" loading="lazy">

      <div class="title-block">
        <h1>Ventilation Calculator</h1>
        <div class="vc-sub">Calculate the perfect airflow for your room ventilation needs</div>
      </div>

      <div class="sec-title">
        <span class="dot" aria-hidden="true"></span><span>Room Dimensions</span>
      </div>

      <div class="grid g-2" style="margin-bottom:14px;">
        <div>
          <label for="unit-system">Unit System</label>
          <select id="unit-system">
            <option value="metric">Metric (m)</option>
            <option value="imperial">Imperial (ft)</option>
          </select>
        </div>
      </div>

      <div class="grid g-3">
        <div>
          <label for="length">Length (<span id="length-unit">m</span>)</label>
          <input type="number" id="length" placeholder="Enter room length" min="0" step="0.1">
          <div class="help">Enter a positive number.</div>
        </div>
        <div>
          <label for="width">Width (<span id="width-unit">m</span>)</label>
          <input type="number" id="width" placeholder="Enter room width" min="0" step="0.1">
          <div class="help">Enter a positive number.</div>
        </div>
        <div>
          <label for="height">Height (<span id="height-unit">m</span>)</label>
          <input type="number" id="height" placeholder="Enter room height" min="0" step="0.1">
          <div class="help">Enter a positive number.</div>
        </div>
      </div>
      <div id="dim-err" class="error-msg hidden">Please enter room length, width, and height.</div>

      <div class="sec-title">
        <span class="dot" aria-hidden="true"></span><span>Ventilation Calculation</span>
      </div>

      <div class="grid g-2" style="margin-bottom:10px;">
        <div>
          <label for="stage">Grow Stage Preset (optional)</label>
          <select id="stage">
            <option value="">None</option>
            <option value="seed">Seedling/Clone (15‚Äì20 ACH)</option>
            <option value="veg">Vegetative (20‚Äì30 ACH)</option>
            <option value="flower">Flowering (30‚Äì40 ACH)</option>
            <option value="high">High Heat/CO‚ÇÇ (40‚Äì60 ACH)</option>
          </select>
          <div class="help">Selecting a preset fills a recommended ACH (you can still edit it).</div>
        </div>
        <div>
          <label style="visibility:hidden">Scrubbing</label>
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="show-scrub"> Show recirculating / scrubbing targets
          </label>
        </div>
      </div>

      <div class="grid g-2">
        <div>
          <label for="ach">Desired Air Changes per Hour (ACH)</label>
          <input type="number" id="ach" placeholder="Enter target ACH (optional)" min="0" step="0.1">
          <div id="ach-err" class="error-msg hidden">Enter ACH or Flow Rate to calculate.</div>
          <div class="help">Leave empty if you know your fan‚Äôs flow rate.</div>
        </div>

        <div>
          <label for="flow-rate">Fan Flow Rate</label>
          <div class="inline-field">
            <div class="grow">
              <input type="number" id="flow-rate" placeholder="Enter fan flow (optional)" min="0" step="1">
            </div>
            <div class="unit-select">
              <select id="flow-rate-unit" aria-label="Flow rate unit">
                <option value="cmh">m¬≥/h</option>
                <option value="cfm">CFM</option>
              </select>
            </div>
          </div>
          <div id="flow-err" class="error-msg hidden">Enter Flow Rate or ACH to calculate.</div>
          <div class="help">Leave empty if you want to calculate required flow rate.</div>
        </div>
      </div>

      <div style="margin-top:16px;">
        <div class="sec-title" style="font-size:16px;">
          <span class="dot" aria-hidden="true"></span><span>Optional Loss / Safety Model</span>
        </div>

        <div class="inline-options">
          <label><input type="radio" name="loss-mode" id="loss-mode-simple" checked> Simple Safety Margin (%)</label>
          <label><input type="radio" name="loss-mode" id="loss-mode-detailed"> Detailed Losses (filter, ducting, bends)</label>
        </div>

        <div id="tolerance-row" class="grid g-3">
          <div>
            <label for="tolerance">Safety Margin (%)</label>
            <input type="number" id="tolerance" placeholder="Add % buffer (e.g., 25)" min="0" max="100" step="1">
            <div class="help">Adds a fixed buffer to the calculated requirement.</div>
          </div>
        </div>

        <div id="detailed-losses" class="grid g-3 hidden" style="margin-top:6px;">
          <div>
            <label style="display:flex; align-items:center; gap:8px; margin-top:24px;">
              <input id="has-filter" type="checkbox"> Carbon Filter (‚âà22% loss)
            </label>
          </div>
          <div>
            <label for="duct-length">Duct Length (m)</label>
            <input type="number" id="duct-length" placeholder="Total duct length" min="0" step="0.1">
            <div class="help">~4% loss per metre (rule of thumb).</div>
          </div>
          <div>
            <label for="bends">90¬∞ Bends (count)</label>
            <input type="number" id="bends" placeholder="Number of 90¬∞ bends" min="0" step="1">
            <div class="help">~10% loss per 90¬∞ bend.</div>
          </div>
        </div>
      </div>

      <div style="text-align:center; margin-top:18px; position:relative; z-index:1;">
        <button id="calculate-btn" type="button" class="btn">Calculate Ventilation</button>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden" aria-live="polite" aria-atomic="true"></div>
  </div>
</div>

<!-- Fixed watermark (matches nutrient calculator styling) -->
<div id="ho-watermark" aria-hidden="true">Hydro Oasis ‚Ä¢ Ventilation Calculator</div>

<script>
  const CUBIC_METERS_TO_CUBIC_FEET = 35.3147;
  const CFM_TO_CMH = 1.69901;
  const $ = (id)=>document.getElementById(id);

  function toCFM(cmh){ return cmh/CFM_TO_CMH; }
  function toCMH(cfm){ return cfm*CFM_TO_CMH; }
  function volumeM3(L,W,H,isMetric){ return isMetric ? L*W*H : (L*W*H)/CUBIC_METERS_TO_CUBIC_FEET; }

  const fanMap = [
    { maxCMH: 200, items:[
      { title:'4‚Äù Inline Fan ~190 m¬≥/h', url:'#', note:'Small tents up to ~0.6√ó1.2m' },
      { title:'4‚Äù Inline + Carbon Filter Kit', url:'#', note:'Odour control starter' }
    ]},
    { maxCMH: 400, items:[
      { title:'6‚Äù Inline Fan ~360 m¬≥/h', url:'#', note:'1.2√ó1.2m‚Äì1.5√ó1.5m' },
      { title:'6‚Äù EC Inline (Speed Control)', url:'#', note:'Quieter & efficient' }
    ]},
    { maxCMH: 800, items:[
      { title:'8‚Äù Inline Fan ~700‚Äì800 m¬≥/h', url:'#', note:'Large tents / filter runs' },
      { title:'8‚Äù EC Inline + Carbon Kit', url:'#', note:'Flowering + odour control' }
    ]},
    { maxCMH: 1200, items:[
      { title:'10‚Äù Inline Fan ~1000‚Äì1200 m¬≥/h', url:'#', note:'Commercial-lite setups' },
      { title:'10‚Äù Silenced EC Inline', url:'#', note:'Low noise, high flow' }
    ]},
    { maxCMH: Infinity, items:[
      { title:'12‚Äù / Industrial EC Fan', url:'#', note:'Large rooms / multi-tent' },
      { title:'Dual-Fan / HVAC Consultation', url:'#', note:'Custom ducting & control' }
    ]}
  ];

  const fieldsToPersist = [
    'unit-system','length','width','height','ach','flow-rate','flow-rate-unit',
    'tolerance','has-filter','duct-length','bends','stage','loss-mode-simple','loss-mode-detailed','show-scrub'
  ];

  const getLossModeDetailed = ()=> $('loss-mode-detailed').checked;
  function estimateLossFactorDetailed(){
    const hasFilter = $('has-filter').checked;
    const duct = parseFloat($('duct-length').value)||0;
    const bends = parseFloat($('bends').value)||0;
    const filterLoss = hasFilter ? 0.22 : 0;
    const ductLoss = 0.04 * duct;
    const bendLoss = 0.10 * bends;
    return Math.min(0.7, filterLoss + ductLoss + bendLoss);
  }
  function getTolerancePct(){
    const v = parseFloat($('tolerance').value);
    return Number.isFinite(v)? Math.min(Math.max(v,0),100) : 0;
  }

  /* ===== Section builders (cards + tiles) ===== */
  function makeSection(title, icon){
    const sec = document.createElement('div'); sec.className='sec-card';
    const head = document.createElement('div'); head.className='sec-head';
    head.innerHTML = `<span class="icon">${icon||'üìä'}</span><span>${title}</span>`;
    const stats = document.createElement('div'); stats.className='stats';
    sec.append(head, stats);
    return {sec, stats};
  }
  function statTile(label, value){
    const d = document.createElement('div'); d.className='stat';
    d.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return d;
  }

  /* === ‚ÄúComing soon‚Äù card helper for Recommendations === */
  function addComingSoon(recSection){
    const a = document.createElement('a');
    a.href = '#';
    a.className = 'pick';
    a.innerHTML = `
      <div>
        <div style="font-weight:700;">Coming soon</div>
        <div style="font-size:12px;opacity:.9;">Tap to refresh</div>
      </div>
      <span style="font-size:12px;opacity:.9;">‚Üª</span>`;
    a.addEventListener('click', (e)=>{ e.preventDefault(); location.reload(); });
    recSection.sec.appendChild(a);
  }

  function hideResults(){ $('results').classList.add('hidden'); $('results').innerHTML=''; }
  function showResults(){ $('results').classList.remove('hidden'); }

  function readNum(id){
    const v = parseFloat($(id).value);
    return Number.isFinite(v)? v : null;
  }
  function clearErrors(ids){
    ids.forEach(id=>$(id).classList.remove('error'));
    ['ach-err','flow-err','dim-err'].forEach(id=>$(id).classList.add('hidden'));
  }

  function getInputs(){
    const ids = ['length','width','height','ach','flow-rate','tolerance','duct-length','bends'];
    clearErrors(ids);
    const L = readNum('length'), W=readNum('width'), H=readNum('height');
    const ach = readNum('ach'), flow=readNum('flow-rate');

    let ok = true;
    if(!(L>0)){ $('length').classList.add('error'); ok=false; }
    if(!(W>0)){ $('width').classList.add('error'); ok=false; }
    if(!(H>0)){ $('height').classList.add('error'); ok=false; }
    if(!ok){ $('dim-err').classList.remove('hidden'); return null; }

    if(!(ach>0) && !(flow>0)){
      $('ach').classList.add('error');
      $('flow-rate').classList.add('error');
      $('ach-err').classList.remove('hidden');
      $('flow-err').classList.remove('hidden');
      return null;
    }
    return {L,W,H,ach,flow};
  }

  function renderStorePicks(targetRatedCMH, host){
    const tier = fanMap.find(t=>targetRatedCMH <= t.maxCMH) || fanMap[fanMap.length-1];
    const wrap = document.createElement('div');
    wrap.style.background = '#F7FAF9';
    wrap.style.border = '1px solid var(--tile-border)';
    wrap.style.borderRadius = '12px';
    wrap.style.padding = '14px';
    wrap.innerHTML = `
      <div style="font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px;">
        üõí Store Picks for ~${Math.round(targetRatedCMH)} m¬≥/h
      </div>
      <div style="display:grid;gap:8px;">
        ${tier.items.map(it=>`
          <a href="${it.url}" target="_blank" rel="noopener" class="pick">
            <div>
              <div style="font-weight:700;">${it.title}</div>
              ${it.note?`<div style="font-size:12px;opacity:.9;">${it.note}</div>`:''}
            </div>
            <span style="font-size:12px;opacity:.9;">View ‚Üí</span>
          </a>`).join('')}
      </div>`;
    host.appendChild(wrap);
  }

  function calculate(){
    const inputs = getInputs();
    if(!inputs){ hideResults(); return; }

    const metric = $('unit-system').value==='metric';
    const unitSel = $('flow-rate-unit').value;
    const detailed = getLossModeDetailed();
    const loss = detailed ? estimateLossFactorDetailed() : 0;
    const tol = detailed ? 0 : getTolerancePct();
    const showScrub = $('show-scrub').checked;

    const vol = volumeM3(inputs.L, inputs.W, inputs.H, metric);
    const volFt3 = vol * 35.3147;

    // Build results fresh
    const root = $('results'); root.innerHTML='';

    // Room volume section
    const sVol = makeSection('Room Volume', 'üì¶');
    sVol.stats.appendChild(statTile('Volume (m¬≥)', vol.toFixed(2)+' m¬≥'));
    sVol.stats.appendChild(statTile('Volume (ft¬≥)', volFt3.toFixed(2)+' ft¬≥'));
    root.appendChild(sVol.sec);

    if(inputs.ach && !inputs.flow){
      // Required airflow case
      const cmh = (vol * inputs.ach) * (1 + (tol||0)/100) / (1 - (loss||0));
      const cfm = toCFM(cmh);

      const core = makeSection('Required Airflow', 'üßÆ');
      core.stats.appendChild(statTile('Target ACH', inputs.ach.toFixed(1)));
      core.stats.appendChild(statTile('Required Rated (m¬≥/h)', Math.round(cmh)));
      core.stats.appendChild(statTile('Required Rated (CFM)', Math.round(cfm)));
      core.stats.appendChild(statTile('Model', detailed ? 'Detailed Losses' : (tol?`${tol}% Margin`:'No Margin')));
      core.stats.appendChild(statTile('Intake for Neg. Pressure (‚âà85%)', Math.round(cmh*0.85) + ' m¬≥/h'));
      root.appendChild(core.sec);

      const rec = makeSection('Recommendations', 'üìã');
      addComingSoon(rec);
      root.appendChild(rec.sec);

    } else if(inputs.flow && !inputs.ach){
      // Given fan, compute ACH
      let ratedCMH, ratedCFM;
      if(unitSel==='cmh'){ ratedCMH = inputs.flow; ratedCFM = toCFM(inputs.flow); }
      else { ratedCFM = inputs.flow; ratedCMH = toCMH(inputs.flow); }
      const actualACH = (ratedCMH * (1 - (loss||0))) / vol;

      const core = makeSection('Fan Assessment', 'üß™');
      core.stats.appendChild(statTile('Rated (m¬≥/h)', Math.round(ratedCMH)));
      core.stats.appendChild(statTile('Rated (CFM)', Math.round(ratedCFM)));
      core.stats.appendChild(statTile('Effective ACH', actualACH.toFixed(1)));
      core.stats.appendChild(statTile('Model', detailed ? 'Detailed Losses' : (tol?`${tol}% Margin`:'No Margin')));
      root.appendChild(core.sec);

      const rec = makeSection('Recommendations', 'üìã');
      addComingSoon(rec);
      root.appendChild(rec.sec);

    } else if(inputs.ach && inputs.flow){
      // Compare fan vs target
      let ratedCMH, ratedCFM;
      if(unitSel==='cmh'){ ratedCMH = inputs.flow; ratedCFM = toCFM(inputs.flow); }
      else { ratedCFM = inputs.flow; ratedCMH = toCMH(inputs.flow); }
      const actualACH = (ratedCMH * (1 - (loss||0))) / vol;
      const reqCMH = (vol * inputs.ach) * (1 + (tol||0)/100) / (1 - (loss||0));
      const reqCFM = toCFM(reqCMH);

      const core = makeSection('Fan vs Target', 'üéØ');
      core.stats.appendChild(statTile('Target ACH', inputs.ach.toFixed(1)));
      core.stats.appendChild(statTile('Effective ACH', actualACH.toFixed(1)));
      core.stats.appendChild(statTile('Required (m¬≥/h)', Math.round(reqCMH)));
      core.stats.appendChild(statTile('Required (CFM)', Math.round(reqCFM)));
      core.stats.appendChild(statTile('Difference (ACH)', (actualACH-inputs.ach).toFixed(1)));
      root.appendChild(core.sec);

      const rec = makeSection('Recommendations', 'üìã');
      addComingSoon(rec);
      root.appendChild(rec.sec);
    } else {
      hideResults(); return;
    }

    showResults();
  }

  function syncLossUI(){
    const detailed = getLossModeDetailed();
    $('tolerance-row').classList.toggle('hidden', detailed);
    $('detailed-losses').classList.toggle('hidden', !detailed);
  }

  function updateUnitLabels(){
    const metric = $('unit-system').value === 'metric';
    const unit = metric ? 'm' : 'ft';
    $('length-unit').textContent = unit;
    $('width-unit').textContent = unit;
    $('height-unit').textContent = unit;
    $('flow-rate-unit').value = metric ? 'cmh' : 'cfm';
  }

  function saveState(){
    const s = Object.fromEntries(fieldsToPersist.map(id=>{
      const el = $(id);
      return [id, (el.type==='checkbox'||el.type==='radio') ? el.checked : el.value];
    }));
    localStorage.setItem('ventCalc', JSON.stringify(s));
  }
  function loadState(){
    const raw = localStorage.getItem('ventCalc');
    if(!raw){ updateUnitLabels(); syncLossUI(); return; }
    try{
      const s = JSON.parse(raw);
      fieldsToPersist.forEach(id=>{
        if(s[id]!==undefined){
          const el = $(id);
          if(el.type==='checkbox'||el.type==='radio') el.checked = !!s[id];
          else el.value = s[id];
        }
      });
    }catch(e){}
    updateUnitLabels(); syncLossUI();
  }

  $('unit-system').addEventListener('change', ()=>{ updateUnitLabels(); hideResults(); saveState(); });
  $('loss-mode-simple').addEventListener('change', ()=>{ syncLossUI(); hideResults(); saveState(); });
  $('loss-mode-detailed').addEventListener('change', ()=>{ syncLossUI(); hideResults(); saveState(); });
  $('stage').addEventListener('change', ()=>{
    const v = $('stage').value;
    const map = { seed:17.5, veg:25, flower:35, high:50 };
    $('ach').value = map[v] || '';
    hideResults(); saveState();
  });
  ['length','width','height','ach','flow-rate','flow-rate-unit','has-filter','duct-length','bends','tolerance','show-scrub']
    .forEach(id=> $(id).addEventListener('input', ()=>{ hideResults(); saveState(); }));

  // Tactile "pressed" feel across mouse/touch/keyboard (like nutrient calc)
  (function(){
    const root = document.getElementById('vent-calc');
    const BTN_SEL = '.btn';

    function pressOn(el){ el.classList.add('is-pressed'); }
    function pressOff(el){ el.classList.remove('is-pressed'); }

    root.addEventListener('pointerdown', (e) => {
      const b = e.target.closest(BTN_SEL);
      if (b) pressOn(b);
    });
    root.addEventListener('pointerup', (e) => {
      const b = e.target.closest(BTN_SEL);
      if (b) pressOff(b);
    });
    root.addEventListener('pointercancel', (e) => {
      const b = e.target.closest(BTN_SEL);
      if (b) pressOff(b);
    });
    root.addEventListener('pointerleave', (e) => {
      const b = e.target.closest(BTN_SEL);
      if (b) pressOff(b);
    });
    // Keyboard accessibility (Space/Enter)
    root.addEventListener('keydown', (e) => {
      if ((e.key === ' ' || e.key === 'Enter')) {
        const b = e.target.closest(BTN_SEL);
        if (b) pressOn(b);
      }
    });
    root.addEventListener('keyup', (e) => {
      if ((e.key === ' ' || e.key === 'Enter')) {
        const b = e.target.closest(BTN_SEL);
        if (b) pressOff(b);
      }
    });
  })();

  // Blur button after click to avoid sticky focus/pressed state
  $('calculate-btn').addEventListener('click', (e)=>{
    e.preventDefault();
    calculate();
    e.currentTarget.blur();
  });

  window.addEventListener('DOMContentLoaded', ()=>{ loadState(); });
  updateUnitLabels(); syncLossUI();
</script>
</body>