<body>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutrient Cost Calculator</title>
  <link rel="stylesheet" href="../../shared/styles/calculators.css">

<script src="/_sdk/element_sdk.js"></script>
<script src="/_sdk/data_sdk.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>




<div id="nutri-calc">
  <div class="wrap">
    <div class="card">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">

      <div class="title-block">
        <h1>Nutrient Cost Calculator</h1>
        <div class="subtitle">Estimate per-litre and time-based costs for your feed programme</div>
      </div>

      <div class="saved-weeks-toggle">
        <div class="toggle-container">
          <span>Show Saved Weeks for Harvest</span>
          <div class="toggle" id="nutrientSavedWeeksToggle" role="switch" aria-checked="false" tabindex="0">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <div id="nutrientSavedWeeks" class="saved-weeks-widget" style="display:none;">
        <div class="widget-title">ðŸ“˜ Saved Weeks for Harvest</div>
        <div id="nutrientSavedWeeksList"></div>
      </div>

      <!-- Plant info -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Plant Information</span></div>
      <div class="grid g-3">
        <div>
          <label>Number of Plants</label>
          <input id="numPlants" type="number" class="input" min="1" step="1" placeholder="e.g., 10">
          <div class="help">Enter a positive whole number.</div>
        </div>
        <div>
          <label>Water per Plant (L)</label>
          <input id="waterPerPlant" type="number" class="input" min="0.1" step="0.1" placeholder="e.g., 2.5">
          <div class="help">Average litres per watering.</div>
        </div>
        <div>
          <label>Watering Frequency (days/week)</label>
          <input id="wateringFreq" type="number" class="input" min="1" max="7" step="1" placeholder="e.g., 3">
          <div class="help">From 1 to 7.</div>
        </div>
      </div>

      <!-- Nutrients -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Nutrients</span></div>
      <div id="nutrientsContainer" class="grid" style="gap:12px;"></div>
      <div class="center" style="margin-top:10px;">
        <button id="addNutrientBtn" class="btn btn-ghost" type="button">ï¼‹ Add Nutrient</button>
      </div>

      <!-- Errors -->
      <div id="errorMessage" class="error-msg"></div>

      <!-- Controls -->
      <div class="center" style="margin-top:14px;">
        <button id="calculateBtn" class="btn" type="button">Calculate</button>
        <label class="inline" style="margin-left:10px;">
          <input id="roundResults" type="checkbox" checked>
          <span>Round currency to 2 decimals</span>
        </label>
      </div>

      <!-- ================= Results container (new layout) ================= -->
      <div id="resultsContainer" style="position:relative; z-index:1;"></div>

      <div id="nutrientWeekSave" class="week-save" style="display:none; margin-top:14px;">
        <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Send this week to the Harvest calculator</span></div>
        <div class="grid g-3" style="gap:12px;">
          <div>
            <label for="nutrientWeekStage">Stage</label>
            <select id="nutrientWeekStage" class="input">
              <option value="vegetative">Vegetative</option>
              <option value="flowering">Generative (Flowering)</option>
            </select>
          </div>
          <div>
            <label for="nutrientWeekNumber">Week Number</label>
            <input id="nutrientWeekNumber" type="number" class="input" min="1" step="1" placeholder="e.g., 4">
            <div class="help">Choose the exact veg/flower week this cost represents.</div>
          </div>
          <div class="center" style="align-self:end;">
            <button id="nutrientWeekSaveBtn" class="btn btn-ghost" type="button">Save Week for Harvest</button>
            <div id="nutrientWeekStatus" class="help" style="margin-top:6px;"></div>
          </div>
        </div>
      </div>

      <!-- PDF -->
      <div class="center" style="margin-top:12px;">
        <button id="downloadBtn" class="btn" type="button" style="display:none;">Download Results (PDF)</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* -------- App logic (scoped) -------- */
  const defaultConfig = {
    calculator_title: "Nutrient Cost Calculator",
    add_nutrient_text: "Add Nutrient",
    calculate_button_text: "Calculate"
  };

  const BRIDGE_STORAGE_KEY = 'hoCalcBridge';
  const NUTRIENT_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering (Generative)' };
  const SAVED_WEEK_CALC_LABELS = { nutrient: 'Nutrients', water: 'Water', electricity: 'Electricity' };
  const SAVED_WEEK_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering' };
  let latestWeeklyTotal = null;
  let nutrientSavedWeeksVisible = false;

  function applyNutrientSavedWeeksVisibility(){
    const widget = document.getElementById('nutrientSavedWeeks');
    if(widget){
      widget.style.display = nutrientSavedWeeksVisible ? 'block' : 'none';
    }
    const toggle = document.getElementById('nutrientSavedWeeksToggle');
    if(toggle){
      toggle.classList.toggle('active', nutrientSavedWeeksVisible);
      toggle.setAttribute('aria-checked', nutrientSavedWeeksVisible ? 'true' : 'false');
    }
  }

  function setNutrientSavedWeeksVisibility(show){
    nutrientSavedWeeksVisible = !!show;
    applyNutrientSavedWeeksVisibility();
  }
  function saveBridgeData(calculator, payload){
    try{
      if(typeof window === 'undefined' || !window.localStorage) return;
      const existing = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      existing[calculator] = { ...payload, updatedAt: Date.now() };
      window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(existing));
    }catch(err){
      console.warn('Hydro Oasis bridge save skipped:', err);
    }
  }

  function nutrientNormalizeStage(stage){
    return (stage === 'flowering' || stage === 'generative') ? 'flowering' : 'vegetative';
  }
  function nutrientStageLabel(stage){
    return NUTRIENT_STAGE_LABELS[nutrientNormalizeStage(stage)] || NUTRIENT_STAGE_LABELS.vegetative;
  }
  function saveNutrientWeekSnapshot(stage, weekNumber, weeklyCost){
    if(!(weekNumber > 0) || !Number.isFinite(weeklyCost)) return false;
    try{
      if(typeof window === 'undefined' || !window.localStorage) return false;
      const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      if(!data.stageWeeks) data.stageWeeks = { vegetative:{}, flowering:{} };
      const normalizedStage = nutrientNormalizeStage(stage);
      if(!data.stageWeeks[normalizedStage]) data.stageWeeks[normalizedStage] = {};
      const weekKey = String(weekNumber);
      const existingWeek = data.stageWeeks[normalizedStage][weekKey] || {};
      existingWeek.nutrient = { weeklyCost, updatedAt: Date.now() };
      data.stageWeeks[normalizedStage][weekKey] = existingWeek;
      window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(data));
      return true;
    }catch(err){
      console.warn('Hydro Oasis week save skipped:', err);
      return false;
    }
  }

  function getSavedWeeksSummary(){
    const empty = { vegetative: [], flowering: [], totalCount: 0 };
    try{
      if(typeof window === 'undefined' || !window.localStorage) return empty;
      const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      const stageWeeks = data?.stageWeeks || {};
      const parseStage = (stageKey)=>{
        const stageData = stageWeeks[stageKey] || {};
        return Object.keys(stageData).map(weekKey=>{
          const weekNumber = parseInt(weekKey, 10);
          if(!Number.isFinite(weekNumber)) return null;
          const entry = stageData[weekKey] || {};
          const calculators = Object.entries(SAVED_WEEK_CALC_LABELS).reduce((list,[calcKey,label])=>{
            const value = Number(entry?.[calcKey]?.weeklyCost);
            if(Number.isFinite(value)) list.push(label);
            return list;
          }, []);
          if(calculators.length === 0) return null;
          return { weekNumber, calculators };
        }).filter(Boolean).sort((a,b)=>a.weekNumber - b.weekNumber);
      };
      const vegetative = parseStage('vegetative');
      const flowering = parseStage('flowering');
      return { vegetative, flowering, totalCount: vegetative.length + flowering.length };
    }catch(err){
      console.warn('Hydro Oasis saved weeks read skipped:', err);
      return empty;
    }
  }

  function updateNutrientSavedWeeksWidget(){
    const widget = $('nutrientSavedWeeks');
    const body = $('nutrientSavedWeeksList');
    if(!widget || !body) return;
    const summary = getSavedWeeksSummary();
    if(summary.totalCount === 0){
      body.innerHTML = '<div class="sw-empty">No weeks saved yet. Save a week after running the Nutrient, Water, or Electricity calculators.</div>';
      applyNutrientSavedWeeksVisibility();
      return;
    }
    const sections = [];
    ['vegetative','flowering'].forEach(stage=>{
      if(summary[stage].length){
        const label = SAVED_WEEK_STAGE_LABELS[stage] || stage;
        const rows = summary[stage].map(week=>{
          const calcList = week.calculators.join(', ');
          return `<li><span class="sw-week">Week ${week.weekNumber}</span><span class="sw-meta">${calcList}</span></li>`;
        }).join('');
        sections.push(`<div class="sw-stage"><div class="sw-stage-label">${label}</div><ul>${rows}</ul></div>`);
      }
    });
    body.innerHTML = sections.join('');
    applyNutrientSavedWeeksVisibility();
  }

  function resetNutrientWeekPanel(){
    const panel = $('nutrientWeekSave');
    if(panel) panel.style.display = 'none';
    const status = $('nutrientWeekStatus');
    if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
  }

  function showNutrientWeekPanel(){
    const panel = $('nutrientWeekSave');
    if(panel) panel.style.display = 'block';
    const status = $('nutrientWeekStatus');
    if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
  }

  function handleNutrientWeekSave(){
    const status = $('nutrientWeekStatus');
    if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
    if(!Number.isFinite(latestWeeklyTotal)){
      if(status){ status.textContent = 'Run the calculator before saving.'; status.style.color = '#b91c1c'; }
      return;
    }
    const stage = $('nutrientWeekStage')?.value || 'vegetative';
    const weekNumber = parseInt($('nutrientWeekNumber')?.value, 10);
    if(!(weekNumber > 0)){
      if(status){ status.textContent = 'Enter a valid week number (1 or higher).'; status.style.color = '#b91c1c'; }
      return;
    }
    const ok = saveNutrientWeekSnapshot(stage, weekNumber, latestWeeklyTotal);
    if(status){
      if(ok){
        status.textContent = `Saved ${nutrientStageLabel(stage)} week ${weekNumber} for Harvest.`;
        status.style.color = '#1f7a54';
        updateNutrientSavedWeeksWidget();
      }else{
        status.textContent = 'Unable to save this week. Please try again.';
        status.style.color = '#b91c1c';
      }
    }
  }

  let nutrientCounter = 0;
  let calculationResults = null;
  const $ = (id)=>document.getElementById(id);

  function formatCurrency(value, rounded=true){
    if(rounded) return `$${value.toFixed(2)}`;
    let s = value.toFixed(6);
    s = parseFloat(s).toString();
    const parts = s.split('.');
    if(parts.length===1) return `$${s}.00`;
    const frac = parts[1].replace(/0+$/,'');
    return `$${parts[0]}.${(frac.length<2 ? frac.padEnd(2,'0') : frac)}`;
  }

  function addNutrientCard(){
    nutrientCounter++;
    const host = $('nutrientsContainer');
    const div = document.createElement('div');
    div.className = 'nutr-card';
    div.id = `nutrient-${nutrientCounter}`;
    div.innerHTML = `
      <div class="nutr-head">
        <div class="nutr-title">Nutrient #${nutrientCounter}</div>
        <button class="btn remove" type="button" onclick="removeNutrientCard(${nutrientCounter})">Remove</button>
      </div>
      <div class="grid g-3">
        <div>
          <label>Nutrient Name</label>
          <input type="text" class="input nutrient-name" placeholder="e.g., CalMag"/>
        </div>
        <div>
          <label>Bottle Cost ($)</label>
          <input type="number" class="input bottle-cost" min="0.01" step="0.01" placeholder="e.g., 25.99"/>
        </div>
        <div>
          <label>Bottle Size (L)</label>
          <input type="number" class="input bottle-size" min="0.1" step="0.1" placeholder="e.g., 1.0"/>
        </div>
      </div>
      <div class="grid g-3" style="margin-top:10px;">
        <div>
          <label>Dilution Rate (ml/L)</label>
          <input type="number" class="input dilution-rate" min="0.1" step="0.1" placeholder="e.g., 2.5"/>
        </div>
      </div>
    `;
    host.appendChild(div);
  }

  window.removeNutrientCard = function(id){
    const el = document.getElementById(`nutrient-${id}`);
    if(el) el.remove();
  };

  function validateInputs(){
    const n = parseFloat($('numPlants').value);
    const w = parseFloat($('waterPerPlant').value);
    const f = parseFloat($('wateringFreq').value);
    const err = $('errorMessage');
    const setErr = (msg, ids=[])=>{
      err.textContent = msg; err.classList.add('show');
      ids.forEach(i => $(i).classList.add('error'));
      return msg;
    };
    err.classList.remove('show');
    ['numPlants','waterPerPlant','wateringFreq'].forEach(i => $(i).classList.remove('error'));

    if(!(n>0)) return setErr("Number of plants must be greater than zero.", ['numPlants']);
    if(!(w>0)) return setErr("Water per plant must be greater than zero.", ['waterPerPlant']);
    if(!(f>0 && f<=7)) return setErr("Watering frequency must be between 1 and 7 days per week.", ['wateringFreq']);

    const cards = document.querySelectorAll('#nutri-calc .nutr-card');
    if(cards.length===0) return setErr("Please add at least one nutrient.");
    for(const card of cards){
      const name = card.querySelector('.nutrient-name').value.trim();
      const cost = parseFloat(card.querySelector('.bottle-cost').value);
      const size = parseFloat(card.querySelector('.bottle-size').value);
      const dil  = parseFloat(card.querySelector('.dilution-rate').value);
      if(!name) return setErr("All nutrients must have a name.");
      if(!(cost>0)) return setErr("All bottle costs must be greater than zero.");
      if(!(size>0)) return setErr("All bottle sizes must be greater than zero.");
      if(!(dil>0))  return setErr("All dilution rates must be greater than zero.");
    }
    return null;
  }

  /* ---------- Helpers to build "screenshot-style" sections ---------- */
  function makeSection(title, icon){
    const sec = document.createElement('div');
    sec.className = 'sec-card';

    const head = document.createElement('div');
    head.className = 'sec-head';
    head.innerHTML = `<span class="icon" aria-hidden="true">${icon || 'ðŸ“Š'}</span><span>${title}</span>`;
    sec.appendChild(head);

    const stats = document.createElement('div');
    stats.className = 'stats';
    sec.appendChild(stats);

    return {sec, stats};
  }
  function statTile(label, value){
    const s = document.createElement('div');
    s.className = 'stat';
    s.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return s;
  }

  function calculate(){
    const error = validateInputs();
    const round = $('roundResults').checked;
    const resultsHost = $('resultsContainer');
    resultsHost.innerHTML = '';
    $('downloadBtn').style.display = 'none';
    latestWeeklyTotal = null;
    resetNutrientWeekPanel();
    if(error) return;

    const numPlants = parseFloat($('numPlants').value);
    const waterPerPlant = parseFloat($('waterPerPlant').value);
    const wateringFreq = parseFloat($('wateringFreq').value);

    const cards = document.querySelectorAll('#nutri-calc .nutr-card');
    const nutrients = [];
    let totalPerLitre = 0, totalDay = 0, totalWeek = 0, totalMonth = 0, totalYear = 0;

    // ======= One section per nutrient (matches Electricity "Equipment" blocks) =======
    let idx = 0;
    cards.forEach(card=>{
      idx++;
      const name = card.querySelector('.nutrient-name').value.trim();
      const productCost = parseFloat(card.querySelector('.bottle-cost').value);
      const productSize = parseFloat(card.querySelector('.bottle-size').value);
      const dilution    = parseFloat(card.querySelector('.dilution-rate').value);

      const costPerLitre = (productCost / productSize) / (1000 / dilution);
      const perDay  = costPerLitre * waterPerPlant * numPlants;
      const perWeek = perDay * wateringFreq;
      const perMonth= perWeek * 4;
      const perYear = perWeek * 52;

      nutrients.push({name, costPerLitre, dailyCost:perDay, weeklyCost:perWeek, monthlyCost:perMonth, yearlyCost:perYear});

      totalPerLitre += costPerLitre;
      totalDay += perDay; totalWeek += perWeek; totalMonth += perMonth; totalYear += perYear;

      const label = name ? `${name}` : `Nutrient ${idx}`;
      const headerTitle = `${label} (${dilution} ml/L)`;

      const nsec = makeSection(headerTitle, 'ðŸ§ª');
      nsec.stats.appendChild(statTile('Per Litre',  formatCurrency(costPerLitre, round)));
      nsec.stats.appendChild(statTile('Daily',      formatCurrency(perDay,       round)));
      nsec.stats.appendChild(statTile('Weekly',     formatCurrency(perWeek,      round)));
      nsec.stats.appendChild(statTile('Monthly',    formatCurrency(perMonth,     round)));
      nsec.stats.appendChild(statTile('Yearly',     formatCurrency(perYear,      round)));

      resultsHost.appendChild(nsec.sec);
    });

    // ======= Totals section (like "Total Usage & Cost Breakdown") =======
    const secTotals = makeSection('Total Usage & Cost Breakdown', 'ðŸ“ˆ');
    secTotals.stats.appendChild(statTile('Total Per Litre',   formatCurrency(totalPerLitre, round)));
    secTotals.stats.appendChild(statTile('Total Daily Cost',  formatCurrency(totalDay, round)));
    secTotals.stats.appendChild(statTile('Total Weekly Cost', formatCurrency(totalWeek, round)));
    secTotals.stats.appendChild(statTile('Total Monthly Cost',formatCurrency(totalMonth, round)));
    secTotals.stats.appendChild(statTile('Total Yearly Cost', formatCurrency(totalYear, round)));

    const totalLitresPerDay = numPlants * waterPerPlant;
    const totalLitresPerWeek = totalLitresPerDay * wateringFreq;
    const totalLitresPerMonth = totalLitresPerWeek * 4;
    const totalLitresPerYear = totalLitresPerWeek * 52;

    secTotals.stats.appendChild(statTile('Litres / Day',   totalLitresPerDay.toFixed(2) + ' L'));
    secTotals.stats.appendChild(statTile('Litres / Week',  totalLitresPerWeek.toFixed(2) + ' L'));
    secTotals.stats.appendChild(statTile('Litres / Month', totalLitresPerMonth.toFixed(2) + ' L'));
    secTotals.stats.appendChild(statTile('Litres / Year',  totalLitresPerYear.toFixed(2) + ' L'));

    resultsHost.appendChild(secTotals.sec);

    // store results for PDF
    calculationResults = {
      title: (document.querySelector('#nutri-calc .title-block h1')?.textContent || defaultConfig.calculator_title),
      numPlants, waterPerPlant, wateringFreq, nutrients,
      totals:{ costPerLitre:totalPerLitre, dailyCost:totalDay, weeklyCost:totalWeek, monthlyCost:totalMonth, yearlyCost:totalYear },
      roundResults: round
    };

    saveBridgeData('nutrient', {
      dailyCost: totalDay,
      weeklyCost: totalWeek,
      monthlyCost: totalMonth,
      yearlyCost: totalYear
    });
    latestWeeklyTotal = totalWeek;
    showNutrientWeekPanel();
    $('downloadBtn').style.display = 'inline-block';
  }

  function downloadPDF(){
    if(!calculationResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 30, margin = 18, line = 8, pageH = doc.internal.pageSize.height;
    const check = (need)=>{ if(y+need > pageH - margin){ doc.addPage(); y = 30; } };

    doc.setFont('helvetica','bold'); doc.setFontSize(22);
    const w = doc.getTextWidth(calculationResults.title);
    doc.text(calculationResults.title, (doc.internal.pageSize.width - w)/2, y); y += 16;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Plant Information', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Number of Plants: ${calculationResults.numPlants}`, margin, y); y += line;
    doc.text(`Water per Plant: ${calculationResults.waterPerPlant} L`, margin, y); y += line;
    doc.text(`Watering Frequency: ${calculationResults.wateringFreq} days/week`, margin, y); y += 14;

    calculationResults.nutrients.forEach(n=>{
      check(60);
      doc.setFont('helvetica','bold'); doc.setFontSize(13);
      doc.text(`${n.name} â€“ Cost Breakdown`, margin, y); y += 9;
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Per Litre: ${formatCurrency(n.costPerLitre, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Day: ${formatCurrency(n.dailyCost, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Week: ${formatCurrency(n.weeklyCost, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Month: ${formatCurrency(n.monthlyCost, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Year: ${formatCurrency(n.yearlyCost, calculationResults.roundResults)}`, margin, y); y += 10;
    });

    check(60);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Total Cost Breakdown', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    const T = calculationResults.totals, R = calculationResults.roundResults;
    doc.text(`Total Per Litre: ${formatCurrency(T.costPerLitre,R)}`, margin, y); y += line;
    doc.text(`Total Per Day: ${formatCurrency(T.dailyCost,R)}`, margin, y); y += line;
    doc.text(`Total Per Week: ${formatCurrency(T.weeklyCost,R)}`, margin, y); y += line;
    doc.text(`Total Per Month: ${formatCurrency(T.monthlyCost,R)}`, margin, y); y += line;
    doc.text(`Total Per Year: ${formatCurrency(T.yearlyCost,R)}`, margin, y);

    doc.save('NutrientCostCalculatorResults.pdf');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Safe SDK init AFTER DOM is ready
    try{
      if (window.elementSdk && typeof window.elementSdk.init === 'function') {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: (cfg) => {
            const titleEl = document.querySelector('#nutri-calc .title-block h1');
            const add = document.getElementById('addNutrientBtn');
            const calc = document.getElementById('calculateBtn');
            if (titleEl) titleEl.textContent = cfg.calculator_title || defaultConfig.calculator_title;
            if (add) add.textContent = `ï¼‹ ${cfg.add_nutrient_text || defaultConfig.add_nutrient_text}`;
            if (calc) calc.textContent = cfg.calculate_button_text || defaultConfig.calculate_button_text;
          }
        });
      }
    } catch(e){
      console.warn('Element SDK init skipped:', e);
    }

    const titleEl = document.querySelector('#nutri-calc .title-block h1');
    if (titleEl) titleEl.textContent = defaultConfig.calculator_title;

    const addBtn = document.getElementById('addNutrientBtn');
    const calcBtn = document.getElementById('calculateBtn');
    const dlBtn = document.getElementById('downloadBtn');
    const saveBtn = document.getElementById('nutrientWeekSaveBtn');

    if (addBtn) addBtn.addEventListener('click', addNutrientCard);
    if (calcBtn) calcBtn.addEventListener('click', calculate);
    if (dlBtn) dlBtn.addEventListener('click', downloadPDF);
    if (saveBtn) saveBtn.addEventListener('click', handleNutrientWeekSave);
    const savedWeeksToggle = document.getElementById('nutrientSavedWeeksToggle');
    if(savedWeeksToggle){
      const toggleVisibility = ()=> setNutrientSavedWeeksVisibility(!nutrientSavedWeeksVisible);
      savedWeeksToggle.addEventListener('click', (e)=>{ e.preventDefault(); toggleVisibility(); });
      savedWeeksToggle.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          toggleVisibility();
        }
      });
    }
    setNutrientSavedWeeksVisibility(false);
    updateNutrientSavedWeeksWidget();
    if(typeof window !== 'undefined'){
      window.addEventListener('storage', event=>{
        if(event.key === BRIDGE_STORAGE_KEY) updateNutrientSavedWeeksWidget();
      });
    }
  });
</script>

  <div id="ho-watermark">Hydro Oasis â€¢ Nutrient Cost Calculator</div>

</body>