<body>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutrient Cost Calculator</title>

<script src="/_sdk/element_sdk.js"></script>
<script src="/_sdk/data_sdk.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  /* ========= Scoped Hydro Oasis theme (NO global bleed) ========= */
  :root{
    --bg:#FDFBF4; --text:#333; --heading:#2D5C4E;
    --btn:#2D5C4E; --btn-hover:#A76DAB; --btn-text:#fff;
    --card:#fff; --card-border:#E7E5DC; --icon:#2D5C4E; --err:#BE5C5C;

    /* results look + tiles like your screenshots */
    --sec-border:#D9E2DE;        /* outer card border */
    --sec-head-bg:#F3F7F5;       /* section header background */
    --sec-head-text:#2D5C4E;     /* header text */
    --tile-bg:#FFFFFF;           /* stat tile background */
    --tile-border:#E7E5DC;       /* stat tile border */
    --tile-label:#5C6F69;        /* small label */
    --tile-value:#2D5C4E;        /* bold value */
  }

  #nutri-calc, #nutri-calc * { box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  #nutri-calc { background:var(--bg); color:var(--text); padding:16px; }
  #nutri-calc .wrap{ max-width:1100px; margin:0 auto; }

  /* Base card (with watermark) */
  #nutri-calc .card{
    background:var(--card); border:1px solid var(--card-border); border-radius:16px;
    padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.06); position:relative; overflow:hidden;
  }
  #nutri-calc .wm-img{
    position:absolute; right:-28px; bottom:-28px; width:260px; opacity:.06;
    pointer-events:none; user-select:none; z-index:0;
  }
  @media (min-width:768px){ #nutri-calc .wm-img{ width:320px; } }

  /* Title */
  #nutri-calc .title-block{ text-align:center; margin:6px 0 10px; position:relative; z-index:1; }
  #nutri-calc .title-block h1{ color:var(--heading); font-weight:800; font-size:clamp(26px,3.2vw,36px); margin:0; letter-spacing:.3px; }
  #nutri-calc .subtitle{ color:#456E62; font-size:14px; }

  /* Section titles (input areas) */
  #nutri-calc .sec-title{ color:var(--heading); font-weight:800; font-size:18px; display:flex; align-items:center; gap:8px; margin:16px 0 12px; position:relative; z-index:1; }
  #nutri-calc .dot{ width:18px; height:18px; border-radius:4px; background:var(--icon); display:inline-block; }

  /* Inputs */
  #nutri-calc .grid{ display:grid; gap:14px; position:relative; z-index:1; }
  #nutri-calc .g-3{ grid-template-columns: repeat(3,1fr); }
  @media (max-width:820px){ #nutri-calc .g-3{ grid-template-columns:1fr; } }
  #nutri-calc label{ display:block; font-size:13px; color:#516A64; margin:2px 0 6px; }
  #nutri-calc .input{ width:100%; padding:12px 12px; border-radius:10px; border:1px solid #D1D1D1; background:#fff; font-size:16px; }
  #nutri-calc .help{ font-size:12px; color:#6B7C77; margin-top:6px; }
  #nutri-calc .error{ border-color:var(--err)!important; }
  #nutri-calc .error-msg{ color:var(--err); font-size:12px; margin:8px 0; display:none; }
  #nutri-calc .error-msg.show{ display:block; }

  /* Buttons */
  #nutri-calc .btn{
    background:var(--btn); color:var(--btn-text); border:1px solid var(--btn);
    border-radius:12px; padding:12px 18px; font-weight:700; cursor:pointer; transition:.15s; position:relative; z-index:1;
  }
  #nutri-calc .btn:hover{ background:var(--btn-hover); border-color:var(--btn-hover); }
  #nutri-calc .btn-ghost{ background:#f3f5f1; color:#1f3b33; border-color:#d9e2de; }
  #nutri-calc .btn-ghost:hover{ background:#e8eee9; }
  #nutri-calc .center{ text-align:center; }

  /* Nutrient mini-cards (input) */
  #nutri-calc .nutr-card{ background:#f8faf8; border:1px solid #e2e7e4; border-radius:12px; padding:16px; }
  #nutri-calc .nutr-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
  #nutri-calc .nutr-title{ font-weight:700; color:#1f3b33; }
  #nutri-calc .remove{ background:#ef4444; border-color:#ef4444; }
  #nutri-calc .remove:hover{ background:#dc2626; border-color:#dc2626; }

  /* =================== RESULTS UI (matches screenshots) =================== */
  /* Outer section card (each nutrient & totals) */
  #nutri-calc .sec-card{
    border:1px solid var(--sec-border);
    border-radius:12px;
    padding:12px;
    background:#fff;
    margin-top:14px;
  }
  /* Section header strip */
  #nutri-calc .sec-head{
    display:flex; align-items:center; gap:8px;
    background:var(--sec-head-bg);
    color:var(--sec-head-text);
    padding:8px 10px;
    border-radius:9px;
    font-weight:800;
    font-size:14px;
  }
  #nutri-calc .sec-head .icon{ font-size:16px; line-height:1; }

  /* Stats grid inside each section */
  #nutri-calc .stats{
    display:grid;
    grid-template-columns: repeat(5, minmax(120px,1fr));
    gap:10px;
    padding:10px 6px 6px;
  }
  @media (max-width:980px){
    #nutri-calc .stats{ grid-template-columns: repeat(2, minmax(140px,1fr)); }
  }
  @media (max-width:560px){
    #nutri-calc .stats{ grid-template-columns: 1fr; }
  }

  /* Individual stat tile */
  #nutri-calc .stat{
    background:var(--tile-bg);
    border:1px solid var(--tile-border);
    border-radius:10px;
    padding:10px 12px;
    text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,.03);
  }
  #nutri-calc .stat .label{
    font-size:12px; color:var(--tile-label); font-weight:700; letter-spacing:.2px;
  }
  #nutri-calc .stat .value{
    margin-top:4px; font-size:18px; font-weight:800; color:var(--tile-value);
  }
</style>


<div id="nutri-calc">
  <div class="wrap">
    <div class="card">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">

      <div class="title-block">
        <h1>Nutrient Cost Calculator</h1>
        <div class="subtitle">Estimate per-litre and time-based costs for your feed programme</div>
      </div>

      <!-- Plant info -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Plant Information</span></div>
      <div class="grid g-3">
        <div>
          <label>Number of Plants</label>
          <input id="numPlants" type="number" class="input" min="1" step="1" placeholder="e.g., 10">
          <div class="help">Enter a positive whole number.</div>
        </div>
        <div>
          <label>Water per Plant (L)</label>
          <input id="waterPerPlant" type="number" class="input" min="0.1" step="0.1" placeholder="e.g., 2.5">
          <div class="help">Average litres per watering.</div>
        </div>
        <div>
          <label>Watering Frequency (days/week)</label>
          <input id="wateringFreq" type="number" class="input" min="1" max="7" step="1" placeholder="e.g., 3">
          <div class="help">From 1 to 7.</div>
        </div>
      </div>

      <!-- Nutrients -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Nutrients</span></div>
      <div id="nutrientsContainer" class="grid" style="gap:12px;"></div>
      <div class="center" style="margin-top:10px;">
        <button id="addNutrientBtn" class="btn btn-ghost" type="button">ï¼‹ Add Nutrient</button>
      </div>

      <!-- Errors -->
      <div id="errorMessage" class="error-msg"></div>

      <!-- Controls -->
      <div class="center" style="margin-top:14px;">
        <button id="calculateBtn" class="btn" type="button">Calculate</button>
        <label class="inline" style="margin-left:10px;">
          <input id="roundResults" type="checkbox" checked>
          <span>Round currency to 2 decimals</span>
        </label>
      </div>

      <!-- ================= Results container (new layout) ================= -->
      <div id="resultsContainer" style="position:relative; z-index:1;"></div>

      <!-- PDF -->
      <div class="center" style="margin-top:12px;">
        <button id="downloadBtn" class="btn" type="button" style="display:none;">Download Results (PDF)</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* -------- App logic (scoped) -------- */
  const defaultConfig = {
    calculator_title: "Nutrient Cost Calculator",
    add_nutrient_text: "Add Nutrient",
    calculate_button_text: "Calculate"
  };

  let nutrientCounter = 0;
  let calculationResults = null;
  const $ = (id)=>document.getElementById(id);

  function formatCurrency(value, rounded=true){
    if(rounded) return `$${value.toFixed(2)}`;
    let s = value.toFixed(6);
    s = parseFloat(s).toString();
    const parts = s.split('.');
    if(parts.length===1) return `$${s}.00`;
    const frac = parts[1].replace(/0+$/,'');
    return `$${parts[0]}.${(frac.length<2 ? frac.padEnd(2,'0') : frac)}`;
  }

  function addNutrientCard(){
    nutrientCounter++;
    const host = $('nutrientsContainer');
    const div = document.createElement('div');
    div.className = 'nutr-card';
    div.id = `nutrient-${nutrientCounter}`;
    div.innerHTML = `
      <div class="nutr-head">
        <div class="nutr-title">Nutrient #${nutrientCounter}</div>
        <button class="btn remove" type="button" onclick="removeNutrientCard(${nutrientCounter})">Remove</button>
      </div>
      <div class="grid g-3">
        <div>
          <label>Nutrient Name</label>
          <input type="text" class="input nutrient-name" placeholder="e.g., CalMag"/>
        </div>
        <div>
          <label>Bottle Cost ($)</label>
          <input type="number" class="input bottle-cost" min="0.01" step="0.01" placeholder="e.g., 25.99"/>
        </div>
        <div>
          <label>Bottle Size (L)</label>
          <input type="number" class="input bottle-size" min="0.1" step="0.1" placeholder="e.g., 1.0"/>
        </div>
      </div>
      <div class="grid g-3" style="margin-top:10px;">
        <div>
          <label>Dilution Rate (ml/L)</label>
          <input type="number" class="input dilution-rate" min="0.1" step="0.1" placeholder="e.g., 2.5"/>
        </div>
      </div>
    `;
    host.appendChild(div);
  }

  window.removeNutrientCard = function(id){
    const el = document.getElementById(`nutrient-${id}`);
    if(el) el.remove();
  };

  function validateInputs(){
    const n = parseFloat($('numPlants').value);
    const w = parseFloat($('waterPerPlant').value);
    const f = parseFloat($('wateringFreq').value);
    const err = $('errorMessage');
    const setErr = (msg, ids=[])=>{
      err.textContent = msg; err.classList.add('show');
      ids.forEach(i => $(i).classList.add('error'));
      return msg;
    };
    err.classList.remove('show');
    ['numPlants','waterPerPlant','wateringFreq'].forEach(i => $(i).classList.remove('error'));

    if(!(n>0)) return setErr("Number of plants must be greater than zero.", ['numPlants']);
    if(!(w>0)) return setErr("Water per plant must be greater than zero.", ['waterPerPlant']);
    if(!(f>0 && f<=7)) return setErr("Watering frequency must be between 1 and 7 days per week.", ['wateringFreq']);

    const cards = document.querySelectorAll('#nutri-calc .nutr-card');
    if(cards.length===0) return setErr("Please add at least one nutrient.");
    for(const card of cards){
      const name = card.querySelector('.nutrient-name').value.trim();
      const cost = parseFloat(card.querySelector('.bottle-cost').value);
      const size = parseFloat(card.querySelector('.bottle-size').value);
      const dil  = parseFloat(card.querySelector('.dilution-rate').value);
      if(!name) return setErr("All nutrients must have a name.");
      if(!(cost>0)) return setErr("All bottle costs must be greater than zero.");
      if(!(size>0)) return setErr("All bottle sizes must be greater than zero.");
      if(!(dil>0))  return setErr("All dilution rates must be greater than zero.");
    }
    return null;
  }

  /* ---------- Helpers to build "screenshot-style" sections ---------- */
  function makeSection(title, icon){
    const sec = document.createElement('div');
    sec.className = 'sec-card';

    const head = document.createElement('div');
    head.className = 'sec-head';
    head.innerHTML = `<span class="icon" aria-hidden="true">${icon || 'ðŸ“Š'}</span><span>${title}</span>`;
    sec.appendChild(head);

    const stats = document.createElement('div');
    stats.className = 'stats';
    sec.appendChild(stats);

    return {sec, stats};
  }
  function statTile(label, value){
    const s = document.createElement('div');
    s.className = 'stat';
    s.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return s;
  }

  function calculate(){
    const error = validateInputs();
    const round = $('roundResults').checked;
    const resultsHost = $('resultsContainer');
    resultsHost.innerHTML = '';
    $('downloadBtn').style.display = 'none';
    if(error) return;

    const numPlants = parseFloat($('numPlants').value);
    const waterPerPlant = parseFloat($('waterPerPlant').value);
    const wateringFreq = parseFloat($('wateringFreq').value);

    const cards = document.querySelectorAll('#nutri-calc .nutr-card');
    const nutrients = [];
    let totalPerLitre = 0, totalDay = 0, totalWeek = 0, totalMonth = 0, totalYear = 0;

    // ======= One section per nutrient (matches Electricity "Equipment" blocks) =======
    let idx = 0;
    cards.forEach(card=>{
      idx++;
      const name = card.querySelector('.nutrient-name').value.trim();
      const productCost = parseFloat(card.querySelector('.bottle-cost').value);
      const productSize = parseFloat(card.querySelector('.bottle-size').value);
      const dilution    = parseFloat(card.querySelector('.dilution-rate').value);

      const costPerLitre = (productCost / productSize) / (1000 / dilution);
      const perDay  = costPerLitre * waterPerPlant * numPlants;
      const perWeek = perDay * wateringFreq;
      const perMonth= perWeek * 4;
      const perYear = perWeek * 52;

      nutrients.push({name, costPerLitre, dailyCost:perDay, weeklyCost:perWeek, monthlyCost:perMonth, yearlyCost:perYear});

      totalPerLitre += costPerLitre;
      totalDay += perDay; totalWeek += perWeek; totalMonth += perMonth; totalYear += perYear;

      const label = name ? `${name}` : `Nutrient ${idx}`;
      const headerTitle = `${label} (${dilution} ml/L)`;

      const nsec = makeSection(headerTitle, 'ðŸ§ª');
      nsec.stats.appendChild(statTile('Per Litre',  formatCurrency(costPerLitre, round)));
      nsec.stats.appendChild(statTile('Daily',      formatCurrency(perDay,       round)));
      nsec.stats.appendChild(statTile('Weekly',     formatCurrency(perWeek,      round)));
      nsec.stats.appendChild(statTile('Monthly',    formatCurrency(perMonth,     round)));
      nsec.stats.appendChild(statTile('Yearly',     formatCurrency(perYear,      round)));

      resultsHost.appendChild(nsec.sec);
    });

    // ======= Totals section (like "Total Usage & Cost Breakdown") =======
    const secTotals = makeSection('Total Usage & Cost Breakdown', 'ðŸ“ˆ');
    secTotals.stats.appendChild(statTile('Total Per Litre',   formatCurrency(totalPerLitre, round)));
    secTotals.stats.appendChild(statTile('Total Daily Cost',  formatCurrency(totalDay, round)));
    secTotals.stats.appendChild(statTile('Total Weekly Cost', formatCurrency(totalWeek, round)));
    secTotals.stats.appendChild(statTile('Total Monthly Cost',formatCurrency(totalMonth, round)));
    secTotals.stats.appendChild(statTile('Total Yearly Cost', formatCurrency(totalYear, round)));

    const totalLitresPerDay = numPlants * waterPerPlant;
    const totalLitresPerWeek = totalLitresPerDay * wateringFreq;
    const totalLitresPerMonth = totalLitresPerWeek * 4;
    const totalLitresPerYear = totalLitresPerWeek * 52;

    secTotals.stats.appendChild(statTile('Litres / Day',   totalLitresPerDay.toFixed(2) + ' L'));
    secTotals.stats.appendChild(statTile('Litres / Week',  totalLitresPerWeek.toFixed(2) + ' L'));
    secTotals.stats.appendChild(statTile('Litres / Month', totalLitresPerMonth.toFixed(2) + ' L'));
    secTotals.stats.appendChild(statTile('Litres / Year',  totalLitresPerYear.toFixed(2) + ' L'));

    resultsHost.appendChild(secTotals.sec);

    // store results for PDF
    calculationResults = {
      title: (document.querySelector('#nutri-calc .title-block h1')?.textContent || defaultConfig.calculator_title),
      numPlants, waterPerPlant, wateringFreq, nutrients,
      totals:{ costPerLitre:totalPerLitre, dailyCost:totalDay, weeklyCost:totalWeek, monthlyCost:totalMonth, yearlyCost:totalYear },
      roundResults: round
    };
    $('downloadBtn').style.display = 'inline-block';
  }

  function downloadPDF(){
    if(!calculationResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 30, margin = 18, line = 8, pageH = doc.internal.pageSize.height;
    const check = (need)=>{ if(y+need > pageH - margin){ doc.addPage(); y = 30; } };

    doc.setFont('helvetica','bold'); doc.setFontSize(22);
    const w = doc.getTextWidth(calculationResults.title);
    doc.text(calculationResults.title, (doc.internal.pageSize.width - w)/2, y); y += 16;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Plant Information', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Number of Plants: ${calculationResults.numPlants}`, margin, y); y += line;
    doc.text(`Water per Plant: ${calculationResults.waterPerPlant} L`, margin, y); y += line;
    doc.text(`Watering Frequency: ${calculationResults.wateringFreq} days/week`, margin, y); y += 14;

    calculationResults.nutrients.forEach(n=>{
      check(60);
      doc.setFont('helvetica','bold'); doc.setFontSize(13);
      doc.text(`${n.name} â€“ Cost Breakdown`, margin, y); y += 9;
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Per Litre: ${formatCurrency(n.costPerLitre, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Day: ${formatCurrency(n.dailyCost, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Week: ${formatCurrency(n.weeklyCost, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Month: ${formatCurrency(n.monthlyCost, calculationResults.roundResults)}`, margin, y); y += line;
      doc.text(`Per Year: ${formatCurrency(n.yearlyCost, calculationResults.roundResults)}`, margin, y); y += 10;
    });

    check(60);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Total Cost Breakdown', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    const T = calculationResults.totals, R = calculationResults.roundResults;
    doc.text(`Total Per Litre: ${formatCurrency(T.costPerLitre,R)}`, margin, y); y += line;
    doc.text(`Total Per Day: ${formatCurrency(T.dailyCost,R)}`, margin, y); y += line;
    doc.text(`Total Per Week: ${formatCurrency(T.weeklyCost,R)}`, margin, y); y += line;
    doc.text(`Total Per Month: ${formatCurrency(T.monthlyCost,R)}`, margin, y); y += line;
    doc.text(`Total Per Year: ${formatCurrency(T.yearlyCost,R)}`, margin, y);

    doc.save('NutrientCostCalculatorResults.pdf');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Safe SDK init AFTER DOM is ready
    try{
      if (window.elementSdk && typeof window.elementSdk.init === 'function') {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: (cfg) => {
            const titleEl = document.querySelector('#nutri-calc .title-block h1');
            const add = document.getElementById('addNutrientBtn');
            const calc = document.getElementById('calculateBtn');
            if (titleEl) titleEl.textContent = cfg.calculator_title || defaultConfig.calculator_title;
            if (add) add.textContent = `ï¼‹ ${cfg.add_nutrient_text || defaultConfig.add_nutrient_text}`;
            if (calc) calc.textContent = cfg.calculate_button_text || defaultConfig.calculate_button_text;
          }
        });
      }
    } catch(e){
      console.warn('Element SDK init skipped:', e);
    }

    const titleEl = document.querySelector('#nutri-calc .title-block h1');
    if (titleEl) titleEl.textContent = defaultConfig.calculator_title;

    const addBtn = document.getElementById('addNutrientBtn');
    const calcBtn = document.getElementById('calculateBtn');
    const dlBtn = document.getElementById('downloadBtn');

    if (addBtn) addBtn.addEventListener('click', addNutrientCard);
    if (calcBtn) calcBtn.addEventListener('click', calculate);
    if (dlBtn) dlBtn.addEventListener('click', downloadPDF);
  });
</script>
  <script>
/* ===== CEA calc core (drop-in) ===== */
const CEA = (() => {
  const BUS = document.createElement('div');
  const on  = (evt, fn) => BUS.addEventListener(evt, fn);
  const emit = (evt, detail) => BUS.dispatchEvent(new CustomEvent(evt,{detail}));

  function getRunId() {
    const k = 'cea.runId';
    let id = localStorage.getItem(k);
    if (!id) { id = 'RUN-' + Math.random().toString(36).slice(2,8).toUpperCase(); localStorage.setItem(k, id); }
    return id;
  }
  function save(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch{} }
  function load(key, fallback=null) { try { const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; } catch{ return fallback; } }

  return { on, emit, getRunId, save, load };
})();
</script>
</body>
