<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Harvest Cost Calculator</title>
  <link rel="stylesheet" href="../../shared/styles/calculators.css">

<!-- SDKs kept consistent with your other calcs -->
<script src="/_sdk/element_sdk.js"></script>
<script src="/_sdk/data_sdk.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


</head>
<body>
<div id="harvest-calc">
  <div class="wrap">
    <!-- Main Card -->
    <div class="card">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">

      <div class="title-block">
        <h1 id="page-title">Harvest Cost Calculator</h1>
        <div class="subtitle">Sum weekly inputs and see cost per gram, ounce, pound, and kilogram</div>
        <div id="prefill-notice" class="info-banner" style="display:none;"></div>
      </div>

      <!-- Vegetative -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span id="vegetative-label">Vegetative Cost</span></div>
      <div id="vegetative-weeks" class="grid" style="gap:12px;"></div>
      <div class="center" style="margin-top:10px;">
        <button class="btn btn-ghost" type="button" onclick="addWeek('vegetative')">Ôºã Add Week</button>
      </div>

      <!-- Flowering -->
      <div class="sec-title" style="margin-top:18px;"><span class="dot" aria-hidden="true"></span><span id="flowering-label">Flowering Cost</span></div>
      <div id="flowering-weeks" class="grid" style="gap:12px;"></div>
      <div class="center" style="margin-top:10px;">
        <button class="btn btn-ghost" type="button" onclick="addWeek('flowering')">Ôºã Add Week</button>
      </div>

      <!-- Harvest weight + options -->
      <div class="sec-title" style="margin-top:18px;"><span class="dot" aria-hidden="true"></span><span>Harvest Output</span></div>
      <div class="grid g-2">
        <div>
          <label id="harvest-weight-label" for="harvest-weight">Harvest Weight (g)</label>
          <input id="harvest-weight" type="number" class="input" min="0.01" step="0.01" placeholder="Enter weight in grams">
          <div class="help">Enter > 0 to compute per-weight costs.</div>
        </div>
        <div class="center" style="align-self:end;">
          <label style="font-size:14px;">
            <input id="round-results" type="checkbox" checked style="margin-right:6px; vertical-align:-2px;"> Round results to two decimals
          </label>
        </div>
      </div>

      <!-- Errors -->
      <div id="error-container" class="error-msg"></div>

      <!-- Actions -->
      <div class="center" style="margin-top:14px;">
        <button class="btn" id="calculate-button" type="button" onclick="calculateResults()">Calculate</button>
      </div>
    </div>

    <!-- Results Card -->
    <div id="results-card" class="card" style="display:none;">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">
      <div id="results-container"></div>

      <div class="center" style="margin-top:12px;">
        <button id="downloadBtn" class="btn" type="button" style="display:none;">Download Results (PDF)</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* ========= Config ========= */
  const defaultConfig = {
    page_title: "Harvest Cost Calculator",
    vegetative_label: "Vegetative Cost",
    flowering_label: "Flowering Cost",
    harvest_weight_label: "Harvest Weight (g)",
    calculate_button_text: "Calculate",
    download_button_text: "Download Results (PDF)"
  };

  /* ========= State ========= */
  let vegetativeWeeks = [];
  let floweringWeeks = [];
  let weekCounter = 0;
  let calculationResults = null;
  const BRIDGE_STORAGE_KEY = 'hoCalcBridge';

  const $ = (id)=>document.getElementById(id);

  /* ========= UI Helpers (shared patterns) ========= */
  function makeSection(title, icon){
    const sec = document.createElement('div');
    sec.className = 'sec-card';
    const head = document.createElement('div');
    head.className = 'sec-head';
    head.innerHTML = `<span class="icon" aria-hidden="true">${icon||'üìä'}</span><span>${title}</span>`;
    const stats = document.createElement('div');
    stats.className = 'stats';
    sec.append(head, stats);
    return {sec, stats};
  }
  function statTile(label, value){
    const d = document.createElement('div'); d.className='stat';
    d.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return d;
  }
  function formatMoney(v, round=true){
    if(!Number.isFinite(v)) return '$0.00';
    const n = round ? v.toFixed(2) : (v.toFixed(6).replace(/\.?0+$/,''));
    return '$' + (round ? n : (n.includes('.') ? (n.split('.')[1].length<2? Number(v).toFixed(2): n) : (n + '.00')));
  }

  function loadBridgePrefills(){
    const defaults = { nutrient:null, water:null, electricity:null, hasValues:false };
    try{
      if(typeof window === 'undefined' || !window.localStorage) return defaults;
      const stored = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      ['nutrient','water','electricity'].forEach(key=>{
        const v = Number(stored?.[key]?.weeklyCost);
        if(Number.isFinite(v)) defaults[key] = v;
      });
      defaults.hasValues = ['nutrient','water','electricity'].some(key=>Number.isFinite(defaults[key]));
    }catch(err){
      console.warn('Hydro Oasis bridge read skipped:', err);
    }
    return defaults;
  }

  function getWeekDefaults(){
    const prefills = loadBridgePrefills();
    if(!prefills.hasValues) return null;
    return {
      nutrient: Number.isFinite(prefills.nutrient) ? prefills.nutrient : 0,
      water: Number.isFinite(prefills.water) ? prefills.water : 0,
      electricity: Number.isFinite(prefills.electricity) ? prefills.electricity : 0
    };
  }

  function updatePrefillNotice(){
    const banner = $('prefill-notice');
    if(!banner) return;
    const prefills = loadBridgePrefills();
    if(!prefills.hasValues){
      banner.style.display = 'none';
      banner.textContent = '';
      return;
    }
    const parts = [];
    if(Number.isFinite(prefills.nutrient)) parts.push(`Nutrients ${formatMoney(prefills.nutrient, true)}`);
    if(Number.isFinite(prefills.water)) parts.push(`Water ${formatMoney(prefills.water, true)}`);
    if(Number.isFinite(prefills.electricity)) parts.push(`Electricity ${formatMoney(prefills.electricity, true)}`);
    banner.innerHTML = `<strong>Auto-filled from saved calculators:</strong> ${parts.join(' ‚Ä¢ ')}<br><span style="font-size:12px;">Re-run the individual calculators to refresh these defaults.</span>`;
    banner.style.display = 'block';
  }

  /* ========= Weeks CRUD ========= */
  function addWeek(section, initialValues){
    const weekId = `week-${weekCounter++}`;
    const defaults = initialValues || getWeekDefaults();
    const weekData = {
      id: weekId,
      nutrient: Number.isFinite(defaults?.nutrient) ? defaults.nutrient : 0,
      water: Number.isFinite(defaults?.water) ? defaults.water : 0,
      electricity: Number.isFinite(defaults?.electricity) ? defaults.electricity : 0
    };

    if(section==='vegetative'){ vegetativeWeeks.push(weekData); renderWeeks('vegetative'); }
    else { floweringWeeks.push(weekData); renderWeeks('flowering'); }
  }

  function removeWeek(section, weekId){
    if(section==='vegetative'){ vegetativeWeeks = vegetativeWeeks.filter(w=>w.id!==weekId); renderWeeks('vegetative'); }
    else { floweringWeeks = floweringWeeks.filter(w=>w.id!==weekId); renderWeeks('flowering'); }
  }

  function updateWeekData(section, weekId, field, value){
    const weeks = (section==='vegetative') ? vegetativeWeeks : floweringWeeks;
    const week = weeks.find(w=>w.id===weekId);
    if(!week) return;
    const num = parseFloat(value);
    if (Number.isFinite(num) && num >= 0) {
      week[field] = num;
    } else if (value === '') {
      // keep empty as NaN to trigger validation
      week[field] = NaN;
    } else {
      week[field] = NaN;
    }
  }

  function renderWeeks(section){
    const container = $(`${section}-weeks`);
    const weeks = (section==='vegetative') ? vegetativeWeeks : floweringWeeks;

    if(weeks.length===0){
      container.innerHTML = `<div class="week-card" style="text-align:center; color:#6B7C77;">No weeks added yet. Click ‚ÄúÔºã Add Week‚Äù.</div>`;
      return;
    }

    container.innerHTML = weeks.map((week, i)=>`
      <div class="week-card">
        <div class="week-head">
          <div class="week-title">${section==='vegetative'?'Veg':'Flower'} ‚Äì Week ${i+1}</div>
          <button class="btn remove" type="button" onclick="removeWeek('${section}','${week.id}')">Remove</button>
        </div>

        <div class="grid g-3">
          <div>
            <label>Nutrient Cost ($)</label>
            <input type="number" class="input" min="0" step="0.01" value="${Number.isFinite(week.nutrient)?week.nutrient:0}"
                   onchange="updateWeekData('${section}','${week.id}','nutrient', this.value)">
          </div>
          <div>
            <label>Water Cost ($)</label>
            <input type="number" class="input" min="0" step="0.01" value="${Number.isFinite(week.water)?week.water:0}"
                   onchange="updateWeekData('${section}','${week.id}','water', this.value)">
          </div>
          <div>
            <label>Electricity Cost ($)</label>
            <input type="number" class="input" min="0" step="0.01" value="${Number.isFinite(week.electricity)?week.electricity:0}"
                   onchange="updateWeekData('${section}','${week.id}','electricity', this.value)">
          </div>
        </div>
      </div>
    `).join('');
  }

  /* ========= Validation & Calculation ========= */
  function validate(){
    const err = $('error-container');
    err.classList.remove('show'); err.textContent='';

    const allWeeks = [...vegetativeWeeks, ...floweringWeeks];
    if(allWeeks.length===0) return "Please add at least one week to calculate costs.";

    const harvestWeight = parseFloat($('harvest-weight').value);
    if(!(harvestWeight>0)) return "Please enter a valid harvest weight (> 0 grams).";

    // All visible fields must be numeric >= 0 (allow 0)
    for(const w of allWeeks){
      const fields = [w.nutrient, w.water, w.electricity];
      if(fields.some(v => !Number.isFinite(v) || v < 0)){
        return "Please enter numbers ‚â• 0 for Nutrient, Water, and Electricity in each week.";
      }
    }
    return null;
  }

  function calculateResults(){
    const err = validate();
    const errBox = $('error-container');
    if(err){
      errBox.textContent = err; errBox.classList.add('show');
      $('results-card').style.display='none';
      $('downloadBtn').style.display='none';
      calculationResults = null;
      return;
    }

    const allWeeks = [...vegetativeWeeks, ...floweringWeeks];
    const harvestWeight = parseFloat($('harvest-weight').value);
    const round = $('round-results').checked;

    let totalNutrient=0, totalWater=0, totalElectricity=0;
    allWeeks.forEach(w=>{
      totalNutrient += w.nutrient||0;
      totalWater    += w.water||0;
      totalElectricity += w.electricity||0;
    });
    const totalCost = totalNutrient + totalWater + totalElectricity;

    const G_PER_OZ = 28.3495, G_PER_LB = 453.592, G_PER_KG = 1000;

    function per(v){ return {
      gram: v/harvestWeight,
      ounce: (v/harvestWeight)*G_PER_OZ,
      pound: (v/harvestWeight)*G_PER_LB,
      kilogram: (v/harvestWeight)*G_PER_KG
    };}

    calculationResults = {
      round,
      parts:{
        nutrient: per(totalNutrient),
        water: per(totalWater),
        electricity: per(totalElectricity),
        total: per(totalCost)
      },
      totals:{ totalNutrient, totalWater, totalElectricity, totalCost },
      harvestWeight
    };

    renderResults();
    $('results-card').style.display='block';
    $('downloadBtn').style.display='inline-block';
  }

  /* ========= Render results in Hydro Oasis tiles ========= */
  function addCostSection(root, title, icon, data, round){
    const sec = makeSection(title, icon);
    sec.stats.appendChild(statTile('Per Gram',     formatMoney(data.gram, round)));
    sec.stats.appendChild(statTile('Per Ounce',    formatMoney(data.ounce, round)));
    sec.stats.appendChild(statTile('Per Pound',    formatMoney(data.pound, round)));
    sec.stats.appendChild(statTile('Per Kilogram', formatMoney(data.kilogram, round)));
    root.appendChild(sec.sec);
  }

  function renderResults(){
    const root = $('results-container');
    root.innerHTML = '';
    const R = calculationResults.round;
    const P = calculationResults.parts;

    // Absolute totals (renamed to Total Cost)
    const abs = makeSection('Total Cost', 'üíµ');
    abs.stats.appendChild(statTile('Nutrients', formatMoney(calculationResults.totals.totalNutrient, R)));
    abs.stats.appendChild(statTile('Water',     formatMoney(calculationResults.totals.totalWater, R)));
    abs.stats.appendChild(statTile('Electricity', formatMoney(calculationResults.totals.totalElectricity, R)));
    abs.stats.appendChild(statTile('All Inputs',  formatMoney(calculationResults.totals.totalCost, R)));
    root.appendChild(abs.sec);

    // Per-weight sections (no "per Unit Weight" wording)
    addCostSection(root, 'Nutrient Cost', 'üß™', P.nutrient, R);
    addCostSection(root, 'Water Cost', 'üíß', P.water, R);
    addCostSection(root, 'Electricity Cost', '‚ö°', P.electricity, R);
    addCostSection(root, 'Total Cost (per weight)', 'üìà', P.total, R);
  }

  /* ========= PDF ========= */
  function downloadPDF(){
    if(!calculationResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const R = calculationResults.round;
    let y = 30, line = 8, margin = 18, pageH = doc.internal.pageSize.height;
    const check = need => { if(y+need > pageH - margin){ doc.addPage(); y = 30; } };

    // Title
    const title = ($('page-title')?.textContent) || defaultConfig.page_title;
    doc.setFont('helvetica','bold'); doc.setFontSize(22);
    const w = doc.getTextWidth(title);
    doc.text(title, (doc.internal.pageSize.width - w)/2, y); y += 16;

    // Harvest info
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Harvest Output', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Harvest Weight: ${calculationResults.harvestWeight} g`, margin, y); y += 12;

    // Absolute totals
    check(40);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Total Cost', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Nutrients: ${formatMoney(calculationResults.totals.totalNutrient, R)}`, margin, y); y += line;
    doc.text(`Water: ${formatMoney(calculationResults.totals.totalWater, R)}`, margin, y); y += line;
    doc.text(`Electricity: ${formatMoney(calculationResults.totals.totalElectricity, R)}`, margin, y); y += line;
    doc.text(`All Inputs: ${formatMoney(calculationResults.totals.totalCost, R)}`, margin, y); y += 12;

    // Helper
    function writeSection(h, p){
      check(50);
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text(h, margin, y); y += 10;
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      doc.text(`Per Gram: ${formatMoney(p.gram, R)}`, margin, y); y += line;
      doc.text(`Per Ounce: ${formatMoney(p.ounce, R)}`, margin, y); y += line;
      doc.text(`Per Pound: ${formatMoney(p.pound, R)}`, margin, y); y += line;
      doc.text(`Per Kilogram: ${formatMoney(p.kilogram, R)}`, margin, y); y += 12;
    }

    writeSection('Nutrient Cost', calculationResults.parts.nutrient);
    writeSection('Water Cost', calculationResults.parts.water);
    writeSection('Electricity Cost', calculationResults.parts.electricity);
    writeSection('Total Cost (per weight)', calculationResults.parts.total);

    doc.save('HarvestCostCalculatorResults.pdf');
  }

  /* ========= elementSdk wiring ========= */
  function onConfigChange(cfg){
    $('page-title').textContent = cfg.page_title || defaultConfig.page_title;
    $('vegetative-label').textContent = cfg.vegetative_label || defaultConfig.vegetative_label;
    $('flowering-label').textContent  = cfg.flowering_label  || defaultConfig.flowering_label;
    $('harvest-weight-label').textContent = cfg.harvest_weight_label || defaultConfig.harvest_weight_label;
    $('calculate-button').textContent = cfg.calculate_button_text || defaultConfig.calculate_button_text;
    const dl = $('downloadBtn'); if(dl) dl.textContent = cfg.download_button_text || defaultConfig.download_button_text;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // SDK init (safe & consistent with other calcs)
    try{
      if (window.elementSdk && typeof window.elementSdk.init === 'function') {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToEditPanelValues: (cfg)=>new Map([
            ["page_title", cfg.page_title || defaultConfig.page_title],
            ["vegetative_label", cfg.vegetative_label || defaultConfig.vegetative_label],
            ["flowering_label", cfg.flowering_label || defaultConfig.flowering_label],
            ["harvest_weight_label", cfg.harvest_weight_label || defaultConfig.harvest_weight_label],
            ["calculate_button_text", cfg.calculate_button_text || defaultConfig.calculate_button_text],
            ["download_button_text", cfg.download_button_text || defaultConfig.download_button_text]
          ])
        });
      }
    }catch(e){ console.warn('Element SDK init skipped:', e); }

    updatePrefillNotice();
    const prefills = loadBridgePrefills();
    if(prefills.hasValues){
      addWeek('vegetative');
      addWeek('flowering');
    }else{
      renderWeeks('vegetative');
      renderWeeks('flowering');
    }

    // Wire PDF
    $('downloadBtn').addEventListener('click', downloadPDF);

    // Enter key ‚Üí calculate
    ['harvest-weight'].forEach(id=>{
      $(id).addEventListener('keypress', e=>{ if(e.key==='Enter') calculateResults(); });
    });
  });
</script>
<div id="ho-watermark">Hydro Oasis ‚Ä¢ Harvest Cost Calculator</div>
</body>
</html>