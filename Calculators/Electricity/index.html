<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Electricity Cost Calculator</title>
  <link rel="stylesheet" href="../../shared/styles/calculators.css">

  <!-- SDKs -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



</head>
<body>
<div id="ecalc">
  <div class="container">
    <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="">
    <div class="header">
      <h1 id="app-title">Electricity Cost Calculator</h1>
      <p class="subtitle">Calculate your energy usage and cost breakdown</p>
    </div>

    <div id="electricSavedWeeks" class="saved-weeks-widget" style="display:none;">
      <div class="widget-title">ðŸ“˜ Saved Weeks for Harvest</div>
      <div id="electricSavedWeeksList"></div>
    </div>

    <!-- ========== Rate Configuration ========== -->
    <div class="section">
      <h2 class="section-title">âš¡ Rate Configuration</h2>
      <p class="muted" id="tariff-meta-line" style="margin-bottom:8px;display:none;"></p>

      <div class="form-grid" id="rate-grid">
        <div class="form-group">
          <label for="on-peak-rate">On-Peak Rate (c/kWh)</label>
          <input type="number" id="on-peak-rate" min="0" step="0.0001" value="25.5" placeholder="e.g. 38.52">
        </div>
        <div class="form-group">
          <label for="off-peak-rate">Off-Peak Rate (c/kWh)</label>
          <input type="number" id="off-peak-rate" min="0" step="0.0001" value="15.2" placeholder="e.g. 19.26">
        </div>
        <!-- Shoulder rate slot injected when enabled -->
      </div>

      <div class="toggles-row">
        <div class="toggle-container">
          <span>Round to 2 decimals</span>
          <div class="toggle active" id="rounding-toggle"><div class="toggle-slider"></div></div>
        </div>

        <div class="toggle-container" title="Enable a Shoulder period with its own rate and schedule">
          <span>Enable Shoulder</span>
          <div class="toggle" id="shoulder-toggle"><div class="toggle-slider"></div></div>
        </div>
      </div>

      <button class="btn btn-secondary" id="fetch-tariffs-btn" style="margin-top:16px;">ðŸ“‹ Select Tariff</button>
      <span id="selected-plan-title" class="muted" style="margin-left:10px;display:none;"></span>
    </div>

    <!-- ========== Tariff Schedule ========== -->
    <div class="section" id="tariff-schedule">
      <h2 class="section-title" id="tariff-schedule-title">ðŸ“… Tariff Schedule</h2>

      <!-- ON-PEAK -->
      <div class="tariff-type" data-type="on-peak" id="on-peak-block">
        <h3 id="on-peak-heading" style="color:#dc2626;margin-bottom:16px;">On-Peak Times</h3>

        <div class="tariff-groups" id="on-peak-groups">
          <div class="day-range-group">
            <div class="days-row">
              <div class="days-selector">
                <button class="day-btn active" data-day="1">Mon</button>
                <button class="day-btn active" data-day="2">Tue</button>
                <button class="day-btn active" data-day="3">Wed</button>
                <button class="day-btn active" data-day="4">Thu</button>
                <button class="day-btn active" data-day="5">Fri</button>
                <button class="day-btn" data-day="6">Sat</button>
                <button class="day-btn" data-day="0">Sun</button>
              </div>
              <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
            </div>

            <div class="tariff-ranges">
              <div class="time-range">
                <div class="time-row">
                  <input type="time" class="time-input" value="15:00">
                  <span>to</span>
                  <input type="time" class="time-input" value="21:00">
                  <!-- HOA All-Day toggle -->
                  <div class="toggle-container" style="margin-left:auto;">
                    <span>All Day</span>
                    <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
                  </div>
                  <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
                </div>
              </div>
            </div>

            <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
              <button class="btn btn-secondary outline" onclick="addDayRange('on-peak-groups')">+ Add Day Range</button>
            </div>
          </div>
        </div>
      </div>

      <!-- OFF-PEAK -->
      <div class="tariff-type" data-type="off-peak" id="off-peak-block" style="margin-top:24px;">
        <h3 id="off-peak-heading" style="color:#059669;margin-bottom:16px;">Off-Peak Times</h3>

        <div class="tariff-groups" id="off-peak-groups">
          <div class="day-range-group">
            <div class="days-row">
              <div class="days-selector">
                <button class="day-btn active" data-day="1">Mon</button>
                <button class="day-btn active" data-day="2">Tue</button>
                <button class="day-btn active" data-day="3">Wed</button>
                <button class="day-btn active" data-day="4">Thu</button>
                <button class="day-btn active" data-day="5">Fri</button>
                <button class="day-btn active" data-day="6">Sat</button>
                <button class="day-btn active" data-day="0">Sun</button>
              </div>
              <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
            </div>

            <div class="tariff-ranges">
              <div class="time-range">
                <div class="time-row">
                  <input type="time" class="time-input" value="21:00">
                  <span>to</span>
                  <input type="time" class="time-input" value="15:00">
                  <div class="toggle-container" style="margin-left:auto;">
                    <span>All Day</span>
                    <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
                  </div>
                  <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
                </div>
              </div>
            </div>

            <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
              <button class="btn btn-secondary outline" onclick="addDayRange('off-peak-groups')">+ Add Day Range</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SHOULDER dynamically injected -->
    </div>

    <div id="tariff-errors"></div>

    <!-- ========== Equipment ========== -->
    <div class="section">
      <h2 class="section-title">ðŸ”Œ Equipment</h2>

      <div id="equipment-list"></div>
      <div id="equipment-errors"></div>

      <button class="btn btn-primary" id="add-equipment-btn" style="display:block;margin:16px auto 0;">
        + Add Equipment
      </button>
    </div>

    <!-- Calculate (sticky on mobile) -->
    <div class="cta-row" style="text-align:center;margin:24px 0 8px;">
      <button class="btn btn-success" id="calculate-btn" style="font-size:18px;padding:16px 32px;max-width:680px; width:100%;">ðŸ§® Calculate Costs</button>
    </div>

    <!-- Results -->
    <div id="results-container" style="display:none;"></div>

    <div id="electricWeekPanel" class="section" style="display:none; margin-top:16px;">
      <h2 class="section-title">ðŸŒ± Save Week for Harvest</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="electricWeekStage">Stage</label>
          <select id="electricWeekStage" class="input">
            <option value="vegetative">Vegetative</option>
            <option value="flowering">Generative (Flowering)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="electricWeekNumber">Week Number</label>
          <input type="number" id="electricWeekNumber" class="input" min="1" step="1" placeholder="e.g., 4">
          <p class="muted" style="margin-top:4px;">Match the veg/flower week you plan to prefill in Harvest.</p>
        </div>
        <div class="form-group" style="align-self:flex-end;">
          <button class="btn btn-primary" type="button" id="electricWeekSaveBtn">Save Week for Harvest</button>
          <p id="electricWeekStatus" class="muted" style="margin-top:6px;"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tariff Modal -->
  <div class="modal" id="tariff-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Select Tariff</h3>
        <button class="close-btn" onclick="closeTariffModal()">Ã—</button>
      </div>

      <div class="form-group" style="margin-bottom:10px;">
        <label for="retailer-select">Retailer</label>
        <select id="retailer-select"><option value="">Select Retailer</option></select>
      </div>

      <div class="form-group" style="margin-bottom:10px;">
        <label for="plan-select">Plan</label>
        <select id="plan-select"><option value="">Select Plan</option></select>
      </div>

      <div class="form-group" style="margin-bottom:10px;">
        <label for="region-select">State/Network</label>
        <select id="region-select"><option value="">Select Region</option></select>
      </div>

      <div style="display:flex;gap:12px;margin-top:18px;flex-wrap:wrap;">
        <button class="btn btn-primary" style="flex:1 1 180px;" onclick="applySelectedTariff()">Apply Selected Plan</button>
        <button class="btn" style="flex:1 1 120px;" onclick="closeTariffModal()">Close</button>
      </div>

      <div id="fetch-status" style="margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- (Cloudflare anti-bot iframe preserved) -->
<script>
(function(){
  function c(){
    var b=a.contentDocument||a.contentWindow.document;
    if(b){
      var d=b.createElement('script');
      d.innerHTML="window.__CF$cv$params={r:'99881531a63cf0c8',t:'MTc2MjEzMzE3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
      b.getElementsByTagName('head')[0].appendChild(d)
    }
  }
  if(document.body){
    var a=document.createElement('iframe');
    a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';
    document.body.appendChild(a);
    if('loading'!==document.readyState) c();
    else if(window.addEventListener) document.addEventListener('DOMContentLoaded',c);
    else{
      var e=document.onreadystatechange||function(){};
      document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}
    }
  }
})();
</script>

<div id="ho-watermark">Hydro Oasis â€¢ Electricity Cost Calculator</div>

<script>
/* ========= Config ========= */
const defaultConfig = { app_title: "Electricity Cost Calculator", footer_text: "Hydro Oasis â€¢ Electricity Cost Calculator" };
let roundingEnabled = true;
let shoulderEnabled = false;

const BRIDGE_STORAGE_KEY = 'hoCalcBridge';
const ELECTRIC_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering (Generative)' };
const SAVED_WEEK_CALC_LABELS = { nutrient: 'Nutrients', water: 'Water', electricity: 'Electricity' };
const SAVED_WEEK_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering' };
function saveBridgeData(calculator, payload){
  try{
    if(typeof window === 'undefined' || !window.localStorage) return;
    const existing = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    existing[calculator] = { ...payload, updatedAt: Date.now() };
    window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(existing));
  }catch(err){
    console.warn('Hydro Oasis bridge save skipped:', err);
  }
}

function electricNormalizeStage(stage){
  return (stage === 'flowering' || stage === 'generative') ? 'flowering' : 'vegetative';
}
function electricStageLabel(stage){
  return ELECTRIC_STAGE_LABELS[electricNormalizeStage(stage)] || ELECTRIC_STAGE_LABELS.vegetative;
}
function saveElectricWeekSnapshot(stage, weekNumber, weeklyCost){
  if(!(weekNumber > 0) || !Number.isFinite(weeklyCost)) return false;
  try{
    if(typeof window === 'undefined' || !window.localStorage) return false;
    const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    if(!data.stageWeeks) data.stageWeeks = { vegetative:{}, flowering:{} };
    const normalizedStage = electricNormalizeStage(stage);
    if(!data.stageWeeks[normalizedStage]) data.stageWeeks[normalizedStage] = {};
    const weekKey = String(weekNumber);
    const existingWeek = data.stageWeeks[normalizedStage][weekKey] || {};
    existingWeek.electricity = { weeklyCost, updatedAt: Date.now() };
    data.stageWeeks[normalizedStage][weekKey] = existingWeek;
    window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(data));
    return true;
  }catch(err){
    console.warn('Hydro Oasis week save skipped:', err);
    return false;
  }
}

function getSavedWeeksSummary(){
  const empty = { vegetative: [], flowering: [], totalCount: 0 };
  try{
    if(typeof window === 'undefined' || !window.localStorage) return empty;
    const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    const stageWeeks = data?.stageWeeks || {};
    const parseStage = (stageKey)=>{
      const stageData = stageWeeks[stageKey] || {};
      return Object.keys(stageData).map(weekKey=>{
        const weekNumber = parseInt(weekKey, 10);
        if(!Number.isFinite(weekNumber)) return null;
        const entry = stageData[weekKey] || {};
        const calculators = Object.entries(SAVED_WEEK_CALC_LABELS).reduce((list,[calcKey,label])=>{
          const value = Number(entry?.[calcKey]?.weeklyCost);
          if(Number.isFinite(value)) list.push(label);
          return list;
        }, []);
        if(calculators.length === 0) return null;
        return { weekNumber, calculators };
      }).filter(Boolean).sort((a,b)=>a.weekNumber - b.weekNumber);
    };
    const vegetative = parseStage('vegetative');
    const flowering = parseStage('flowering');
    return { vegetative, flowering, totalCount: vegetative.length + flowering.length };
  }catch(err){
    console.warn('Hydro Oasis saved weeks read skipped:', err);
    return empty;
  }
}

function updateElectricSavedWeeksWidget(){
  const widget = document.getElementById('electricSavedWeeks');
  const body = document.getElementById('electricSavedWeeksList');
  if(!widget || !body) return;
  const summary = getSavedWeeksSummary();
  widget.style.display = 'block';
  if(summary.totalCount === 0){
    body.innerHTML = '<div class="sw-empty">No weeks saved yet. Save a week after running the Nutrient, Water, or Electricity calculators.</div>';
    return;
  }
  const sections = [];
  ['vegetative','flowering'].forEach(stage=>{
    if(summary[stage].length){
      const label = SAVED_WEEK_STAGE_LABELS[stage] || stage;
      const rows = summary[stage].map(week=>{
        const calcList = week.calculators.join(', ');
        return `<li><span class="sw-week">Week ${week.weekNumber}</span><span class="sw-meta">${calcList}</span></li>`;
      }).join('');
      sections.push(`<div class="sw-stage"><div class="sw-stage-label">${label}</div><ul>${rows}</ul></div>`);
    }
  });
  body.innerHTML = sections.join('');
}

let latestElectricWeekTotal = null;
function resetElectricWeekPanel(){
  const panel = document.getElementById('electricWeekPanel');
  if(panel) panel.style.display = 'none';
  const status = document.getElementById('electricWeekStatus');
  if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
}
function showElectricWeekPanel(){
  const panel = document.getElementById('electricWeekPanel');
  if(panel) panel.style.display = 'block';
  const status = document.getElementById('electricWeekStatus');
  if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
}
function handleElectricWeekSave(){
  const status = document.getElementById('electricWeekStatus');
  if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
  if(!Number.isFinite(latestElectricWeekTotal)){
    if(status){ status.textContent = 'Calculate your electricity costs first.'; status.style.color = '#b91c1c'; }
    return;
  }
  const stage = document.getElementById('electricWeekStage')?.value || 'vegetative';
  const weekNumber = parseInt(document.getElementById('electricWeekNumber')?.value, 10);
  if(!(weekNumber > 0)){
    if(status){ status.textContent = 'Enter a valid week number (1 or higher).'; status.style.color = '#b91c1c'; }
    return;
  }
  const ok = saveElectricWeekSnapshot(stage, weekNumber, latestElectricWeekTotal);
  if(status){
    if(ok){
      status.textContent = `Saved ${electricStageLabel(stage)} week ${weekNumber} for Harvest.`;
      status.style.color = '#1f7a54';
      updateElectricSavedWeeksWidget();
    }else{
      status.textContent = 'Unable to save this week. Please try again.';
      status.style.color = '#b91c1c';
    }
  }
}

/* ========= External tariffs ========= */
const TARIFFS_URL = "https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Electricity_Tariffs.json?v=1763176275";
let tariffsData = null;
const regionLabels = { vic:"VIC", tas:"TAS", citipower:"VIC â€“ CitiPower", powercor:"VIC â€“ Powercor", jemena:"VIC â€“ Jemena", ausnet:"VIC â€“ AusNet", united:"VIC â€“ United Energy" };

function validateTariffsSchema(json){
  if (!json || typeof json !== "object") throw new Error("Top-level JSON must be an object.");
  if (!json.retailers || typeof json.retailers !== "object") throw new Error("Invalid JSON structure: expected { retailers: { ... } }");
  Object.entries(json.retailers).forEach(([key, retailer])=>{
    if (!retailer.displayName) throw new Error(`Retailer "${key}" missing displayName`);
    if (!retailer.plans || typeof retailer.plans !== "object") throw new Error(`Retailer "${key}" missing plans`);
    Object.entries(retailer.plans).forEach(([pid, plan])=>{
      if (!plan.title) throw new Error(`Plan "${pid}" missing title`);
      if (!plan.byRegion || typeof plan.byRegion !== "object") throw new Error(`Plan "${pid}" missing byRegion`);
      Object.entries(plan.byRegion).forEach(([rid, rates])=>{
        if (typeof rates.on !== "number" || typeof rates.off !== "number") throw new Error(`Plan "${pid}" region "${rid}" rates must have numeric "on" and "off"`);
        if (rates.shoulder != null && typeof rates.shoulder !== "number") throw new Error(`Plan "${pid}" region "${rid}" "shoulder" must be numeric when provided`);
      });
      if (!plan.windows || typeof plan.windows !== "object") throw new Error(`Plan "${pid}" missing windows`);
      ["on","off"].forEach(bucket=>{
        if (!Array.isArray(plan.windows[bucket])) throw new Error(`Plan "${pid}" windows.${bucket} must be an array`);
        plan.windows[bucket].forEach((w,i)=>{
          if (!w.start || !w.end || !Array.isArray(w.days)) throw new Error(`Plan "${pid}" windows.${bucket}[${i}] must have start, end, days[]`);
        });
      });
      if (plan.windows.shoulder){
        if (!Array.isArray(plan.windows.shoulder)) throw new Error(`Plan "${pid}" windows.shoulder must be an array`);
        plan.windows.shoulder.forEach((w,i)=>{
          if (!w.start || !w.end || !Array.isArray(w.days)) throw new Error(`Plan "${pid}" windows.shoulder[${i}] must have start, end, days[]`);
        });
      }
    });
  });
}

async function fetchTariffsOnce(){
  if (tariffsData) return tariffsData;
  const status = document.getElementById("fetch-status");
  try{
    if (status) status.innerHTML = "Loading tariffsâ€¦";
    const res = await fetch(TARIFFS_URL, { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    validateTariffsSchema(json);
    tariffsData = json;
    if (status) status.innerHTML = "<span style='color:#10b981;'>Tariffs loaded.</span>";
    return tariffsData;
  }catch(err){
    if (status) status.innerHTML = `<div class="error-message">Failed to load tariffs file at ${TARIFFS_URL}: ${err.message}</div>`;
    throw err;
  }
}

/* ========= SDK init ========= */
function initSDK(){
  if (window.elementSdk){
    window.elementSdk.init({
      defaultConfig,
      onConfigChange:(config)=>{
        const t=document.getElementById('app-title');
        if (t) t.textContent = config.app_title || defaultConfig.app_title;
      }
    });
  }
}

/* ========= Shoulder UI ========= */
function addShoulderRateInput(){
  if (document.getElementById('shoulder-rate')) return;
  const grid=document.getElementById('rate-grid');
  const div=document.createElement('div');
  div.className='form-group';
  div.innerHTML = `
    <label for="shoulder-rate">Shoulder Rate (c/kWh)</label>
    <input type="number" id="shoulder-rate" min="0" step="0.0001" value="28" placeholder="e.g. 30.00">
  `;
  grid.appendChild(div);
}
function removeShoulderRateInput(){
  const el=document.getElementById('shoulder-rate');
  if (el) el.closest('.form-group').remove();
}

function addShoulderSection(){
  if (document.getElementById('shoulder-block')) return;

  let schedule = document.getElementById('tariff-schedule');
  if (!schedule) {
    const titleEl = document.getElementById('tariff-schedule-title');
    schedule = titleEl ? titleEl.closest('.section') : null;
  }
  if (!schedule) return;

  const block = document.createElement('div');
  block.className = 'tariff-type';
  block.dataset.type = 'shoulder';
  block.id = 'shoulder-block';
  block.style.marginTop = '24px';
  block.innerHTML = `
    <h3 id="shoulder-heading" style="color:#d97706;margin-bottom:16px;">Shoulder Times</h3>
    <div class="tariff-groups" id="shoulder-groups">
      <div class="day-range-group">
        <div class="days-row">
          <div class="days-selector">
            <button class="day-btn active" data-day="1">Mon</button>
            <button class="day-btn active" data-day="2">Tue</button>
            <button class="day-btn active" data-day="3">Wed</button>
            <button class="day-btn active" data-day="4">Thu</button>
            <button class="day-btn active" data-day="5">Fri</button>
            <button class="day-btn" data-day="6">Sat</button>
            <button class="day-btn" data-day="0">Sun</button>
          </div>
          <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
        </div>
        <div class="tariff-ranges"></div>
        <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
          <button class="btn btn-secondary outline" onclick="addDayRange('shoulder-groups')">+ Add Day Range</button>
        </div>
      </div>
    </div>`;
  schedule.appendChild(block);
  activateDayToggles(block);
  refreshGroupButtons(block.querySelector('#shoulder-groups'));
}
function removeShoulderSection(){
  const block=document.getElementById('shoulder-block');
  if (block) block.remove();
}
function setShoulderUI(active){
  shoulderEnabled = !!active;
  const shToggle=document.getElementById('shoulder-toggle');
  if (shToggle) shToggle.classList.toggle('active', shoulderEnabled);
  if (shoulderEnabled){ addShoulderRateInput(); addShoulderSection(); }
  else { removeShoulderRateInput(); removeShoulderSection(); }
}

/* ========= Day toggles ========= */
function activateDayToggles(scope=document){
  scope.querySelectorAll('.day-btn').forEach(btn=>{
    btn.addEventListener('click', function(){ this.classList.toggle('active'); });
  });
}

/* All-day helpers */
function isAllDayRange(start, end){ return (start === '00:00' && (end === '23:59' || end === '00:00')); }
function bindAllDayToggle(toggleEl){
  const tr = toggleEl.closest('.time-range');
  const [startEl, endEl] = tr.querySelectorAll('.time-input');

  const setState = (on) => {
    toggleEl.classList.toggle('active', on);
    if (on){
      startEl.value = '00:00';
      endEl.value   = '00:00';
      startEl.disabled = true;
      endEl.disabled   = true;
      tr.dataset.allDay = '1';
    }else{
      startEl.disabled = false;
      endEl.disabled   = false;
      tr.dataset.allDay = '';
    }
  };

  const initiallyAllDay = isAllDayRange(startEl.value, endEl.value) || tr.dataset.allDay === '1';
  setState(initiallyAllDay);

  toggleEl.addEventListener('click', () => {
    const nowOn = !toggleEl.classList.contains('active');
    setState(nowOn);
  });
}
function wireAllDayToggles(scope){ scope.querySelectorAll('.time-range .all-day-toggle').forEach(bindAllDayToggle); }

/* Show/hide X only if >1 time range */
function updateTimeRangeXs(container){
  container.querySelectorAll('.tariff-ranges, .equipment-ranges').forEach(ranges=>{
    const rows = ranges.querySelectorAll('.time-range .tr-remove');
    const show = (ranges.querySelectorAll('.time-range').length > 1);
    rows.forEach(btn => btn.style.display = show ? 'inline-flex' : 'none');
  });
}

/* ========= Tariff Day Range Groups ========= */
function addTimeRangeToGroup(btnOrGroup){
  const group = btnOrGroup.closest ? btnOrGroup.closest('.day-range-group') : btnOrGroup;
  const ranges = group.querySelector('.tariff-ranges');
  const d = document.createElement('div');
  d.className = 'time-range';
  d.innerHTML = `
    <div class="time-row">
      <input type="time" class="time-input" value="09:00">
      <span>to</span>
      <input type="time" class="time-input" value="17:00">
      <div class="toggle-container" style="margin-left:auto;">
        <span>All Day</span>
        <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
      </div>
      <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
    </div>`;
  ranges.appendChild(d);
  wireAllDayToggles(d);
  updateTimeRangeXs(group);
}
function removeTimeRange(btn){
  const group = btn.closest('.day-range-group');
  btn.closest('.time-range').remove();
  updateTimeRangeXs(group);
}
function addDayRange(groupsId){
  const container=document.getElementById(groupsId);
  const group=document.createElement('div');
  group.className='day-range-group';
  group.innerHTML=`
    <div class="days-row">
      <div class="days-selector">
        <button class="day-btn active" data-day="1">Mon</button>
        <button class="day-btn active" data-day="2">Tue</button>
        <button class="day-btn active" data-day="3">Wed</button>
        <button class="day-btn active" data-day="4">Thu</button>
        <button class="day-btn active" data-day="5">Fri</button>
        <button class="day-btn" data-day="6">Sat</button>
        <button class="day-btn" data-day="0">Sun</button>
      </div>
      <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
    </div>
    <div class="tariff-ranges"></div>
    <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
      <button class="btn btn-secondary outline" onclick="addDayRange('${groupsId}')">+ Add Day Range</button>
    </div>`;
  container.appendChild(group);
  activateDayToggles(group);
  addTimeRangeToGroup(group);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}
function removeDayRange(xBtn){
  const group=xBtn.closest('.day-range-group');
  const container=group.parentElement;
  group.remove();
  if (!container.querySelector('.day-range-group')) addDayRange(container.id);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}
function refreshGroupButtons(container){
  const groups=[...container.querySelectorAll('.day-range-group')];
  groups.forEach((g,i)=>{
    const addDayBtn=g.querySelector('.group-actions .btn.outline');
    const removeX=g.querySelector('.remove-day-group');
    if (addDayBtn) addDayBtn.style.display=(i===groups.length-1)?'inline-block':'none';
    if (removeX) removeX.style.visibility = (groups.length>1)?'visible':'hidden';
  });
}

/* ========= Equipment numbering helpers ========= */
function getUsedEquipmentIndices(){
  return Array.from(document.querySelectorAll('.equipment-card'))
    .map(c => parseInt(c.dataset.index,10))
    .filter(n => Number.isInteger(n));
}
function getNextEquipmentIndex(){
  const used = new Set(getUsedEquipmentIndices());
  let i = 1; while (used.has(i)) i++; return i;
}

/* ========= Equipment blocks ========= */
function addEquipment(){
  const list = document.getElementById('equipment-list');
  const index = getNextEquipmentIndex();
  const gid = `equip-${index}-groups`;
  const card=document.createElement('div');
  card.className='equipment-card';
  card.dataset.index = String(index);
  const defaultName = `Equipment ${index}`;
  card.innerHTML=`
    <button class="remove-btn btn-x" onclick="removeEquipment(${index})" title="Remove equipment">Ã—</button>
    <div class="equipment-header">
      <div class="equipment-title" id="equip-title-${index}">${defaultName}</div>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>Equipment Name</label>
        <input type="text" class="equipment-name" placeholder="e.g., Air Conditioner" value="${defaultName}">
      </div>
      <div class="form-group">
        <label>Power (W)</label>
        <input type="number" class="equipment-power" min="0" step="0.1" placeholder="1500" value="1500">
      </div>
    </div>

    <h4 style="margin:20px 0 12px 0; color:#4f46e5;">Operating Schedule</h4>

    <div class="equipment-groups" id="${gid}">
      <div class="day-range-group">
        <div class="days-row">
          <div class="days-selector">
            <button class="day-btn active" data-day="1">Mon</button>
            <button class="day-btn active" data-day="2">Tue</button>
            <button class="day-btn active" data-day="3">Wed</button>
            <button class="day-btn active" data-day="4">Thu</button>
            <button class="day-btn active" data-day="5">Fri</button>
            <button class="day-btn" data-day="6">Sat</button>
            <button class="day-btn" data-day="0">Sun</button>
          </div>
          <button class="remove-day-group" onclick="removeEquipDayRange(this)" title="Remove day range">Ã—</button>
        </div>

        <div class="equipment-ranges">
          <div class="time-range">
            <div class="time-row">
              <input type="time" class="time-input" value="09:00"><span>to</span>
              <input type="time" class="time-input" value="17:00">
              <div class="toggle-container" style="margin-left:auto;">
                <span>All Day</span>
                <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
              </div>
              <button class="btn-x tr-remove" onclick="removeEquipmentTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
            </div>
          </div>
        </div>

        <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn btn-secondary" onclick="addEquipmentTimeRange(this)">+ Add Time Range</button>
          <button class="btn btn-secondary outline" onclick="addEquipDayRange('${gid}')">+ Add Day Range</button>
        </div>
      </div>
    </div>

    <div class="equipment-results" style="display:none;margin-top:20px;padding:16px;background:#f8fafc;border-radius:8px;">
      <div class="results-grid"></div>
    </div>`;
  list.appendChild(card);
  activateDayToggles(card);
  wireAllDayToggles(card);
  refreshGroupButtons(card.querySelector('#'+gid));
  updateTimeRangeXs(card);

  const nameInput = card.querySelector('.equipment-name');
  const titleEl = card.querySelector(`#equip-title-${index}`);
  nameInput.addEventListener('input', () => {
    titleEl.textContent = nameInput.value.trim() || defaultName;
  });
}
function removeEquipment(index){
  const el = document.querySelector(`.equipment-card[data-index="${index}"]`);
  if (el) el.remove();
}

function addEquipmentTimeRange(btnOrGroup){
  const group=btnOrGroup.closest ? btnOrGroup.closest('.day-range-group') : btnOrGroup;
  const ranges=group.querySelector('.equipment-ranges');
  const d=document.createElement('div');
  d.className='time-range';
  d.innerHTML=`
    <div class="time-row">
      <input type="time" class="time-input" value="09:00"><span>to</span>
      <input type="time" class="time-input" value="17:00">
      <div class="toggle-container" style="margin-left:auto;">
        <span>All Day</span>
        <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
      </div>
      <button class="btn-x tr-remove" onclick="removeEquipmentTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
    </div>`;
  ranges.appendChild(d);
  wireAllDayToggles(d);
  updateTimeRangeXs(group);
}
function removeEquipmentTimeRange(btn){
  const group = btn.closest('.day-range-group');
  btn.parentElement.parentElement.remove();
  updateTimeRangeXs(group);
}
function addEquipDayRange(groupsId){
  const container=document.getElementById(groupsId);
  const group=document.createElement('div');
  group.className='day-range-group';
  group.innerHTML=`
    <div class="days-row">
      <div class="days-selector">
        <button class="day-btn active" data-day="1">Mon</button>
        <button class="day-btn active" data-day="2">Tue</button>
        <button class="day-btn active" data-day="3">Wed</button>
        <button class="day-btn active" data-day="4">Thu</button>
        <button class="day-btn active" data-day="5">Fri</button>
        <button class="day-btn" data-day="6">Sat</button>
        <button class="day-btn" data-day="0">Sun</button>
      </div>
      <button class="remove-day-group" onclick="removeEquipDayRange(this)" title="Remove day range">Ã—</button>
    </div>
    <div class="equipment-ranges"></div>
    <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn btn-secondary" onclick="addEquipmentTimeRange(this)">+ Add Time Range</button>
      <button class="btn btn-secondary outline" onclick="addEquipDayRange('${groupsId}')">+ Add Day Range</button>
    </div>`;
  container.appendChild(group);
  activateDayToggles(group);
  addEquipmentTimeRange(group);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}
function removeEquipDayRange(btn){
  const group=btn.closest('.day-range-group');
  const container=group.parentElement;
  group.remove();
  if (!container.querySelector('.day-range-group')) addEquipDayRange(container.id);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}

/* ========= Calc helpers ========= */
function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
function normalizeTimeRange(s,e){
  const sm=timeToMinutes(s), em=timeToMinutes(e);
  if (sm===0 && em===0) return [{start:0,end:1440}];
  if (sm<=em) return [{start:sm,end:em}];
  return [{start:sm,end:1440},{start:0,end:em}];
}
function mergeOverlapping(ranges){
  if (!ranges.length) return [];
  ranges.sort((a,b)=>a.start-b.start);
  const out=[{...ranges[0]}];
  for (let i=1;i<ranges.length;i++){
    const cur=ranges[i], last=out[out.length-1];
    if (cur.start<=last.end) last.end=Math.max(last.end,cur.end);
    else out.push({...cur});
  }
  return out;
}
function overlapHours(r1,r2){
  let tot=0;
  for (const a of r1) for (const b of r2){
    const st=Math.max(a.start,b.start), en=Math.min(a.end,b.end);
    if (st<en) tot+=en-st;
  }
  return tot/60;
}

/* Build schedules from UI */
function getTariffSchedule(kind){
  const groupsId = (kind==='on-peak') ? 'on-peak-groups' : (kind==='off-peak') ? 'off-peak-groups' : (kind==='shoulder') ? 'shoulder-groups' : null;
  const cont=document.getElementById(groupsId);
  if (!cont) return [];
  const groupEls=[...cont.querySelectorAll('.day-range-group')];
  const out=[];
  groupEls.forEach(g=>{
    const days=[...g.querySelectorAll('.days-selector .day-btn.active')].map(b=>parseInt(b.dataset.day));
    const ranges=[...g.querySelectorAll('.tariff-ranges .time-range')];
    ranges.forEach(r=>{
      const [s,e]=[...r.querySelectorAll('.time-input')].map(i=>i.value);
      if (!s || !e) return;
      out.push({ start:s, end:e, days, allDay:r.dataset.allDay==='1' });
    });
  });
  return out;
}

function formatNumber(n){
  if (roundingEnabled) return Number(n).toFixed(2);
  let f=Number(n).toFixed(6).replace(/\.?0+$/,'');
  if (!f.includes('.')) f+='.00';
  else if (f.split('.')[1].length===1) f+='0';
  return f;
}

function validateInputs(){
  const errs=[];
  const on=parseFloat(document.getElementById('on-peak-rate').value);
  const off=parseFloat(document.getElementById('off-peak-rate').value);
  if (!on || on<=0) errs.push('On-peak rate must be greater than 0');
  if (!off|| off<=0) errs.push('Off-peak rate must be greater than 0');
  if (shoulderEnabled){
    const sh=parseFloat(document.getElementById('shoulder-rate').value);
    if (!sh || sh<=0) errs.push('Shoulder rate must be greater than 0');
    if (!document.getElementById('shoulder-block')) errs.push('Shoulder section missing.');
  }
  const cards=document.querySelectorAll('.equipment-card');
  if (!cards.length) errs.push('At least one equipment must be added');
  cards.forEach((c,idx)=>{
    const p=parseFloat(c.querySelector('.equipment-power').value);
    if (!p || p<=0) errs.push(`Equipment ${idx+1}: Power must be greater than 0`);
    const trs=c.querySelectorAll('.time-range');
    trs.forEach((r,ri)=>{
      const [s,e]=[...r.querySelectorAll('.time-input')].map(i=>i.value);
      if (!s || !e) errs.push(`Equipment ${idx+1}, Range ${ri+1}: Both start and end times required`);
    });
    if (!c.querySelector('.day-btn.active')) errs.push(`Equipment ${idx+1}: At least one day must be selected`);
  });
  return errs;
}

/* ========= Calculation & PDF ========= */
function calculateCosts(){
  const errors=validateInputs();
  document.getElementById('equipment-errors').innerHTML='';
  document.getElementById('tariff-errors').innerHTML='';
  if (errors.length){
    document.getElementById('equipment-errors').innerHTML=errors.map(e=>`<div class="error-message">${e}</div>`).join('');
    document.getElementById('results-container').style.display='none';
    latestElectricWeekTotal = null;
    resetElectricWeekPanel();
    return;
  }

  const onRate=parseFloat(document.getElementById('on-peak-rate').value)/100;
  const offRate=parseFloat(document.getElementById('off-peak-rate').value)/100;
  const shRate=shoulderEnabled ? (parseFloat(document.getElementById('shoulder-rate').value)/100) : 0;

  const onSched=getTariffSchedule('on-peak');
  const offSched=getTariffSchedule('off-peak');
  const shSched=shoulderEnabled ? getTariffSchedule('shoulder') : [];

  let totals={ dailyKwh:0, weeklyKwh:0, monthlyKwh:0, yearlyKwh:0, dailyCost:0, weeklyCost:0, monthlyCost:0, yearlyCost:0, onPeakHours:0, offPeakHours:0, shoulderHours:0 };

  document.querySelectorAll('.equipment-card').forEach(card=>{
    const kW=parseFloat(card.querySelector('.equipment-power').value)/1000;
    let weekOn=0, weekOff=0, weekSh=0;

    const eqGroups=[...card.querySelectorAll('.equipment-groups .day-range-group')];
    eqGroups.forEach(g=>{
      const ranges=[...g.querySelectorAll('.equipment-ranges .time-range')].map(r=>{
        const [s,e]=[...r.querySelectorAll('.time-input')].map(i=>i.value);
        return {start:s,end:e};
      });
      let eqRanges=[];
      ranges.forEach(r=>{ eqRanges = eqRanges.concat(normalizeTimeRange(r.start,r.end)); });
      eqRanges=mergeOverlapping(eqRanges);

      const days=[...g.querySelectorAll('.days-selector .day-btn.active')].map(b=>parseInt(b.dataset.day));
      days.forEach(d=>{
        const dayOn = onSched.filter(x=>x.days.includes(d)).flatMap(x=>normalizeTimeRange(x.start,x.end));
        const dayOff = offSched.filter(x=>x.days.includes(d)).flatMap(x=>normalizeTimeRange(x.start,x.end));
        const daySh = shSched.filter(x=>x.days.includes(d)).flatMap(x=>normalizeTimeRange(x.start,x.end));
        weekOn += overlapHours(eqRanges, mergeOverlapping(dayOn));
        weekOff += overlapHours(eqRanges, mergeOverlapping(dayOff));
        weekSh += overlapHours(eqRanges, mergeOverlapping(daySh));
      });
    });

    const dOn=weekOn/7, dOff=weekOff/7, dSh=weekSh/7;
    const dKwh=kW*(dOn+dOff+dSh);
    const wKwh=kW*(weekOn+weekOff+weekSh);
    const mKwh=wKwh*(365.25/12/7);
    const yKwh=wKwh*(365.25/7);

    const dCost=kW*(dOn*onRate + dOff*offRate + dSh*shRate);
    const wCost=kW*(weekOn*onRate + weekOff*offRate + weekSh*shRate);
    const mCost=wCost*(365.25/12/7);
    const yCost=wCost*(365.25/7);

    const gResults=card.querySelector('.equipment-results .results-grid');
    gResults.innerHTML=`
      <div class="result-item"><div class="result-label">On-Peak Hours/Day</div><div class="result-value">${formatNumber(dOn)}h</div></div>
      ${shoulderEnabled ? `<div class="result-item"><div class="result-label">Shoulder Hours/Day</div><div class="result-value">${formatNumber(dSh)}h</div></div>` : ``}
      <div class="result-item"><div class="result-label">Off-Peak Hours/Day</div><div class="result-value">${formatNumber(dOff)}h</div></div>
      <div class="result-item"><div class="result-label">Daily kWh</div><div class="result-value">${formatNumber(dKwh)}</div></div>
      <div class="result-item"><div class="result-label">Weekly kWh</div><div class="result-value">${formatNumber(wKwh)}</div></div>
      <div class="result-item"><div class="result-label">Monthly kWh</div><div class="result-value">${formatNumber(mKwh)}</div></div>
      <div class="result-item"><div class="result-label">Yearly kWh</div><div class="result-value">${formatNumber(yKwh)}</div></div>
      <div class="result-item"><div class="result-label">Daily Cost</div><div class="result-value">$${formatNumber(dCost)}</div></div>
      <div class="result-item"><div class="result-label">Weekly Cost</div><div class="result-value">$${formatNumber(wCost)}</div></div>
      <div class="result-item"><div class="result-label">Monthly Cost</div><div class="result-value">$${formatNumber(mCost)}</div></div>
      <div class="result-item"><div class="result-label">Yearly Cost</div><div class="result-value">$${formatNumber(yCost)}</div></div>
    `;
    card.querySelector('.equipment-results').style.display='none';

    totals.dailyKwh+=dKwh; totals.weeklyKwh+=wKwh; totals.monthlyKwh+=mKwh; totals.yearlyKwh+=yKwh;
    totals.dailyCost+=dCost; totals.weeklyCost+=wCost; totals.monthlyCost+=mCost; totals.yearlyCost+=yCost;
    totals.onPeakHours+=dOn; totals.offPeakHours+=dOff; totals.shoulderHours+=dSh;
  });

  saveBridgeData('electricity', {
    dailyCost: totals.dailyCost,
    weeklyCost: totals.weeklyCost,
    monthlyCost: totals.monthlyCost,
    yearlyCost: totals.yearlyCost
  });
  latestElectricWeekTotal = totals.weeklyCost;
  showElectricWeekPanel();

  displayTotals(totals);
}

function displayTotals(t){
  const results=document.getElementById('results-container');
  let perEquipHTML='';
  document.querySelectorAll('.equipment-card').forEach((card,idx)=>{
    const name=card.querySelector('.equipment-name').value || `Equipment ${idx+1}`;
    const power=card.querySelector('.equipment-power').value || '?';
    perEquipHTML += `
      <div class="results-section" style="margin-bottom:24px;">
        <h3 class="section-title">ðŸ”Œ ${name} (${power}W)</h3>
        <div class="results-grid">${card.querySelector('.equipment-results .results-grid').innerHTML}</div>
      </div>`;
  });

  results.innerHTML = `
    ${perEquipHTML}
    <div class="results-section">
      <h2 class="section-title">ðŸ“Š Total Usage & Cost Breakdown</h2>
      <div class="results-grid">
        <div class="result-item"><div class="result-label">On-Peak Hours/Day</div><div class="result-value">${formatNumber(t.onPeakHours)}h</div></div>
        ${shoulderEnabled ? `<div class="result-item"><div class="result-label">Shoulder Hours/Day</div><div class="result-value">${formatNumber(t.shoulderHours)}h</div></div>` : ``}
        <div class="result-item"><div class="result-label">Off-Peak Hours/Day</div><div class="result-value">${formatNumber(t.offPeakHours)}h</div></div>
        <div class="result-item"><div class="result-label">Daily kWh</div><div class="result-value">${formatNumber(t.dailyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Weekly kWh</div><div class="result-value">${formatNumber(t.weeklyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Monthly kWh</div><div class="result-value">${formatNumber(t.monthlyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Yearly kWh</div><div class="result-value">${formatNumber(t.yearlyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Daily Cost</div><div class="result-value">$${formatNumber(t.dailyCost)}</div></div>
        <div class="result-item"><div class="result-label">Weekly Cost</div><div class="result-value">$${formatNumber(t.weeklyCost)}</div></div>
        <div class="result-item"><div class="result-label">Monthly Cost</div><div class="result-value">$${formatNumber(t.monthlyCost)}</div></div>
        <div class="result-item"><div class="result-label">Yearly Cost</div><div class="result-value">$${formatNumber(t.yearlyCost)}</div></div>
      </div>
      <div style="text-align:center;margin-top:24px;">
        <button class="btn btn-primary" onclick="downloadPDF()">ðŸ“„ Download Results as PDF</button>
      </div>
    </div>`;
  results.style.display='block';
}

/* ========= PDF ========= */
function downloadPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  let y=20, H=doc.internal.pageSize.height, M=20;
  function br(h){ if (y+h>H-M){ doc.addPage(); y=20; } }

  const title=(window.elementSdk?.config?.app_title)||defaultConfig.app_title;
  doc.setFontSize(20); doc.setFont(undefined,'bold'); doc.text(title,M,y); y+=15;
  doc.setFontSize(12); doc.setFont(undefined,'normal'); doc.text(`Generated: ${new Date().toLocaleDateString()}`,M,y); y+=12;

  br(20);
  doc.setFontSize(16); doc.setFont(undefined,'bold'); doc.text('Tariff Summary',M,y); y+=10;
  const onRate=document.getElementById('on-peak-rate').value;
  const offRate=document.getElementById('off-peak-rate').value;
  const shRateEl=document.getElementById('shoulder-rate');
  doc.setFontSize(12); doc.setFont(undefined,'normal');
  doc.text(`On-Peak Rate: ${onRate} c/kWh`,M,y); y+=8;
  if (shRateEl){ doc.text(`Shoulder Rate: ${shRateEl.value} c/kWh`,M,y); y+=8; }
  doc.text(`Off-Peak Rate: ${offRate} c/kWh`,M,y); y+=14;

  const cards=document.querySelectorAll('.equipment-card');
  cards.forEach((card,idx)=>{
    br(60);
    const name=card.querySelector('.equipment-name').value;
    const power=card.querySelector('.equipment-power').value;
    doc.setFontSize(14); doc.setFont(undefined,'bold'); doc.text(`Equipment ${idx+1}: ${name}`,M,y); y+=10;
    doc.setFontSize(12); doc.setFont(undefined,'normal'); doc.text(`Power: ${power}W`,M,y); y+=8;

    const items=card.querySelectorAll('.equipment-results .results-grid .result-item');
    items.forEach(it=>{
      br(8);
      const label=it.querySelector('.result-label').textContent;
      const val=it.querySelector('.result-value').textContent;
      doc.text(`${label}: ${val}`,M+10,y); y+=6;
    });
    y+=6;
  });

  br(80);
  doc.setFontSize(16); doc.setFont(undefined,'bold'); doc.text('Total Usage & Cost Breakdown',M,y); y+=12;
  const totalGrid=document.querySelector('#results-container .results-grid');
  if (totalGrid){
    totalGrid.querySelectorAll('.result-item').forEach(it=>{
      br(8);
      const label=it.querySelector('.result-label').textContent;
      const val=it.querySelector('.result-value').textContent;
      doc.setFontSize(12); doc.setFont(undefined,'normal');
      doc.text(`${label}: ${val}`,M,y); y+=8;
    });
  }
  doc.setFontSize(10);
  doc.text((window.elementSdk?.config?.footer_text)||defaultConfig.footer_text, M, H-10);
  doc.save('ElectricityCostCalculatorResults.pdf');
}

/* ========= Tariff modal + selects ========= */
function openTariffModal(){ document.getElementById('tariff-modal').classList.add('show'); }
function closeTariffModal(){ document.getElementById('tariff-modal').classList.remove('show'); }
function fillRetailersSelect(){
  const sel=document.getElementById('retailer-select');
  sel.innerHTML=`<option value="">Select Retailer</option>`;
  Object.entries(tariffsData.retailers).forEach(([key,r])=>{
    const opt=document.createElement('option');
    opt.value=key; opt.textContent=r.displayName||key; sel.appendChild(opt);
  });
}
function fillPlansSelect(retailerKey){
  const sel=document.getElementById('plan-select');
  sel.innerHTML=`<option value="">Select Plan</option>`;
  if (!retailerKey) return;
  const plans=tariffsData.retailers[retailerKey]?.plans || {};
  Object.entries(plans).forEach(([pid,p])=>{
    const opt=document.createElement('option');
    opt.value=pid; opt.textContent=p.title||pid; sel.appendChild(opt);
  });
}
function fillRegionsSelect(retailerKey, planId){
  const sel=document.getElementById('region-select');
  sel.innerHTML=`<option value="">Select Region</option>`;
  if (!retailerKey || !planId) return;
  const byRegion=tariffsData.retailers[retailerKey]?.plans?.[planId]?.byRegion || {};
  Object.keys(byRegion).forEach(rid=>{
    const opt=document.createElement('option');
    opt.value=rid; opt.textContent=regionLabels[rid] || rid.toUpperCase(); sel.appendChild(opt);
  });
}

/* Group windows by day-signature so same-day sets share a UI group */
function setWindows(groupsId, windowsArr){
  const container=document.getElementById(groupsId);
  if (!container) return;
  container.innerHTML='';
  if (!windowsArr || !windowsArr.length){ addDayRange(groupsId); return; }

  const grouped = {};
  windowsArr.forEach(w=>{
    const sig = Array.isArray(w.days) ? [...w.days].sort((a,b)=>a-b).join(',') : '';
    if (!grouped[sig]) grouped[sig] = { days:[...(w.days||[])], ranges:[] };
    grouped[sig].ranges.push({start:w.start||'00:00', end:w.end||'00:00'});
  });

  Object.values(grouped).forEach(({days, ranges})=>{
    addDayRange(groupsId);
    const allGroups = container.querySelectorAll('.day-range-group');
    const g = allGroups[allGroups.length-1];
    g.querySelectorAll('.days-selector .day-btn').forEach(btn=>{
      const d=parseInt(btn.dataset.day); btn.classList.toggle('active', days.includes(d));
    });

    const rangesEl = g.querySelector('.tariff-ranges');
    rangesEl.innerHTML='';
    ranges.forEach(r=>{
      const div=document.createElement('div');
      div.className='time-range';
      div.innerHTML=`
        <div class="time-row">
          <input type="time" class="time-input" value="${r.start}">
          <span>to</span>
          <input type="time" class="time-input" value="${r.end}">
          <div class="toggle-container" style="margin-left:auto;">
            <span>All Day</span>
            <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
          </div>
          <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
        </div>`;
      rangesEl.appendChild(div);
      wireAllDayToggles(div);
    });
    updateTimeRangeXs(container);
  });
  refreshGroupButtons(container);
}

function applySelectedTariff(){
  const rSel=document.getElementById('retailer-select').value;
  const pSel=document.getElementById('plan-select').value;
  const reg=document.getElementById('region-select').value;
  const status=document.getElementById('fetch-status');

  if (!rSel || !pSel || !reg){
    status.innerHTML = `<div class="error-message">Please choose retailer, plan, and region.</div>`;
    return;
  }

  const plan=tariffsData.retailers[rSel].plans[pSel];
  const regionRates=plan.byRegion[reg];

  document.getElementById('on-peak-rate').value = regionRates.on.toFixed(4);
  document.getElementById('off-peak-rate').value = regionRates.off.toFixed(4);

  const hasShoulder = typeof regionRates.shoulder==='number' && plan.windows.shoulder && plan.windows.shoulder.length;
  if (hasShoulder){
    if (!shoulderEnabled) setShoulderUI(true);
    document.getElementById('shoulder-rate').value = regionRates.shoulder.toFixed(4);
  }else{
    setShoulderUI(false);
  }

  setWindows('on-peak-groups', plan.windows.on || []);
  setWindows('off-peak-groups', plan.windows.off || []);
  if (shoulderEnabled) setWindows('shoulder-groups', plan.windows.shoulder || []);

  const title = `${tariffsData.retailers[rSel].displayName} â€“ ${plan.title} (${regionLabels[reg] || reg.toUpperCase()})`;
  const titleEl=document.getElementById('selected-plan-title');
  titleEl.textContent=title; titleEl.style.display='inline';
  closeTariffModal();
}

/* ========= Rounding toggle ========= */
function setRoundingUI(active){
  roundingEnabled = !!active;
  const rt=document.getElementById('rounding-toggle');
  if (rt) rt.classList.toggle('active', roundingEnabled);
}

/* ========= DOM Ready wiring ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  initSDK();
  activateDayToggles(document);

  refreshGroupButtons(document.getElementById('on-peak-groups'));
  refreshGroupButtons(document.getElementById('off-peak-groups'));
  wireAllDayToggles(document);
  updateTimeRangeXs(document);

  const rt=document.getElementById('rounding-toggle');
  if (rt) rt.addEventListener('click', ()=> setRoundingUI(!rt.classList.contains('active')));

  const st=document.getElementById('shoulder-toggle');
  if (st) st.addEventListener('click', ()=> setShoulderUI(!st.classList.contains('active')));

  const fetchBtn=document.getElementById('fetch-tariffs-btn');
  if (fetchBtn){
    fetchBtn.addEventListener('click', async ()=>{
      openTariffModal();
      try{
        await fetchTariffsOnce();
        fillRetailersSelect();
        document.getElementById('retailer-select').onchange = (e)=>{
          fillPlansSelect(e.target.value);
          document.getElementById('region-select').innerHTML = `<option value="">Select Region</option>`;
        };
        document.getElementById('plan-select').onchange = (e)=>{
          const rKey=document.getElementById('retailer-select').value;
          fillRegionsSelect(rKey, e.target.value);
        };
      }catch(e){/* error already shown */}
    });
  }

  document.getElementById('add-equipment-btn').addEventListener('click', addEquipment);
  document.getElementById('calculate-btn').addEventListener('click', calculateCosts);
  const weekBtn = document.getElementById('electricWeekSaveBtn');
  if(weekBtn) weekBtn.addEventListener('click', handleElectricWeekSave);
  updateElectricSavedWeeksWidget();
  if(typeof window !== 'undefined'){
    window.addEventListener('storage', event=>{
      if(event.key === BRIDGE_STORAGE_KEY) updateElectricSavedWeeksWidget();
    });
  }

  setRoundingUI(true);
  setShoulderUI(false);
  addEquipment();
});
</script>
</body>
</html>