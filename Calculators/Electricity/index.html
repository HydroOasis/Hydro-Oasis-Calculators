<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electricity Cost Calculator</title>
  <link rel="stylesheet" href="../../assets/cea.css" data-preview-href="assets/cea.css">
  <link rel="stylesheet" href="../../shared/hoa-calcs.css" data-preview-href="shared/hoa-calcs.css">
  <script type="application/json" id="electricity-tariffs-fallback">
[{
  "retailer": "Aurora Energy",
  "region": "TAS",
  "distributor": null,
  "plan": "Tariff 31 (Flat)",
  "type": "flat",
  "flat_c_per_kWh": 29.0535,
  "supply_c_per_day": null,
  "notes": "From Power Tariffs sheet"
},
{
  "retailer": "Aurora Energy",
  "region": "TAS",
  "distributor": null,
  "plan": "Tariff 93 (TOU)",
  "type": "tou",
  "on_c_per_kWh": 35.4782,
  "off_c_per_kWh": 16.6862,
  "shoulder_c_per_kWh": null,
  "supply_c_per_day": null,
  "schedule": {
    "on": "07:00â€“10:00 & 16:00â€“21:00",
    "off": "10:00â€“16:00 & 21:00â€“07:00 (all day Sat/Sun)"
  },
  "notes": "From Power Tariffs sheet"
},
{
  "retailer": "Aurora Energy",
  "region": "TAS",
  "distributor": null,
  "plan": "Tariff 62 (Controlled Load)",
  "type": "flat",
  "flat_c_per_kWh": 14.3078,
  "supply_c_per_day": null,
  "notes": "Night/off-peak CL"
},
{
  "retailer": "AGL",
  "region": "National",
  "distributor": null,
  "plan": "Home Plan (Flat)",
  "type": "flat",
  "flat_c_per_kWh": 40.183,
  "supply_c_per_day": null,
  "notes": "From Power Tariffs sheet"
},
{
  "retailer": "AGL",
  "region": "National",
  "distributor": null,
  "plan": "Home Time of Use",
  "type": "tou",
  "on_c_per_kWh": 59.301,
  "off_c_per_kWh": 27.071,
  "shoulder_c_per_kWh": 33.044,
  "supply_c_per_day": null,
  "schedule": {
    "on": "16:00â€“21:00",
    "shoulder": "09:00â€“17:00 & 20:00â€“22:00",
    "off": "21:00â€“09:00"
  }
},
{
  "retailer": "Ergon Energy",
  "region": "QLD",
  "distributor": "Ergon",
  "plan": "Tariff 11 (Flat)",
  "type": "flat",
  "flat_c_per_kWh": 32.973,
  "supply_c_per_day": null,
  "notes": "From Power Tariffs sheet"
},
{
  "retailer": "Ergon Energy",
  "region": "QLD",
  "distributor": "Ergon",
  "plan": "Tariff 12D (TOU)",
  "type": "tou",
  "on_c_per_kWh": 45.712,
  "off_c_per_kWh": 22.68,
  "shoulder_c_per_kWh": 28.035,
  "schedule": {
    "on": "16:00â€“21:00",
    "shoulder": "21:00â€“11:00",
    "off": "11:00â€“16:00"
  }
},
{
  "retailer": "Synergy",
  "region": "WA",
  "distributor": "Western Power",
  "plan": "A1 (Flat)",
  "type": "flat",
  "flat_c_per_kWh": 32.3719,
  "supply_c_per_day": null
},
{
  "retailer": "Synergy",
  "region": "WA",
  "distributor": "Western Power",
  "plan": "Midday Saver (TOU)",
  "type": "tou",
  "on_c_per_kWh": 53.8446,
  "off_c_per_kWh": 8.6151,
  "shoulder_c_per_kWh": 23.6916,
  "schedule": {
    "on": "15:00â€“21:00",
    "shoulder": "21:00â€“09:00",
    "off": "09:00â€“15:00"
  }
},
{
  "retailer": "Powershop",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "Residential Single Rate",
  "type": "flat",
  "flat_c_per_kWh": 28.71,
  "supply_c_per_day": 115.25,
  "notes": "VDO 2023â€“24"
},
{
  "retailer": "Powershop",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "Residential TOU (2-period)",
  "type": "tou",
  "on_c_per_kWh": 37.19,
  "off_c_per_kWh": 24.41,
  "shoulder_c_per_kWh": null,
  "supply_c_per_day": 115.25,
  "schedule": {
    "on": "15:00â€“21:00 (daily)",
    "off": "all other times"
  }
},
{
  "retailer": "Powershop",
  "region": "VIC",
  "distributor": "AusNet",
  "plan": "Residential Single Rate",
  "type": "flat",
  "flat_c_per_kWh": 38.51,
  "supply_c_per_day": 132.51
},
{
  "retailer": "Powershop",
  "region": "VIC",
  "distributor": "AusNet",
  "plan": "Residential TOU (2-period)",
  "type": "tou",
  "on_c_per_kWh": 49.32,
  "off_c_per_kWh": 28.69,
  "supply_c_per_day": 132.51
},
{
  "retailer": "EnergyAustralia",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "Residential Peak Anytime (Flat)",
  "type": "flat",
  "flat_c_per_kWh": 28.71,
  "supply_c_per_day": 115.2492
},
{
  "retailer": "EnergyAustralia",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "Residential 7-Day TOU",
  "type": "tou",
  "on_c_per_kWh": 37.1899,
  "off_c_per_kWh": 24.4099,
  "supply_c_per_day": 115.2492
},
{
  "retailer": "Lumo Energy",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "Residential Single Rate",
  "type": "flat",
  "flat_c_per_kWh": 28.71,
  "supply_c_per_day": 115.25
},
{
  "retailer": "Lumo Energy",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "Residential TOU (7-Day)",
  "type": "tou",
  "on_c_per_kWh": 37.19,
  "off_c_per_kWh": 24.41,
  "supply_c_per_day": 115.25
},
{
  "retailer": "Lumo Energy",
  "region": "VIC",
  "distributor": "AusNet",
  "plan": "Residential Single Rate",
  "type": "flat",
  "flat_c_per_kWh": 38.51,
  "supply_c_per_day": 132.51
},
{
  "retailer": "Lumo Energy",
  "region": "VIC",
  "distributor": "AusNet",
  "plan": "Residential TOU (7-Day)",
  "type": "tou",
  "on_c_per_kWh": 49.32,
  "off_c_per_kWh": 28.69,
  "supply_c_per_day": 132.51
},
{
  "retailer": "Red Energy",
  "region": "VIC",
  "distributor": "CitiPower",
  "plan": "VDO Single Rate",
  "type": "flat",
  "flat_c_per_kWh": 27.33,
  "supply_c_per_day": 124.07,
  "notes": "Effective 1 Jul 2025"
},
{
  "retailer": "Red Energy",
  "region": "VIC",
  "distributor": "AusNet",
  "plan": "VDO 2-Period TOU (Res.)",
  "type": "tou",
  "on_c_per_kWh": 46.82,
  "off_c_per_kWh": 23.99,
  "supply_c_per_day": 141.46
}]
  </script>
  <!-- CDN fallbacks for GitHub preview / raw.githubusercontent -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HydroOasis/Hydro-Oasis-Calculators@main/assets/cea.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HydroOasis/Hydro-Oasis-Calculators@main/shared/hoa-calcs.css" media="print" onload="this.media='all'">
  <script>
  (function(){
    var isPreview = /github\.io|raw\.githubusercontent\.com|htmlpreview/i.test(location.href);
    if (!isPreview) return;

    var defaults = { owner: 'HydroOasis', repo: 'Hydro-Oasis-Calculators', branch: 'main' };

    function normalizeBranch(branch){
      if (!branch) return branch;
      return String(branch)
        .replace(/^refs\/?heads\//i, '')
        .replace(/^heads\//i, '')
        .replace(/^origin\//i, '');
    }

    function parsePreviewContext(){
      try {
        var href = String(location.href);
        var queryMatch = href.match(/\?(https?:\/\/[^\s]+)$/);
        if (queryMatch) {
          href = queryMatch[1];
        }
        href = decodeURIComponent(href);
        var match = href.match(/https?:\/\/[^/]*github(?:usercontent)?\.com\/([^/]+)\/([^/]+)\/(.+)$/i);
        if (!match) return defaults;
        var owner = match[1];
        var repo = match[2];
        var remainder = match[3].split(/[?#]/)[0];
        var segments = remainder.split('/').filter(Boolean);

        if (segments[0] === 'blob' || segments[0] === 'raw' || segments[0] === 'tree') {
          segments = segments.slice(1);
        }
        if (segments[0] === 'refs' && segments[1] === 'heads') {
          segments = segments.slice(2);
        }

        var markers = ['Calculators','assets','shared','data','Recommendations','build','dist','public','src','docs','.github'];
        var branchEnd = segments.length;
        for (var i = 0; i < segments.length; i++) {
          if (markers.indexOf(segments[i]) !== -1) {
            branchEnd = i;
            break;
          }
        }
        var branchParts = segments.slice(0, branchEnd);
        if (!branchParts.length && segments.length) {
          branchParts = [segments[0]];
        }
        var rawBranch = branchParts.join('/') || defaults.branch;
        var branch = normalizeBranch(rawBranch) || defaults.branch;
        return { owner: owner, repo: repo, branch: branch };
      } catch(err) {
        console.warn('Failed to detect preview context', err);
        return defaults;
      }
    }

    function computeBases(ctx){
      var branch = normalizeBranch(ctx.branch) || defaults.branch;
      var bases = [
        'https://raw.githubusercontent.com/' + ctx.owner + '/' + ctx.repo + '/' + branch + '/'
      ];
      if (branch.indexOf('/') === -1) {
        bases.push('https://cdn.jsdelivr.net/gh/' + ctx.owner + '/' + ctx.repo + '@' + branch + '/');
      }
      bases.push('https://rawcdn.githack.com/' + ctx.owner + '/' + ctx.repo + '/' + branch + '/');
      return Array.from(new Set(bases));
    }

    var context = window.__HOA_PREVIEW_CTX__ = parsePreviewContext();
    var bases = window.__HOA_PREVIEW_BASES__ = computeBases(context);
    var primaryBase = bases[0];

    function join(base, target){
      return base.replace(/\/+$/, '/') + target.replace(/^\/+/, '');
    }

    document.querySelectorAll('link[data-preview-href]').forEach(function(link){
      var target = link.getAttribute('data-preview-href');
      if (target) link.href = join(primaryBase, target);
    });
    document.querySelectorAll('script[data-preview-src]').forEach(function(scr){
      var target = scr.getAttribute('data-preview-src');
      if (target) scr.src = join(primaryBase, target);
    });
  })();
  </script>
  <script>
  // Only try to load Shopify/theme SDK in production storefronts, not in GitHub preview
  (function(){
    var isPreview = /github\.io|raw\.githubusercontent\.com|htmlpreview/i.test(location.href);
    if (isPreview) return; // skip in preview environments
    var s = document.createElement('script');
    s.src = '/_sdk/element_sdk.js';
    s.defer = true;
    document.head.appendChild(s);
  })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>


        #ecalc {
            --bg: #FDFBF4;
            --text: #333;
            --heading: #2D5C4E;
            --btn: #2D5C4E;
            --btn-hover: #A76DAB;
            --btn-text: #fff;
            --card: #fff;
            --card-border: #E7E5DC;
            --icon: #2D5C4E;
            --err: #BE5C5C;
            position: relative;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100%;
        }

        #ecalc * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #ecalc .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }

        #ecalc .container > * {
            position: relative;
            z-index: 2;
        }

        #ecalc .wm-img {
            position: absolute;
            right: -28px;
            bottom: -28px;
            width: 220px;
            opacity: 0.06;
            pointer-events: none;
            user-select: none;
            filter: saturate(0.9) contrast(0.95);
            z-index: 1;
        }

        #ecalc .header {
            text-align: center;
            padding: 40px 20px 32px 20px;
            margin: 0 0 32px 0;
        }

        #ecalc .header h1 {
            margin: 0 0 8px 0;
            font-size: clamp(26px, 3.2vw, 36px);
            font-weight: 800;
            color: #2D5C4E;
            line-height: 1.2;
        }

        #ecalc .header .subtitle {
            font-size: 14px;
            font-weight: 400;
            color: #456E62;
            margin: 8px 0 0 0;
            line-height: 1.4;
        }

        #ecalc .section {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--card-border);
        }

        #ecalc .section-title {
            display: flex;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 20px;
            align-items: center;
            gap: 8px;
        }

        #ecalc .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        #ecalc .form-group,
        #ecalc .input {
            display: flex;
            flex-direction: column;
        }

        #ecalc .form-group label,
        #ecalc .input label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        #ecalc .form-group input,
        #ecalc .form-group select,
        #ecalc .input input,
        #ecalc .input select {
            padding: 12px;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: var(--card);
            color: var(--text);
        }

        #ecalc .form-group input:focus,
        #ecalc .form-group select:focus,
        #ecalc .input input:focus,
        #ecalc .input select:focus {
            outline: none;
            border-color: var(--heading);
            box-shadow: 0 0 0 3px rgba(45, 92, 78, 0.1);
        }

        #ecalc .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }

        #ecalc .toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #ecalc .toggle.active {
            background: var(--btn);
        }

        #ecalc .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--card);
            border-radius: 50%;
            transition: transform 0.2s;
        }

        #ecalc .toggle.active .toggle-slider {
            transform: translateX(24px);
        }

        #ecalc .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            gap: 8px;
            text-align: center;
            white-space: nowrap;
        }

        #ecalc .btn-primary {
            background: var(--btn);
            color: var(--btn-text);
        }

        #ecalc .btn-primary:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        #ecalc .btn-secondary {
            background: #6b7280;
            color: var(--btn-text);
        }

        #ecalc .btn-secondary:hover {
            background: #4b5563;
        }

        #ecalc .btn-success {
            background: #10b981;
            color: var(--btn-text);
        }

        #ecalc .btn-success:hover {
            background: #059669;
        }

        #ecalc .btn-danger {
            background: var(--err);
            color: var(--btn-text);
        }

        #ecalc .btn-danger:hover {
            background: #a04545;
        }

        #ecalc .equipment-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
        }

        #ecalc .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #ecalc .equipment-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--heading);
        }

        #ecalc .remove-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--err);
            color: var(--btn-text);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        #ecalc .time-range {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        #ecalc .time-input {
            padding: 8px;
            border: 1px solid var(--card-border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card);
            color: var(--text);
        }

        #ecalc .days-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        #ecalc .day-btn {
            padding: 8px 12px;
            border: 2px solid var(--card-border);
            background: var(--card);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: var(--text);
        }

        #ecalc .day-btn.active {
            background: var(--btn);
            color: var(--btn-text);
            border-color: var(--btn);
        }

        #ecalc .results-section {
            background: var(--card);
            border: 2px solid var(--heading);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        #ecalc .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        #ecalc .result-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--card-border);
        }

        #ecalc .result-label {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 4px;
            opacity: 0.7;
        }

        #ecalc .result-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--heading);
        }

        #ecalc .error-message {
            background: #fef2f2;
            border: 1px solid var(--err);
            color: var(--err);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        #ecalc .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #ecalc .modal.show {
            display: flex;
        }

        #ecalc .modal-content {
            background: var(--card);
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid var(--card-border);
            position: relative;
            z-index: 1001;
        }

        #ecalc .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        #ecalc .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--heading);
        }

        #ecalc .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
        }

        #ecalc .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            #ecalc .wm-img {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            #ecalc .container {
                margin: 10px;
                padding: 16px;
            }
            
            #ecalc .header {
                padding: 30px 16px 20px 16px;
                margin: 0 0 20px 0;
            }
            
            #ecalc .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            #ecalc .time-range {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            #ecalc .time-range span {
                text-align: center;
                font-weight: 500;
            }
            
            #ecalc .days-selector {
                gap: 6px;
            }
            
            #ecalc .day-btn {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            #ecalc .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            #ecalc .result-item {
                padding: 12px;
            }
            
            #ecalc .result-value {
                font-size: 16px;
            }
            
            #ecalc .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            #ecalc .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            #ecalc .section {
                padding: 16px;
            }
            
            #ecalc .equipment-card {
                padding: 16px;
            }
        }
        
        @media (max-width: 480px) {
            #ecalc .header h1 {
                font-size: 1.7rem;
            }
            
            #ecalc .header .subtitle {
                font-size: 0.85rem;
            }
            
            #ecalc .section-title {
                font-size: 1.2rem;
            }
            
            #ecalc .results-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            #ecalc .days-selector {
                justify-content: center;
            }
            
            #ecalc .time-range .btn-danger {
                padding: 2px 6px;
                font-size: 10px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script>
  (function(){
    var href = window.location && window.location.href || '';
    var isPreview = /github\.io|raw\.githubusercontent\.com|htmlpreview/i.test(href);
    if (isPreview) return;
    var doc = document;
    if (doc.querySelector('script[src="/_sdk/data_sdk.js"]')) return;
    var s = doc.createElement('script');
    s.src = '/_sdk/data_sdk.js';
    s.type = 'text/javascript';
    s.defer = true;
    doc.head.appendChild(s);
  })();
  </script>
 </head>
 <body>
  <div id="elecFetchError" class="error-message" style="display:none"></div>
  <div class="hoa-calc" id="ecalc">
   <div class="container"><img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="">
    <div class="header">
     <h1 id="app-title">Electricity Cost Calculator</h1>
     <p class="subtitle">Calculate your energy usage and cost breakdown</p>
    </div><!-- Rate Configuration -->
    <div class="section">
     <h2 class="section-title">âš¡ Rate Configuration</h2>
     <div class="form-grid">
      <div class="input">
       <label for="elecRegion">Region/State</label>
       <select id="elecRegion"><option value="">Select regionâ€¦</option></select>
      </div>
      <div class="input">
       <label for="elecRetailer">Retailer</label>
       <select id="elecRetailer" disabled><option value="">Select retailerâ€¦</option></select>
      </div>
      <div class="input">
       <label for="elecPlan">Plan</label>
       <select id="elecPlan" disabled><option value="">Select planâ€¦</option></select>
      </div>
     </div>
     <div class="form-grid">
      <div class="form-group"><label for="on-peak-rate">On-Peak Rate (c/kWh)</label> <input type="number" id="on-peak-rate" min="0" step="0.01" placeholder="25.5">
      </div>
      <div class="form-group"><label for="off-peak-rate">Off-Peak Rate (c/kWh)</label> <input type="number" id="off-peak-rate" min="0" step="0.01" placeholder="15.2">
      </div>
     </div>
     <div class="toggle-container"><span>Round to 2 decimals</span>
      <div class="toggle active" id="rounding-toggle">
       <div class="toggle-slider"></div>
      </div><span>Show up to 6 decimals</span>
     </div><button class="btn btn-secondary" id="fetch-tariffs-btn" style="margin-top: 16px;"> ðŸ“‹ Fetch Tariffs </button>
    </div><!-- Tariff Schedule -->
    <div class="section">
     <h2 class="section-title">ðŸ“… Tariff Schedule</h2>
     <div id="tariff-schedule">
      <div class="tariff-type" data-type="on-peak">
       <h3 style="color: #dc2626; margin-bottom: 16px;">On-Peak Times</h3>
       <div class="tariff-ranges" id="on-peak-ranges">
        <div class="time-range"><input type="time" class="time-input" value="15:00"> <span>to</span> <input type="time" class="time-input" value="21:00"> <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
        </div>
       </div><button class="btn btn-secondary" onclick="addTimeRange('on-peak-ranges')" style="margin-bottom: 12px;">+ Add Time Range</button>
       <div class="days-selector"><button class="day-btn active" data-day="1">Mon</button> <button class="day-btn active" data-day="2">Tue</button> <button class="day-btn active" data-day="3">Wed</button> <button class="day-btn active" data-day="4">Thu</button> <button class="day-btn active" data-day="5">Fri</button> <button class="day-btn" data-day="6">Sat</button> <button class="day-btn" data-day="0">Sun</button>
       </div>
      </div>
      <div class="tariff-type" data-type="off-peak" style="margin-top: 24px;">
       <h3 style="color: #059669; margin-bottom: 16px;">Off-Peak Times</h3>
       <div class="tariff-ranges" id="off-peak-ranges">
        <div class="time-range"><input type="time" class="time-input" value="21:00"> <span>to</span> <input type="time" class="time-input" value="15:00"> <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
        </div>
       </div><button class="btn btn-secondary" onclick="addTimeRange('off-peak-ranges')" style="margin-bottom: 12px;">+ Add Time Range</button>
       <div class="days-selector"><button class="day-btn active" data-day="1">Mon</button> <button class="day-btn active" data-day="2">Tue</button> <button class="day-btn active" data-day="3">Wed</button> <button class="day-btn active" data-day="4">Thu</button> <button class="day-btn active" data-day="5">Fri</button> <button class="day-btn active" data-day="6">Sat</button> <button class="day-btn active" data-day="0">Sun</button>
       </div>
      </div>
     </div>
     <div id="tariff-errors"></div>
    </div><!-- Equipment Section -->
    <div class="section">
     <h2 class="section-title">ðŸ”Œ Equipment</h2><button class="btn btn-primary" id="add-equipment-btn">+ Add Equipment</button>
     <div id="equipment-list"></div>
     <div id="equipment-errors"></div>
    </div><!-- Calculate Button -->
    <div style="text-align: center; margin: 32px 0;"><button class="btn btn-success" id="calculate-btn" style="font-size: 18px; padding: 16px 32px; margin-right: 16px;"> ðŸ§® Calculate Costs </button>
    </div><!-- Results -->
    <div id="results-container" style="display: none;"></div>
   </div><!-- Tariff Fetch Modal -->
   <div class="modal" id="tariff-modal">
    <div class="modal-content">
     <div class="modal-header">
      <h3 class="modal-title">Fetch Tariff Data</h3><button class="close-btn" onclick="closeTariffModal()">Ã—</button>
     </div>
     <div class="form-group"><label for="retailer-select">Retailer</label> <select id="retailer-select"> <option value="">Select Retailer</option> <option value="actew">ActewAGL (ACT)</option> <option value="agl">AGL</option> <option value="alinta">Alinta Energy</option> <option value="amber">Amber Electric</option> <option value="aurora">Aurora Energy (TAS)</option> <option value="energyaustralia">Energy Australia</option> <option value="ergon">Ergon Energy (QLD)</option> <option value="energex">Energex (QLD)</option> <option value="horizon">Horizon Power (WA)</option> <option value="lumo">Lumo Energy</option> <option value="momentum">Momentum Energy</option> <option value="origin">Origin Energy</option> <option value="powershop">Powershop</option> <option value="red">Red Energy</option> <option value="sapowernetworks">SA Power Networks (SA)</option> <option value="simply">Simply Energy</option> <option value="synergy">Synergy (WA)</option> </select>
     </div>
     <div class="form-group"><label for="plan-select">Plan</label> <select id="plan-select"> <option value="">Select Plan</option> </select>
     </div>
     <div class="form-group"><label for="region-select">State/Network</label> <select id="region-select"> <option value="">Select Region</option> <option value="nsw">NSW</option> <option value="vic">VIC</option> <option value="qld">QLD</option> <option value="sa">SA</option> <option value="wa">WA</option> <option value="tas">TAS</option> <option value="act">ACT</option> </select>
     </div>
     <div style="display: flex; gap: 12px; margin-top: 24px;"><button class="btn btn-primary" onclick="fetchTariffData()">Fetch Data</button> <button class="btn btn-secondary" onclick="closeTariffModal()">Cancel</button>
     </div>
     <div id="fetch-status" style="margin-top: 16px;"></div>
    </div>
   </div>
  </div>
  <script>
        // Configuration object for Element SDK
        const defaultConfig = {
            app_title: "Electricity Cost Calculator",
            footer_text: "Hydro Oasis â€¢ Electricity Cost Calculator"
        };

        let equipmentCounter = 0;
        let roundingEnabled = true;

        // Initialize SDKs
        async function initializeSDKs() {
            // Initialize Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        const titleElement = document.getElementById('app-title');
                        if (titleElement) {
                            titleElement.textContent = config.app_title || defaultConfig.app_title;
                        }
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["app_title", config.app_title || defaultConfig.app_title],
                        ["footer_text", config.footer_text || defaultConfig.footer_text]
                    ])
                });
            }
        }

        // Initialize SDKs when page loads
        initializeSDKs();

        // Time overlap calculation engine
        function normalizeTimeRange(start, end) {
            const startMinutes = timeToMinutes(start);
            const endMinutes = timeToMinutes(end);
            
            if (startMinutes <= endMinutes) {
                return [{ start: startMinutes, end: endMinutes }];
            } else {
                // Range crosses midnight
                return [
                    { start: startMinutes, end: 1440 }, // Until midnight
                    { start: 0, end: endMinutes }       // From midnight
                ];
            }
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function mergeOverlappingRanges(ranges) {
            if (ranges.length === 0) return [];
            
            ranges.sort((a, b) => a.start - b.start);
            const merged = [ranges[0]];
            
            for (let i = 1; i < ranges.length; i++) {
                const current = ranges[i];
                const last = merged[merged.length - 1];
                
                if (current.start <= last.end) {
                    last.end = Math.max(last.end, current.end);
                } else {
                    merged.push(current);
                }
            }
            
            return merged;
        }

        function calculateOverlap(ranges1, ranges2) {
            let totalOverlap = 0;
            
            for (const range1 of ranges1) {
                for (const range2 of ranges2) {
                    const overlapStart = Math.max(range1.start, range2.start);
                    const overlapEnd = Math.min(range1.end, range2.end);
                    
                    if (overlapStart < overlapEnd) {
                        totalOverlap += overlapEnd - overlapStart;
                    }
                }
            }
            
            return totalOverlap / 60; // Convert to hours
        }

        // Equipment management
        function addEquipment() {
            equipmentCounter++;
            const equipmentList = document.getElementById('equipment-list');
            
            const equipmentCard = document.createElement('div');
            equipmentCard.className = 'equipment-card';
            equipmentCard.dataset.id = equipmentCounter;
            
            equipmentCard.innerHTML = `
                <button class="remove-btn" onclick="removeEquipment(${equipmentCounter})">Ã—</button>
                <div class="equipment-header">
                    <div class="equipment-title">Equipment ${equipmentCounter}</div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Equipment Name</label>
                        <input type="text" class="equipment-name" placeholder="e.g., Air Conditioner" value="Equipment ${equipmentCounter}">
                    </div>
                    <div class="form-group">
                        <label>Power (W)</label>
                        <input type="number" class="equipment-power" min="0" step="0.1" placeholder="1500" value="1500">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Daily kWh Cap (optional note)</label>
                    <input type="text" class="equipment-cap" placeholder="e.g., Max 8 hours per day">
                </div>
                
                <h4 style="margin: 20px 0 12px 0; color: #4f46e5;">Operating Schedule</h4>
                <div class="equipment-ranges">
                    <div class="time-range">
                        <input type="time" class="time-input" value="09:00">
                        <span>to</span>
                        <input type="time" class="time-input" value="17:00">
                        <button class="btn btn-danger" onclick="removeEquipmentTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addEquipmentTimeRange(${equipmentCounter})" style="margin-bottom: 12px;">+ Add Time Range</button>
                
                <div class="days-selector">
                    <button class="day-btn active" data-day="1">Mon</button>
                    <button class="day-btn active" data-day="2">Tue</button>
                    <button class="day-btn active" data-day="3">Wed</button>
                    <button class="day-btn active" data-day="4">Thu</button>
                    <button class="day-btn active" data-day="5">Fri</button>
                    <button class="day-btn" data-day="6">Sat</button>
                    <button class="day-btn" data-day="0">Sun</button>
                </div>
                
                <div class="equipment-results" style="display: none; margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                    <div class="results-grid"></div>
                </div>
            `;
            
            equipmentList.appendChild(equipmentCard);
            
            // Add event listeners for day buttons
            equipmentCard.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
        }

        function removeEquipment(id) {
            const equipment = document.querySelector(`[data-id="${id}"]`);
            if (equipment) {
                equipment.remove();
            }
        }

        function addEquipmentTimeRange(equipmentId) {
            const equipment = document.querySelector(`[data-id="${equipmentId}"]`);
            const rangesContainer = equipment.querySelector('.equipment-ranges');
            
            const timeRange = document.createElement('div');
            timeRange.className = 'time-range';
            timeRange.innerHTML = `
                <input type="time" class="time-input" value="09:00">
                <span>to</span>
                <input type="time" class="time-input" value="17:00">
                <button class="btn btn-danger" onclick="removeEquipmentTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
            `;
            
            rangesContainer.appendChild(timeRange);
        }

        function removeEquipmentTimeRange(btn) {
            btn.parentElement.remove();
        }

        // Tariff schedule management
        function addTimeRange(containerId) {
            const container = document.getElementById(containerId);
            const timeRange = document.createElement('div');
            timeRange.className = 'time-range';
            timeRange.innerHTML = `
                <input type="time" class="time-input" value="09:00">
                <span>to</span>
                <input type="time" class="time-input" value="17:00">
                <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
            `;
            
            container.appendChild(timeRange);
        }

        function removeTimeRange(btn) {
            btn.parentElement.remove();
        }

        // Tariff fetching
        function openTariffModal() {
            const modal = document.getElementById('tariff-modal');
            modal.classList.add('show');
        }

        function closeTariffModal() {
            const modal = document.getElementById('tariff-modal');
            modal.classList.remove('show');
        }

        async function fetchTariffData() {
            const retailer = document.getElementById('retailer-select').value;
            const plan = document.getElementById('plan-select').value;
            const region = document.getElementById('region-select').value;

            if (!retailer || !plan || !region) {
                document.getElementById('fetch-status').innerHTML =
                    '<div class="error-message">Please select all fields</div>';
                return;
            }

            const statusEl = document.getElementById('fetch-status');
            statusEl.innerHTML =
                '<div style="color: #4f46e5;">Loading shared tariff dataâ€¦</div>';

            try {
                await initElecTariffs();
                statusEl.innerHTML =
                    '<div style="color: #10b981;">Tariffs loaded. Use the selectors above to choose your plan.</div>';
                setTimeout(() => {
                    closeTariffModal();
                    statusEl.innerHTML = '';
                }, 1500);
            } catch (error) {
                console.warn('Tariff modal fetch failed', error);
                statusEl.innerHTML =
                    '<div class="error-message">Unable to load tariffs from the shared dataset.</div>';
            }
        }

        // Validation functions
        function validateInputs() {
            const errors = [];
            
            // Validate rates
            const onPeakRate = parseFloat(document.getElementById('on-peak-rate').value);
            const offPeakRate = parseFloat(document.getElementById('off-peak-rate').value);
            
            if (!onPeakRate || onPeakRate <= 0) {
                errors.push('On-peak rate must be greater than 0');
            }
            
            if (!offPeakRate || offPeakRate <= 0) {
                errors.push('Off-peak rate must be greater than 0');
            }
            
            // Validate equipment
            const equipmentCards = document.querySelectorAll('.equipment-card');
            if (equipmentCards.length === 0) {
                errors.push('At least one equipment must be added');
            }
            
            equipmentCards.forEach((card, index) => {
                const power = parseFloat(card.querySelector('.equipment-power').value);
                if (!power || power <= 0) {
                    errors.push(`Equipment ${index + 1}: Power must be greater than 0`);
                }
                
                // Validate time ranges
                const timeRanges = card.querySelectorAll('.time-range');
                timeRanges.forEach((range, rangeIndex) => {
                    const inputs = range.querySelectorAll('.time-input');
                    const start = inputs[0].value;
                    const end = inputs[1].value;
                    
                    if (!start || !end) {
                        errors.push(`Equipment ${index + 1}, Range ${rangeIndex + 1}: Both start and end times required`);
                    }
                });
                
                // Check if at least one day is selected
                const activeDays = card.querySelectorAll('.day-btn.active');
                if (activeDays.length === 0) {
                    errors.push(`Equipment ${index + 1}: At least one day must be selected`);
                }
            });
            
            return errors;
        }

        // Main calculation function
        function calculateCosts() {
            const errors = validateInputs();
            
            // Clear previous errors
            document.getElementById('equipment-errors').innerHTML = '';
            document.getElementById('tariff-errors').innerHTML = '';
            
            if (errors.length > 0) {
                document.getElementById('equipment-errors').innerHTML = 
                    errors.map(error => `<div class="error-message">${error}</div>`).join('');
                document.getElementById('results-container').style.display = 'none';
                return;
            }
            
            const flat = Number((document.getElementById('ratePerKwh') || document.getElementById('rate-per-kwh'))?.value || 0);
            const on   = Number(document.getElementById('on-peak-rate')?.value || 0);
            const off  = Number(document.getElementById('off-peak-rate')?.value || 0);
            const sh   = Number(document.getElementById('shoulder-rate')?.value || 0);

            const onPeakRate = (on || flat) / 100; // Convert c/kWh to $/kWh
            const offPeakRate = (off || flat) / 100;
            const shoulderRate = sh / 100;
            
            // Get tariff schedules
            const onPeakSchedule = getTariffSchedule('on-peak');
            const offPeakSchedule = getTariffSchedule('off-peak');
            
            let totalResults = {
                dailyKwh: 0,
                weeklyKwh: 0,
                monthlyKwh: 0,
                yearlyKwh: 0,
                dailyCost: 0,
                weeklyCost: 0,
                monthlyCost: 0,
                yearlyCost: 0,
                onPeakHours: 0,
                offPeakHours: 0,
                ratesSnapshot: { flat, on, off, sh, shoulderRate }
            };
            
            // Calculate for each equipment
            document.querySelectorAll('.equipment-card').forEach(card => {
                const power = parseFloat(card.querySelector('.equipment-power').value) / 1000; // Convert W to kW
                const equipmentSchedule = getEquipmentSchedule(card);
                const selectedDays = getSelectedDays(card);
                
                // Calculate total weekly hours for this equipment
                let totalWeeklyOnPeakHours = 0;
                let totalWeeklyOffPeakHours = 0;
                
                selectedDays.forEach(day => {
                    const dayOnPeakSchedule = onPeakSchedule.filter(s => s.days.includes(day));
                    const dayOffPeakSchedule = offPeakSchedule.filter(s => s.days.includes(day));
                    
                    // Normalize equipment schedule for this day
                    let equipmentRanges = [];
                    equipmentSchedule.forEach(range => {
                        equipmentRanges = equipmentRanges.concat(normalizeTimeRange(range.start, range.end));
                    });
                    equipmentRanges = mergeOverlappingRanges(equipmentRanges);
                    
                    // Calculate on-peak overlap for this day
                    dayOnPeakSchedule.forEach(tariffRange => {
                        let tariffRanges = normalizeTimeRange(tariffRange.start, tariffRange.end);
                        tariffRanges = mergeOverlappingRanges(tariffRanges);
                        totalWeeklyOnPeakHours += calculateOverlap(equipmentRanges, tariffRanges);
                    });
                    
                    // Calculate off-peak overlap for this day
                    dayOffPeakSchedule.forEach(tariffRange => {
                        let tariffRanges = normalizeTimeRange(tariffRange.start, tariffRange.end);
                        tariffRanges = mergeOverlappingRanges(tariffRanges);
                        totalWeeklyOffPeakHours += calculateOverlap(equipmentRanges, tariffRanges);
                    });
                });
                
                // Calculate daily averages
                const dailyOnPeakHours = totalWeeklyOnPeakHours / 7;
                const dailyOffPeakHours = totalWeeklyOffPeakHours / 7;
                
                // Calculate consumption and costs
                const dailyKwh = power * (dailyOnPeakHours + dailyOffPeakHours);
                const weeklyKwh = power * (totalWeeklyOnPeakHours + totalWeeklyOffPeakHours);
                const monthlyKwh = weeklyKwh * (365.25 / 12 / 7); // More accurate monthly calculation
                const yearlyKwh = weeklyKwh * (365.25 / 7); // More accurate yearly calculation
                
                const dailyCost = power * (dailyOnPeakHours * onPeakRate + dailyOffPeakHours * offPeakRate);
                const weeklyCost = power * (totalWeeklyOnPeakHours * onPeakRate + totalWeeklyOffPeakHours * offPeakRate);
                const monthlyCost = weeklyCost * (365.25 / 12 / 7);
                const yearlyCost = weeklyCost * (365.25 / 7);
                
                // Store equipment results for later display (but don't show under each equipment)
                const resultsContainer = card.querySelector('.equipment-results .results-grid');
                resultsContainer.innerHTML = `
                    <div class="result-item">
                        <div class="result-label">On-Peak Hours/Day</div>
                        <div class="result-value">${formatNumber(dailyOnPeakHours)}h</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Off-Peak Hours/Day</div>
                        <div class="result-value">${formatNumber(dailyOffPeakHours)}h</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Daily kWh</div>
                        <div class="result-value">${formatNumber(dailyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Weekly kWh</div>
                        <div class="result-value">${formatNumber(weeklyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly kWh</div>
                        <div class="result-value">${formatNumber(monthlyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Yearly kWh</div>
                        <div class="result-value">${formatNumber(yearlyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Daily Cost</div>
                        <div class="result-value">$${formatNumber(dailyCost)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Weekly Cost</div>
                        <div class="result-value">$${formatNumber(weeklyCost)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly Cost</div>
                        <div class="result-value">$${formatNumber(monthlyCost)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Yearly Cost</div>
                        <div class="result-value">$${formatNumber(yearlyCost)}</div>
                    </div>
                `;
                
                // Keep equipment results hidden under each equipment card
                card.querySelector('.equipment-results').style.display = 'none';
                
                // Add to totals
                totalResults.dailyKwh += dailyKwh;
                totalResults.weeklyKwh += weeklyKwh;
                totalResults.monthlyKwh += monthlyKwh;
                totalResults.yearlyKwh += yearlyKwh;
                totalResults.dailyCost += dailyCost;
                totalResults.weeklyCost += weeklyCost;
                totalResults.monthlyCost += monthlyCost;
                totalResults.yearlyCost += yearlyCost;
                totalResults.onPeakHours += dailyOnPeakHours;
                totalResults.offPeakHours += dailyOffPeakHours;
            });
            
            // Display results
            displayTotalResults(totalResults);

            try {
                HOA.pushToHarvest({
                    source: 'electricity',
                    ts: Date.now(),
                    summary: {
                        dailyKwh: totalResults?.dailyKwh ?? null,
                        monthlyCost: totalResults?.monthlyCost ?? null,
                        yearlyCost: totalResults?.yearlyCost ?? null
                    },
                    raw: totalResults || {}
                });
            } catch(e) { console.warn('Harvest export (electricity) failed', e); }
        }

        function getTariffSchedule(type) {
            const container = document.getElementById(`${type}-ranges`);
            const ranges = container.querySelectorAll('.time-range');
            const schedule = [];
            
            ranges.forEach(range => {
                const inputs = range.querySelectorAll('.time-input');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                if (start && end) {
                    schedule.push({ start, end });
                }
            });
            
            // Get selected days for this tariff type
            const tariffSection = container.closest('.tariff-type');
            const selectedDays = [];
            tariffSection.querySelectorAll('.day-btn.active').forEach(btn => {
                selectedDays.push(parseInt(btn.dataset.day));
            });
            
            return schedule.map(range => ({ ...range, days: selectedDays }));
        }

        function getEquipmentSchedule(card) {
            const ranges = card.querySelectorAll('.equipment-ranges .time-range');
            const schedule = [];
            
            ranges.forEach(range => {
                const inputs = range.querySelectorAll('.time-input');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                if (start && end) {
                    schedule.push({ start, end });
                }
            });
            
            return schedule;
        }

        function getSelectedDays(card) {
            const selectedDays = [];
            card.querySelectorAll('.day-btn.active').forEach(btn => {
                selectedDays.push(parseInt(btn.dataset.day));
            });
            return selectedDays;
        }

        function formatNumber(num) {
            if (roundingEnabled) {
                return num.toFixed(2);
            } else {
                // Show up to 6 decimals, but trim trailing zeros (minimum 2 decimals)
                let formatted = num.toFixed(6);
                formatted = formatted.replace(/\.?0+$/, '');
                if (!formatted.includes('.')) {
                    formatted += '.00';
                } else if (formatted.split('.')[1].length === 1) {
                    formatted += '0';
                }
                return formatted;
            }
        }

        function displayTotalResults(results) {
            const resultsContainer = document.getElementById('results-container');
            
            // Collect all equipment results
            let equipmentResultsHTML = '';
            document.querySelectorAll('.equipment-card').forEach((card, index) => {
                const name = card.querySelector('.equipment-name').value;
                const power = card.querySelector('.equipment-power').value;
                const resultsGrid = card.querySelector('.equipment-results .results-grid');
                
                if (resultsGrid) {
                    equipmentResultsHTML += `
                        <div class="results-section" style="margin-bottom: 24px;">
                            <h3 class="section-title">ðŸ”Œ ${name} (${power}W)</h3>
                            <div class="results-grid">
                                ${resultsGrid.innerHTML}
                            </div>
                        </div>
                    `;
                }
            });
            
            resultsContainer.innerHTML = `
                ${equipmentResultsHTML}
                
                <div class="results-section">
                    <h2 class="section-title">ðŸ“Š Total Usage & Cost Breakdown</h2>
                    
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-label">On-Peak Hours/Day</div>
                            <div class="result-value">${formatNumber(results.onPeakHours)}h</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Off-Peak Hours/Day</div>
                            <div class="result-value">${formatNumber(results.offPeakHours)}h</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Daily kWh</div>
                            <div class="result-value">${formatNumber(results.dailyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Weekly kWh</div>
                            <div class="result-value">${formatNumber(results.weeklyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Monthly kWh</div>
                            <div class="result-value">${formatNumber(results.monthlyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Yearly kWh</div>
                            <div class="result-value">${formatNumber(results.yearlyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Daily Cost</div>
                            <div class="result-value">$${formatNumber(results.dailyCost)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Weekly Cost</div>
                            <div class="result-value">$${formatNumber(results.weeklyCost)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Monthly Cost</div>
                            <div class="result-value">$${formatNumber(results.monthlyCost)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Yearly Cost</div>
                            <div class="result-value">${formatNumber(results.yearlyCost)}</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="downloadPDF()">
                            ðŸ“„ Download Results as PDF
                        </button>
                    </div>
                </div>
            `;
            
            resultsContainer.style.display = 'block';
        }

        // PDF Generation
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            
            // Helper function to add new page if needed
            function checkPageBreak(neededSpace) {
                if (yPosition + neededSpace > pageHeight - margin) {
                    doc.addPage();
                    yPosition = 20;
                }
            }
            
            // Title
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            const title = config.app_title || defaultConfig.app_title;
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(title, margin, yPosition);
            yPosition += 15;
            
            // Date
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, yPosition);
            yPosition += 20;
            
            // Tariff Summary
            checkPageBreak(30);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Tariff Summary', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            const onPeakRate = document.getElementById('on-peak-rate').value;
            const offPeakRate = document.getElementById('off-peak-rate').value;
            doc.text(`On-Peak Rate: ${onPeakRate} c/kWh`, margin, yPosition);
            yPosition += 8;
            doc.text(`Off-Peak Rate: ${offPeakRate} c/kWh`, margin, yPosition);
            yPosition += 20;
            
            // Equipment Details
            const equipmentCards = document.querySelectorAll('.equipment-card');
            equipmentCards.forEach((card, index) => {
                checkPageBreak(60);
                
                const name = card.querySelector('.equipment-name').value;
                const power = card.querySelector('.equipment-power').value;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Equipment ${index + 1}: ${name}`, margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Power: ${power}W`, margin, yPosition);
                yPosition += 8;
                
                // Equipment results
                const results = card.querySelector('.equipment-results .results-grid');
                if (results) {
                    const resultItems = results.querySelectorAll('.result-item');
                    resultItems.forEach(item => {
                        const label = item.querySelector('.result-label').textContent;
                        const value = item.querySelector('.result-value').textContent;
                        doc.text(`${label}: ${value}`, margin + 10, yPosition);
                        yPosition += 6;
                    });
                }
                yPosition += 10;
            });
            
            // Total Results
            checkPageBreak(80);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Total Usage & Cost Breakdown', margin, yPosition);
            yPosition += 15;
            
            const totalResults = document.querySelector('#results-container .results-grid');
            if (totalResults) {
                const resultItems = totalResults.querySelectorAll('.result-item');
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                
                resultItems.forEach(item => {
                    checkPageBreak(8);
                    const label = item.querySelector('.result-label').textContent;
                    const value = item.querySelector('.result-value').textContent;
                    doc.text(`${label}: ${value}`, margin, yPosition);
                    yPosition += 8;
                });
            }
            
            // Footer
            const footerText = config.footer_text || defaultConfig.footer_text;
            doc.setFontSize(10);
            doc.text(footerText, margin, pageHeight - 10);
            
            doc.save('ElectricityCostCalculatorResults.pdf');
        }

        // Event Listeners
        document.getElementById('add-equipment-btn').addEventListener('click', addEquipment);
        document.getElementById('calculate-btn').addEventListener('click', calculateCosts);
        document.getElementById('fetch-tariffs-btn').addEventListener('click', openTariffModal);

        document.getElementById('rounding-toggle').addEventListener('click', function() {
            this.classList.toggle('active');
            roundingEnabled = this.classList.contains('active');
            
            // If results are visible, recalculate to update the display
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer.style.display !== 'none') {
                calculateCosts();
            }
        });

        // Add event listeners for tariff day buttons
        document.querySelectorAll('.tariff-type .day-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });

        // Retailer selection handler
        document.getElementById('retailer-select').addEventListener('change', function() {
            const planSelect = document.getElementById('plan-select');
            const regionSelect = document.getElementById('region-select');
            
            planSelect.innerHTML = '<option value="">Select Plan</option>';
            regionSelect.innerHTML = '<option value="">Select Region</option>';
            
            const plans = {
                actew: ['standard-tariff', 'time-of-use'],
                agl: ['basic-plan', 'time-of-use'],
                alinta: ['home-deal'],
                amber: ['wholesale-plan'],
                aurora: ['residential-tariff', 'time-of-use'],
                energyaustralia: ['basic-plan', 'time-of-use'],
                ergon: ['tariff-11', 'tariff-12'],
                energex: ['tariff-11'],
                horizon: ['standard-tariff'],
                lumo: ['basic-plan', 'time-of-use'],
                momentum: ['classic-plan'],
                origin: ['basic-plan', 'time-of-use'],
                powershop: ['standard-plan'],
                red: ['living-energy'],
                sapowernetworks: ['single-rate', 'flexible-tariff'],
                simply: ['simply-save'],
                synergy: ['a1-tariff', 'a2-tariff']
            };
            
            // Define which states each retailer operates in
            const retailerStates = {
                actew: ['act'],
                agl: ['nsw', 'vic', 'qld', 'sa'],
                alinta: ['nsw', 'vic', 'qld', 'sa', 'wa'],
                amber: ['nsw', 'vic', 'qld', 'sa'],
                aurora: ['tas'],
                energyaustralia: ['nsw', 'vic', 'qld', 'sa'],
                ergon: ['qld'],
                energex: ['qld'],
                horizon: ['wa'],
                lumo: ['nsw', 'vic', 'qld', 'sa'],
                momentum: ['nsw', 'vic', 'qld', 'sa'],
                origin: ['nsw', 'vic', 'qld', 'sa'],
                powershop: ['nsw', 'vic', 'qld', 'sa'],
                red: ['nsw', 'vic', 'qld', 'sa'],
                sapowernetworks: ['sa'],
                simply: ['nsw', 'vic', 'qld', 'sa'],
                synergy: ['wa']
            };
            
            const stateNames = {
                nsw: 'NSW',
                vic: 'VIC',
                qld: 'QLD',
                sa: 'SA',
                wa: 'WA',
                tas: 'TAS',
                act: 'ACT'
            };
            
            // Populate plans
            if (plans[this.value]) {
                plans[this.value].forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan;
                    option.textContent = plan.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    planSelect.appendChild(option);
                });
            }
            
            // Populate states based on retailer coverage
            if (retailerStates[this.value]) {
                retailerStates[this.value].forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = stateNames[state];
                    regionSelect.appendChild(option);
                });
            }
        });

        // Initialize with one equipment
        addEquipment();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99881531a63cf0c8',t:'MTc2MjEzMzE3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script src="../../shared/js/hoa-calcs.js" data-preview-src="shared/js/hoa-calcs.js"></script>
  <script>
  (function ensureHOA(){
    if (window.HOA && typeof window.HOA.pushToHarvest === 'function') return;
    var defaults = [
      'https://raw.githubusercontent.com/HydroOasis/Hydro-Oasis-Calculators/main/',
      'https://cdn.jsdelivr.net/gh/HydroOasis/Hydro-Oasis-Calculators@main/',
      'https://rawcdn.githack.com/HydroOasis/Hydro-Oasis-Calculators/main/'
    ];

    function gatherBases(){
      if (Array.isArray(window.__HOA_PREVIEW_BASES__) && window.__HOA_PREVIEW_BASES__.length) {
        return window.__HOA_PREVIEW_BASES__;
      }
      return defaults;
    }

    function toSrc(base){
      return base.replace(/\/+$/, '/') + 'shared/js/hoa-calcs.js';
    }

    var seen = {};
    var sources = gatherBases().map(toSrc).filter(function(src){
      if (seen[src]) return false;
      seen[src] = true;
      return true;
    });

    defaults.map(toSrc).forEach(function(src){
      if (!seen[src]) {
        seen[src] = true;
        sources.push(src);
      }
    });

    function loadNext(){
      if (window.HOA && typeof window.HOA.pushToHarvest === 'function') return;
      if (!sources.length) {
        console.error('Failed to load HOA shared utilities from all preview sources.');
        return;
      }
      var src = sources.shift();
      var script = document.createElement('script');
      script.src = src;
      script.onload = function(){
        if (!window.HOA || typeof window.HOA.pushToHarvest !== 'function') {
          console.error('HOA still not available after loading', src);
          loadNext();
        }
      };
      script.onerror = function(){
        console.error('Failed to load HOA from', src);
        loadNext();
      };
      document.head.appendChild(script);
    }

    loadNext();
  })();
  </script>
  <script>
  (function injectPreviewHOA(){
    if (window.HOA && typeof window.HOA.fetchJSON === 'function') return;
    console.warn('[Electricity] Falling back to inline HOA utilities for preview.');
    window.HOA = (() => {
      const isPreview = /github\.io|raw\.githubusercontent\.com|htmlpreview/i.test(location.href);
      const DEFAULT_CONTEXT = { owner: 'HydroOasis', repo: 'Hydro-Oasis-Calculators', branch: 'main' };

      const normalizeBranch = branch => branch
        ? String(branch)
            .replace(/^refs\/?heads\//i, '')
            .replace(/^heads\//i, '')
            .replace(/^origin\//i, '')
        : branch;

      function computeBases(){
        if (!isPreview) return [];
        if (Array.isArray(window.__HOA_PREVIEW_BASES__) && window.__HOA_PREVIEW_BASES__.length) {
          return window.__HOA_PREVIEW_BASES__;
        }
        const ctx = window.__HOA_PREVIEW_CTX__ || DEFAULT_CONTEXT;
        const branch = normalizeBranch(ctx.branch) || DEFAULT_CONTEXT.branch;
        const bases = [
          'https://raw.githubusercontent.com/' + ctx.owner + '/' + ctx.repo + '/' + branch + '/'
        ];
        if (branch.indexOf('/') === -1) {
          bases.push('https://cdn.jsdelivr.net/gh/' + ctx.owner + '/' + ctx.repo + '@' + branch + '/');
        }
        bases.push('https://rawcdn.githack.com/' + ctx.owner + '/' + ctx.repo + '/' + branch + '/');
        window.__HOA_PREVIEW_BASES__ = Array.from(new Set(bases));
        return window.__HOA_PREVIEW_BASES__;
      }

      const PREVIEW_BASES = computeBases();

      const DATA = {
        waterProviders: '../../data/water_providers.json',
        elecTariffs:    '../../data/electricity_tariffs.json',
        nutrientPresets:'../../data/nutrient_presets.json',
        recVent:        '../../Recommendations/ventilation.md',
        recDehum:       '../../Recommendations/dehumidification.md'
      };

      const toRepoPath = path => path.replace(/^\/+/, '').replace(/^(\.\.\/)+/, '');

      async function tryFetchJSON(targets){
        let lastErr;
        for (const target of targets){
          try {
            const res = await fetch(target, { cache: 'no-cache' });
            if (!res.ok) throw new Error(`Fetch failed ${res.status} for ${target}`);
            return await res.json();
          } catch(err){
            lastErr = err;
          }
        }
        throw lastErr || new Error('Unable to fetch JSON');
      }

      async function tryFetchText(targets){
        let lastErr;
        for (const target of targets){
          try {
            const res = await fetch(target, { cache: 'no-cache' });
            if (!res.ok) throw new Error(`Fetch failed ${res.status} for ${target}`);
            return await res.text();
          } catch(err){
            lastErr = err;
          }
        }
        throw lastErr || new Error('Unable to fetch text');
      }

      function buildFetchTargets(path){
        const targets = [];
        if (!isPreview) {
          targets.push(path);
          return targets;
        }
        const repoPath = toRepoPath(path);
        PREVIEW_BASES.forEach(function(base){ targets.push(base + repoPath); });
        targets.push(path);
        return targets;
      }

      async function fetchJSON(path){
        return tryFetchJSON(buildFetchTargets(path));
      }

      async function fetchText(path){
        return tryFetchText(buildFetchTargets(path));
      }

      const HARVEST_KEY = 'hoa.harvest.payloads.v1';

      function pushToHarvest(payload){
        try{
          const arr = JSON.parse(localStorage.getItem(HARVEST_KEY) || '[]');
          arr.unshift(payload);
          localStorage.setItem(HARVEST_KEY, JSON.stringify(arr.slice(0, 25)));
          window.dispatchEvent(new CustomEvent('hoa-harvest-updated'));
        }catch(e){ console.warn('pushToHarvest error', e); }
      }

      function getHarvestPayloads(){
        try{ return JSON.parse(localStorage.getItem(HARVEST_KEY) || '[]'); }
        catch{ return []; }
      }

      return {
        DATA,
        fetchJSON,
        fetchText,
        pushToHarvest,
        getHarvestPayloads,
        buildFetchTargets,
        previewBases: PREVIEW_BASES.slice ? PREVIEW_BASES.slice() : []
      };
    })();
  })();
  </script>
<script>
/* ===== CEA calc core (drop-in) ===== */
const CEA = (() => {
  const BUS = document.createElement('div');
  const on  = (evt, fn) => BUS.addEventListener(evt, fn);
  const emit = (evt, detail) => BUS.dispatchEvent(new CustomEvent(evt,{detail}));

  function getRunId() {
    const k = 'cea.runId';
    let id = localStorage.getItem(k);
    if (!id) { id = 'RUN-' + Math.random().toString(36).slice(2,8).toUpperCase(); localStorage.setItem(k, id); }
    return id;
  }
  function save(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch{} }
  function load(key, fallback=null) { try { const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; } catch{ return fallback; } }

  return { on, emit, getRunId, save, load };
})();
</script>
  <script>
async function initElecTariffs(){
  const $region   = document.getElementById('elecRegion');
  const $retailer = document.getElementById('elecRetailer');
  const $plan     = document.getElementById('elecPlan');
  if (!$region || !$retailer || !$plan) return;

  // Resolve a deterministic tariffs URL right now (no async race)
  const isPreview = /github\.io|raw\.githubusercontent\.com|htmlpreview/i.test(location.href);
  const previewBases = (window.HOA && Array.isArray(HOA.previewBases) && HOA.previewBases.length)
    ? HOA.previewBases
    : (Array.isArray(window.__HOA_PREVIEW_BASES__) ? window.__HOA_PREVIEW_BASES__ : []);
  const previewCtx = (window.HOA && HOA.previewContext) || window.__HOA_PREVIEW_CTX__ || { owner: 'HydroOasis', repo: 'Hydro-Oasis-Calculators', branch: 'main' };

  function normalizeBranch(branch){
    if (!branch) return branch;
    return String(branch)
      .replace(/^refs\/?heads\//i, '')
      .replace(/^heads\//i, '')
      .replace(/^origin\//i, '');
  }

  function buildBase(ctx, kind){
    if (!ctx) return null;
    var branch = normalizeBranch(ctx.branch || previewCtx.branch) || 'main';
    if (kind === 'raw') {
      return 'https://raw.githubusercontent.com/' + ctx.owner + '/' + ctx.repo + '/' + branch + '/';
    }
    if (kind === 'cdn') {
      if (branch.indexOf('/') !== -1) return null;
      return 'https://cdn.jsdelivr.net/gh/' + ctx.owner + '/' + ctx.repo + '@' + branch + '/';
    }
    if (kind === 'githack') {
      return 'https://rawcdn.githack.com/' + ctx.owner + '/' + ctx.repo + '/' + branch + '/';
    }
    return null;
  }

  function findBase(pattern, fallbackKind){
    const match = previewBases.find(function(base){ return pattern.test(base); });
    if (match) return match;
    return buildBase(previewCtx, fallbackKind);
  }

  function join(base, path){
    if (!base) return null;
    return base.replace(/\/+$/, '/') + path.replace(/^\/+/, '');
  }

  const RAW = join(findBase(/raw\.githubusercontent\.com/, 'raw'), 'data/electricity_tariffs.json');
  const CDN_BASE = findBase(/cdn\.jsdelivr\.net/, 'cdn');
  const CDN = CDN_BASE ? join(CDN_BASE, 'data/electricity_tariffs.json') : null;
  const GITHACK_BASE = findBase(/rawcdn\.githack\.com/, 'githack');
  const GITHACK = GITHACK_BASE ? join(GITHACK_BASE, 'data/electricity_tariffs.json') : null;
  const LOCAL = '../../data/electricity_tariffs.json';
  const url = (window.HOA && HOA.DATA && HOA.DATA.elecTariffs) ||
              (isPreview ? RAW : LOCAL);
  console.log('[Elec] Tariffs URL resolved â†’', url);

  const embeddedTariffs = (() => {
    const node = document.getElementById('electricity-tariffs-fallback');
    if (!node) return null;
    try {
      const parsed = JSON.parse(node.textContent || node.innerText || '[]');
      return Array.isArray(parsed) ? parsed : null;
    } catch(err) {
      console.error('[Elec] Failed to parse embedded tariffs fallback', err);
      return null;
    }
  })();

  let tariffs = [];
  let lastError;
  try {
    // Use HOA.fetchJSON if available, else bare fetch
    const fetcher = (window.HOA && HOA.fetchJSON) ? HOA.fetchJSON : (async u => {
      const r = await fetch(u, { cache: 'no-cache' });
      if (!r.ok) throw new Error('Fetch failed '+r.status+' for '+u);
      return r.json();
    });
    tariffs = await fetcher(url);
    // If preview + RAW unexpectedly fails, try CDN once
  } catch(e1){
    lastError = e1;
    if (isPreview) {
      if (CDN) {
        try {
          console.warn('[Elec] RAW failed, trying CDN onceâ€¦');
          const r2 = await fetch(CDN, { cache: 'no-cache' });
          if (!r2.ok) throw new Error('CDN fetch failed '+r2.status);
          tariffs = await r2.json();
        } catch(e2){
          lastError = e2;
          if (GITHACK) {
            try {
              console.warn('[Elec] CDN failed, trying githackâ€¦');
              const r3 = await fetch(GITHACK, { cache: 'no-cache' });
              if (!r3.ok) throw new Error('githack fetch failed '+r3.status);
              tariffs = await r3.json();
            } catch(e3){
              lastError = e3;
              console.error('Tariffs fetch failed (preview RAW/CDN/githack).', e1, e2, e3);
            }
          } else {
            console.error('Tariffs fetch failed (preview RAW/CDN).', e1, e2);
          }
        }
      } else if (GITHACK) {
        try {
          console.warn('[Elec] RAW failed, trying githackâ€¦');
          const r3 = await fetch(GITHACK, { cache: 'no-cache' });
          if (!r3.ok) throw new Error('githack fetch failed '+r3.status);
          tariffs = await r3.json();
        } catch(e3){
          lastError = e3;
          console.error('Tariffs fetch failed (preview RAW/githack).', e1, e3);
        }
      }
    } else {
      console.error('Tariffs fetch failed (LOCAL).', e1);
    }
  }

  if ((!Array.isArray(tariffs) || tariffs.length === 0) && embeddedTariffs && embeddedTariffs.length) {
    console.warn('[Elec] Using embedded tariffs fallback for preview.');
    tariffs = embeddedTariffs;
  }

  if (!Array.isArray(tariffs) || tariffs.length === 0) {
    const $err = document.getElementById('elecFetchError');
    if ($err) {
      $err.textContent = 'Could not load electricity tariffs data.';
      $err.style.display = 'block';
    }
    if (lastError) {
      console.error('Unable to load tariffs data.', lastError);
    }
    alert('Unable to load tariffs data. Please try again later.');
    return;
  }

  // Try to find existing rate inputs used by your calculator:
  const $flat = document.getElementById('ratePerKwh') || document.getElementById('rate-per-kwh') || document.querySelector('[data-rate="flat"]');
  const $on   = document.getElementById('on-peak-rate')  || document.querySelector('[data-rate="on"]');
  const $off  = document.getElementById('off-peak-rate') || document.querySelector('[data-rate="off"]');
  const $sh   = document.getElementById('shoulder-rate') || document.querySelector('[data-rate="shoulder"]');

  [$flat, $on, $off, $sh].filter(Boolean).forEach(el => {
    el.addEventListener('input', () => {
      el.dataset.userEdited = '1';
    }, { once: false });
  });

  const $errBanner = document.getElementById('elecFetchError');
  if ($errBanner) { $errBanner.style.display = 'none'; }

  const regions = [...new Set(tariffs.map(t=>t.region))].sort();
  $region.innerHTML = '<option value="">Select regionâ€¦</option>' + regions.map(r=>`<option>${r}</option>`).join('');

  $region.addEventListener('change', syncRetailers);
  $retailer.addEventListener('change', syncPlans);
  $plan.addEventListener('change', applyTariffToInputs);

  function syncRetailers(){
    const subset = tariffs.filter(t=>!$region.value || t.region===$region.value);
    const retailers = [...new Set(subset.map(t=>t.retailer))].sort();
    $retailer.innerHTML = '<option value="">Select retailerâ€¦</option>' + retailers.map(r=>`<option>${r}</option>`).join('');
    $retailer.disabled = retailers.length===0;
    if (retailers.length === 1) { $retailer.value = retailers[0]; }
    $plan.innerHTML = '<option value="">Select planâ€¦</option>';
    $plan.disabled = true;
    syncPlans();
  }

  function syncPlans(){
    const subset = tariffs.filter(t=>(!$region.value || t.region===$region.value) && t.retailer===$retailer.value);
    const plans = [...new Set(subset.map(t=>t.plan))];
    $plan.innerHTML = '<option value="">Select planâ€¦</option>' + plans.map(p=>`<option>${p}</option>`).join('');
    $plan.disabled = plans.length===0;
    if (plans.length === 1) {
      $plan.value = plans[0];
      applyTariffToInputs();
    }
    if (plans.includes($plan.value)) {
      applyTariffToInputs();
    }
  }

  function applyTariffToInputs(){
    const t = tariffs.find(x => (!$region.value || x.region===$region.value) && x.retailer===$retailer.value && x.plan===$plan.value);
    console.log('[Elec] Applying tariff from JSON', t);
    if (!t) return;

    const setRate = (el, value) => {
      if (!el || el.dataset.userEdited) return;
      if (value === undefined || value === null || value === '') return;
      const num = Number(value);
      if (!Number.isFinite(num)) return;
      el.value = num;
    };

    if (t.type === 'flat') {
      const flatVal = t.flat_c_per_kWh ?? t.on_c_per_kWh ?? t.onPeakRate ?? t.on ?? null;
      setRate($flat, flatVal);
      setRate($on, t.on_c_per_kWh ?? flatVal);
      setRate($off, t.off_c_per_kWh ?? flatVal);
      setRate($sh, t.shoulder_c_per_kWh);
    } else {
      setRate($flat, t.flat_c_per_kWh);
      setRate($on, t.on_c_per_kWh ?? t.onPeakRate ?? t.on);
      setRate($off, t.off_c_per_kWh ?? t.offPeakRate ?? t.off);
      setRate($sh, t.shoulder_c_per_kWh ?? t.shoulder);
    }

    console.log('[Elec] Set rates â†’ flat:', $flat?.value, 'on:', $on?.value, 'off:', $off?.value, 'shoulder:', $sh?.value);
  }

  syncRetailers();
  try { applyTariffToInputs(); } catch(_) {}
}

const startElecTariffs = () => initElecTariffs().catch(err => console.warn('initElecTariffs failed', err));
if (document.readyState === 'complete') {
  startElecTariffs();
} else {
  window.addEventListener('load', startElecTariffs);
}
  </script>
</body>
</html>
