<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electricity Cost Calculator</title>
  <link rel="stylesheet" href="../../assets/cea.css">
  <link rel="stylesheet" href="../../shared/hoa-calcs.css">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>


        #ecalc {
            --bg: #FDFBF4;
            --text: #333;
            --heading: #2D5C4E;
            --btn: #2D5C4E;
            --btn-hover: #A76DAB;
            --btn-text: #fff;
            --card: #fff;
            --card-border: #E7E5DC;
            --icon: #2D5C4E;
            --err: #BE5C5C;
            position: relative;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100%;
        }

        #ecalc * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #ecalc .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }

        #ecalc .container > * {
            position: relative;
            z-index: 2;
        }

        #ecalc .wm-img {
            position: absolute;
            right: -28px;
            bottom: -28px;
            width: 220px;
            opacity: 0.06;
            pointer-events: none;
            user-select: none;
            filter: saturate(0.9) contrast(0.95);
            z-index: 1;
        }

        #ecalc .header {
            text-align: center;
            padding: 40px 20px 32px 20px;
            margin: 0 0 32px 0;
        }

        #ecalc .header h1 {
            margin: 0 0 8px 0;
            font-size: clamp(26px, 3.2vw, 36px);
            font-weight: 800;
            color: #2D5C4E;
            line-height: 1.2;
        }

        #ecalc .header .subtitle {
            font-size: 14px;
            font-weight: 400;
            color: #456E62;
            margin: 8px 0 0 0;
            line-height: 1.4;
        }

        #ecalc .section {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--card-border);
        }

        #ecalc .section-title {
            display: flex;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 20px;
            align-items: center;
            gap: 8px;
        }

        #ecalc .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        #ecalc .form-group {
            display: flex;
            flex-direction: column;
        }

        #ecalc .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        #ecalc .form-group input, 
        #ecalc .form-group select {
            padding: 12px;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: var(--card);
            color: var(--text);
        }

        #ecalc .form-group input:focus, 
        #ecalc .form-group select:focus {
            outline: none;
            border-color: var(--heading);
            box-shadow: 0 0 0 3px rgba(45, 92, 78, 0.1);
        }

        #ecalc .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }

        #ecalc .toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #ecalc .toggle.active {
            background: var(--btn);
        }

        #ecalc .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--card);
            border-radius: 50%;
            transition: transform 0.2s;
        }

        #ecalc .toggle.active .toggle-slider {
            transform: translateX(24px);
        }

        #ecalc .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            gap: 8px;
            text-align: center;
            white-space: nowrap;
        }

        #ecalc .btn-primary {
            background: var(--btn);
            color: var(--btn-text);
        }

        #ecalc .btn-primary:hover {
            background: var(--btn-hover);
            transform: translateY(-1px);
        }

        #ecalc .btn-secondary {
            background: #6b7280;
            color: var(--btn-text);
        }

        #ecalc .btn-secondary:hover {
            background: #4b5563;
        }

        #ecalc .btn-success {
            background: #10b981;
            color: var(--btn-text);
        }

        #ecalc .btn-success:hover {
            background: #059669;
        }

        #ecalc .btn-danger {
            background: var(--err);
            color: var(--btn-text);
        }

        #ecalc .btn-danger:hover {
            background: #a04545;
        }

        #ecalc .equipment-card {
            background: var(--card);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
        }

        #ecalc .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #ecalc .equipment-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--heading);
        }

        #ecalc .remove-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--err);
            color: var(--btn-text);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        #ecalc .time-range {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        #ecalc .time-input {
            padding: 8px;
            border: 1px solid var(--card-border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card);
            color: var(--text);
        }

        #ecalc .days-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        #ecalc .day-btn {
            padding: 8px 12px;
            border: 2px solid var(--card-border);
            background: var(--card);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: var(--text);
        }

        #ecalc .day-btn.active {
            background: var(--btn);
            color: var(--btn-text);
            border-color: var(--btn);
        }

        #ecalc .results-section {
            background: var(--card);
            border: 2px solid var(--heading);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        #ecalc .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        #ecalc .result-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--card-border);
        }

        #ecalc .result-label {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 4px;
            opacity: 0.7;
        }

        #ecalc .result-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--heading);
        }

        #ecalc .error-message {
            background: #fef2f2;
            border: 1px solid var(--err);
            color: var(--err);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        #ecalc .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #ecalc .modal.show {
            display: flex;
        }

        #ecalc .modal-content {
            background: var(--card);
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid var(--card-border);
            position: relative;
            z-index: 1001;
        }

        #ecalc .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        #ecalc .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--heading);
        }

        #ecalc .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
        }

        #ecalc .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            #ecalc .wm-img {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            #ecalc .container {
                margin: 10px;
                padding: 16px;
            }
            
            #ecalc .header {
                padding: 30px 16px 20px 16px;
                margin: 0 0 20px 0;
            }
            
            #ecalc .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            #ecalc .time-range {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            #ecalc .time-range span {
                text-align: center;
                font-weight: 500;
            }
            
            #ecalc .days-selector {
                gap: 6px;
            }
            
            #ecalc .day-btn {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            #ecalc .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            #ecalc .result-item {
                padding: 12px;
            }
            
            #ecalc .result-value {
                font-size: 16px;
            }
            
            #ecalc .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            #ecalc .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            #ecalc .section {
                padding: 16px;
            }
            
            #ecalc .equipment-card {
                padding: 16px;
            }
        }
        
        @media (max-width: 480px) {
            #ecalc .header h1 {
                font-size: 1.7rem;
            }
            
            #ecalc .header .subtitle {
                font-size: 0.85rem;
            }
            
            #ecalc .section-title {
                font-size: 1.2rem;
            }
            
            #ecalc .results-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            #ecalc .days-selector {
                justify-content: center;
            }
            
            #ecalc .time-range .btn-danger {
                padding: 2px 6px;
                font-size: 10px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="hoa-calc" id="ecalc">
   <div class="container"><img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="">
    <div class="header">
     <h1 id="app-title">Electricity Cost Calculator</h1>
     <p class="subtitle">Calculate your energy usage and cost breakdown</p>
    </div><!-- Rate Configuration -->
    <div class="section">
     <h2 class="section-title">âš¡ Rate Configuration</h2>
     <div class="form-grid">
      <div class="form-group"><label for="on-peak-rate">On-Peak Rate (c/kWh)</label> <input type="number" id="on-peak-rate" min="0" step="0.01" value="25.5" placeholder="25.5">
      </div>
      <div class="form-group"><label for="off-peak-rate">Off-Peak Rate (c/kWh)</label> <input type="number" id="off-peak-rate" min="0" step="0.01" value="15.2" placeholder="15.2">
      </div>
     </div>
     <div class="toggle-container"><span>Round to 2 decimals</span>
      <div class="toggle active" id="rounding-toggle">
       <div class="toggle-slider"></div>
      </div><span>Show up to 6 decimals</span>
     </div><button class="btn btn-secondary" id="fetch-tariffs-btn" style="margin-top: 16px;"> ðŸ“‹ Fetch Tariffs </button>
    </div><!-- Tariff Schedule -->
    <div class="section">
     <h2 class="section-title">ðŸ“… Tariff Schedule</h2>
     <div id="tariff-schedule">
      <div class="tariff-type" data-type="on-peak">
       <h3 style="color: #dc2626; margin-bottom: 16px;">On-Peak Times</h3>
       <div class="tariff-ranges" id="on-peak-ranges">
        <div class="time-range"><input type="time" class="time-input" value="15:00"> <span>to</span> <input type="time" class="time-input" value="21:00"> <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
        </div>
       </div><button class="btn btn-secondary" onclick="addTimeRange('on-peak-ranges')" style="margin-bottom: 12px;">+ Add Time Range</button>
       <div class="days-selector"><button class="day-btn active" data-day="1">Mon</button> <button class="day-btn active" data-day="2">Tue</button> <button class="day-btn active" data-day="3">Wed</button> <button class="day-btn active" data-day="4">Thu</button> <button class="day-btn active" data-day="5">Fri</button> <button class="day-btn" data-day="6">Sat</button> <button class="day-btn" data-day="0">Sun</button>
       </div>
      </div>
      <div class="tariff-type" data-type="off-peak" style="margin-top: 24px;">
       <h3 style="color: #059669; margin-bottom: 16px;">Off-Peak Times</h3>
       <div class="tariff-ranges" id="off-peak-ranges">
        <div class="time-range"><input type="time" class="time-input" value="21:00"> <span>to</span> <input type="time" class="time-input" value="15:00"> <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
        </div>
       </div><button class="btn btn-secondary" onclick="addTimeRange('off-peak-ranges')" style="margin-bottom: 12px;">+ Add Time Range</button>
       <div class="days-selector"><button class="day-btn active" data-day="1">Mon</button> <button class="day-btn active" data-day="2">Tue</button> <button class="day-btn active" data-day="3">Wed</button> <button class="day-btn active" data-day="4">Thu</button> <button class="day-btn active" data-day="5">Fri</button> <button class="day-btn active" data-day="6">Sat</button> <button class="day-btn active" data-day="0">Sun</button>
       </div>
      </div>
     </div>
     <div id="tariff-errors"></div>
    </div><!-- Equipment Section -->
    <div class="section">
     <h2 class="section-title">ðŸ”Œ Equipment</h2><button class="btn btn-primary" id="add-equipment-btn">+ Add Equipment</button>
     <div id="equipment-list"></div>
     <div id="equipment-errors"></div>
    </div><!-- Calculate Button -->
    <div style="text-align: center; margin: 32px 0;"><button class="btn btn-success" id="calculate-btn" style="font-size: 18px; padding: 16px 32px; margin-right: 16px;"> ðŸ§® Calculate Costs </button>
    </div><!-- Results -->
    <div id="results-container" style="display: none;"></div>
   </div><!-- Tariff Fetch Modal -->
   <div class="modal" id="tariff-modal">
    <div class="modal-content">
     <div class="modal-header">
      <h3 class="modal-title">Fetch Tariff Data</h3><button class="close-btn" onclick="closeTariffModal()">Ã—</button>
     </div>
     <div class="form-group"><label for="retailer-select">Retailer</label> <select id="retailer-select"> <option value="">Select Retailer</option> <option value="actew">ActewAGL (ACT)</option> <option value="agl">AGL</option> <option value="alinta">Alinta Energy</option> <option value="amber">Amber Electric</option> <option value="aurora">Aurora Energy (TAS)</option> <option value="energyaustralia">Energy Australia</option> <option value="ergon">Ergon Energy (QLD)</option> <option value="energex">Energex (QLD)</option> <option value="horizon">Horizon Power (WA)</option> <option value="lumo">Lumo Energy</option> <option value="momentum">Momentum Energy</option> <option value="origin">Origin Energy</option> <option value="powershop">Powershop</option> <option value="red">Red Energy</option> <option value="sapowernetworks">SA Power Networks (SA)</option> <option value="simply">Simply Energy</option> <option value="synergy">Synergy (WA)</option> </select>
     </div>
     <div class="form-group"><label for="plan-select">Plan</label> <select id="plan-select"> <option value="">Select Plan</option> </select>
     </div>
     <div class="form-group"><label for="region-select">State/Network</label> <select id="region-select"> <option value="">Select Region</option> <option value="nsw">NSW</option> <option value="vic">VIC</option> <option value="qld">QLD</option> <option value="sa">SA</option> <option value="wa">WA</option> <option value="tas">TAS</option> <option value="act">ACT</option> </select>
     </div>
     <div style="display: flex; gap: 12px; margin-top: 24px;"><button class="btn btn-primary" onclick="fetchTariffData()">Fetch Data</button> <button class="btn btn-secondary" onclick="closeTariffModal()">Cancel</button>
     </div>
     <div id="fetch-status" style="margin-top: 16px;"></div>
    </div>
   </div>
  </div>
  <script>
        // Configuration object for Element SDK
        const defaultConfig = {
            app_title: "Electricity Cost Calculator",
            footer_text: "Hydro Oasis â€¢ Electricity Cost Calculator"
        };

        let equipmentCounter = 0;
        let roundingEnabled = true;

        // Initialize SDKs
        async function initializeSDKs() {
            // Initialize Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async (config) => {
                        const titleElement = document.getElementById('app-title');
                        if (titleElement) {
                            titleElement.textContent = config.app_title || defaultConfig.app_title;
                        }
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["app_title", config.app_title || defaultConfig.app_title],
                        ["footer_text", config.footer_text || defaultConfig.footer_text]
                    ])
                });
            }
        }

        // Initialize SDKs when page loads
        initializeSDKs();

        // Time overlap calculation engine
        function normalizeTimeRange(start, end) {
            const startMinutes = timeToMinutes(start);
            const endMinutes = timeToMinutes(end);
            
            if (startMinutes <= endMinutes) {
                return [{ start: startMinutes, end: endMinutes }];
            } else {
                // Range crosses midnight
                return [
                    { start: startMinutes, end: 1440 }, // Until midnight
                    { start: 0, end: endMinutes }       // From midnight
                ];
            }
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function mergeOverlappingRanges(ranges) {
            if (ranges.length === 0) return [];
            
            ranges.sort((a, b) => a.start - b.start);
            const merged = [ranges[0]];
            
            for (let i = 1; i < ranges.length; i++) {
                const current = ranges[i];
                const last = merged[merged.length - 1];
                
                if (current.start <= last.end) {
                    last.end = Math.max(last.end, current.end);
                } else {
                    merged.push(current);
                }
            }
            
            return merged;
        }

        function calculateOverlap(ranges1, ranges2) {
            let totalOverlap = 0;
            
            for (const range1 of ranges1) {
                for (const range2 of ranges2) {
                    const overlapStart = Math.max(range1.start, range2.start);
                    const overlapEnd = Math.min(range1.end, range2.end);
                    
                    if (overlapStart < overlapEnd) {
                        totalOverlap += overlapEnd - overlapStart;
                    }
                }
            }
            
            return totalOverlap / 60; // Convert to hours
        }

        // Equipment management
        function addEquipment() {
            equipmentCounter++;
            const equipmentList = document.getElementById('equipment-list');
            
            const equipmentCard = document.createElement('div');
            equipmentCard.className = 'equipment-card';
            equipmentCard.dataset.id = equipmentCounter;
            
            equipmentCard.innerHTML = `
                <button class="remove-btn" onclick="removeEquipment(${equipmentCounter})">Ã—</button>
                <div class="equipment-header">
                    <div class="equipment-title">Equipment ${equipmentCounter}</div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Equipment Name</label>
                        <input type="text" class="equipment-name" placeholder="e.g., Air Conditioner" value="Equipment ${equipmentCounter}">
                    </div>
                    <div class="form-group">
                        <label>Power (W)</label>
                        <input type="number" class="equipment-power" min="0" step="0.1" placeholder="1500" value="1500">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Daily kWh Cap (optional note)</label>
                    <input type="text" class="equipment-cap" placeholder="e.g., Max 8 hours per day">
                </div>
                
                <h4 style="margin: 20px 0 12px 0; color: #4f46e5;">Operating Schedule</h4>
                <div class="equipment-ranges">
                    <div class="time-range">
                        <input type="time" class="time-input" value="09:00">
                        <span>to</span>
                        <input type="time" class="time-input" value="17:00">
                        <button class="btn btn-danger" onclick="removeEquipmentTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addEquipmentTimeRange(${equipmentCounter})" style="margin-bottom: 12px;">+ Add Time Range</button>
                
                <div class="days-selector">
                    <button class="day-btn active" data-day="1">Mon</button>
                    <button class="day-btn active" data-day="2">Tue</button>
                    <button class="day-btn active" data-day="3">Wed</button>
                    <button class="day-btn active" data-day="4">Thu</button>
                    <button class="day-btn active" data-day="5">Fri</button>
                    <button class="day-btn" data-day="6">Sat</button>
                    <button class="day-btn" data-day="0">Sun</button>
                </div>
                
                <div class="equipment-results" style="display: none; margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                    <div class="results-grid"></div>
                </div>
            `;
            
            equipmentList.appendChild(equipmentCard);
            
            // Add event listeners for day buttons
            equipmentCard.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
        }

        function removeEquipment(id) {
            const equipment = document.querySelector(`[data-id="${id}"]`);
            if (equipment) {
                equipment.remove();
            }
        }

        function addEquipmentTimeRange(equipmentId) {
            const equipment = document.querySelector(`[data-id="${equipmentId}"]`);
            const rangesContainer = equipment.querySelector('.equipment-ranges');
            
            const timeRange = document.createElement('div');
            timeRange.className = 'time-range';
            timeRange.innerHTML = `
                <input type="time" class="time-input" value="09:00">
                <span>to</span>
                <input type="time" class="time-input" value="17:00">
                <button class="btn btn-danger" onclick="removeEquipmentTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
            `;
            
            rangesContainer.appendChild(timeRange);
        }

        function removeEquipmentTimeRange(btn) {
            btn.parentElement.remove();
        }

        // Tariff schedule management
        function addTimeRange(containerId) {
            const container = document.getElementById(containerId);
            const timeRange = document.createElement('div');
            timeRange.className = 'time-range';
            timeRange.innerHTML = `
                <input type="time" class="time-input" value="09:00">
                <span>to</span>
                <input type="time" class="time-input" value="17:00">
                <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
            `;
            
            container.appendChild(timeRange);
        }

        function removeTimeRange(btn) {
            btn.parentElement.remove();
        }

        // Tariff fetching
        function openTariffModal() {
            const modal = document.getElementById('tariff-modal');
            modal.classList.add('show');
        }

        function closeTariffModal() {
            const modal = document.getElementById('tariff-modal');
            modal.classList.remove('show');
        }

        function fetchTariffData() {
            const retailer = document.getElementById('retailer-select').value;
            const plan = document.getElementById('plan-select').value;
            const region = document.getElementById('region-select').value;
            
            if (!retailer || !plan || !region) {
                document.getElementById('fetch-status').innerHTML = 
                    '<div class="error-message">Please select all fields</div>';
                return;
            }
            
            document.getElementById('fetch-status').innerHTML = 
                '<div style="color: #4f46e5;">Fetching tariff data...</div>';
            
            // Simulate API call with comprehensive Australian tariff data
            setTimeout(() => {
                // Current Australian electricity tariff data (November 2, 2025)
                const sampleTariffs = {
                    // NSW Retailers
                    origin: {
                        'basic-plan': {
                            onPeakRate: 35.84, offPeakRate: 35.84, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'time-of-use': {
                            onPeakRate: 54.72, offPeakRate: 21.18,
                            onPeakTimes: [{ start: '14:00', end: '20:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '20:00', end: '14:00', days: [0,1,2,3,4,5,6] }]
                        }
                    },
                    agl: {
                        'basic-plan': {
                            onPeakRate: 35.26, offPeakRate: 35.26, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'time-of-use': {
                            onPeakRate: 53.17, offPeakRate: 20.84,
                            onPeakTimes: [{ start: '14:00', end: '20:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '20:00', end: '14:00', days: [0,1,2,3,4,5,6] }]
                        }
                    },
                    energyaustralia: {
                        'basic-plan': {
                            onPeakRate: 36.12, offPeakRate: 36.12, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'time-of-use': {
                            onPeakRate: 55.31, offPeakRate: 21.56,
                            onPeakTimes: [{ start: '14:00', end: '20:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '20:00', end: '14:00', days: [0,1,2,3,4,5,6] }]
                        }
                    },
                    red: {
                        'living-energy': {
                            onPeakRate: 33.67, offPeakRate: 33.67, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    amber: {
                        'wholesale-plan': {
                            onPeakRate: 42.15, offPeakRate: 18.92,
                            onPeakTimes: [{ start: '16:00', end: '21:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '21:00', end: '16:00', days: [0,1,2,3,4,5,6] }]
                        }
                    },
                    
                    // VIC Retailers
                    lumo: {
                        'basic-plan': {
                            onPeakRate: 30.47, offPeakRate: 30.47, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'time-of-use': {
                            onPeakRate: 38.34, offPeakRate: 20.23,
                            onPeakTimes: [{ start: '15:00', end: '21:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '21:00', end: '15:00', days: [0,1,2,3,4,5,6] }]
                        }
                    },
                    alinta: {
                        'home-deal': {
                            onPeakRate: 30.08, offPeakRate: 30.08, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    momentum: {
                        'classic-plan': {
                            onPeakRate: 30.33, offPeakRate: 30.33, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    simply: {
                        'simply-save': {
                            onPeakRate: 31.49, offPeakRate: 31.49, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    powershop: {
                        'standard-plan': {
                            onPeakRate: 30.93, offPeakRate: 30.93, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    
                    // QLD Retailers
                    ergon: {
                        'tariff-11': {
                            onPeakRate: 31.38, offPeakRate: 31.38, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'tariff-12': {
                            onPeakRate: 35.49, offPeakRate: 24.26,
                            onPeakTimes: [{ start: '07:00', end: '09:00', days: [1,2,3,4,5] }, { start: '17:00', end: '20:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '20:00', end: '07:00', days: [0,1,2,3,4,5,6] }, { start: '09:00', end: '17:00', days: [1,2,3,4,5] }]
                        }
                    },
                    energex: {
                        'tariff-11': {
                            onPeakRate: 31.38, offPeakRate: 31.38, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    
                    // SA Retailers
                    sapowernetworks: {
                        'flexible-tariff': {
                            onPeakRate: 52.34, offPeakRate: 14.26,
                            onPeakTimes: [{ start: '15:00', end: '21:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '21:00', end: '15:00', days: [0,1,2,3,4,5,6] }]
                        },
                        'single-rate': {
                            onPeakRate: 43.96, offPeakRate: 43.96, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    
                    // WA Retailers
                    synergy: {
                        'a1-tariff': {
                            onPeakRate: 33.64, offPeakRate: 33.64, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'a2-tariff': {
                            onPeakRate: 59.72, offPeakRate: 16.82,
                            onPeakTimes: [{ start: '15:00', end: '21:00', days: [1,2,3,4,5] }, { start: '15:00', end: '21:00', days: [6,0] }],
                            offPeakTimes: [{ start: '21:00', end: '15:00', days: [0,1,2,3,4,5,6] }]
                        }
                    },
                    horizon: {
                        'standard-tariff': {
                            onPeakRate: 59.35, offPeakRate: 59.35, // Flat rate (regional WA)
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        }
                    },
                    
                    // TAS Retailers
                    aurora: {
                        'residential-tariff': {
                            onPeakRate: 31.59, offPeakRate: 31.59, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'time-of-use': {
                            onPeakRate: 38.52, offPeakRate: 19.26,
                            onPeakTimes: [{ start: '07:00', end: '10:00', days: [1,2,3,4,5] }, { start: '16:00', end: '19:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '19:00', end: '07:00', days: [0,1,2,3,4,5,6] }, { start: '10:00', end: '16:00', days: [1,2,3,4,5] }]
                        }
                    },
                    
                    // ACT Retailers
                    actew: {
                        'standard-tariff': {
                            onPeakRate: 28.12, offPeakRate: 28.12, // Flat rate
                            onPeakTimes: [{ start: '00:00', end: '23:59', days: [0,1,2,3,4,5,6] }],
                            offPeakTimes: []
                        },
                        'time-of-use': {
                            onPeakRate: 32.09, offPeakRate: 19.26,
                            onPeakTimes: [{ start: '07:00', end: '09:00', days: [1,2,3,4,5] }, { start: '17:00', end: '20:00', days: [1,2,3,4,5] }],
                            offPeakTimes: [{ start: '20:00', end: '07:00', days: [0,1,2,3,4,5,6] }, { start: '09:00', end: '17:00', days: [1,2,3,4,5] }]
                        }
                    }
                };
                
                const tariffData = sampleTariffs[retailer]?.[plan];
                
                if (tariffData) {
                    // Update rates
                    document.getElementById('on-peak-rate').value = tariffData.onPeakRate;
                    document.getElementById('off-peak-rate').value = tariffData.offPeakRate;
                    
                    // Clear existing time ranges
                    document.getElementById('on-peak-ranges').innerHTML = '';
                    document.getElementById('off-peak-ranges').innerHTML = '';
                    
                    // Populate on-peak time ranges
                    tariffData.onPeakTimes.forEach(timeRange => {
                        const rangeDiv = document.createElement('div');
                        rangeDiv.className = 'time-range';
                        rangeDiv.innerHTML = `
                            <input type="time" class="time-input" value="${timeRange.start}">
                            <span>to</span>
                            <input type="time" class="time-input" value="${timeRange.end}">
                            <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
                        `;
                        document.getElementById('on-peak-ranges').appendChild(rangeDiv);
                    });
                    
                    // Populate off-peak time ranges
                    tariffData.offPeakTimes.forEach(timeRange => {
                        const rangeDiv = document.createElement('div');
                        rangeDiv.className = 'time-range';
                        rangeDiv.innerHTML = `
                            <input type="time" class="time-input" value="${timeRange.start}">
                            <span>to</span>
                            <input type="time" class="time-input" value="${timeRange.end}">
                            <button class="btn btn-danger" onclick="removeTimeRange(this)" style="padding: 4px 8px; font-size: 12px;">Ã—</button>
                        `;
                        document.getElementById('off-peak-ranges').appendChild(rangeDiv);
                    });
                    
                    // Update day selections for on-peak
                    const onPeakDayBtns = document.querySelector('[data-type="on-peak"] .days-selector').querySelectorAll('.day-btn');
                    onPeakDayBtns.forEach(btn => {
                        const dayValue = parseInt(btn.dataset.day);
                        if (tariffData.onPeakTimes.some(range => range.days.includes(dayValue))) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    
                    // Update day selections for off-peak
                    const offPeakDayBtns = document.querySelector('[data-type="off-peak"] .days-selector').querySelectorAll('.day-btn');
                    offPeakDayBtns.forEach(btn => {
                        const dayValue = parseInt(btn.dataset.day);
                        if (tariffData.offPeakTimes.some(range => range.days.includes(dayValue))) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    
                    document.getElementById('fetch-status').innerHTML = 
                        '<div style="color: #10b981;">Tariff data and time ranges loaded successfully!</div>';
                    
                    setTimeout(() => {
                        closeTariffModal();
                    }, 1500);
                } else {
                    document.getElementById('fetch-status').innerHTML = 
                        '<div class="error-message">Tariff data not available for this combination</div>';
                }
            }, 1500);
        }

        // Validation functions
        function validateInputs() {
            const errors = [];
            
            // Validate rates
            const onPeakRate = parseFloat(document.getElementById('on-peak-rate').value);
            const offPeakRate = parseFloat(document.getElementById('off-peak-rate').value);
            
            if (!onPeakRate || onPeakRate <= 0) {
                errors.push('On-peak rate must be greater than 0');
            }
            
            if (!offPeakRate || offPeakRate <= 0) {
                errors.push('Off-peak rate must be greater than 0');
            }
            
            // Validate equipment
            const equipmentCards = document.querySelectorAll('.equipment-card');
            if (equipmentCards.length === 0) {
                errors.push('At least one equipment must be added');
            }
            
            equipmentCards.forEach((card, index) => {
                const power = parseFloat(card.querySelector('.equipment-power').value);
                if (!power || power <= 0) {
                    errors.push(`Equipment ${index + 1}: Power must be greater than 0`);
                }
                
                // Validate time ranges
                const timeRanges = card.querySelectorAll('.time-range');
                timeRanges.forEach((range, rangeIndex) => {
                    const inputs = range.querySelectorAll('.time-input');
                    const start = inputs[0].value;
                    const end = inputs[1].value;
                    
                    if (!start || !end) {
                        errors.push(`Equipment ${index + 1}, Range ${rangeIndex + 1}: Both start and end times required`);
                    }
                });
                
                // Check if at least one day is selected
                const activeDays = card.querySelectorAll('.day-btn.active');
                if (activeDays.length === 0) {
                    errors.push(`Equipment ${index + 1}: At least one day must be selected`);
                }
            });
            
            return errors;
        }

        // Main calculation function
        function calculateCosts() {
            const errors = validateInputs();
            
            // Clear previous errors
            document.getElementById('equipment-errors').innerHTML = '';
            document.getElementById('tariff-errors').innerHTML = '';
            
            if (errors.length > 0) {
                document.getElementById('equipment-errors').innerHTML = 
                    errors.map(error => `<div class="error-message">${error}</div>`).join('');
                document.getElementById('results-container').style.display = 'none';
                return;
            }
            
            const onPeakRate = parseFloat(document.getElementById('on-peak-rate').value) / 100; // Convert c/kWh to $/kWh
            const offPeakRate = parseFloat(document.getElementById('off-peak-rate').value) / 100;
            
            // Get tariff schedules
            const onPeakSchedule = getTariffSchedule('on-peak');
            const offPeakSchedule = getTariffSchedule('off-peak');
            
            let totalResults = {
                dailyKwh: 0,
                weeklyKwh: 0,
                monthlyKwh: 0,
                yearlyKwh: 0,
                dailyCost: 0,
                weeklyCost: 0,
                monthlyCost: 0,
                yearlyCost: 0,
                onPeakHours: 0,
                offPeakHours: 0
            };
            
            // Calculate for each equipment
            document.querySelectorAll('.equipment-card').forEach(card => {
                const power = parseFloat(card.querySelector('.equipment-power').value) / 1000; // Convert W to kW
                const equipmentSchedule = getEquipmentSchedule(card);
                const selectedDays = getSelectedDays(card);
                
                // Calculate total weekly hours for this equipment
                let totalWeeklyOnPeakHours = 0;
                let totalWeeklyOffPeakHours = 0;
                
                selectedDays.forEach(day => {
                    const dayOnPeakSchedule = onPeakSchedule.filter(s => s.days.includes(day));
                    const dayOffPeakSchedule = offPeakSchedule.filter(s => s.days.includes(day));
                    
                    // Normalize equipment schedule for this day
                    let equipmentRanges = [];
                    equipmentSchedule.forEach(range => {
                        equipmentRanges = equipmentRanges.concat(normalizeTimeRange(range.start, range.end));
                    });
                    equipmentRanges = mergeOverlappingRanges(equipmentRanges);
                    
                    // Calculate on-peak overlap for this day
                    dayOnPeakSchedule.forEach(tariffRange => {
                        let tariffRanges = normalizeTimeRange(tariffRange.start, tariffRange.end);
                        tariffRanges = mergeOverlappingRanges(tariffRanges);
                        totalWeeklyOnPeakHours += calculateOverlap(equipmentRanges, tariffRanges);
                    });
                    
                    // Calculate off-peak overlap for this day
                    dayOffPeakSchedule.forEach(tariffRange => {
                        let tariffRanges = normalizeTimeRange(tariffRange.start, tariffRange.end);
                        tariffRanges = mergeOverlappingRanges(tariffRanges);
                        totalWeeklyOffPeakHours += calculateOverlap(equipmentRanges, tariffRanges);
                    });
                });
                
                // Calculate daily averages
                const dailyOnPeakHours = totalWeeklyOnPeakHours / 7;
                const dailyOffPeakHours = totalWeeklyOffPeakHours / 7;
                
                // Calculate consumption and costs
                const dailyKwh = power * (dailyOnPeakHours + dailyOffPeakHours);
                const weeklyKwh = power * (totalWeeklyOnPeakHours + totalWeeklyOffPeakHours);
                const monthlyKwh = weeklyKwh * (365.25 / 12 / 7); // More accurate monthly calculation
                const yearlyKwh = weeklyKwh * (365.25 / 7); // More accurate yearly calculation
                
                const dailyCost = power * (dailyOnPeakHours * onPeakRate + dailyOffPeakHours * offPeakRate);
                const weeklyCost = power * (totalWeeklyOnPeakHours * onPeakRate + totalWeeklyOffPeakHours * offPeakRate);
                const monthlyCost = weeklyCost * (365.25 / 12 / 7);
                const yearlyCost = weeklyCost * (365.25 / 7);
                
                // Store equipment results for later display (but don't show under each equipment)
                const resultsContainer = card.querySelector('.equipment-results .results-grid');
                resultsContainer.innerHTML = `
                    <div class="result-item">
                        <div class="result-label">On-Peak Hours/Day</div>
                        <div class="result-value">${formatNumber(dailyOnPeakHours)}h</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Off-Peak Hours/Day</div>
                        <div class="result-value">${formatNumber(dailyOffPeakHours)}h</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Daily kWh</div>
                        <div class="result-value">${formatNumber(dailyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Weekly kWh</div>
                        <div class="result-value">${formatNumber(weeklyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly kWh</div>
                        <div class="result-value">${formatNumber(monthlyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Yearly kWh</div>
                        <div class="result-value">${formatNumber(yearlyKwh)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Daily Cost</div>
                        <div class="result-value">$${formatNumber(dailyCost)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Weekly Cost</div>
                        <div class="result-value">$${formatNumber(weeklyCost)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly Cost</div>
                        <div class="result-value">$${formatNumber(monthlyCost)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Yearly Cost</div>
                        <div class="result-value">$${formatNumber(yearlyCost)}</div>
                    </div>
                `;
                
                // Keep equipment results hidden under each equipment card
                card.querySelector('.equipment-results').style.display = 'none';
                
                // Add to totals
                totalResults.dailyKwh += dailyKwh;
                totalResults.weeklyKwh += weeklyKwh;
                totalResults.monthlyKwh += monthlyKwh;
                totalResults.yearlyKwh += yearlyKwh;
                totalResults.dailyCost += dailyCost;
                totalResults.weeklyCost += weeklyCost;
                totalResults.monthlyCost += monthlyCost;
                totalResults.yearlyCost += yearlyCost;
                totalResults.onPeakHours += dailyOnPeakHours;
                totalResults.offPeakHours += dailyOffPeakHours;
            });
            
            // Display results
            displayTotalResults(totalResults);
        }

        function getTariffSchedule(type) {
            const container = document.getElementById(`${type}-ranges`);
            const ranges = container.querySelectorAll('.time-range');
            const schedule = [];
            
            ranges.forEach(range => {
                const inputs = range.querySelectorAll('.time-input');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                if (start && end) {
                    schedule.push({ start, end });
                }
            });
            
            // Get selected days for this tariff type
            const tariffSection = container.closest('.tariff-type');
            const selectedDays = [];
            tariffSection.querySelectorAll('.day-btn.active').forEach(btn => {
                selectedDays.push(parseInt(btn.dataset.day));
            });
            
            return schedule.map(range => ({ ...range, days: selectedDays }));
        }

        function getEquipmentSchedule(card) {
            const ranges = card.querySelectorAll('.equipment-ranges .time-range');
            const schedule = [];
            
            ranges.forEach(range => {
                const inputs = range.querySelectorAll('.time-input');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                if (start && end) {
                    schedule.push({ start, end });
                }
            });
            
            return schedule;
        }

        function getSelectedDays(card) {
            const selectedDays = [];
            card.querySelectorAll('.day-btn.active').forEach(btn => {
                selectedDays.push(parseInt(btn.dataset.day));
            });
            return selectedDays;
        }

        function formatNumber(num) {
            if (roundingEnabled) {
                return num.toFixed(2);
            } else {
                // Show up to 6 decimals, but trim trailing zeros (minimum 2 decimals)
                let formatted = num.toFixed(6);
                formatted = formatted.replace(/\.?0+$/, '');
                if (!formatted.includes('.')) {
                    formatted += '.00';
                } else if (formatted.split('.')[1].length === 1) {
                    formatted += '0';
                }
                return formatted;
            }
        }

        function displayTotalResults(results) {
            const resultsContainer = document.getElementById('results-container');
            
            // Collect all equipment results
            let equipmentResultsHTML = '';
            document.querySelectorAll('.equipment-card').forEach((card, index) => {
                const name = card.querySelector('.equipment-name').value;
                const power = card.querySelector('.equipment-power').value;
                const resultsGrid = card.querySelector('.equipment-results .results-grid');
                
                if (resultsGrid) {
                    equipmentResultsHTML += `
                        <div class="results-section" style="margin-bottom: 24px;">
                            <h3 class="section-title">ðŸ”Œ ${name} (${power}W)</h3>
                            <div class="results-grid">
                                ${resultsGrid.innerHTML}
                            </div>
                        </div>
                    `;
                }
            });
            
            resultsContainer.innerHTML = `
                ${equipmentResultsHTML}
                
                <div class="results-section">
                    <h2 class="section-title">ðŸ“Š Total Usage & Cost Breakdown</h2>
                    
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-label">On-Peak Hours/Day</div>
                            <div class="result-value">${formatNumber(results.onPeakHours)}h</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Off-Peak Hours/Day</div>
                            <div class="result-value">${formatNumber(results.offPeakHours)}h</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Daily kWh</div>
                            <div class="result-value">${formatNumber(results.dailyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Weekly kWh</div>
                            <div class="result-value">${formatNumber(results.weeklyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Monthly kWh</div>
                            <div class="result-value">${formatNumber(results.monthlyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Yearly kWh</div>
                            <div class="result-value">${formatNumber(results.yearlyKwh)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Daily Cost</div>
                            <div class="result-value">$${formatNumber(results.dailyCost)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Weekly Cost</div>
                            <div class="result-value">$${formatNumber(results.weeklyCost)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Monthly Cost</div>
                            <div class="result-value">$${formatNumber(results.monthlyCost)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Yearly Cost</div>
                            <div class="result-value">${formatNumber(results.yearlyCost)}</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="downloadPDF()">
                            ðŸ“„ Download Results as PDF
                        </button>
                    </div>
                </div>
            `;
            
            resultsContainer.style.display = 'block';
        }

        // PDF Generation
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            
            // Helper function to add new page if needed
            function checkPageBreak(neededSpace) {
                if (yPosition + neededSpace > pageHeight - margin) {
                    doc.addPage();
                    yPosition = 20;
                }
            }
            
            // Title
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            const title = config.app_title || defaultConfig.app_title;
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(title, margin, yPosition);
            yPosition += 15;
            
            // Date
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, yPosition);
            yPosition += 20;
            
            // Tariff Summary
            checkPageBreak(30);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Tariff Summary', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            const onPeakRate = document.getElementById('on-peak-rate').value;
            const offPeakRate = document.getElementById('off-peak-rate').value;
            doc.text(`On-Peak Rate: ${onPeakRate} c/kWh`, margin, yPosition);
            yPosition += 8;
            doc.text(`Off-Peak Rate: ${offPeakRate} c/kWh`, margin, yPosition);
            yPosition += 20;
            
            // Equipment Details
            const equipmentCards = document.querySelectorAll('.equipment-card');
            equipmentCards.forEach((card, index) => {
                checkPageBreak(60);
                
                const name = card.querySelector('.equipment-name').value;
                const power = card.querySelector('.equipment-power').value;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Equipment ${index + 1}: ${name}`, margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Power: ${power}W`, margin, yPosition);
                yPosition += 8;
                
                // Equipment results
                const results = card.querySelector('.equipment-results .results-grid');
                if (results) {
                    const resultItems = results.querySelectorAll('.result-item');
                    resultItems.forEach(item => {
                        const label = item.querySelector('.result-label').textContent;
                        const value = item.querySelector('.result-value').textContent;
                        doc.text(`${label}: ${value}`, margin + 10, yPosition);
                        yPosition += 6;
                    });
                }
                yPosition += 10;
            });
            
            // Total Results
            checkPageBreak(80);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Total Usage & Cost Breakdown', margin, yPosition);
            yPosition += 15;
            
            const totalResults = document.querySelector('#results-container .results-grid');
            if (totalResults) {
                const resultItems = totalResults.querySelectorAll('.result-item');
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                
                resultItems.forEach(item => {
                    checkPageBreak(8);
                    const label = item.querySelector('.result-label').textContent;
                    const value = item.querySelector('.result-value').textContent;
                    doc.text(`${label}: ${value}`, margin, yPosition);
                    yPosition += 8;
                });
            }
            
            // Footer
            const footerText = config.footer_text || defaultConfig.footer_text;
            doc.setFontSize(10);
            doc.text(footerText, margin, pageHeight - 10);
            
            doc.save('ElectricityCostCalculatorResults.pdf');
        }

        // Event Listeners
        document.getElementById('add-equipment-btn').addEventListener('click', addEquipment);
        document.getElementById('calculate-btn').addEventListener('click', calculateCosts);
        document.getElementById('fetch-tariffs-btn').addEventListener('click', openTariffModal);

        document.getElementById('rounding-toggle').addEventListener('click', function() {
            this.classList.toggle('active');
            roundingEnabled = this.classList.contains('active');
            
            // If results are visible, recalculate to update the display
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer.style.display !== 'none') {
                calculateCosts();
            }
        });

        // Add event listeners for tariff day buttons
        document.querySelectorAll('.tariff-type .day-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });

        // Retailer selection handler
        document.getElementById('retailer-select').addEventListener('change', function() {
            const planSelect = document.getElementById('plan-select');
            const regionSelect = document.getElementById('region-select');
            
            planSelect.innerHTML = '<option value="">Select Plan</option>';
            regionSelect.innerHTML = '<option value="">Select Region</option>';
            
            const plans = {
                actew: ['standard-tariff', 'time-of-use'],
                agl: ['basic-plan', 'time-of-use'],
                alinta: ['home-deal'],
                amber: ['wholesale-plan'],
                aurora: ['residential-tariff', 'time-of-use'],
                energyaustralia: ['basic-plan', 'time-of-use'],
                ergon: ['tariff-11', 'tariff-12'],
                energex: ['tariff-11'],
                horizon: ['standard-tariff'],
                lumo: ['basic-plan', 'time-of-use'],
                momentum: ['classic-plan'],
                origin: ['basic-plan', 'time-of-use'],
                powershop: ['standard-plan'],
                red: ['living-energy'],
                sapowernetworks: ['single-rate', 'flexible-tariff'],
                simply: ['simply-save'],
                synergy: ['a1-tariff', 'a2-tariff']
            };
            
            // Define which states each retailer operates in
            const retailerStates = {
                actew: ['act'],
                agl: ['nsw', 'vic', 'qld', 'sa'],
                alinta: ['nsw', 'vic', 'qld', 'sa', 'wa'],
                amber: ['nsw', 'vic', 'qld', 'sa'],
                aurora: ['tas'],
                energyaustralia: ['nsw', 'vic', 'qld', 'sa'],
                ergon: ['qld'],
                energex: ['qld'],
                horizon: ['wa'],
                lumo: ['nsw', 'vic', 'qld', 'sa'],
                momentum: ['nsw', 'vic', 'qld', 'sa'],
                origin: ['nsw', 'vic', 'qld', 'sa'],
                powershop: ['nsw', 'vic', 'qld', 'sa'],
                red: ['nsw', 'vic', 'qld', 'sa'],
                sapowernetworks: ['sa'],
                simply: ['nsw', 'vic', 'qld', 'sa'],
                synergy: ['wa']
            };
            
            const stateNames = {
                nsw: 'NSW',
                vic: 'VIC',
                qld: 'QLD',
                sa: 'SA',
                wa: 'WA',
                tas: 'TAS',
                act: 'ACT'
            };
            
            // Populate plans
            if (plans[this.value]) {
                plans[this.value].forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan;
                    option.textContent = plan.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    planSelect.appendChild(option);
                });
            }
            
            // Populate states based on retailer coverage
            if (retailerStates[this.value]) {
                retailerStates[this.value].forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = stateNames[state];
                    regionSelect.appendChild(option);
                });
            }
        });

        // Initialize with one equipment
        addEquipment();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99881531a63cf0c8',t:'MTc2MjEzMzE3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
  <script src="../../shared/js/hoa-calcs.js"></script>
 </body>
<script>
/* ===== CEA calc core (drop-in) ===== */
const CEA = (() => {
  const BUS = document.createElement('div');
  const on  = (evt, fn) => BUS.addEventListener(evt, fn);
  const emit = (evt, detail) => BUS.dispatchEvent(new CustomEvent(evt,{detail}));

  function getRunId() {
    const k = 'cea.runId';
    let id = localStorage.getItem(k);
    if (!id) { id = 'RUN-' + Math.random().toString(36).slice(2,8).toUpperCase(); localStorage.setItem(k, id); }
    return id;
  }
  function save(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch{} }
  function load(key, fallback=null) { try { const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; } catch{ return fallback; } }

  return { on, emit, getRunId, save, load };
})();
</script>
</html>
