<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Electricity Cost Calculator</title>
  <!-- Inline styles so GitHub preview/local copies preserve the design -->
  <style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Inter:wght@400;500;600;700;800&display=swap');

#ecalc{
  --bg:#FDFBF4; --text:#333; --heading:#2D5C4E;
  --btn:#2D5C4E; --btn-hover:#A76DAB; --btn-text:#fff;
  --card:#fff; --card-border:#E7E5DC; --icon:#2D5C4E; --err:#BE5C5C;
  --sec-border:#D9E2DE; --sec-head-bg:#F3F7F5; --sec-head-text:#2D5C4E;
  --tile-bg:#FFFFFF; --tile-border:#E7E5DC; --tile-label:#5C6F69; --tile-value:#2D5C4E;

  position:relative;
  color:var(--text);
  line-height:1.6;
  min-height:100%;
  font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
  max-width: var(--page-width, 1200px);
  margin-left:auto; margin-right:auto;
  padding-left:clamp(12px,4vw,24px);
  padding-right:clamp(12px,4vw,24px);
  background:transparent;
}
#ecalc *{ margin:0; padding:0; box-sizing:border-box; }
#ecalc .container{ width:100%; max-width:1100px; margin:18px auto; padding:20px; background:var(--card); border:1px solid var(--card-border); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); position:relative; overflow:hidden; }
#ecalc .container>*{ position:relative; z-index:2; }
#ecalc .wm-img{ position:absolute; right:-28px; bottom:-28px; width:260px; opacity:.06; pointer-events:none; user-select:none; z-index:0; filter:saturate(.95) contrast(.95); }
@media (min-width:768px){ #ecalc .wm-img{ width:320px; } }

#ecalc .header{ text-align:center; padding:30px 16px 22px; margin:0 0 16px; }
#ecalc .header h1{ margin:0 0 6px; font-size:clamp(26px,3.2vw,36px); font-weight:800; color:var(--heading); line-height:1.2; font-family:'Inter',system-ui,sans-serif; }
#ecalc .header .subtitle{ font-size:14px; font-weight:500; color:#456E62; }
#ecalc .muted{ font-size:.9rem; color:#6B7C77; }

#ecalc .section{ background:#fff; border:1px solid var(--sec-border); border-radius:12px; padding:16px; margin-bottom:16px; }
#ecalc .section-title{ display:flex; align-items:center; gap:8px; margin:2px 0 10px; font-size:18px; font-weight:800; color:var(--heading); font-family:'Inter',system-ui,sans-serif; }

#ecalc .form-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px; margin-bottom:10px; position:relative; z-index:1; }
#ecalc .form-group{ display:flex; flex-direction:column; }
#ecalc .form-group label{ font-weight:700; color:var(--heading); margin-bottom:6px; font-size:.95em; }
#ecalc .form-group input, #ecalc .form-group select{ padding:12px; border:1px solid #D1D1D1; border-radius:10px; font-size:16px; background:#fff; color:#31473a; transition: box-shadow .12s ease, border-color .12s ease; }
#ecalc .form-group input:focus, #ecalc .form-group select:focus{ outline:none; border-color:var(--heading); box-shadow:0 0 0 3px rgba(45,92,78,.18); }

#ecalc .toggle-container{ display:flex; align-items:center; gap:10px; }
#ecalc .toggle{ position:relative; width:52px; height:28px; border-radius:14px; cursor:pointer; background:#cbd5e1; border:1px solid #94a3b8; transition:background-color .15s ease, transform .06s ease, border-color .15s ease; box-shadow: inset 0 0 0 1px rgba(0,0,0,.04); }
#ecalc .toggle:active{ transform:scale(.98); }
#ecalc .toggle.active{ background:#16a34a; border-color:#0f8a3a; box-shadow:0 0 0 3px rgba(22,163,74,.18) inset; }
#ecalc .toggle-slider{ position:absolute; top:3px; left:3px; width:22px; height:22px; background:#fff; border-radius:50%; transition:transform .15s ease; box-shadow:0 1px 2px rgba(0,0,0,.2); }
#ecalc .toggle.active .toggle-slider{ transform:translateX(24px); }
#ecalc .toggles-row{ display:flex; flex-wrap:wrap; gap:16px; align-items:center; margin-top:8px; }

#ecalc .btn{ display:inline-flex; align-items:center; justify-content:center; padding:12px 18px; border:1px solid transparent; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer; transition:.15s; gap:8px; text-align:center; white-space:nowrap; font-family:'Inter',system-ui,sans-serif; box-shadow:0 1px 0 rgba(0,0,0,.03); }
#ecalc .btn:hover{ filter:brightness(1.03); }
#ecalc .btn:active{ transform:translateY(1px); }
#ecalc .btn-primary{ background:var(--btn); color:var(--btn-text); border-color:var(--btn); }
#ecalc .btn-primary:hover{ background:var(--btn-hover); border-color:var(--btn-hover); }
#ecalc .btn-secondary,
#ecalc .btn-ghost{ background:#f3f5f1; color:#1f3b33; border-color:#d9e2de; }
#ecalc .btn-secondary:hover,
#ecalc .btn-ghost:hover{ background:#e8eee9; }
#ecalc .btn-success{ background:#10b981; color:#fff; border-color:#10b981; }
#ecalc .btn-success:hover{ background:#059669; border-color:#059669; }
#ecalc .btn-danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
#ecalc .btn-danger:hover{ background:#dc2626; border-color:#dc2626; }
#ecalc .btn-x, #ecalc .remove-day-group{ background:#ef4444; color:#fff; border:none; border-radius:10px; padding:6px 10px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; line-height:1; transition: transform .1s ease, filter .15s ease, background-color .15s ease; }
#ecalc .btn-x:hover, #ecalc .remove-day-group:hover{ background:#dc2626; }
#ecalc .btn-x:active, #ecalc .remove-day-group:active{ transform:scale(.96); }

#ecalc .time-range{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; padding:12px; background:#fcfaf3; border-radius:8px; border:1px solid #e3e2d7; }
#ecalc .time-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; width:100%; min-width:0; }
#ecalc .time-input{ padding:10px 12px; border:1px solid #c4c8b8; border-radius:8px; font-size:14px; background:#fff; color:#31473a; transition: box-shadow .12s ease, border-color .12s ease; min-width:110px; }
#ecalc .time-input:focus{ outline:none; border-color:var(--heading); box-shadow:0 0 0 3px rgba(45,92,78,.18); }

#ecalc .day-range-group{ border:1px dashed #e3e2d7; border-radius:10px; padding:12px; margin-bottom:12px; background:#fffef8; position:relative; overflow:hidden; }
#ecalc .days-row{ display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap; width:100%; }
#ecalc .days-selector{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:8px; flex:1; width:100%; min-width:0; }
#ecalc .day-btn{ display:flex; align-items:center; justify-content:center; width:100%; height:44px; padding:0 10px; border:1px solid #c4c8b8; background:#fff; border-radius:8px; cursor:pointer; font-size:14px; font-weight:700; color:#31473a; transition: background-color .12s ease, border-color .12s ease, transform .06s ease; text-align:center; overflow:hidden; text-overflow:ellipsis; }
#ecalc .day-btn:hover{ background:#f3f7f5; border-color:#b8c2b5; }
#ecalc .day-btn:active{ transform:scale(.98); }
#ecalc .day-btn.active{ background:var(--btn); color:#fff; border-color:var(--btn); }

#ecalc .time-range[data-all-day="1"] .time-row .to,
#ecalc .time-range[data-allday="1"] .time-row .to,
#ecalc .time-row .toggle.active ~ .to{ display:none; }

#ecalc .equipment-card{ position:relative; border:1px solid var(--sec-border); border-radius:12px; padding:14px; margin-top:12px; background:#fff; }
#ecalc .equipment-card > .remove-btn{ position:absolute; top:10px; right:10px; }
#ecalc .equipment-header{ display:flex; align-items:center; justify-content:space-between; }
#ecalc .equipment-title{ font-weight:800; color:#2f3e39; font-family:'Inter',system-ui; }

#ecalc .results-section{ border:1px solid var(--sec-border); border-radius:12px; padding:12px; background:#fff; margin-top:14px; }
#ecalc .results-section .section-title{ display:flex; align-items:center; gap:8px; margin:0 0 8px; background:var(--sec-head-bg); color:var(--sec-head-text); padding:8px 10px; border-radius:9px; font-weight:800; font-size:14px; font-family:'Inter',system-ui,sans-serif; }
#ecalc .results-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-top:8px; }
#ecalc .result-item{ background:var(--tile-bg); border:1px solid var(--tile-border); border-radius:10px; padding:10px 12px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,.03); }
#ecalc .result-label{ font-size:12px; color:var(--tile-label); font-weight:700; letter-spacing:.2px; }
#ecalc .result-value{ margin-top:4px; font-size:18px; font-weight:800; color:var(--tile-value); }

#ecalc .error-message{ color:var(--err); background:#fef2f2; border:1px solid var(--err); padding:12px; border-radius:8px; margin-top:10px; font-size:14px; font-weight:700; text-align:left; }

#ecalc .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1000; }
#ecalc .modal-content{ background:#fff; padding:24px; border-radius:12px; max-width:560px; width:90%; max-height:80%; overflow-y:auto; border:1px solid var(--card-border); position:relative; z-index:1001; box-shadow:0 6px 20px rgba(0,0,0,.12); }
#ecalc .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
#ecalc .modal-title{ font-size:1.15rem; font-weight:800; color:var(--heading); font-family:'Inter',system-ui,sans-serif; }
#ecalc .close-btn{ background:none; border:none; font-size:24px; cursor:pointer; color:var(--text); }
#ecalc .modal.show{ display:flex; }
#ecalc .close-btn:hover{ filter:brightness(1.2); }
#ecalc .close-btn:active{ transform:scale(.96); }

@media (max-width:768px){
  #ecalc{ padding-left:16px; padding-right:16px; }
  #ecalc .container{ max-width:680px; margin:14px auto; padding:14px; border-radius:14px; }
  #ecalc .header{ padding:18px 8px 10px; }
  #ecalc .header h1{ font-size:clamp(22px,5.2vw,28px); }
  #ecalc .header .subtitle{ font-size:13px; }
  #ecalc .section{ padding:14px; margin-bottom:14px; }
  #ecalc .form-grid{ grid-template-columns:1fr; gap:10px; }
  #ecalc .time-range{ flex-direction:column; align-items:stretch; gap:8px; }
  #ecalc .time-row{ gap:8px; }
  #ecalc .time-row span{ order:2; }
  #ecalc .time-input{ width:100%; font-size:16px; }
  #ecalc .toggles-row{ gap:12px; }
  #ecalc .btn{ padding:12px 14px; font-size:15px; width:100%; }
  #ecalc .group-actions{ flex-direction:column; }
  #ecalc .results-grid{ grid-template-columns:1fr 1fr; gap:8px; }
  #ecalc .days-selector{ grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; }
  #ecalc .day-btn{ height:48px; font-size:16px; }
  #ecalc .remove-day-group{ margin-left:auto; }
  #ecalc .wm-img{ display:none; }
  #ho-watermark{ display:none; }
  #ecalc .cta-row{ position:sticky; bottom:8px; z-index:20; background:transparent; padding-top:6px; }
  #ecalc .cta-row .btn{ border-radius:14px; }
  #ecalc .modal-content{ width:94%; padding:16px; border-radius:14px; }
}

#ho-watermark{ position:fixed; right:16px; bottom:12px; background:rgba(45,92,78,.08); color:#2D5C4E; border:1px solid #E7E5DC; border-radius:10px; padding:6px 10px; font:600 12px/1 'Inter',system-ui,sans-serif; backdrop-filter:blur(2px); z-index:9999; pointer-events:none; }
@view-transition { navigation:auto; }
  </style>

  <!-- SDKs -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  (function(global){
    'use strict';

    const BRAND_URLS = {
      logo: 'https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Hydro_Oasis_Logo.svg?v=1750645434',
      nepenthes: 'https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Nepenthes_Mascot.png?v=1750645317',
      cactus: 'https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317'
    };

    const assetCache = {};

    function readBlobAsDataURL(blob){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function loadImageAsset(url){
      if(!url) return Promise.resolve(null);
      if(!assetCache[url]){
        assetCache[url] = fetch(url, { mode: 'cors' })
          .then(resp=>resp.blob())
          .then(readBlobAsDataURL)
          .then(dataUrl=>new Promise(resolve=>{
            const img = new Image();
            img.onload = ()=> resolve({ dataUrl, width: img.naturalWidth || img.width || 1, height: img.naturalHeight || img.height || 1 });
            img.onerror = ()=> resolve({ dataUrl, width: 1, height: 1 });
            img.src = dataUrl;
          }))
          .catch(err=>{ console.warn('[Hydro Oasis] Unable to load branding asset', url, err); return null; });
      }
      return assetCache[url];
    }

    function getHeightFromWidth(asset, width){
      const originalWidth = asset?.width || width || 1;
      const originalHeight = asset?.height || width || 1;
      return width * (originalHeight / originalWidth);
    }

    function getWidthFromHeight(asset, height){
      const originalWidth = asset?.width || height || 1;
      const originalHeight = asset?.height || height || 1;
      return height * (originalWidth / originalHeight);
    }

    function drawBrandHeader(doc, assets, options){
      if(!doc) return options.startY ?? 20;
      const prevFont = typeof doc.getFont === 'function' ? doc.getFont() : null;
      const prevSize = typeof doc.getFontSize === 'function' ? doc.getFontSize() : null;
      const pageWidth = doc.internal.pageSize.getWidth();
      let cursorY = options.startY ?? 12;
      let drewSomething = false;

      if(assets.logo?.dataUrl){
        const logoWidth = options.logoWidth || 44;
        const logoHeight = getHeightFromWidth(assets.logo, logoWidth);
        const x = (pageWidth - logoWidth) / 2;
        doc.addImage(assets.logo.dataUrl, 'PNG', x, cursorY, logoWidth, logoHeight);
        cursorY += logoHeight + (options.logoSpacing ?? 4);
        drewSomething = true;
      }

      const brandTitle = options.brandTitle || 'Hydro Oasis';
      const fontSize = options.brandFontSize || 22;
      const fontName = options.brandFont || 'helvetica';
      if(typeof doc.setFont === 'function'){ doc.setFont(fontName, 'bold'); }
      if(typeof doc.setFontSize === 'function'){ doc.setFontSize(fontSize); }
      const textWidth = doc.getTextWidth ? doc.getTextWidth(brandTitle) : 0;
      const textX = textWidth ? (pageWidth - textWidth) / 2 : pageWidth / 2;
      const scale = doc.internal.scaleFactor || 1;
      const fontHeight = fontSize / scale;
      const baseline = cursorY + fontHeight;
      doc.text(brandTitle, textX, baseline);
      drewSomething = true;

      const textCenterY = baseline - fontHeight / 2;
      const mascotHeight = options.mascotHeight || 18;
      const spacing = options.mascotSpacing || 6;
      const margin = options.mascotMargin || 8;

      if(assets.nepenthes?.dataUrl){
        const width = getWidthFromHeight(assets.nepenthes, mascotHeight);
        const x = Math.max(margin, textX - width - spacing);
        const y = textCenterY - mascotHeight / 2;
        doc.addImage(assets.nepenthes.dataUrl, 'PNG', x, y, width, mascotHeight);
      }

      if(assets.cactus?.dataUrl){
        const width = getWidthFromHeight(assets.cactus, mascotHeight);
        const x = Math.min(pageWidth - width - margin, textX + textWidth + spacing);
        const y = textCenterY - mascotHeight / 2;
        doc.addImage(assets.cactus.dataUrl, 'PNG', x, y, width, mascotHeight);
      }

      if(prevFont && typeof doc.setFont === 'function'){
        doc.setFont(prevFont.fontName || 'helvetica', prevFont.fontStyle || 'normal');
      }
      if(prevSize && typeof doc.setFontSize === 'function'){
        doc.setFontSize(prevSize);
      }

      return drewSomething ? baseline + (options.headerPadding ?? 6) : cursorY;
    }

    function addWatermarkToPage(doc, cactus, options){
      if(!cactus?.dataUrl) return;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const width = options.watermarkWidth || 36;
      const height = getHeightFromWidth(cactus, width);
      const margin = options.watermarkMargin || 14;
      const x = pageWidth - width - margin;
      const y = pageHeight - height - margin;
      let resetOpacity = null;
      if(typeof doc.setGState === 'function' && typeof doc.GState === 'function'){
        try{
          doc.setGState(new doc.GState({ opacity: options.watermarkOpacity ?? 0.12 }));
          resetOpacity = ()=>{ doc.setGState(new doc.GState({ opacity: 1 })); };
        }catch(err){ resetOpacity = null; }
      }
      doc.addImage(cactus.dataUrl, 'PNG', x, y, width, height);
      if(resetOpacity) resetOpacity();
    }

    function patchAddPage(doc, assets, options){
      if(doc.__hoBrandingPatched) return;
      const originalAddPage = doc.addPage.bind(doc);
      doc.addPage = function(...args){
        originalAddPage(...args);
        if(assets.logo || assets.nepenthes || assets.cactus){
          drawBrandHeader(this, assets, options);
        }
        if(assets.cactus){
          addWatermarkToPage(this, assets.cactus, options);
        }
        return this;
      };
      doc.__hoBrandingPatched = true;
    }

    async function decorate(doc, options = {}){
      if(!doc || !doc.internal?.pageSize){
        const start = options.startY ?? 20;
        const gap = options.contentGap ?? 10;
        return { headerBottom: start, contentStart: start + gap };
      }

      const assets = await Promise.all([
        loadImageAsset(BRAND_URLS.logo),
        loadImageAsset(BRAND_URLS.nepenthes),
        loadImageAsset(BRAND_URLS.cactus)
      ]).then(([logo, nepenthes, cactus])=>({ logo, nepenthes, cactus }));

      const headerBottom = drawBrandHeader(doc, assets, options);
      if(assets.cactus){
        addWatermarkToPage(doc, assets.cactus, options);
      }
      patchAddPage(doc, assets, options);

      const gap = options.contentGap ?? 10;
      return {
        assets,
        headerBottom,
        contentStart: (headerBottom ?? (options.startY ?? 20)) + gap
      };
    }

    global.hydroPdfBranding = { decorate };
  })(window);
  </script>

  <!-- Embed the tariff data so standalone copies do not rely on external fetches -->
  <script id="embedded-tariffs-data" type="application/json">
{
  "retailers": {
    "actewagl": {
      "displayName": "ActewAGL",
      "regions": ["act"],
      "plans": {
        "home-plan-flat": {
          "title": "Home Plan - Flat Rate",
          "byRegion": { "act": { "on": 32.56, "off": 32.56 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "home-tou": {
          "title": "Home Time of Use Plan",
          "byRegion": { "act": { "on": 43.34, "off": 26.4, "shoulder": 29.8845 } },
          "windows": {
            "on": [
              { "start": "07:00", "end": "09:00", "days": [1,2,3,4,5] },
              { "start": "17:00", "end": "20:00", "days": [1,2,3,4,5] }
            ],
            "shoulder": [
              { "start": "09:00", "end": "17:00", "days": [1,2,3,4,5] },
              { "start": "20:00", "end": "22:00", "days": [1,2,3,4,5] }
            ],
            "off": [
              { "start": "22:00", "end": "07:00", "days": [0,1,2,3,4,5,6] },
              { "start": "00:00", "end": "23:59", "days": [0,6] }
            ]
          }
        }
      }
    },

    "agl": {
      "displayName": "AGL",
      "regions": ["national"],
      "plans": {
        "home-plan-flat": {
          "title": "Home Plan - Flat Rate",
          "byRegion": { "national": { "on": 40.183, "off": 40.183 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "home-tou": {
          "title": "Home Time of Use Plan",
          "byRegion": { "national": { "on": 59.301, "off": 27.071, "shoulder": 33.044 } },
          "windows": {
            "on": [{ "start": "16:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "shoulder": [
              { "start": "09:00", "end": "17:00", "days": [1,2,3,4,5] },
              { "start": "20:00", "end": "22:00", "days": [1,2,3,4,5] }
            ],
            "off": [{ "start": "21:00", "end": "09:00", "days": [0,1,2,3,4,5,6] }]
          }
        }
      }
    },

    "alinta": {
      "displayName": "Alinta Energy",
      "regions": ["national"],
      "plans": {
        "standard-contract-flat-est": {
          "title": "Standard Contract (est.) - Flat",
          "byRegion": { "national": { "on": 21.45, "off": 21.45 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        }
      }
    },

    "amber": {
      "displayName": "Amber Electric",
      "regions": ["national"],
      "plans": {
        "standard-contract-flat-est": {
          "title": "Standard Contract (est.) - Flat",
          "byRegion": { "national": { "on": 38.42, "off": 38.42 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        }
      }
    },

    "aurora": {
      "displayName": "Aurora Energy (TAS)",
      "regions": ["tas"],
      "plans": {
        "tariff-31-flat": {
          "title": "Tariff 31 - Residential Flat",
          "byRegion": { "tas": { "on": 29.0535, "off": 29.0535 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
"tariff-93-tou": {
  "title": "Tariff 93 - Time of Use",
  "byRegion": { "tas": { "on": 35.4782, "off": 16.6862 } },
  "windows": {
    "on": [
      { "start": "07:00", "end": "10:00", "days": [1,2,3,4,5] },
      { "start": "16:00", "end": "21:00", "days": [1,2,3,4,5] }
    ],
    "off": [
      { "start": "10:00", "end": "16:00", "days": [1,2,3,4,5] },
      { "start": "21:00", "end": "07:00", "days": [1,2,3,4,5] },
      { "start": "00:00", "end": "23:59", "days": [0,6] }
    ]
  }
},
        "tariff-62-night": {
          "title": "Tariff 62 - Controlled Load (Night)",
          "byRegion": { "tas": { "on": 14.3078, "off": 14.3078 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        }
      }
    },

    "ergon": {
      "displayName": "Ergon Energy (QLD)",
      "regions": ["qld-regional"],
      "plans": {
        "t11-flat": {
          "title": "Tariff 11 - Flat",
          "byRegion": { "qld-regional": { "on": 32.973, "off": 32.973 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "t12d-tou": {
          "title": "Tariff 12D - TOU",
          "byRegion": { "qld-regional": { "on": 45.712, "off": 22.68, "shoulder": 28.035 } },
          "windows": {
            "on": [{ "start": "16:00", "end": "21:00", "days": [1,2,3,4,5] }],
            "shoulder": [{ "start": "21:00", "end": "11:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "11:00", "end": "16:00", "days": [1,2,3,4,5] }]
          }
        }
      }
    },

    "energex": {
      "displayName": "Energex (QLD SEQ)",
      "regions": ["qld-seq"],
      "plans": {
        "res-tou": {
          "title": "Residential TOU",
          "byRegion": { "qld-seq": { "on": 31.21, "off": 21.84, "shoulder": 25.4 } },
          "windows": {
            "on": [{ "start": "16:00", "end": "21:00", "days": [1,2,3,4,5] }],
            "off": [{ "start": "11:00", "end": "16:00", "days": [1,2,3,4,5] }],
            "shoulder": [
              { "start": "21:00", "end": "07:00", "days": [0,1,2,3,4,5,6] },
              { "start": "07:00", "end": "11:00", "days": [1,2,3,4,5] },
              { "start": "00:00", "end": "23:59", "days": [0,6] }
            ]
          }
        }
      }
    },

    "momentum": {
      "displayName": "Momentum Energy",
      "regions": ["national"],
      "plans": {
        "flat": {
          "title": "Residential Flat",
          "byRegion": { "national": { "on": 46.72, "off": 46.72 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "tou": {
          "title": "Residential TOU",
          "byRegion": { "national": { "on": 46.82, "off": 23.99 } },
          "windows": {
            "on": [{ "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "21:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }]
          }
        }
      }
    },

    "origin": {
      "displayName": "Origin Energy",
      "regions": ["national"],
      "plans": {
        "flat": {
          "title": "Residential Flat",
          "byRegion": { "national": { "on": 28.71, "off": 28.71 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "tou": {
          "title": "Residential TOU",
          "byRegion": { "national": { "on": 37.19, "off": 24.41 } },
          "windows": {
            "on": [{ "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "21:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }]
          }
        }
      }
    },

    "sapower": {
      "displayName": "SA Power Networks",
      "regions": ["sa"],
      "plans": {
        "res-single-flat": {
          "title": "Residential Single Rate - Flat",
          "byRegion": { "sa": { "on": 7.26, "off": 7.26 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "res-tou": {
          "title": "Residential TOU",
          "byRegion": { "sa": { "on": 18.95, "off": 9.47 } },
          "windows": {
            "on": [
              { "start": "06:00", "end": "10:00", "days": [1,2,3,4,5,6,0] },
              { "start": "16:00", "end": "23:59", "days": [1,2,3,4,5,6,0] }
            ],
            "off": [{ "start": "00:00", "end": "06:00", "days": [0,1,2,3,4,5,6] }]
          }
        }
      }
    },

    "synergy": {
      "displayName": "Synergy (WA)",
      "regions": ["wa"],
      "plans": {
        "a1-flat": {
          "title": "A1 Tariff - Flat",
          "byRegion": { "wa": { "on": 32.3719, "off": 32.3719 } },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "midday-saver-tou": {
          "title": "Midday Saver TOU",
          "byRegion": { "wa": { "on": 53.8446, "off": 8.6151, "shoulder": 23.6916 } },
          "windows": {
            "on": [{ "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "09:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }],
            "shoulder": [
              { "start": "21:00", "end": "09:00", "days": [0,1,2,3,4,5,6] }
            ]
          }
        }
      }
    },

    "powershop": {
      "displayName": "Powershop",
      "regions": ["vic"],
      "plans": {
        "vdo-single-rate": {
          "title": "VDO Residential Single Rate (VIC)",
          "byRegion": {
            "ausnet": { "on": 38.51, "off": 38.51 },
            "citipower": { "on": 28.71, "off": 28.71 },
            "jemena": { "on": 32.52, "off": 32.52 },
            "powercor": { "on": 32.92, "off": 32.92 },
            "united": { "on": 31.74, "off": 31.74 }
          },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "vdo-tou": {
          "title": "VDO Time of Use (VIC, Peak 3pmâ€“9pm daily)",
          "byRegion": {
            "ausnet": { "on": 49.32, "off": 28.69 },
            "citipower": { "on": 37.19, "off": 24.41 },
            "jemena": { "on": 39.25, "off": 27.10 },
            "powercor": { "on": 42.65, "off": 27.72 },
            "united": { "on": 41.20, "off": 26.65 }
          },
          "windows": {
            "on": [{ "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "21:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }]
          }
        },
        "controlled-load": {
          "title": "Controlled Load (VIC)",
          "byRegion": {
            "ausnet": { "on": 28.69, "off": 28.69 },
            "citipower": { "on": 22.71, "off": 22.71 },
            "jemena": { "on": 26.39, "off": 26.39 },
            "powercor": { "on": 25.59, "off": 25.59 },
            "united": { "on": 24.66, "off": 24.66 }
          },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        }
      }
    },

    "lumo": {
      "displayName": "Lumo Energy",
      "regions": ["vic"],
      "plans": {
        "single-rate": {
          "title": "Residential Single Rate",
          "byRegion": {
            "ausnet": { "on": 38.51, "off": 38.51 },
            "citipower": { "on": 28.71, "off": 28.71 },
            "jemena": { "on": 32.52, "off": 32.52 },
            "powercor": { "on": 32.92, "off": 32.92 }
          },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "two-rate": {
          "title": "Residential Two Rate (Anytime + CL)",
          "byRegion": {
            "ausnet": { "on": 38.51, "off": 38.51 },
            "citipower": { "on": 28.71, "off": 28.71 },
            "jemena": { "on": 32.52, "off": 32.52 },
            "powercor": { "on": 32.92, "off": 32.92 }
          },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "tou-7day": {
          "title": "Residential Time of Use (7-Day, Peak 3pmâ€“9pm)",
          "byRegion": {
            "ausnet": { "on": 49.32, "off": 28.69 },
            "citipower": { "on": 37.19, "off": 24.41 },
            "jemena": { "on": 39.25, "off": 27.10 },
            "powercor": { "on": 42.65, "off": 27.72 }
          },
          "windows": {
            "on": [{ "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "21:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }]
          }
        }
      }
    },

"redenergy": {
  "displayName": "Red Energy",
  "regions": ["vic"],
  "plans": {
    "vdo-single-rate": {
      "title": "VDO Residential Single Rate (CitiPower)",
      "byRegion": {
        "citipower": { "on": 27.33, "off": 27.33, "supply": 124.07 }
      },
      "windows": {
        "on": [
          { "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }
        ],
        "off": []
      }
    },

    "vdo-tou": {
      "title": "VDO 2-Period TOU (Residential)",
      "byRegion": {
        "ausnet":   { "on": 46.82, "off": 23.99, "supply": 141.46 },
        "citipower":{ "on": 36.33, "off": 22.06, "supply": 124.07 },
        "jemena":   { "on": 37.61, "off": 23.68, "supply": 123.01 },
        "powercor": { "on": 40.40, "off": 23.65, "supply": 136.84 },
        "united":   { "on": 38.37, "off": 22.99, "supply": 116.48 }
      },
      "windows": {
        "on": [
          { "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }
        ],
        "off": [
          { "start": "21:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }
        ]
      }
    },

    "controlled-load": {
      "title": "VDO Controlled Load (Residential)",
      "byRegion": {
        "ausnet":   { "on": 23.99, "off": 23.99 },
        "citipower":{ "on": 20.12, "off": 20.12 },
        "jemena":   { "on": 23.14, "off": 23.14 },
        "powercor": { "on": 21.22, "off": 21.22 },
        "united":   { "on": 21.07, "off": 21.07 }
      },
      "windows": {
        "on": [
          { "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }
        ],
        "off": []
      }
    }
  }
},

    "energyaustralia": {
      "displayName": "EnergyAustralia",
      "regions": ["vic"],
      "plans": {
        "peak-anytime": {
          "title": "Residential Peak Anytime / Peak + Dedicated Circuit",
          "byRegion": {
            "citipower": { "on": 28.71, "off": 28.71 },
            "jemena": { "on": 32.5199, "off": 32.5199 },
            "powercor": { "on": 32.9199, "off": 32.9199 },
            "united": { "on": 31.7399, "off": 31.7399 },
            "ausnet": { "on": 38.5099, "off": 39.5499 }
          },
          "windows": { "on": [{ "start": "00:00", "end": "23:59", "days": [0,1,2,3,4,5,6] }], "off": [] }
        },
        "7day-tou": {
          "title": "Residential 7-Day Time of Use / TOU + Dedicated Circuit",
          "byRegion": {
            "citipower": { "on": 37.1899, "off": 24.4099 },
            "jemena": { "on": 39.25, "off": 27.10 },
            "powercor": { "on": 42.6499, "off": 27.72 },
            "united": { "on": 41.1999, "off": 26.6499 },
            "ausnet": { "on": 49.3199, "off": 28.6899 }
          },
          "windows": {
            "on": [{ "start": "15:00", "end": "21:00", "days": [0,1,2,3,4,5,6] }],
            "off": [{ "start": "21:00", "end": "15:00", "days": [0,1,2,3,4,5,6] }]
          }
        }
      }
    }
  }
}
  </script>



</head>
<body>
<div id="ecalc">
  <div class="container">
    <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="">
    <div class="header">
      <h1 id="app-title">Electricity Cost Calculator</h1>
      <p class="subtitle">Calculate your energy usage and cost breakdown</p>
    </div>

    <div class="saved-weeks-toggle">
      <div class="toggle-container">
        <span>Show Saved Weeks for Harvest</span>
        <div class="toggle" id="electricSavedWeeksToggle" role="switch" aria-checked="false" tabindex="0">
          <div class="toggle-slider"></div>
        </div>
      </div>
    </div>

    <div id="electricSavedWeeks" class="saved-weeks-widget" style="display:none;">
      <div class="widget-title">ðŸ“˜ Saved Weeks for Harvest</div>
      <div id="electricSavedWeeksList"></div>
      <div style="text-align:center;margin-top:10px;">
        <button class="btn btn-ghost" id="electricClearCacheBtn" type="button">ðŸ§¹ Clear Cache</button>
      </div>
      <div class="help" id="electricClearCacheStatus" style="text-align:center;margin-top:6px;"></div>
    </div>

    <!-- ========== Rate Configuration ========== -->
    <div class="section">
      <h2 class="section-title">âš¡ Rate Configuration</h2>
      <p class="muted" id="tariff-meta-line" style="margin-bottom:8px;display:none;"></p>

      <div class="form-grid" id="rate-grid">
        <div class="form-group">
          <label for="on-peak-rate">On-Peak Rate (c/kWh)</label>
          <input type="number" id="on-peak-rate" min="0" step="0.0001" value="25.5" placeholder="e.g. 38.52">
        </div>
        <div class="form-group">
          <label for="off-peak-rate">Off-Peak Rate (c/kWh)</label>
          <input type="number" id="off-peak-rate" min="0" step="0.0001" value="15.2" placeholder="e.g. 19.26">
        </div>
        <!-- Shoulder rate slot injected when enabled -->
      </div>

      <div class="toggles-row">
        <div class="toggle-container">
          <span>Round to 2 decimals</span>
          <div class="toggle active" id="rounding-toggle"><div class="toggle-slider"></div></div>
        </div>

        <div class="toggle-container" title="Enable a Shoulder period with its own rate and schedule">
          <span>Enable Shoulder</span>
          <div class="toggle" id="shoulder-toggle"><div class="toggle-slider"></div></div>
        </div>
      </div>

      <button class="btn btn-secondary" id="fetch-tariffs-btn" style="margin-top:16px;">ðŸ“‹ Select Tariff</button>
      <span id="selected-plan-title" class="muted" style="margin-left:10px;display:none;"></span>
    </div>

    <!-- ========== Tariff Schedule ========== -->
    <div class="section" id="tariff-schedule">
      <h2 class="section-title" id="tariff-schedule-title">ðŸ“… Tariff Schedule</h2>

      <!-- ON-PEAK -->
      <div class="tariff-type" data-type="on-peak" id="on-peak-block">
        <h3 id="on-peak-heading" style="color:#dc2626;margin-bottom:16px;">On-Peak Times</h3>

        <div class="tariff-groups" id="on-peak-groups">
          <div class="day-range-group">
            <div class="days-row">
              <div class="days-selector">
                <button class="day-btn active" data-day="1">Mon</button>
                <button class="day-btn active" data-day="2">Tue</button>
                <button class="day-btn active" data-day="3">Wed</button>
                <button class="day-btn active" data-day="4">Thu</button>
                <button class="day-btn active" data-day="5">Fri</button>
                <button class="day-btn" data-day="6">Sat</button>
                <button class="day-btn" data-day="0">Sun</button>
              </div>
              <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
            </div>

            <div class="tariff-ranges">
              <div class="time-range">
                <div class="time-row">
                  <input type="time" class="time-input" value="15:00">
                  <span>to</span>
                  <input type="time" class="time-input" value="21:00">
                  <!-- HOA All-Day toggle -->
                  <div class="toggle-container" style="margin-left:auto;">
                    <span>All Day</span>
                    <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
                  </div>
                  <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
                </div>
              </div>
            </div>

            <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
              <button class="btn btn-secondary outline" onclick="addDayRange('on-peak-groups')">+ Add Day Range</button>
            </div>
          </div>
        </div>
      </div>

      <!-- OFF-PEAK -->
      <div class="tariff-type" data-type="off-peak" id="off-peak-block" style="margin-top:24px;">
        <h3 id="off-peak-heading" style="color:#059669;margin-bottom:16px;">Off-Peak Times</h3>

        <div class="tariff-groups" id="off-peak-groups">
          <div class="day-range-group">
            <div class="days-row">
              <div class="days-selector">
                <button class="day-btn active" data-day="1">Mon</button>
                <button class="day-btn active" data-day="2">Tue</button>
                <button class="day-btn active" data-day="3">Wed</button>
                <button class="day-btn active" data-day="4">Thu</button>
                <button class="day-btn active" data-day="5">Fri</button>
                <button class="day-btn active" data-day="6">Sat</button>
                <button class="day-btn active" data-day="0">Sun</button>
              </div>
              <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
            </div>

            <div class="tariff-ranges">
              <div class="time-range">
                <div class="time-row">
                  <input type="time" class="time-input" value="21:00">
                  <span>to</span>
                  <input type="time" class="time-input" value="15:00">
                  <div class="toggle-container" style="margin-left:auto;">
                    <span>All Day</span>
                    <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
                  </div>
                  <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
                </div>
              </div>
            </div>

            <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
              <button class="btn btn-secondary outline" onclick="addDayRange('off-peak-groups')">+ Add Day Range</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SHOULDER dynamically injected -->
    </div>

    <div id="tariff-errors"></div>

    <!-- ========== Equipment ========== -->
    <div class="section">
      <h2 class="section-title">ðŸ”Œ Equipment</h2>

      <div id="equipment-list"></div>
      <div id="equipment-errors"></div>

      <button class="btn btn-primary" id="add-equipment-btn" style="display:block;margin:16px auto 0;">
        + Add Equipment
      </button>
    </div>

    <!-- Calculate (sticky on mobile) -->
    <div class="cta-row" style="text-align:center;margin:24px 0 8px;">
      <button class="btn btn-success" id="calculate-btn" style="font-size:18px;padding:16px 32px;max-width:680px; width:100%;">ðŸ§® Calculate Costs</button>
    </div>

    <!-- Results -->
    <div id="results-container" style="display:none;"></div>

    <div id="electricWeekPanel" class="section" style="display:none; margin-top:16px;">
      <h2 class="section-title">ðŸŒ± Save Week for Harvest</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="electricWeekStage">Stage</label>
          <select id="electricWeekStage" class="input">
            <option value="vegetative">Vegetative</option>
            <option value="flowering">Generative (Flowering)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="electricWeekNumber">Week Number</label>
          <input type="number" id="electricWeekNumber" class="input" min="1" step="1" placeholder="e.g., 4">
          <p class="muted" style="margin-top:4px;">Match the veg/flower week you plan to prefill in Harvest.</p>
        </div>
        <div class="form-group" style="align-self:flex-end;">
          <button class="btn btn-primary" type="button" id="electricWeekSaveBtn">Save Week for Harvest</button>
          <p id="electricWeekStatus" class="muted" style="margin-top:6px;"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tariff Modal -->
  <div class="modal" id="tariff-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Select Tariff</h3>
        <button class="close-btn" onclick="closeTariffModal()">Ã—</button>
      </div>

      <div class="form-group" style="margin-bottom:10px;">
        <label for="retailer-select">Retailer</label>
        <select id="retailer-select"><option value="">Select Retailer</option></select>
      </div>

      <div class="form-group" style="margin-bottom:10px;">
        <label for="plan-select">Plan</label>
        <select id="plan-select"><option value="">Select Plan</option></select>
      </div>

      <div class="form-group" style="margin-bottom:10px;">
        <label for="region-select">State/Network</label>
        <select id="region-select"><option value="">Select Region</option></select>
      </div>

      <div style="display:flex;gap:12px;margin-top:18px;flex-wrap:wrap;">
        <button class="btn btn-primary" style="flex:1 1 180px;" onclick="applySelectedTariff()">Apply Selected Plan</button>
        <button class="btn" style="flex:1 1 120px;" onclick="closeTariffModal()">Close</button>
      </div>

      <div id="fetch-status" style="margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- (Cloudflare anti-bot iframe preserved) -->
<script>
(function(){
  function c(){
    var b=a.contentDocument||a.contentWindow.document;
    if(b){
      var d=b.createElement('script');
      d.innerHTML="window.__CF$cv$params={r:'99881531a63cf0c8',t:'MTc2MjEzMzE3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
      b.getElementsByTagName('head')[0].appendChild(d)
    }
  }
  if(document.body){
    var a=document.createElement('iframe');
    a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';
    document.body.appendChild(a);
    if('loading'!==document.readyState) c();
    else if(window.addEventListener) document.addEventListener('DOMContentLoaded',c);
    else{
      var e=document.onreadystatechange||function(){};
      document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}
    }
  }
})();
</script>

<div id="ho-watermark">Hydro Oasis â€¢ Electricity Cost Calculator</div>

<script>
/* ========= Config ========= */
const defaultConfig = { app_title: "Electricity Cost Calculator", footer_text: "Hydro Oasis â€¢ Electricity Cost Calculator" };
let roundingEnabled = true;
let shoulderEnabled = false;
let electricSavedWeeksVisible = false;

const BRIDGE_STORAGE_KEY = 'hoCalcBridge';
const ELECTRIC_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering (Generative)' };
const SAVED_WEEK_CALC_LABELS = { nutrient: 'Nutrients', water: 'Water', electricity: 'Electricity' };
const SAVED_WEEK_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering' };
const SAVED_WEEK_STAGE_ORDER = { vegetative: 0, flowering: 1 };

function applyElectricSavedWeeksVisibility(){
  const widget = document.getElementById('electricSavedWeeks');
  if(widget){
    widget.style.display = electricSavedWeeksVisible ? 'block' : 'none';
  }
  const toggle = document.getElementById('electricSavedWeeksToggle');
  if(toggle){
    toggle.classList.toggle('active', electricSavedWeeksVisible);
    toggle.setAttribute('aria-checked', electricSavedWeeksVisible ? 'true' : 'false');
  }
}

function setElectricSavedWeeksVisibility(show){
  electricSavedWeeksVisible = !!show;
  applyElectricSavedWeeksVisibility();
}
function saveBridgeData(calculator, payload){
  try{
    if(typeof window === 'undefined' || !window.localStorage) return;
    const existing = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    existing[calculator] = { ...payload, updatedAt: Date.now() };
    window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(existing));
  }catch(err){
    console.warn('Hydro Oasis bridge save skipped:', err);
  }
}

function clearBridgeDataForCalculator(calculatorKey){
  try{
    if(typeof window === 'undefined' || !window.localStorage) return false;
    const raw = window.localStorage.getItem(BRIDGE_STORAGE_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw || '{}');
    let changed = false;
    if(data[calculatorKey]){
      delete data[calculatorKey];
      changed = true;
    }
    if(data.stageWeeks){
      Object.keys(data.stageWeeks).forEach(stage=>{
        const stageData = data.stageWeeks[stage];
        if(!stageData) return;
        Object.keys(stageData).forEach(weekKey=>{
          const weekEntry = stageData[weekKey];
          if(weekEntry && weekEntry[calculatorKey]){
            delete weekEntry[calculatorKey];
            changed = true;
          }
          if(weekEntry && Object.keys(weekEntry).length === 0){
            delete stageData[weekKey];
          }
        });
        if(Object.keys(stageData).length === 0){
          delete data.stageWeeks[stage];
        }
      });
      if(Object.keys(data.stageWeeks).length === 0){
        delete data.stageWeeks;
      }
    }
    if(!changed) return false;
    if(Object.keys(data).length === 0){
      window.localStorage.removeItem(BRIDGE_STORAGE_KEY);
    }else{
      window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(data));
    }
    return true;
  }catch(err){
    console.warn('Hydro Oasis clear cache skipped:', err);
    return false;
  }
}

function electricNormalizeStage(stage){
  return (stage === 'flowering' || stage === 'generative') ? 'flowering' : 'vegetative';
}
function electricStageLabel(stage){
  return ELECTRIC_STAGE_LABELS[electricNormalizeStage(stage)] || ELECTRIC_STAGE_LABELS.vegetative;
}
function saveElectricWeekSnapshot(stage, weekNumber, weeklyCost){
  if(!(weekNumber > 0) || !Number.isFinite(weeklyCost)) return false;
  try{
    if(typeof window === 'undefined' || !window.localStorage) return false;
    const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    if(!data.stageWeeks) data.stageWeeks = { vegetative:{}, flowering:{} };
    const normalizedStage = electricNormalizeStage(stage);
    if(!data.stageWeeks[normalizedStage]) data.stageWeeks[normalizedStage] = {};
    const weekKey = String(weekNumber);
    const existingWeek = data.stageWeeks[normalizedStage][weekKey] || {};
    existingWeek.electricity = { weeklyCost, updatedAt: Date.now() };
    data.stageWeeks[normalizedStage][weekKey] = existingWeek;
    window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(data));
    return true;
  }catch(err){
    console.warn('Hydro Oasis week save skipped:', err);
    return false;
  }
}

function getSavedWeeksSummary(){
  const empty = { vegetative: [], flowering: [], totalCount: 0 };
  try{
    if(typeof window === 'undefined' || !window.localStorage) return empty;
    const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    const stageWeeks = data?.stageWeeks || {};
    const parseStage = (stageKey)=>{
      const stageData = stageWeeks[stageKey] || {};
      return Object.keys(stageData).map(weekKey=>{
        const weekNumber = parseInt(weekKey, 10);
        if(!Number.isFinite(weekNumber)) return null;
        const entry = stageData[weekKey] || {};
        const calculators = Object.entries(SAVED_WEEK_CALC_LABELS).reduce((list,[calcKey,label])=>{
          const value = Number(entry?.[calcKey]?.weeklyCost);
          if(Number.isFinite(value)) list.push(label);
          return list;
        }, []);
        if(calculators.length === 0) return null;
        return { weekNumber, calculators };
      }).filter(Boolean).sort((a,b)=>a.weekNumber - b.weekNumber);
    };
    const vegetative = parseStage('vegetative');
    const flowering = parseStage('flowering');
    return { vegetative, flowering, totalCount: vegetative.length + flowering.length };
  }catch(err){
    console.warn('Hydro Oasis saved weeks read skipped:', err);
    return empty;
  }
}

function getSavedWeeksForCalculator(calculatorKey){
  const rows = [];
  try{
    if(typeof window === 'undefined' || !window.localStorage) return rows;
    const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
    const stageWeeks = data?.stageWeeks || {};
    Object.keys(stageWeeks).forEach(stage=>{
      const stageData = stageWeeks[stage] || {};
      Object.keys(stageData).forEach(weekKey=>{
        const entry = stageData[weekKey]?.[calculatorKey];
        const weekNumber = parseInt(weekKey, 10);
        const weeklyCost = Number(entry?.weeklyCost);
        if(Number.isFinite(weekNumber) && Number.isFinite(weeklyCost)){
          rows.push({ stage, weekNumber, weeklyCost });
        }
      });
    });
    rows.sort((a,b)=>{
      const stageDiff = (SAVED_WEEK_STAGE_ORDER[a.stage] ?? 99) - (SAVED_WEEK_STAGE_ORDER[b.stage] ?? 99);
      if(stageDiff !== 0) return stageDiff;
      return a.weekNumber - b.weekNumber;
    });
  }catch(err){
    console.warn('Hydro Oasis saved weeks detail read skipped:', err);
  }
  return rows;
}

function updateElectricSavedWeeksWidget(){
  const widget = document.getElementById('electricSavedWeeks');
  const body = document.getElementById('electricSavedWeeksList');
  if(!widget || !body) return;
  const summary = getSavedWeeksSummary();
  if(summary.totalCount === 0){
    body.innerHTML = '<div class="sw-empty">No weeks saved yet. Save a week after running the Nutrient, Water, or Electricity calculators.</div>';
    applyElectricSavedWeeksVisibility();
    return;
  }
  const sections = [];
  ['vegetative','flowering'].forEach(stage=>{
    if(summary[stage].length){
      const label = SAVED_WEEK_STAGE_LABELS[stage] || stage;
      const rows = summary[stage].map(week=>{
        const calcList = week.calculators.join(', ');
        return `<li><span class="sw-week">Week ${week.weekNumber}</span><span class="sw-meta">${calcList}</span></li>`;
      }).join('');
      sections.push(`<div class="sw-stage"><div class="sw-stage-label">${label}</div><ul>${rows}</ul></div>`);
    }
  });
  body.innerHTML = sections.join('');
  applyElectricSavedWeeksVisibility();
}

function handleElectricCacheClear(){
  const status = document.getElementById('electricClearCacheStatus');
  if(status){
    status.textContent = 'Clearing saved electricity dataâ€¦';
    status.style.color = '#6B7C77';
  }
  const cleared = clearBridgeDataForCalculator('electricity');
  if(status){
    if(cleared){
      status.textContent = 'Electricity cache cleared.';
      status.style.color = '#1f7a54';
    }else{
      status.textContent = 'No saved electricity data to clear.';
      status.style.color = '#6B7C77';
    }
  }
  updateElectricSavedWeeksWidget();
}

let latestElectricWeekTotal = null;
function resetElectricWeekPanel(){
  const panel = document.getElementById('electricWeekPanel');
  if(panel) panel.style.display = 'none';
  const status = document.getElementById('electricWeekStatus');
  if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
}
function showElectricWeekPanel(){
  const panel = document.getElementById('electricWeekPanel');
  if(panel) panel.style.display = 'block';
  const status = document.getElementById('electricWeekStatus');
  if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
}
function handleElectricWeekSave(){
  const status = document.getElementById('electricWeekStatus');
  if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
  if(!Number.isFinite(latestElectricWeekTotal)){
    if(status){ status.textContent = 'Calculate your electricity costs first.'; status.style.color = '#b91c1c'; }
    return;
  }
  const stage = document.getElementById('electricWeekStage')?.value || 'vegetative';
  const weekNumber = parseInt(document.getElementById('electricWeekNumber')?.value, 10);
  if(!(weekNumber > 0)){
    if(status){ status.textContent = 'Enter a valid week number (1 or higher).'; status.style.color = '#b91c1c'; }
    return;
  }
  const ok = saveElectricWeekSnapshot(stage, weekNumber, latestElectricWeekTotal);
  if(status){
    if(ok){
      status.textContent = `Saved ${electricStageLabel(stage)} week ${weekNumber} for Harvest.`;
      status.style.color = '#1f7a54';
      updateElectricSavedWeeksWidget();
    }else{
      status.textContent = 'Unable to save this week. Please try again.';
      status.style.color = '#b91c1c';
    }
  }
}

/* ========= External tariffs ========= */
const REMOTE_TARIFFS_URL = "https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Electricity_Tariffs.json?v=1763176275";
const LOCAL_TARIFFS_URL = "../../data/electricity_tariffs.json";
let tariffsData = null;
const embeddedTariffs = (()=>{
  try{
    const el = document.getElementById('embedded-tariffs-data');
    if(!el) return null;
    return JSON.parse(el.textContent || '{}');
  }catch(err){
    console.warn('Unable to parse embedded tariff data:', err);
    return null;
  }
})();
const regionLabels = { vic:"VIC", tas:"TAS", citipower:"VIC â€“ CitiPower", powercor:"VIC â€“ Powercor", jemena:"VIC â€“ Jemena", ausnet:"VIC â€“ AusNet", united:"VIC â€“ United Energy" };

function validateTariffsSchema(json){
  if (!json || typeof json !== "object") throw new Error("Top-level JSON must be an object.");
  if (!json.retailers || typeof json.retailers !== "object") throw new Error("Invalid JSON structure: expected { retailers: { ... } }");
  Object.entries(json.retailers).forEach(([key, retailer])=>{
    if (!retailer.displayName) throw new Error(`Retailer "${key}" missing displayName`);
    if (!retailer.plans || typeof retailer.plans !== "object") throw new Error(`Retailer "${key}" missing plans`);
    Object.entries(retailer.plans).forEach(([pid, plan])=>{
      if (!plan.title) throw new Error(`Plan "${pid}" missing title`);
      if (!plan.byRegion || typeof plan.byRegion !== "object") throw new Error(`Plan "${pid}" missing byRegion`);
      Object.entries(plan.byRegion).forEach(([rid, rates])=>{
        if (typeof rates.on !== "number" || typeof rates.off !== "number") throw new Error(`Plan "${pid}" region "${rid}" rates must have numeric "on" and "off"`);
        if (rates.shoulder != null && typeof rates.shoulder !== "number") throw new Error(`Plan "${pid}" region "${rid}" "shoulder" must be numeric when provided`);
      });
      if (!plan.windows || typeof plan.windows !== "object") throw new Error(`Plan "${pid}" missing windows`);
      ["on","off"].forEach(bucket=>{
        if (!Array.isArray(plan.windows[bucket])) throw new Error(`Plan "${pid}" windows.${bucket} must be an array`);
        plan.windows[bucket].forEach((w,i)=>{
          if (!w.start || !w.end || !Array.isArray(w.days)) throw new Error(`Plan "${pid}" windows.${bucket}[${i}] must have start, end, days[]`);
        });
      });
      if (plan.windows.shoulder){
        if (!Array.isArray(plan.windows.shoulder)) throw new Error(`Plan "${pid}" windows.shoulder must be an array`);
        plan.windows.shoulder.forEach((w,i)=>{
          if (!w.start || !w.end || !Array.isArray(w.days)) throw new Error(`Plan "${pid}" windows.shoulder[${i}] must have start, end, days[]`);
        });
      }
    });
  });
}

async function fetchTariffsFromUrl(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchTariffsOnce(){
  if (tariffsData) return tariffsData;
  const status = document.getElementById("fetch-status");
  if (status) status.innerHTML = "Loading tariffsâ€¦";

  const errors = [];
  const tryUse = (data, sourceLabel)=>{
    if(!data) return false;
    validateTariffsSchema(data);
    tariffsData = data;
    if (status) status.innerHTML = `<span style='color:#10b981;'>Tariffs loaded (${sourceLabel}).</span>`;
    return true;
  };

  try{
    if(embeddedTariffs && tryUse(embeddedTariffs, 'embedded data')){
      return tariffsData;
    }
  }catch(err){ errors.push(`Embedded data: ${err.message}`); }

  const urlSources = [
    { url: LOCAL_TARIFFS_URL, label: 'local data file' },
    { url: REMOTE_TARIFFS_URL, label: 'Shopify CDN' }
  ];

  for(const source of urlSources){
    try{
      const json = await fetchTariffsFromUrl(source.url);
      if(tryUse(json, source.label)) return tariffsData;
    }catch(err){
      errors.push(`${source.label}: ${err.message}`);
    }
  }

  const errorMessage = errors.length ? errors.join('<br>') : 'Unknown error';
  if(status){
    status.innerHTML = `<div class="error-message">Failed to load tariffs.<br>${errorMessage}</div>`;
  }
  throw new Error(`Unable to load tariffs: ${errorMessage}`);
}

/* ========= SDK init ========= */
function initSDK(){
  if (window.elementSdk){
    window.elementSdk.init({
      defaultConfig,
      onConfigChange:(config)=>{
        const t=document.getElementById('app-title');
        if (t) t.textContent = config.app_title || defaultConfig.app_title;
      }
    });
  }
}

/* ========= Shoulder UI ========= */
function addShoulderRateInput(){
  if (document.getElementById('shoulder-rate')) return;
  const grid=document.getElementById('rate-grid');
  const div=document.createElement('div');
  div.className='form-group';
  div.innerHTML = `
    <label for="shoulder-rate">Shoulder Rate (c/kWh)</label>
    <input type="number" id="shoulder-rate" min="0" step="0.0001" value="28" placeholder="e.g. 30.00">
  `;
  grid.appendChild(div);
}
function removeShoulderRateInput(){
  const el=document.getElementById('shoulder-rate');
  if (el) el.closest('.form-group').remove();
}

function addShoulderSection(){
  if (document.getElementById('shoulder-block')) return;

  let schedule = document.getElementById('tariff-schedule');
  if (!schedule) {
    const titleEl = document.getElementById('tariff-schedule-title');
    schedule = titleEl ? titleEl.closest('.section') : null;
  }
  if (!schedule) return;

  const block = document.createElement('div');
  block.className = 'tariff-type';
  block.dataset.type = 'shoulder';
  block.id = 'shoulder-block';
  block.style.marginTop = '24px';
  block.innerHTML = `
    <h3 id="shoulder-heading" style="color:#d97706;margin-bottom:16px;">Shoulder Times</h3>
    <div class="tariff-groups" id="shoulder-groups">
      <div class="day-range-group">
        <div class="days-row">
          <div class="days-selector">
            <button class="day-btn active" data-day="1">Mon</button>
            <button class="day-btn active" data-day="2">Tue</button>
            <button class="day-btn active" data-day="3">Wed</button>
            <button class="day-btn active" data-day="4">Thu</button>
            <button class="day-btn active" data-day="5">Fri</button>
            <button class="day-btn" data-day="6">Sat</button>
            <button class="day-btn" data-day="0">Sun</button>
          </div>
          <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
        </div>
        <div class="tariff-ranges"></div>
        <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
          <button class="btn btn-secondary outline" onclick="addDayRange('shoulder-groups')">+ Add Day Range</button>
        </div>
      </div>
    </div>`;
  schedule.appendChild(block);
  activateDayToggles(block);
  refreshGroupButtons(block.querySelector('#shoulder-groups'));
}
function removeShoulderSection(){
  const block=document.getElementById('shoulder-block');
  if (block) block.remove();
}
function setShoulderUI(active){
  shoulderEnabled = !!active;
  const shToggle=document.getElementById('shoulder-toggle');
  if (shToggle) shToggle.classList.toggle('active', shoulderEnabled);
  if (shoulderEnabled){ addShoulderRateInput(); addShoulderSection(); }
  else { removeShoulderRateInput(); removeShoulderSection(); }
}

/* ========= Day toggles ========= */
function activateDayToggles(scope=document){
  scope.querySelectorAll('.day-btn').forEach(btn=>{
    btn.addEventListener('click', function(){ this.classList.toggle('active'); });
  });
}

/* All-day helpers */
function isAllDayRange(start, end){ return (start === '00:00' && (end === '23:59' || end === '00:00')); }
function bindAllDayToggle(toggleEl){
  const tr = toggleEl.closest('.time-range');
  const [startEl, endEl] = tr.querySelectorAll('.time-input');

  const setState = (on) => {
    toggleEl.classList.toggle('active', on);
    if (on){
      startEl.value = '00:00';
      endEl.value   = '00:00';
      startEl.disabled = true;
      endEl.disabled   = true;
      tr.dataset.allDay = '1';
    }else{
      startEl.disabled = false;
      endEl.disabled   = false;
      tr.dataset.allDay = '';
    }
  };

  const initiallyAllDay = isAllDayRange(startEl.value, endEl.value) || tr.dataset.allDay === '1';
  setState(initiallyAllDay);

  toggleEl.addEventListener('click', () => {
    const nowOn = !toggleEl.classList.contains('active');
    setState(nowOn);
  });
}
function wireAllDayToggles(scope){ scope.querySelectorAll('.time-range .all-day-toggle').forEach(bindAllDayToggle); }

/* Show/hide X only if >1 time range */
function updateTimeRangeXs(container){
  container.querySelectorAll('.tariff-ranges, .equipment-ranges').forEach(ranges=>{
    const rows = ranges.querySelectorAll('.time-range .tr-remove');
    const show = (ranges.querySelectorAll('.time-range').length > 1);
    rows.forEach(btn => btn.style.display = show ? 'inline-flex' : 'none');
  });
}

/* ========= Tariff Day Range Groups ========= */
function addTimeRangeToGroup(btnOrGroup){
  const group = btnOrGroup.closest ? btnOrGroup.closest('.day-range-group') : btnOrGroup;
  const ranges = group.querySelector('.tariff-ranges');
  const d = document.createElement('div');
  d.className = 'time-range';
  d.innerHTML = `
    <div class="time-row">
      <input type="time" class="time-input" value="09:00">
      <span>to</span>
      <input type="time" class="time-input" value="17:00">
      <div class="toggle-container" style="margin-left:auto;">
        <span>All Day</span>
        <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
      </div>
      <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
    </div>`;
  ranges.appendChild(d);
  wireAllDayToggles(d);
  updateTimeRangeXs(group);
}
function removeTimeRange(btn){
  const group = btn.closest('.day-range-group');
  btn.closest('.time-range').remove();
  updateTimeRangeXs(group);
}
function addDayRange(groupsId){
  const container=document.getElementById(groupsId);
  const group=document.createElement('div');
  group.className='day-range-group';
  group.innerHTML=`
    <div class="days-row">
      <div class="days-selector">
        <button class="day-btn active" data-day="1">Mon</button>
        <button class="day-btn active" data-day="2">Tue</button>
        <button class="day-btn active" data-day="3">Wed</button>
        <button class="day-btn active" data-day="4">Thu</button>
        <button class="day-btn active" data-day="5">Fri</button>
        <button class="day-btn" data-day="6">Sat</button>
        <button class="day-btn" data-day="0">Sun</button>
      </div>
      <button class="remove-day-group" onclick="removeDayRange(this)" title="Remove this day range">Ã—</button>
    </div>
    <div class="tariff-ranges"></div>
    <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn btn-secondary" onclick="addTimeRangeToGroup(this)">+ Add Time Range</button>
      <button class="btn btn-secondary outline" onclick="addDayRange('${groupsId}')">+ Add Day Range</button>
    </div>`;
  container.appendChild(group);
  activateDayToggles(group);
  addTimeRangeToGroup(group);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}
function removeDayRange(xBtn){
  const group=xBtn.closest('.day-range-group');
  const container=group.parentElement;
  group.remove();
  if (!container.querySelector('.day-range-group')) addDayRange(container.id);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}
function refreshGroupButtons(container){
  const groups=[...container.querySelectorAll('.day-range-group')];
  groups.forEach((g,i)=>{
    const addDayBtn=g.querySelector('.group-actions .btn.outline');
    const removeX=g.querySelector('.remove-day-group');
    if (addDayBtn) addDayBtn.style.display=(i===groups.length-1)?'inline-block':'none';
    if (removeX) removeX.style.visibility = (groups.length>1)?'visible':'hidden';
  });
}

/* ========= Equipment numbering helpers ========= */
function getUsedEquipmentIndices(){
  return Array.from(document.querySelectorAll('.equipment-card'))
    .map(c => parseInt(c.dataset.index,10))
    .filter(n => Number.isInteger(n));
}
function getNextEquipmentIndex(){
  const used = new Set(getUsedEquipmentIndices());
  let i = 1; while (used.has(i)) i++; return i;
}

/* ========= Equipment blocks ========= */
function addEquipment(){
  const list = document.getElementById('equipment-list');
  const index = getNextEquipmentIndex();
  const gid = `equip-${index}-groups`;
  const card=document.createElement('div');
  card.className='equipment-card';
  card.dataset.index = String(index);
  const defaultName = `Equipment ${index}`;
  card.innerHTML=`
    <button class="remove-btn btn-x" onclick="removeEquipment(${index})" title="Remove equipment">Ã—</button>
    <div class="equipment-header">
      <div class="equipment-title" id="equip-title-${index}">${defaultName}</div>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>Equipment Name</label>
        <input type="text" class="equipment-name" placeholder="e.g., Air Conditioner" value="${defaultName}">
      </div>
      <div class="form-group">
        <label>Power (W)</label>
        <input type="number" class="equipment-power" min="0" step="0.1" placeholder="1500" value="1500">
      </div>
    </div>

    <h4 style="margin:20px 0 12px 0; color:#4f46e5;">Operating Schedule</h4>

    <div class="equipment-groups" id="${gid}">
      <div class="day-range-group">
        <div class="days-row">
          <div class="days-selector">
            <button class="day-btn active" data-day="1">Mon</button>
            <button class="day-btn active" data-day="2">Tue</button>
            <button class="day-btn active" data-day="3">Wed</button>
            <button class="day-btn active" data-day="4">Thu</button>
            <button class="day-btn active" data-day="5">Fri</button>
            <button class="day-btn" data-day="6">Sat</button>
            <button class="day-btn" data-day="0">Sun</button>
          </div>
          <button class="remove-day-group" onclick="removeEquipDayRange(this)" title="Remove day range">Ã—</button>
        </div>

        <div class="equipment-ranges">
          <div class="time-range">
            <div class="time-row">
              <input type="time" class="time-input" value="09:00"><span>to</span>
              <input type="time" class="time-input" value="17:00">
              <div class="toggle-container" style="margin-left:auto;">
                <span>All Day</span>
                <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
              </div>
              <button class="btn-x tr-remove" onclick="removeEquipmentTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
            </div>
          </div>
        </div>

        <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn btn-secondary" onclick="addEquipmentTimeRange(this)">+ Add Time Range</button>
          <button class="btn btn-secondary outline" onclick="addEquipDayRange('${gid}')">+ Add Day Range</button>
        </div>
      </div>
    </div>

    <div class="equipment-results" style="display:none;margin-top:20px;padding:16px;background:#f8fafc;border-radius:8px;">
      <div class="results-grid"></div>
    </div>`;
  list.appendChild(card);
  activateDayToggles(card);
  wireAllDayToggles(card);
  refreshGroupButtons(card.querySelector('#'+gid));
  updateTimeRangeXs(card);

  const nameInput = card.querySelector('.equipment-name');
  const titleEl = card.querySelector(`#equip-title-${index}`);
  nameInput.addEventListener('input', () => {
    titleEl.textContent = nameInput.value.trim() || defaultName;
  });
}
function removeEquipment(index){
  const el = document.querySelector(`.equipment-card[data-index="${index}"]`);
  if (el) el.remove();
}

function addEquipmentTimeRange(btnOrGroup){
  const group=btnOrGroup.closest ? btnOrGroup.closest('.day-range-group') : btnOrGroup;
  const ranges=group.querySelector('.equipment-ranges');
  const d=document.createElement('div');
  d.className='time-range';
  d.innerHTML=`
    <div class="time-row">
      <input type="time" class="time-input" value="09:00"><span>to</span>
      <input type="time" class="time-input" value="17:00">
      <div class="toggle-container" style="margin-left:auto;">
        <span>All Day</span>
        <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
      </div>
      <button class="btn-x tr-remove" onclick="removeEquipmentTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
    </div>`;
  ranges.appendChild(d);
  wireAllDayToggles(d);
  updateTimeRangeXs(group);
}
function removeEquipmentTimeRange(btn){
  const group = btn.closest('.day-range-group');
  btn.parentElement.parentElement.remove();
  updateTimeRangeXs(group);
}
function addEquipDayRange(groupsId){
  const container=document.getElementById(groupsId);
  const group=document.createElement('div');
  group.className='day-range-group';
  group.innerHTML=`
    <div class="days-row">
      <div class="days-selector">
        <button class="day-btn active" data-day="1">Mon</button>
        <button class="day-btn active" data-day="2">Tue</button>
        <button class="day-btn active" data-day="3">Wed</button>
        <button class="day-btn active" data-day="4">Thu</button>
        <button class="day-btn active" data-day="5">Fri</button>
        <button class="day-btn" data-day="6">Sat</button>
        <button class="day-btn" data-day="0">Sun</button>
      </div>
      <button class="remove-day-group" onclick="removeEquipDayRange(this)" title="Remove day range">Ã—</button>
    </div>
    <div class="equipment-ranges"></div>
    <div class="group-actions" style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn btn-secondary" onclick="addEquipmentTimeRange(this)">+ Add Time Range</button>
      <button class="btn btn-secondary outline" onclick="addEquipDayRange('${groupsId}')">+ Add Day Range</button>
    </div>`;
  container.appendChild(group);
  activateDayToggles(group);
  addEquipmentTimeRange(group);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}
function removeEquipDayRange(btn){
  const group=btn.closest('.day-range-group');
  const container=group.parentElement;
  group.remove();
  if (!container.querySelector('.day-range-group')) addEquipDayRange(container.id);
  refreshGroupButtons(container);
  updateTimeRangeXs(container);
}

/* ========= Calc helpers ========= */
function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
function normalizeTimeRange(s,e){
  const sm=timeToMinutes(s), em=timeToMinutes(e);
  if (sm===0 && em===0) return [{start:0,end:1440}];
  if (sm<=em) return [{start:sm,end:em}];
  return [{start:sm,end:1440},{start:0,end:em}];
}
function mergeOverlapping(ranges){
  if (!ranges.length) return [];
  ranges.sort((a,b)=>a.start-b.start);
  const out=[{...ranges[0]}];
  for (let i=1;i<ranges.length;i++){
    const cur=ranges[i], last=out[out.length-1];
    if (cur.start<=last.end) last.end=Math.max(last.end,cur.end);
    else out.push({...cur});
  }
  return out;
}
function overlapHours(r1,r2){
  let tot=0;
  for (const a of r1) for (const b of r2){
    const st=Math.max(a.start,b.start), en=Math.min(a.end,b.end);
    if (st<en) tot+=en-st;
  }
  return tot/60;
}

/* Build schedules from UI */
function getTariffSchedule(kind){
  const groupsId = (kind==='on-peak') ? 'on-peak-groups' : (kind==='off-peak') ? 'off-peak-groups' : (kind==='shoulder') ? 'shoulder-groups' : null;
  const cont=document.getElementById(groupsId);
  if (!cont) return [];
  const groupEls=[...cont.querySelectorAll('.day-range-group')];
  const out=[];
  groupEls.forEach(g=>{
    const days=[...g.querySelectorAll('.days-selector .day-btn.active')].map(b=>parseInt(b.dataset.day));
    const ranges=[...g.querySelectorAll('.tariff-ranges .time-range')];
    ranges.forEach(r=>{
      const [s,e]=[...r.querySelectorAll('.time-input')].map(i=>i.value);
      if (!s || !e) return;
      out.push({ start:s, end:e, days, allDay:r.dataset.allDay==='1' });
    });
  });
  return out;
}

function formatNumber(n){
  if (roundingEnabled) return Number(n).toFixed(2);
  let f=Number(n).toFixed(6).replace(/\.?0+$/,'');
  if (!f.includes('.')) f+='.00';
  else if (f.split('.')[1].length===1) f+='0';
  return f;
}

function validateInputs(){
  const errs=[];
  const on=parseFloat(document.getElementById('on-peak-rate').value);
  const off=parseFloat(document.getElementById('off-peak-rate').value);
  if (!on || on<=0) errs.push('On-peak rate must be greater than 0');
  if (!off|| off<=0) errs.push('Off-peak rate must be greater than 0');
  if (shoulderEnabled){
    const sh=parseFloat(document.getElementById('shoulder-rate').value);
    if (!sh || sh<=0) errs.push('Shoulder rate must be greater than 0');
    if (!document.getElementById('shoulder-block')) errs.push('Shoulder section missing.');
  }
  const cards=document.querySelectorAll('.equipment-card');
  if (!cards.length) errs.push('At least one equipment must be added');
  cards.forEach((c,idx)=>{
    const p=parseFloat(c.querySelector('.equipment-power').value);
    if (!p || p<=0) errs.push(`Equipment ${idx+1}: Power must be greater than 0`);
    const trs=c.querySelectorAll('.time-range');
    trs.forEach((r,ri)=>{
      const [s,e]=[...r.querySelectorAll('.time-input')].map(i=>i.value);
      if (!s || !e) errs.push(`Equipment ${idx+1}, Range ${ri+1}: Both start and end times required`);
    });
    if (!c.querySelector('.day-btn.active')) errs.push(`Equipment ${idx+1}: At least one day must be selected`);
  });
  return errs;
}

/* ========= Calculation & PDF ========= */
function calculateCosts(){
  const errors=validateInputs();
  document.getElementById('equipment-errors').innerHTML='';
  document.getElementById('tariff-errors').innerHTML='';
  if (errors.length){
    document.getElementById('equipment-errors').innerHTML=errors.map(e=>`<div class="error-message">${e}</div>`).join('');
    document.getElementById('results-container').style.display='none';
    latestElectricWeekTotal = null;
    resetElectricWeekPanel();
    return;
  }

  const onRate=parseFloat(document.getElementById('on-peak-rate').value)/100;
  const offRate=parseFloat(document.getElementById('off-peak-rate').value)/100;
  const shRate=shoulderEnabled ? (parseFloat(document.getElementById('shoulder-rate').value)/100) : 0;

  const onSched=getTariffSchedule('on-peak');
  const offSched=getTariffSchedule('off-peak');
  const shSched=shoulderEnabled ? getTariffSchedule('shoulder') : [];

  let totals={ dailyKwh:0, weeklyKwh:0, monthlyKwh:0, yearlyKwh:0, dailyCost:0, weeklyCost:0, monthlyCost:0, yearlyCost:0, onPeakHours:0, offPeakHours:0, shoulderHours:0 };

  document.querySelectorAll('.equipment-card').forEach(card=>{
    const kW=parseFloat(card.querySelector('.equipment-power').value)/1000;
    let weekOn=0, weekOff=0, weekSh=0;

    const eqGroups=[...card.querySelectorAll('.equipment-groups .day-range-group')];
    eqGroups.forEach(g=>{
      const ranges=[...g.querySelectorAll('.equipment-ranges .time-range')].map(r=>{
        const [s,e]=[...r.querySelectorAll('.time-input')].map(i=>i.value);
        return {start:s,end:e};
      });
      let eqRanges=[];
      ranges.forEach(r=>{ eqRanges = eqRanges.concat(normalizeTimeRange(r.start,r.end)); });
      eqRanges=mergeOverlapping(eqRanges);

      const days=[...g.querySelectorAll('.days-selector .day-btn.active')].map(b=>parseInt(b.dataset.day));
      days.forEach(d=>{
        const dayOn = onSched.filter(x=>x.days.includes(d)).flatMap(x=>normalizeTimeRange(x.start,x.end));
        const dayOff = offSched.filter(x=>x.days.includes(d)).flatMap(x=>normalizeTimeRange(x.start,x.end));
        const daySh = shSched.filter(x=>x.days.includes(d)).flatMap(x=>normalizeTimeRange(x.start,x.end));
        weekOn += overlapHours(eqRanges, mergeOverlapping(dayOn));
        weekOff += overlapHours(eqRanges, mergeOverlapping(dayOff));
        weekSh += overlapHours(eqRanges, mergeOverlapping(daySh));
      });
    });

    const dOn=weekOn/7, dOff=weekOff/7, dSh=weekSh/7;
    const dKwh=kW*(dOn+dOff+dSh);
    const wKwh=kW*(weekOn+weekOff+weekSh);
    const mKwh=wKwh*(365.25/12/7);
    const yKwh=wKwh*(365.25/7);

    const dCost=kW*(dOn*onRate + dOff*offRate + dSh*shRate);
    const wCost=kW*(weekOn*onRate + weekOff*offRate + weekSh*shRate);
    const mCost=wCost*(365.25/12/7);
    const yCost=wCost*(365.25/7);

    const gResults=card.querySelector('.equipment-results .results-grid');
    gResults.innerHTML=`
      <div class="result-item"><div class="result-label">On-Peak Hours/Day</div><div class="result-value">${formatNumber(dOn)}h</div></div>
      ${shoulderEnabled ? `<div class="result-item"><div class="result-label">Shoulder Hours/Day</div><div class="result-value">${formatNumber(dSh)}h</div></div>` : ``}
      <div class="result-item"><div class="result-label">Off-Peak Hours/Day</div><div class="result-value">${formatNumber(dOff)}h</div></div>
      <div class="result-item"><div class="result-label">Daily kWh</div><div class="result-value">${formatNumber(dKwh)}</div></div>
      <div class="result-item"><div class="result-label">Weekly kWh</div><div class="result-value">${formatNumber(wKwh)}</div></div>
      <div class="result-item"><div class="result-label">Monthly kWh</div><div class="result-value">${formatNumber(mKwh)}</div></div>
      <div class="result-item"><div class="result-label">Yearly kWh</div><div class="result-value">${formatNumber(yKwh)}</div></div>
      <div class="result-item"><div class="result-label">Daily Cost</div><div class="result-value">$${formatNumber(dCost)}</div></div>
      <div class="result-item"><div class="result-label">Weekly Cost</div><div class="result-value">$${formatNumber(wCost)}</div></div>
      <div class="result-item"><div class="result-label">Monthly Cost</div><div class="result-value">$${formatNumber(mCost)}</div></div>
      <div class="result-item"><div class="result-label">Yearly Cost</div><div class="result-value">$${formatNumber(yCost)}</div></div>
    `;
    card.querySelector('.equipment-results').style.display='none';

    totals.dailyKwh+=dKwh; totals.weeklyKwh+=wKwh; totals.monthlyKwh+=mKwh; totals.yearlyKwh+=yKwh;
    totals.dailyCost+=dCost; totals.weeklyCost+=wCost; totals.monthlyCost+=mCost; totals.yearlyCost+=yCost;
    totals.onPeakHours+=dOn; totals.offPeakHours+=dOff; totals.shoulderHours+=dSh;
  });

  saveBridgeData('electricity', {
    dailyCost: totals.dailyCost,
    weeklyCost: totals.weeklyCost,
    monthlyCost: totals.monthlyCost,
    yearlyCost: totals.yearlyCost
  });
  latestElectricWeekTotal = totals.weeklyCost;
  showElectricWeekPanel();

  displayTotals(totals);
}

function displayTotals(t){
  const results=document.getElementById('results-container');
  let perEquipHTML='';
  document.querySelectorAll('.equipment-card').forEach((card,idx)=>{
    const name=card.querySelector('.equipment-name').value || `Equipment ${idx+1}`;
    const power=card.querySelector('.equipment-power').value || '?';
    perEquipHTML += `
      <div class="results-section" style="margin-bottom:24px;">
        <h3 class="section-title">ðŸ”Œ ${name} (${power}W)</h3>
        <div class="results-grid">${card.querySelector('.equipment-results .results-grid').innerHTML}</div>
      </div>`;
  });

  results.innerHTML = `
    ${perEquipHTML}
    <div class="results-section">
      <h2 class="section-title">ðŸ“Š Total Usage & Cost Breakdown</h2>
      <div class="results-grid">
        <div class="result-item"><div class="result-label">On-Peak Hours/Day</div><div class="result-value">${formatNumber(t.onPeakHours)}h</div></div>
        ${shoulderEnabled ? `<div class="result-item"><div class="result-label">Shoulder Hours/Day</div><div class="result-value">${formatNumber(t.shoulderHours)}h</div></div>` : ``}
        <div class="result-item"><div class="result-label">Off-Peak Hours/Day</div><div class="result-value">${formatNumber(t.offPeakHours)}h</div></div>
        <div class="result-item"><div class="result-label">Daily kWh</div><div class="result-value">${formatNumber(t.dailyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Weekly kWh</div><div class="result-value">${formatNumber(t.weeklyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Monthly kWh</div><div class="result-value">${formatNumber(t.monthlyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Yearly kWh</div><div class="result-value">${formatNumber(t.yearlyKwh)}</div></div>
        <div class="result-item"><div class="result-label">Daily Cost</div><div class="result-value">$${formatNumber(t.dailyCost)}</div></div>
        <div class="result-item"><div class="result-label">Weekly Cost</div><div class="result-value">$${formatNumber(t.weeklyCost)}</div></div>
        <div class="result-item"><div class="result-label">Monthly Cost</div><div class="result-value">$${formatNumber(t.monthlyCost)}</div></div>
        <div class="result-item"><div class="result-label">Yearly Cost</div><div class="result-value">$${formatNumber(t.yearlyCost)}</div></div>
      </div>
      <div style="text-align:center;margin-top:24px;">
        <button class="btn btn-primary" onclick="downloadPDF()">ðŸ“„ Download Results as PDF</button>
      </div>
    </div>`;
  results.style.display='block';
}

/* ========= PDF ========= */
(function(global){
  function escapePdfText(str){
    return String(str || '')
      .replace(/\\/g,'\\\\')
      .replace(/\(/g,'\\(')
      .replace(/\)/g,'\\)')
      .replace(/[\r\n]/g,' ');
  }

  function mmToPt(value){
    return (Number(value)||0)*72/25.4;
  }

  function buildSimplePdfString(pages, widthMm, heightMm){
    const mmWidth=widthMm||210;
    const mmHeight=heightMm||297;
    const widthPt=mmToPt(mmWidth);
    const heightPt=mmToPt(mmHeight);
    const normalizedPages = pages.length ? pages : [{ lines: [] }];
    const numPages = normalizedPages.length;
    const totalObjects = 4 + numPages*2;
    const objects = new Array(totalObjects+1).fill('');
    const catalogNum = 1;
    const pagesNum = 2;
    const fontNormalNum = 3;
    const fontBoldNum = 4;
    const contentStart = 5;
    const pageStart = contentStart + numPages;
    objects[catalogNum] = `<< /Type /Catalog /Pages ${pagesNum} 0 R >>`;
    const kidRefs = [];
    for(let i=0;i<numPages;i++){
      kidRefs.push(`${pageStart+i} 0 R`);
    }
    objects[pagesNum] = `<< /Type /Pages /Count ${numPages} /Kids [${kidRefs.join(' ')}] >>`;
    objects[fontNormalNum] = `<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>`;
    objects[fontBoldNum] = `<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica-Bold >>`;

    normalizedPages.forEach((page, idx)=>{
      const lines = Array.isArray(page.lines) ? page.lines : [];
      const commands = lines.map(line=>{
        const fontKey = line.fontWeight==='bold' ? 'F2' : 'F1';
        const fontSize = Number(line.fontSize)||12;
        const x = mmToPt(line.x);
        const y = heightPt - mmToPt(line.y);
        return `BT /${fontKey} ${fontSize} Tf 1 0 0 1 ${x.toFixed(2)} ${y.toFixed(2)} Tm (${escapePdfText(line.text)}) Tj ET`;
      }).join('\n');
      const contentObjNum = contentStart+idx;
      const contentBody = commands;
      objects[contentObjNum] = `<< /Length ${contentBody.length} >>\nstream\n${contentBody}\nendstream`;
      const pageObjNum = pageStart+idx;
      objects[pageObjNum] = `<< /Type /Page /Parent ${pagesNum} 0 R /MediaBox [0 0 ${widthPt.toFixed(2)} ${heightPt.toFixed(2)}] /Resources << /Font << /F1 ${fontNormalNum} 0 R /F2 ${fontBoldNum} 0 R >> >> /Contents ${contentObjNum} 0 R >>`;
    });

    let pdf = '%PDF-1.4\n';
    const offsets = new Array(objects.length).fill(0);
    for(let i=1;i<objects.length;i++){
      offsets[i] = pdf.length;
      pdf += `${i} 0 obj\n${objects[i]}\nendobj\n`;
    }
    const xrefPos = pdf.length;
    pdf += `xref\n0 ${objects.length}\n0000000000 65535 f \n`;
    for(let i=1;i<objects.length;i++){
      pdf += `${String(offsets[i]).padStart(10,'0')} 00000 n \n`;
    }
    pdf += `trailer << /Size ${objects.length} /Root ${catalogNum} 0 R >>\nstartxref\n${xrefPos}\n%%EOF`;
    return pdf;
  }

  function createSimplePdfBlob(pages, widthMm, heightMm){
    const pdfString = buildSimplePdfString(pages, widthMm, heightMm);
    return new Blob([pdfString], { type:'application/pdf' });
  }

  function newPage(){
    return { lines: [] };
  }

  class HydroSimplePdfDoc{
    constructor(){
      this.__isHydroFallback = true;
      this.pageWidth = 210;
      this.pageHeight = 297;
      this.internal = { pageSize: { height: this.pageHeight } };
      this.pages = [newPage()];
      this.fontSize = 12;
      this.fontWeight = 'normal';
    }
    get currentPage(){
      return this.pages[this.pages.length-1];
    }
    addPage(){
      this.pages.push(newPage());
    }
    setFontSize(size){
      const parsed = Number(size);
      if(!Number.isNaN(parsed)) this.fontSize = parsed;
    }
    setFont(_family, weight){
      if(weight) this.fontWeight = weight==='bold'?'bold':'normal';
    }
    text(str,x,y){
      const textValue = str==null ? '' : String(str);
      this.currentPage.lines.push({
        text: textValue,
        x: Number(x)||0,
        y: Number(y)||0,
        fontSize: this.fontSize,
        fontWeight: this.fontWeight
      });
    }
    save(filename){
      const blob = createSimplePdfBlob(this.pages, this.pageWidth, this.pageHeight);
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename || 'document.pdf';
      document.body.appendChild(link);
      link.click();
      setTimeout(()=>{
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 0);
    }
  }

  global.HydroSimplePdfDoc = HydroSimplePdfDoc;
})(window);

function getJsPdfCtor(){
  const globalPdf=window.jspdf || window.jspPDF || window.jsPDF;
  if(!globalPdf) return null;
  return typeof globalPdf==='function'?globalPdf:(globalPdf.jsPDF||null);
}

function getPdfEngine(){
  const ctor=getJsPdfCtor();
  if(ctor) return { ctor, supportsBranding:true };
  if(window.HydroSimplePdfDoc) return { ctor: window.HydroSimplePdfDoc, supportsBranding:false };
  return null;
}

async function downloadPDF(){
  const engine=getPdfEngine();
  if(!engine){
    alert('PDF downloads are not available in this preview environment. Please open the calculator directly from your browser.');
    return;
  }
  try{
    const doc=new engine.ctor();
    const branding = engine.supportsBranding ? window.hydroPdfBranding : null;
    const brandKit = branding?.decorate ? await branding.decorate(doc, {
      watermarkOpacity: 0.12,
      watermarkWidth: 38,
      mascotHeight: 18,
      contentGap: 10
    }) : null;
    let y=brandKit?.contentStart ?? 24;
    let H=doc.internal.pageSize.height;
    const M=20;
    const goToNewPage = ()=>{
      doc.addPage();
      H=doc.internal.pageSize.height;
      y=brandKit?.contentStart ?? 24;
    };
    function br(h){ if (y+h>H-M){ goToNewPage(); } }

    const title=(window.elementSdk?.config?.app_title)||defaultConfig.app_title;
    doc.setFontSize(20); doc.setFont(undefined,'bold'); doc.text(title,M,y); y+=15;
    doc.setFontSize(12); doc.setFont(undefined,'normal'); doc.text(`Generated: ${new Date().toLocaleDateString()}`,M,y); y+=12;

    br(20);
    doc.setFontSize(16); doc.setFont(undefined,'bold'); doc.text('Tariff Summary',M,y); y+=10;
    const onRate=document.getElementById('on-peak-rate').value;
    const offRate=document.getElementById('off-peak-rate').value;
    const shRateEl=document.getElementById('shoulder-rate');
    doc.setFontSize(12); doc.setFont(undefined,'normal');
    doc.text(`On-Peak Rate: ${onRate} c/kWh`,M,y); y+=8;
    if (shRateEl){ doc.text(`Shoulder Rate: ${shRateEl.value} c/kWh`,M,y); y+=8; }
    doc.text(`Off-Peak Rate: ${offRate} c/kWh`,M,y); y+=14;

    const cards=document.querySelectorAll('.equipment-card');
    cards.forEach((card,idx)=>{
      br(60);
      const name=card.querySelector('.equipment-name').value;
      const power=card.querySelector('.equipment-power').value;
      doc.setFontSize(14); doc.setFont(undefined,'bold'); doc.text(`Equipment ${idx+1}: ${name}`,M,y); y+=10;
      doc.setFontSize(12); doc.setFont(undefined,'normal'); doc.text(`Power: ${power}W`,M,y); y+=8;

      const items=card.querySelectorAll('.equipment-results .results-grid .result-item');
      items.forEach(it=>{
        br(8);
        const label=it.querySelector('.result-label').textContent;
        const val=it.querySelector('.result-value').textContent;
        doc.text(`${label}: ${val}`,M+10,y); y+=6;
      });
      y+=6;
    });

    br(80);
    doc.setFontSize(16); doc.setFont(undefined,'bold'); doc.text('Total Usage & Cost Breakdown',M,y); y+=12;
    const totalGrid=document.querySelector('#results-container .results-grid');
    if (totalGrid){
      totalGrid.querySelectorAll('.result-item').forEach(it=>{
        br(8);
        const label=it.querySelector('.result-label').textContent;
        const val=it.querySelector('.result-value').textContent;
        doc.setFontSize(12); doc.setFont(undefined,'normal');
        doc.text(`${label}: ${val}`,M,y); y+=8;
      });
    }
    const savedWeeks = getSavedWeeksForCalculator('electricity');
    if(savedWeeks.length){
      br(20);
      doc.setFontSize(16); doc.setFont(undefined,'bold');
      doc.text('Saved Weeks for Harvest',M,y); y+=10;
      doc.setFontSize(12); doc.setFont(undefined,'normal');
      savedWeeks.forEach(week=>{
        br(8);
        doc.text(`${electricStageLabel(week.stage)} Week ${week.weekNumber}: $${formatNumber(week.weeklyCost)} per week`, M, y);
        y+=8;
      });
    }
    doc.setFontSize(10);
    doc.text((window.elementSdk?.config?.footer_text)||defaultConfig.footer_text, M, H-10);
    doc.save('ElectricityCostCalculatorResults.pdf');
  }catch(err){
    console.error('Failed to generate Electricity PDF', err);
  }
}

/* ========= Tariff modal + selects ========= */
function openTariffModal(){ document.getElementById('tariff-modal').classList.add('show'); }
function closeTariffModal(){ document.getElementById('tariff-modal').classList.remove('show'); }
function fillRetailersSelect(){
  const sel=document.getElementById('retailer-select');
  sel.innerHTML=`<option value="">Select Retailer</option>`;
  Object.entries(tariffsData.retailers).forEach(([key,r])=>{
    const opt=document.createElement('option');
    opt.value=key; opt.textContent=r.displayName||key; sel.appendChild(opt);
  });
}
function fillPlansSelect(retailerKey){
  const sel=document.getElementById('plan-select');
  sel.innerHTML=`<option value="">Select Plan</option>`;
  if (!retailerKey) return;
  const plans=tariffsData.retailers[retailerKey]?.plans || {};
  Object.entries(plans).forEach(([pid,p])=>{
    const opt=document.createElement('option');
    opt.value=pid; opt.textContent=p.title||pid; sel.appendChild(opt);
  });
}
function fillRegionsSelect(retailerKey, planId){
  const sel=document.getElementById('region-select');
  sel.innerHTML=`<option value="">Select Region</option>`;
  if (!retailerKey || !planId) return;
  const byRegion=tariffsData.retailers[retailerKey]?.plans?.[planId]?.byRegion || {};
  Object.keys(byRegion).forEach(rid=>{
    const opt=document.createElement('option');
    opt.value=rid; opt.textContent=regionLabels[rid] || rid.toUpperCase(); sel.appendChild(opt);
  });
}

/* Group windows by day-signature so same-day sets share a UI group */
function setWindows(groupsId, windowsArr){
  const container=document.getElementById(groupsId);
  if (!container) return;
  container.innerHTML='';
  if (!windowsArr || !windowsArr.length){ addDayRange(groupsId); return; }

  const grouped = {};
  windowsArr.forEach(w=>{
    const sig = Array.isArray(w.days) ? [...w.days].sort((a,b)=>a-b).join(',') : '';
    if (!grouped[sig]) grouped[sig] = { days:[...(w.days||[])], ranges:[] };
    grouped[sig].ranges.push({start:w.start||'00:00', end:w.end||'00:00'});
  });

  Object.values(grouped).forEach(({days, ranges})=>{
    addDayRange(groupsId);
    const allGroups = container.querySelectorAll('.day-range-group');
    const g = allGroups[allGroups.length-1];
    g.querySelectorAll('.days-selector .day-btn').forEach(btn=>{
      const d=parseInt(btn.dataset.day); btn.classList.toggle('active', days.includes(d));
    });

    const rangesEl = g.querySelector('.tariff-ranges');
    rangesEl.innerHTML='';
    ranges.forEach(r=>{
      const div=document.createElement('div');
      div.className='time-range';
      div.innerHTML=`
        <div class="time-row">
          <input type="time" class="time-input" value="${r.start}">
          <span>to</span>
          <input type="time" class="time-input" value="${r.end}">
          <div class="toggle-container" style="margin-left:auto;">
            <span>All Day</span>
            <div class="toggle all-day-toggle"><div class="toggle-slider"></div></div>
          </div>
          <button class="btn-x tr-remove" onclick="removeTimeRange(this)" title="Remove time range" style="display:none;">Ã—</button>
        </div>`;
      rangesEl.appendChild(div);
      wireAllDayToggles(div);
    });
    updateTimeRangeXs(container);
  });
  refreshGroupButtons(container);
}

function applySelectedTariff(){
  const rSel=document.getElementById('retailer-select').value;
  const pSel=document.getElementById('plan-select').value;
  const reg=document.getElementById('region-select').value;
  const status=document.getElementById('fetch-status');

  if (!rSel || !pSel || !reg){
    status.innerHTML = `<div class="error-message">Please choose retailer, plan, and region.</div>`;
    return;
  }

  const plan=tariffsData.retailers[rSel].plans[pSel];
  const regionRates=plan.byRegion[reg];

  document.getElementById('on-peak-rate').value = regionRates.on.toFixed(4);
  document.getElementById('off-peak-rate').value = regionRates.off.toFixed(4);

  const hasShoulder = typeof regionRates.shoulder==='number' && plan.windows.shoulder && plan.windows.shoulder.length;
  if (hasShoulder){
    if (!shoulderEnabled) setShoulderUI(true);
    document.getElementById('shoulder-rate').value = regionRates.shoulder.toFixed(4);
  }else{
    setShoulderUI(false);
  }

  setWindows('on-peak-groups', plan.windows.on || []);
  setWindows('off-peak-groups', plan.windows.off || []);
  if (shoulderEnabled) setWindows('shoulder-groups', plan.windows.shoulder || []);

  const title = `${tariffsData.retailers[rSel].displayName} â€“ ${plan.title} (${regionLabels[reg] || reg.toUpperCase()})`;
  const titleEl=document.getElementById('selected-plan-title');
  titleEl.textContent=title; titleEl.style.display='inline';
  closeTariffModal();
}

/* ========= Rounding toggle ========= */
function setRoundingUI(active){
  roundingEnabled = !!active;
  const rt=document.getElementById('rounding-toggle');
  if (rt) rt.classList.toggle('active', roundingEnabled);
}

/* ========= DOM Ready wiring ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  initSDK();
  activateDayToggles(document);

  refreshGroupButtons(document.getElementById('on-peak-groups'));
  refreshGroupButtons(document.getElementById('off-peak-groups'));
  wireAllDayToggles(document);
  updateTimeRangeXs(document);

  const rt=document.getElementById('rounding-toggle');
  if (rt) rt.addEventListener('click', ()=> setRoundingUI(!rt.classList.contains('active')));

  const st=document.getElementById('shoulder-toggle');
  if (st) st.addEventListener('click', ()=> setShoulderUI(!st.classList.contains('active')));

  const fetchBtn=document.getElementById('fetch-tariffs-btn');
  if (fetchBtn){
    fetchBtn.addEventListener('click', async ()=>{
      openTariffModal();
      try{
        await fetchTariffsOnce();
        fillRetailersSelect();
        document.getElementById('retailer-select').onchange = (e)=>{
          fillPlansSelect(e.target.value);
          document.getElementById('region-select').innerHTML = `<option value="">Select Region</option>`;
        };
        document.getElementById('plan-select').onchange = (e)=>{
          const rKey=document.getElementById('retailer-select').value;
          fillRegionsSelect(rKey, e.target.value);
        };
      }catch(e){/* error already shown */}
    });
  }

  document.getElementById('add-equipment-btn').addEventListener('click', addEquipment);
  document.getElementById('calculate-btn').addEventListener('click', calculateCosts);
  const weekBtn = document.getElementById('electricWeekSaveBtn');
  if(weekBtn) weekBtn.addEventListener('click', handleElectricWeekSave);
  const clearBtn = document.getElementById('electricClearCacheBtn');
  if(clearBtn) clearBtn.addEventListener('click', handleElectricCacheClear);
  const savedWeeksToggle = document.getElementById('electricSavedWeeksToggle');
  if(savedWeeksToggle){
    const toggleVisibility = ()=> setElectricSavedWeeksVisibility(!electricSavedWeeksVisible);
    savedWeeksToggle.addEventListener('click', (e)=>{ e.preventDefault(); toggleVisibility(); });
    savedWeeksToggle.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        toggleVisibility();
      }
    });
  }
  setElectricSavedWeeksVisibility(false);
  updateElectricSavedWeeksWidget();
  if(typeof window !== 'undefined'){
    window.addEventListener('storage', event=>{
      if(event.key === BRIDGE_STORAGE_KEY) updateElectricSavedWeeksWidget();
    });
  }

  setRoundingUI(true);
  setShoulderUI(false);
  addEquipment();
});
</script>
</body>
</html>
