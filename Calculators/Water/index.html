<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Water Cost Calculator</title>
  <link rel="stylesheet" href="../../shared/styles/calculators.css" id="ho-shared-css-water">

  <script type="application/json" id="ho-css-fallback-water">
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Inter:wght@400;500;600;700;800&display=swap');

  #nutri-calc .saved-weeks-widget,
  #water-calc .saved-weeks-widget,
  #ecalc .saved-weeks-widget{
    background:#f8faf8;
    border:1px dashed #d4e4dd;
    border-radius:12px;
    padding:12px 14px;
    margin:12px 0;
    font-size:14px;
    color:#2f3e39;
    position:relative;
    z-index:1;
  }
  #nutri-calc .saved-weeks-widget .widget-title,
  #water-calc .saved-weeks-widget .widget-title,
  #ecalc .saved-weeks-widget .widget-title{
    font-weight:700;
    color:#2D5C4E;
    display:flex;
    align-items:center;
    gap:6px;
    margin-bottom:6px;
  }
  #nutri-calc .saved-weeks-widget ul,
  #water-calc .saved-weeks-widget ul,
  #ecalc .saved-weeks-widget ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  #nutri-calc .saved-weeks-widget .sw-stage,
  #water-calc .saved-weeks-widget .sw-stage,
  #ecalc .saved-weeks-widget .sw-stage{ margin-top:6px; }
  #nutri-calc .saved-weeks-widget .sw-stage-label,
  #water-calc .saved-weeks-widget .sw-stage-label,
  #ecalc .saved-weeks-widget .sw-stage-label{
    font-weight:700;
    color:#1f3b33;
    margin-bottom:4px;
  }
  #nutri-calc .saved-weeks-widget .sw-week,
  #water-calc .saved-weeks-widget .sw-week,
  #ecalc .saved-weeks-widget .sw-week{
    font-weight:600;
    color:#1f3b33;
    margin-right:6px;
  }
  #nutri-calc .saved-weeks-widget .sw-meta,
  #water-calc .saved-weeks-widget .sw-meta,
  #ecalc .saved-weeks-widget .sw-meta{
    font-size:12px;
    color:#52615b;
  }
  #nutri-calc .saved-weeks-widget .sw-empty,
  #water-calc .saved-weeks-widget .sw-empty,
  #ecalc .saved-weeks-widget .sw-empty{
    font-size:13px;
    color:#52615b;
  }
  #nutri-calc .saved-weeks-toggle,
  #water-calc .saved-weeks-toggle,
  #ecalc .saved-weeks-toggle,
  #harvest-calc .saved-weeks-toggle{
    display:flex;
    justify-content:flex-end;
    margin:10px 0 0;
    color:#456E62;
    font-size:14px;
    gap:8px;
  }
  #nutri-calc .saved-weeks-toggle .toggle-container,
  #water-calc .saved-weeks-toggle .toggle-container,
  #ecalc .saved-weeks-toggle .toggle-container,
  #harvest-calc .saved-weeks-toggle .toggle-container{
    margin-left:auto;
  }
  #nutri-calc .saved-weeks-toggle span,
  #water-calc .saved-weeks-toggle span,
  #ecalc .saved-weeks-toggle span,
  #harvest-calc .saved-weeks-toggle span{
    font-weight:600;
  }

  :root{
    --bg:#FDFBF4; --text:#333333; --heading:#2D5C4E;
    --btn:#2D5C4E; --btn-hover:#A76DAB; --btn-text:#FFFFFF;
    --card:#FFFFFF; --card-border:#E7E5DC; --icon:#2D5C4E; --err:#BE5C5C;
    --sec-border:#D9E2DE; --sec-head-bg:#F3F7F5; --sec-head-text:#2D5C4E;
    --tile-bg:#FFFFFF; --tile-border:#E7E5DC; --tile-label:#5C6F69; --tile-value:#2D5C4E;
  }

  #water-calc, #water-calc * { box-sizing:border-box; }
  #water-calc{
    background:var(--bg); color:var(--text); padding:40px 20px;
    font-family:'Nunito', sans-serif; line-height:1.6;
  }
  #water-calc .wrap{ max-width:1100px; margin:0 auto; }
  #water-calc .card{
    background:var(--card); border:1px solid var(--card-border); border-radius:14px;
    padding:28px 24px 34px; box-shadow:0 2px 8px rgba(49,71,58,.08);
    position:relative; overflow:hidden; margin:18px 0;
  }
  #water-calc .wm-img{
    position:absolute; right:14px; bottom:14px; width:min(160px,20%);
    opacity:.12; pointer-events:none; user-select:none; z-index:0;
    filter:saturate(.95) contrast(.95);
  }
  #water-calc .title-block{ text-align:center; margin:4px 0 6px; position:relative; z-index:1; }
  #water-calc .title-block h1{
    font-family:'Inter',system-ui,sans-serif; font-weight:800; letter-spacing:.2px;
    color:var(--heading); margin:0; font-size:clamp(28px,4vw,40px);
  }
  #water-calc .subtitle{
    text-align:center; color:#56645d; font-family:'Inter',system-ui,sans-serif;
    font-weight:500; font-size:clamp(12px,2.1vw,14px); margin:0 0 16px;
  }
  #water-calc .sec-title{
    color:var(--heading); font-weight:800; font-size:18px; display:flex;
    align-items:center; gap:8px; margin:14px 0 12px; position:relative; z-index:1;
  }
  #water-calc .dot{ width:18px; height:18px; border-radius:4px; background:var(--icon); display:inline-block; }
  #water-calc .grid{ display:grid; gap:14px; position:relative; z-index:1; }
  #water-calc .g-3{ grid-template-columns: repeat(3,1fr); }
  #water-calc .g-2{ grid-template-columns: repeat(2,1fr); }
  @media (max-width:820px){ #water-calc .g-3, #water-calc .g-2{ grid-template-columns:1fr; } }
  #water-calc label{ display:block; font-size:13px; color:#516A64; margin:2px 0 6px; }
  #water-calc .input, #water-calc select{
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid #c4c8b8; background:#fff; font-size:16px;
    appearance:none; -webkit-appearance:none; color:#31473a;
  }
  #water-calc .help{ font-size:12px; color:#6B7C77; margin-top:6px; }
  #water-calc .error{ border-color:var(--err)!important; }
  #water-calc .error-msg{ color:var(--err); font-size:12px; margin:8px 0; display:none; text-align:center; font-weight:800; }
  #water-calc .error-msg.show{ display:block; }
  #water-calc .btn{
    background:var(--btn); color:var(--btn-text); border:1px solid var(--btn);
    border-radius:12px; padding:14px 36px; font-weight:800; cursor:pointer; font-size:1.1em;
    display:inline-block; box-shadow:0 4px 12px rgba(53,88,74,.2);
    transition: transform .05s ease, box-shadow .08s ease, filter .08s ease, background-color .12s ease, border-color .12s ease;
    user-select:none; -webkit-tap-highlight-color:transparent;
    -webkit-text-fill-color: var(--btn-text);
  }
  #water-calc .btn:hover{
    background:var(--btn-hover) !important; border-color:var(--btn-hover) !important;
    color:var(--btn-text) !important; -webkit-text-fill-color:var(--btn-text) !important;
  }
  #water-calc .btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(45,92,78,.18); }
  #water-calc .btn:is(:active,.is-pressed){
    transform: translateY(1px);
    box-shadow: inset 0 2px 6px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.06);
    filter: saturate(.98) brightness(.98);
  }
  #water-calc .center{ text-align:center; }
  #water-calc .sec-card{
    border:1px solid var(--sec-border); border-radius:12px; padding:12px; background:#fff; margin-top:14px;
  }
  #water-calc .sec-head{
    display:flex; align-items:center; gap:8px; background:var(--sec-head-bg); color:var(--sec-head-text);
    padding:8px 10px; border-radius:9px; font-weight:800; font-size:14px;
  }
  #water-calc .sec-head .icon{ font-size:16px; line-height:1; }
  #water-calc .stats{
    display:grid; grid-template-columns: repeat(5, minmax(120px,1fr)); gap:10px; padding:10px 6px 6px;
  }
  @media (max-width:980px){ #water-calc .stats{ grid-template-columns: repeat(2, minmax(140px,1fr)); } }
  @media (max-width:560px){ #water-calc .stats{ grid-template-columns: 1fr; } }
  #water-calc .stat{
    background:var(--tile-bg); border:1px solid var(--tile-border); border-radius:10px; padding:10px 12px; text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,.03);
  }
  #water-calc .stat .label{ font-size:12px; color:var(--tile-label); font-weight:700; letter-spacing:.2px; }
  #water-calc .stat .value{ margin-top:4px; font-size:18px; font-weight:800; color:var(--tile-value); }
  #ho-watermark{
    position:fixed; right:16px; bottom:12px; background:rgba(45,92,78,.08); color:#2D5C4E;
    border:1px solid #E7E5DC; border-radius:10px; padding:6px 10px; font:600 12px/1 'Inter',system-ui,sans-serif;
    backdrop-filter:blur(2px); z-index:50; pointer-events:none; user-select:none;
  }
  #water-calc .btn, #water-calc .btn *{
    color:var(--btn-text) !important; -webkit-text-fill-color:var(--btn-text) !important;
  }
  </script>

  <script data-css-link="ho-shared-css-water" data-css-payload="ho-css-fallback-water" data-inline-style="ho-inline-css-water">
    (function(){
      var current = document.currentScript;
      if(!current) return;
      var linkId = current.dataset.cssLink;
      var payloadId = current.dataset.cssPayload;
      var inlineId = current.dataset.inlineStyle;
      function inject(){
        if(document.getElementById(inlineId)) return;
        var payload = document.getElementById(payloadId);
        if(!payload) return;
        var css = payload.textContent;
        if(!css) return;
        var style = document.createElement('style');
        style.id = inlineId;
        style.textContent = css;
        document.head.appendChild(style);
      }
      var linkEl = document.getElementById(linkId);
      if(!linkEl){
        inject();
        return;
      }
      linkEl.addEventListener('error', inject, { once:true });
      function verify(){
        try{
          var sheet = linkEl.sheet;
          if(!sheet || !sheet.cssRules || !sheet.cssRules.length){
            inject();
          }
        }catch(err){
          inject();
        }
      }
      if(document.readyState === 'complete'){
        setTimeout(verify, 0);
      }else{
        window.addEventListener('load', function(){ setTimeout(verify, 0); }, { once:true });
      }
      setTimeout(verify, 1500);
    })();
  </script>

  <!-- SDKs (kept consistent with your other calcs) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div id="water-calc">
  <div class="wrap">
    <div class="card">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true" decoding="async" loading="lazy">
      <div class="title-block">
        <h1 id="main-heading">Water Cost Calculator</h1>
        <div class="subtitle">Estimate water cost per litre, per plant, and totals for your grow</div>
      </div>

      <div class="saved-weeks-toggle">
        <div class="toggle-container">
          <span>Show Saved Weeks for Harvest</span>
          <div class="toggle" id="waterSavedWeeksToggle" role="switch" aria-checked="false" tabindex="0">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <div id="waterSavedWeeks" class="saved-weeks-widget" style="display:none;">
        <div class="widget-title">ðŸ“˜ Saved Weeks for Harvest</div>
        <div id="waterSavedWeeksList"></div>
      </div>

      <div class="saved-weeks-actions">
        <button class="btn btn-ghost" id="waterClearCacheBtn" type="button">ðŸ§¹ Clear Water Cache</button>
        <div class="help" id="waterClearCacheStatus"></div>
      </div>

      <!-- Inputs -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Input Parameters</span></div>
      <div class="grid g-3" style="margin-bottom:6px;">
        <div>
          <label for="numPlants">Number of Plants</label>
          <input class="input" type="number" id="numPlants" min="0" step="1" placeholder="e.g., 10">
        </div>
        <div>
          <label for="waterPerPlant">Litres per Plant per Watering</label>
          <input class="input" type="number" id="waterPerPlant" min="0" step="0.01" placeholder="e.g., 2.5">
        </div>
        <div>
          <label for="waterFrequency">Watering Frequency (days/week)</label>
          <input class="input" type="number" id="waterFrequency" min="0" max="7" step="0.1" placeholder="e.g., 3">
          <div class="help">From 0 to 7.</div>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:6px;">
        <div>
          <label for="waterProvider">Water Provider</label>
          <select class="input" id="waterProvider">
            <option value="">Select your water provider...</option>
            <option value="loading">Loading providers...</option>
          </select>
        </div>
        <div>
          <label for="waterCost">Water Cost ($/kL)</label>
          <input class="input" type="number" id="waterCost" min="0" step="0.01" placeholder="e.g., 2.50">
          <div id="rateInfo" class="help"></div>
        </div>
      </div>

      <!-- Options + actions -->
      <div class="center" style="margin-top:14px;">
        <label class="inline" style="font-size:14px;">
          <input id="roundResults" type="checkbox" checked style="margin-right:6px; vertical-align:-2px;"> Round currency to 2 decimals
        </label>
      </div>

      <div class="error-msg" id="errorMessage"></div>

      <div class="center" style="margin-top:14px;">
        <button class="btn" id="calculateBtn" type="button">Calculate</button>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsCard" class="card" style="display:none;">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true" decoding="async" loading="lazy">
      <div id="resultsContainer"></div>

      <div id="waterWeekPanel" class="week-save" style="display:none; margin-top:16px;">
        <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Send this week to the Harvest calculator</span></div>
        <div class="grid g-3" style="gap:12px;">
          <div>
            <label for="waterWeekStage">Stage</label>
            <select id="waterWeekStage" class="input">
              <option value="vegetative">Vegetative</option>
              <option value="flowering">Generative (Flowering)</option>
            </select>
          </div>
          <div>
            <label for="waterWeekNumber">Week Number</label>
            <input id="waterWeekNumber" type="number" class="input" min="1" step="1" placeholder="e.g., 4">
            <div class="help">Match the exact veg/flower week in your grow.</div>
          </div>
          <div class="center" style="align-self:end;">
            <button id="waterWeekSaveBtn" class="btn btn-ghost" type="button">Save Week for Harvest</button>
            <div id="waterWeekStatus" class="help" style="margin-top:6px;"></div>
          </div>
        </div>
      </div>

      <div class="center" style="margin-top:12px;">
        <button id="downloadBtn" class="btn" type="button" style="display:none;">Download Results (PDF)</button>
      </div>
    </div>
  </div>
</div>

<!-- Fixed watermark (matches your other calculators) -->
<div id="ho-watermark" aria-hidden="true">Hydro Oasis â€¢ Water Cost Calculator</div>

<script>
  /* ========= Config ========= */
  const defaultConfig = {
    main_heading: "Water Cost Calculator",
    calculate_button_text: "Calculate",
    download_button_text: "Download Results (PDF)"
  };

  const BRIDGE_STORAGE_KEY = 'hoCalcBridge';
  const WATER_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering (Generative)' };
  const SAVED_WEEK_CALC_LABELS = { nutrient: 'Nutrients', water: 'Water', electricity: 'Electricity' };
  const SAVED_WEEK_STAGE_LABELS = { vegetative: 'Vegetative', flowering: 'Flowering' };
  const SAVED_WEEK_STAGE_ORDER = { vegetative: 0, flowering: 1 };
  let waterSavedWeeksVisible = false;

  function applyWaterSavedWeeksVisibility(){
    const widget = document.getElementById('waterSavedWeeks');
    if(widget){
      widget.style.display = waterSavedWeeksVisible ? 'block' : 'none';
    }
    const toggle = document.getElementById('waterSavedWeeksToggle');
    if(toggle){
      toggle.classList.toggle('active', waterSavedWeeksVisible);
      toggle.setAttribute('aria-checked', waterSavedWeeksVisible ? 'true' : 'false');
    }
  }

  function setWaterSavedWeeksVisibility(show){
    waterSavedWeeksVisible = !!show;
    applyWaterSavedWeeksVisibility();
  }
  function saveBridgeData(calculator, payload){
    try{
      if(typeof window === 'undefined' || !window.localStorage) return;
      const existing = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      existing[calculator] = { ...payload, updatedAt: Date.now() };
      window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(existing));
    }catch(err){
      console.warn('Hydro Oasis bridge save skipped:', err);
    }
  }

  function clearBridgeDataForCalculator(calculatorKey){
    try{
      if(typeof window === 'undefined' || !window.localStorage) return false;
      const raw = window.localStorage.getItem(BRIDGE_STORAGE_KEY);
      if(!raw) return false;
      const data = JSON.parse(raw || '{}');
      let changed = false;
      if(data[calculatorKey]){
        delete data[calculatorKey];
        changed = true;
      }
      if(data.stageWeeks){
        Object.keys(data.stageWeeks).forEach(stage=>{
          const stageData = data.stageWeeks[stage];
          if(!stageData) return;
          Object.keys(stageData).forEach(weekKey=>{
            const weekEntry = stageData[weekKey];
            if(weekEntry && weekEntry[calculatorKey]){
              delete weekEntry[calculatorKey];
              changed = true;
            }
            if(weekEntry && Object.keys(weekEntry).length === 0){
              delete stageData[weekKey];
            }
          });
          if(Object.keys(stageData).length === 0){
            delete data.stageWeeks[stage];
          }
        });
        if(Object.keys(data.stageWeeks).length === 0){
          delete data.stageWeeks;
        }
      }
      if(!changed) return false;
      if(Object.keys(data).length === 0){
        window.localStorage.removeItem(BRIDGE_STORAGE_KEY);
      }else{
        window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(data));
      }
      return true;
    }catch(err){
      console.warn('Hydro Oasis clear cache skipped:', err);
      return false;
    }
  }

  function waterNormalizeStage(stage){
    return (stage === 'flowering' || stage === 'generative') ? 'flowering' : 'vegetative';
  }
  function waterStageLabel(stage){
    return WATER_STAGE_LABELS[waterNormalizeStage(stage)] || WATER_STAGE_LABELS.vegetative;
  }
  function saveWaterWeekSnapshot(stage, weekNumber, weeklyCost){
    if(!(weekNumber > 0) || !Number.isFinite(weeklyCost)) return false;
    try{
      if(typeof window === 'undefined' || !window.localStorage) return false;
      const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      if(!data.stageWeeks) data.stageWeeks = { vegetative:{}, flowering:{} };
      const normalizedStage = waterNormalizeStage(stage);
      if(!data.stageWeeks[normalizedStage]) data.stageWeeks[normalizedStage] = {};
      const weekKey = String(weekNumber);
      const existingWeek = data.stageWeeks[normalizedStage][weekKey] || {};
      existingWeek.water = { weeklyCost, updatedAt: Date.now() };
      data.stageWeeks[normalizedStage][weekKey] = existingWeek;
      window.localStorage.setItem(BRIDGE_STORAGE_KEY, JSON.stringify(data));
      return true;
    }catch(err){
      console.warn('Hydro Oasis week save skipped:', err);
      return false;
    }
  }

  function getSavedWeeksSummary(){
    const empty = { vegetative: [], flowering: [], totalCount: 0 };
    try{
      if(typeof window === 'undefined' || !window.localStorage) return empty;
      const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      const stageWeeks = data?.stageWeeks || {};
      const parseStage = (stageKey)=>{
        const stageData = stageWeeks[stageKey] || {};
        return Object.keys(stageData).map(weekKey=>{
          const weekNumber = parseInt(weekKey, 10);
          if(!Number.isFinite(weekNumber)) return null;
          const entry = stageData[weekKey] || {};
          const calculators = Object.entries(SAVED_WEEK_CALC_LABELS).reduce((list, [calcKey, label])=>{
            const value = Number(entry?.[calcKey]?.weeklyCost);
            if(Number.isFinite(value)) list.push(label);
            return list;
          }, []);
          if(calculators.length === 0) return null;
          return { weekNumber, calculators };
        }).filter(Boolean).sort((a,b)=>a.weekNumber - b.weekNumber);
      };
      const vegetative = parseStage('vegetative');
      const flowering = parseStage('flowering');
      return { vegetative, flowering, totalCount: vegetative.length + flowering.length };
    }catch(err){
      console.warn('Hydro Oasis saved weeks read skipped:', err);
      return empty;
    }
  }

  function getSavedWeeksForCalculator(calculatorKey){
    const rows = [];
    try{
      if(typeof window === 'undefined' || !window.localStorage) return rows;
      const data = JSON.parse(window.localStorage.getItem(BRIDGE_STORAGE_KEY) || '{}');
      const stageWeeks = data?.stageWeeks || {};
      Object.keys(stageWeeks).forEach(stage=>{
        const stageData = stageWeeks[stage] || {};
        Object.keys(stageData).forEach(weekKey=>{
          const entry = stageData[weekKey]?.[calculatorKey];
          const weekNumber = parseInt(weekKey, 10);
          const weeklyCost = Number(entry?.weeklyCost);
          if(Number.isFinite(weekNumber) && Number.isFinite(weeklyCost)){
            rows.push({ stage, weekNumber, weeklyCost });
          }
        });
      });
      rows.sort((a,b)=>{
        const stageDiff = (SAVED_WEEK_STAGE_ORDER[a.stage] ?? 99) - (SAVED_WEEK_STAGE_ORDER[b.stage] ?? 99);
        if(stageDiff !== 0) return stageDiff;
        return a.weekNumber - b.weekNumber;
      });
    }catch(err){
      console.warn('Hydro Oasis saved weeks detail read skipped:', err);
    }
    return rows;
  }

  function updateWaterSavedWeeksWidget(){
    const widget = $('waterSavedWeeks');
    const body = $('waterSavedWeeksList');
    if(!widget || !body) return;
    const summary = getSavedWeeksSummary();
    if(summary.totalCount === 0){
      body.innerHTML = '<div class="sw-empty">No weeks saved yet. Save a week after running the Nutrient, Water, or Electricity calculators.</div>';
      applyWaterSavedWeeksVisibility();
      return;
    }
    const sections = [];
    ['vegetative','flowering'].forEach(stage=>{
      if(summary[stage].length){
        const label = SAVED_WEEK_STAGE_LABELS[stage] || stage;
        const rows = summary[stage].map(week=>{
          const calcList = week.calculators.join(', ');
          return `<li><span class="sw-week">Week ${week.weekNumber}</span><span class="sw-meta">${calcList}</span></li>`;
        }).join('');
        sections.push(`<div class="sw-stage"><div class="sw-stage-label">${label}</div><ul>${rows}</ul></div>`);
      }
    });
    body.innerHTML = sections.join('');
    applyWaterSavedWeeksVisibility();
  }

  function handleWaterCacheClear(){
    const status = $('waterClearCacheStatus');
    if(status){
      status.textContent = 'Clearing saved water dataâ€¦';
      status.style.color = '#6B7C77';
    }
    const cleared = clearBridgeDataForCalculator('water');
    if(status){
      if(cleared){
        status.textContent = 'Water cache cleared.';
        status.style.color = '#1f7a54';
      }else{
        status.textContent = 'No saved water data to clear.';
        status.style.color = '#6B7C77';
      }
    }
    updateWaterSavedWeeksWidget();
  }

  /* ========= Provider Data (External JSON + fallback) ========= */
  // If this file is placed at Calculators/Water/index.html, this relative path is correct:
  const PROVIDERS_URL = "https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Water_Providers.json?v=1762665123";

  // Fallback (only used if the JSON file canâ€™t be fetched)
  const FALLBACK_PROVIDERS = [
    {"name":"Icon Water","state":"ACT","rate":2.78,"tier":"Tier 1"},
    {"name":"Icon Water","state":"ACT","rate":5.58,"tier":"Tier 2"},
    {"name":"Sydney Water","state":"NSW","rate":3.17,"tier":"Standard Rate"},
    {"name":"Hunter Water","state":"NSW","rate":2.89,"tier":"Standard Rate"},
    {"name":"Central Coast Council","state":"NSW","rate":2.62,"tier":"Standard Rate"},
    {"name":"Power and Water Corporation","state":"NT","rate":2.26,"tier":"Standard Rate"},
    {"name":"Urban Utilities","state":"QLD","rate":0.98,"tier":"Tier 1"},
    {"name":"Urban Utilities","state":"QLD","rate":2.03,"tier":"Tier 2"},
    {"name":"Unity Water","state":"QLD","rate":0.787,"tier":"Tier 1"},
    {"name":"Unity Water","state":"QLD","rate":1.57,"tier":"Tier 2"},
    {"name":"Gold Coast Water","state":"QLD","rate":4.824,"tier":"Standard Rate"},
    {"name":"Townsville Water â€“ Standard Plan (excess over 772 kL)","state":"QLD","rate":4.13,"tier":"Excess Usage"},
    {"name":"Townsville Water â€“ Water Watchers Plan","state":"QLD","rate":1.73,"tier":"Usage Charge"},
    {"name":"SA Water","state":"SA","rate":2.37,"tier":"Tier 1"},
    {"name":"SA Water","state":"SA","rate":3.36,"tier":"Tier 2"},
    {"name":"SA Water","state":"SA","rate":3.64,"tier":"Tier 3"},
    {"name":"TasWater","state":"TAS","rate":1.26,"tier":"Standard Rate"},
    {"name":"Yarra Valley Water","state":"VIC","rate":3.43,"tier":"Tier 1"},
    {"name":"Yarra Valley Water","state":"VIC","rate":4.5,"tier":"Tier 2"},
    {"name":"South East Water","state":"VIC","rate":3.76,"tier":"Tier 1"},
    {"name":"South East Water","state":"VIC","rate":4.8,"tier":"Tier 2"},
    {"name":"City West Water","state":"VIC","rate":3.64,"tier":"Tier 1"},
    {"name":"City West Water","state":"VIC","rate":4.16,"tier":"Tier 2"},
    {"name":"Water Corporation","state":"WA","rate":2.052,"tier":"Tier 1"},
    {"name":"Water Corporation","state":"WA","rate":2.73,"tier":"Tier 2"},
    {"name":"Water Corporation","state":"WA","rate":5.11,"tier":"Tier 3"}
  ];

  /* ========= DOM ========= */
  const $ = (id)=>document.getElementById(id);
  const els = {
    numPlants: $('numPlants'),
    waterPerPlant: $('waterPerPlant'),
    waterFrequency: $('waterFrequency'),
    waterProvider: $('waterProvider'),
    waterCost: $('waterCost'),
    rateInfo: $('rateInfo'),
    roundResults: $('roundResults'),
    errorMessage: $('errorMessage'),
    calculateBtn: $('calculateBtn'),
    downloadBtn: $('downloadBtn'),
    resultsCard: $('resultsCard'),
    resultsContainer: $('resultsContainer'),
    heading: $('main-heading')
  };

  let calculationResults = null;
  let latestWaterWeekTotal = null;

  function resetWaterWeekPanel(){
    const panel = $('waterWeekPanel');
    if(panel) panel.style.display = 'none';
    const status = $('waterWeekStatus');
    if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
  }

  function showWaterWeekPanel(){
    const panel = $('waterWeekPanel');
    if(panel) panel.style.display = 'block';
    const status = $('waterWeekStatus');
    if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
  }

  function handleWaterWeekSave(){
    const status = $('waterWeekStatus');
    if(status){ status.textContent=''; status.style.color = '#6B7C77'; }
    if(!Number.isFinite(latestWaterWeekTotal)){
      if(status){ status.textContent = 'Calculate your water cost first.'; status.style.color = '#b91c1c'; }
      return;
    }
    const stage = $('waterWeekStage')?.value || 'vegetative';
    const weekNumber = parseInt($('waterWeekNumber')?.value, 10);
    if(!(weekNumber > 0)){
      if(status){ status.textContent = 'Enter a valid week number (1 or higher).'; status.style.color = '#b91c1c'; }
      return;
    }
    const ok = saveWaterWeekSnapshot(stage, weekNumber, latestWaterWeekTotal);
    if(status){
      if(ok){
        status.textContent = `Saved ${waterStageLabel(stage)} week ${weekNumber} for Harvest.`;
        status.style.color = '#1f7a54';
        updateWaterSavedWeeksWidget();
      }else{
        status.textContent = 'Unable to save this week. Please try again.';
        status.style.color = '#b91c1c';
      }
    }
  }

  /* ========= UI Helpers ========= */
  function makeSection(title, icon){
    const sec = document.createElement('div');
    sec.className = 'sec-card';
    const head = document.createElement('div');
    head.className = 'sec-head';
    head.innerHTML = `<span class="icon">${icon||'ðŸ“Š'}</span><span>${title}</span>`;
    const stats = document.createElement('div');
    stats.className = 'stats';
    sec.append(head, stats);
    return {sec, stats};
  }
  function statTile(label, value){
    const d = document.createElement('div'); d.className='stat';
    d.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return d;
  }
  function formatNumber(value, shouldRound) {
    if (shouldRound) return value.toFixed(2);
    let s = value.toFixed(6).replace(/\.?0+$/, '');
    const parts = s.split('.');
    if (!parts[1] || parts[1].length < 2) s = value.toFixed(2);
    return s;
  }
  function formatCurrency(v, round){ return '$' + formatNumber(v, round); }

  /* ========= Providers ========= */
  function getStateName(abbrev){
    return ({NSW:'New South Wales',VIC:'Victoria',QLD:'Queensland',SA:'South Australia',WA:'Western Australia',TAS:'Tasmania',NT:'Northern Territory',ACT:'Australian Capital Territory'})[abbrev]||abbrev;
  }
  async function loadWaterProviders(){
    let providers = [];
    try{
      const res = await fetch(PROVIDERS_URL + '?cb=' + Date.now(), {cache:'no-store', credentials:'omit', mode:'cors'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      providers = await res.json();
    }catch(e){
      console.warn('Provider JSON fetch failed, using fallback.', e);
      providers = FALLBACK_PROVIDERS;
    }
    els.waterProvider.innerHTML = '<option value="">Select your water provider...</option>';

    const grouped = {};
    providers.forEach(p=>{ (grouped[p.state]||(grouped[p.state]=[])).push(p); });
    Object.keys(grouped).sort().forEach(state=>{
      const og = document.createElement('optgroup'); og.label = getStateName(state);
      grouped[state].forEach(p=>{
        const opt = document.createElement('option');
        opt.value = JSON.stringify(p);
        opt.textContent = `${p.name} - $${p.rate}/kL (${p.tier})`;
        og.appendChild(opt);
      });
      els.waterProvider.appendChild(og);
    });
    const custom = document.createElement('option');
    custom.value = 'custom'; custom.textContent = 'Enter custom rate...';
    els.waterProvider.appendChild(custom);
  }
  function handleProviderSelection(){
    const v = els.waterProvider.value;
    if(!v){ els.waterCost.value=''; els.rateInfo.textContent=''; els.waterCost.disabled=false; return; }
    if(v==='custom'){
      els.waterCost.value=''; els.waterCost.disabled=false; els.rateInfo.textContent='Enter your custom water rate per kilolitre'; els.waterCost.focus(); return;
    }
    try{
      const provider = JSON.parse(v);
      els.waterCost.value = provider.rate;
      els.waterCost.disabled = true;
      els.rateInfo.textContent = `Rate: $${provider.rate}/kL (${provider.tier}) â€“ ${provider.name}`;
    }catch(e){ els.waterCost.disabled=false; }
  }

  /* ========= Validation & Calc ========= */
  function validate(){
    const np = parseFloat(els.numPlants.value);
    const wpp = parseFloat(els.waterPerPlant.value);
    const wf = parseFloat(els.waterFrequency.value);
    const wc = parseFloat(els.waterCost.value);

    els.errorMessage.classList.remove('show');

    if(!Number.isFinite(np) || !Number.isFinite(wpp) || !Number.isFinite(wf) || !Number.isFinite(wc))
      return "Please fill in all fields with valid numbers.";
    if(!(np>0)) return "Number of plants must be greater than zero.";
    if(!(wpp>0)) return "Litres per plant must be greater than zero.";
    if(!(wf>=0 && wf<=7)) return "Watering frequency must be between 0 and 7.";
    if(!(wc>0)) return "Water cost must be greater than zero.";
    return null;
  }

  function calculate(){
    const err = validate();
    if(err){
      els.errorMessage.textContent = err;
      els.errorMessage.classList.add('show');
      els.resultsCard.style.display = 'none';
      els.downloadBtn.style.display = 'none';
      calculationResults = null;
      latestWaterWeekTotal = null;
      resetWaterWeekPanel();
      return;
    }

    const np = parseFloat(els.numPlants.value);
    const wpp = parseFloat(els.waterPerPlant.value);
    const wf = parseFloat(els.waterFrequency.value);
    const wc = parseFloat(els.waterCost.value);
    const round = els.roundResults.checked;

    const costPerLitre = wc / 1000;
    const perPlantDaily  = wpp * costPerLitre;
    const perPlantWeekly = perPlantDaily * wf;
    const perPlantMonthly= perPlantWeekly * 4;
    const perPlantYearly = perPlantMonthly * 12;

    const totalDaily  = perPlantDaily  * np;
    const totalWeekly = perPlantWeekly * np;
    const totalMonthly= perPlantMonthly* np;
    const totalYearly = perPlantYearly * np;

    calculationResults = {
      inputs:{ numPlants:np, waterPerPlant:wpp, waterFrequency:wf, waterCost:wc },
      costPerLitre,
      perPlant:{ daily:perPlantDaily, weekly:perPlantWeekly, monthly:perPlantMonthly, yearly:perPlantYearly },
      totals:{ daily:totalDaily, weekly:totalWeekly, monthly:totalMonthly, yearly:totalYearly },
      round
    };

    saveBridgeData('water', {
      dailyCost: totalDaily,
      weeklyCost: totalWeekly,
      monthlyCost: totalMonthly,
      yearlyCost: totalYearly
    });
    latestWaterWeekTotal = totalWeekly;

    renderResults();
    els.resultsCard.style.display = 'block';
    els.downloadBtn.style.display  = 'inline-block';
    showWaterWeekPanel();
  }

  /* ========= Render results ========= */
  function renderResults(){
    if(!calculationResults) return;
    const R = calculationResults.round;
    const root = els.resultsContainer;
    root.innerHTML = '';

    const s1 = makeSection('Water Cost per Litre', 'ðŸ’§');
    s1.stats.appendChild(statTile('Cost per Litre', formatCurrency(calculationResults.costPerLitre, R)));
    root.appendChild(s1.sec);

    const s2 = makeSection('Per Plant Cost (by period)', 'ðŸŒ±');
    s2.stats.appendChild(statTile('Daily',   formatCurrency(calculationResults.perPlant.daily, R)));
    s2.stats.appendChild(statTile('Weekly',  formatCurrency(calculationResults.perPlant.weekly, R)));
    s2.stats.appendChild(statTile('Monthly', formatCurrency(calculationResults.perPlant.monthly, R)));
    s2.stats.appendChild(statTile('Yearly',  formatCurrency(calculationResults.perPlant.yearly, R)));
    root.appendChild(s2.sec);

    const s3 = makeSection('Total Cost (all plants)', 'ðŸ“ˆ');
    s3.stats.appendChild(statTile('Daily Total',   formatCurrency(calculationResults.totals.daily, R)));
    s3.stats.appendChild(statTile('Weekly Total',  formatCurrency(calculationResults.totals.weekly, R)));
    s3.stats.appendChild(statTile('Monthly Total', formatCurrency(calculationResults.totals.monthly, R)));
    s3.stats.appendChild(statTile('Yearly Total',  formatCurrency(calculationResults.totals.yearly, R)));
    root.appendChild(s3.sec);
  }

  /* ========= PDF ========= */
  function generatePDF(){
    if(!calculationResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const R = calculationResults.round;

    let y = 30, line = 8, margin = 18, pageH = doc.internal.pageSize.height;
    const check = need => { if(y+need > pageH - margin){ doc.addPage(); y = 30; } };

    doc.setFont('helvetica','bold'); doc.setFontSize(22);
    const title = document.getElementById('main-heading').textContent || 'Water Cost Calculator';
    const w = doc.getTextWidth(title);
    doc.text(title, (doc.internal.pageSize.width - w)/2, y); y += 16;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Input Parameters', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Number of Plants: ${calculationResults.inputs.numPlants}`, margin, y); y += line;
    doc.text(`Litres per Plant per Watering: ${calculationResults.inputs.waterPerPlant}`, margin, y); y += line;
    doc.text(`Watering Frequency: ${calculationResults.inputs.waterFrequency} days/week`, margin, y); y += line;
    doc.text(`Water Cost: $${calculationResults.inputs.waterCost} per kL`, margin, y); y += 12;

    check(30);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Water Cost per Litre', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Per Litre: ${formatCurrency(calculationResults.costPerLitre, R)}`, margin, y); y += 12;

    check(50);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Per Plant Cost', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Daily: ${formatCurrency(calculationResults.perPlant.daily, R)}`, margin, y); y += line;
    doc.text(`Weekly: ${formatCurrency(calculationResults.perPlant.weekly, R)}`, margin, y); y += line;
    doc.text(`Monthly: ${formatCurrency(calculationResults.perPlant.monthly, R)}`, margin, y); y += line;
    doc.text(`Yearly: ${formatCurrency(calculationResults.perPlant.yearly, R)}`, margin, y); y += 12;

    check(50);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Total Cost (All Plants)', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Daily Total: ${formatCurrency(calculationResults.totals.daily, R)}`, margin, y); y += line;
    doc.text(`Weekly Total: ${formatCurrency(calculationResults.totals.weekly, R)}`, margin, y); y += line;
    doc.text(`Monthly Total: ${formatCurrency(calculationResults.totals.monthly, R)}`, margin, y); y += line;
    doc.text(`Yearly Total: ${formatCurrency(calculationResults.totals.yearly, R)}`, margin, y);

    const savedWeeks = getSavedWeeksForCalculator('water');
    if(savedWeeks.length){
      check(20);
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Saved Weeks for Harvest', margin, y); y += 10;
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      savedWeeks.forEach(week=>{
        check(line);
        doc.text(`${waterStageLabel(week.stage)} Week ${week.weekNumber}: ${formatCurrency(week.weeklyCost, R)} per week`, margin, y);
        y += line;
      });
    }

    doc.save('WaterCostCalculatorResults.pdf');
  }

  /* ========= Button tactile feedback (pressed feel) ========= */
  (function(){
    const root = document.getElementById('water-calc');
    const BTN_SEL = '.btn';
    function pressOn(el){ el.classList.add('is-pressed'); }
    function pressOff(el){ el.classList.remove('is-pressed'); }

    root.addEventListener('pointerdown', e => { const b=e.target.closest(BTN_SEL); if(b) pressOn(b); });
    root.addEventListener('pointerup',   e => { const b=e.target.closest(BTN_SEL); if(b) pressOff(b); });
    root.addEventListener('pointercancel', e => { const b=e.target.closest(BTN_SEL); if(b) pressOff(b); });
    root.addEventListener('pointerleave',  e => { const b=e.target.closest(BTN_SEL); if(b) pressOff(b); });
    root.addEventListener('keydown', e => { if(e.key===' '||e.key==='Enter'){ const b=e.target.closest(BTN_SEL); if(b) pressOn(b); }});
    root.addEventListener('keyup',   e => { if(e.key===' '||e.key==='Enter'){ const b=e.target.closest(BTN_SEL); if(b) pressOff(b); }});
  })();

  /* ========= SDK + Events ========= */
  function onConfigChange(cfg){
    els.heading.textContent = cfg.main_heading || defaultConfig.main_heading;
    els.calculateBtn.textContent = cfg.calculate_button_text || defaultConfig.calculate_button_text;
    els.downloadBtn.textContent  = cfg.download_button_text  || defaultConfig.download_button_text;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      if (window.elementSdk && typeof window.elementSdk.init === 'function') {
        window.elementSdk.init({ defaultConfig, onConfigChange,
          mapToEditPanelValues: (cfg)=>new Map([
            ["main_heading", cfg.main_heading || defaultConfig.main_heading],
            ["calculate_button_text", cfg.calculate_button_text || defaultConfig.calculate_button_text],
            ["download_button_text", cfg.download_button_text || defaultConfig.download_button_text]
          ])
        });
      }
    }catch(e){ console.warn('Element SDK init skipped:', e); }

    loadWaterProviders();

    els.waterProvider.addEventListener('change', handleProviderSelection);
    els.calculateBtn.addEventListener('click', (e)=>{ e.preventDefault(); calculate(); e.currentTarget.blur(); });
    els.downloadBtn.addEventListener('click', generatePDF);
    const saveBtn = $('waterWeekSaveBtn');
    if(saveBtn) saveBtn.addEventListener('click', handleWaterWeekSave);
    const clearBtn = $('waterClearCacheBtn');
    if(clearBtn) clearBtn.addEventListener('click', handleWaterCacheClear);
    const savedWeeksToggle = document.getElementById('waterSavedWeeksToggle');
    if(savedWeeksToggle){
      const toggleVisibility = ()=> setWaterSavedWeeksVisibility(!waterSavedWeeksVisible);
      savedWeeksToggle.addEventListener('click', (e)=>{ e.preventDefault(); toggleVisibility(); });
      savedWeeksToggle.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          toggleVisibility();
        }
      });
    }
    setWaterSavedWeeksVisibility(false);
    updateWaterSavedWeeksWidget();
    if(typeof window !== 'undefined'){
      window.addEventListener('storage', event=>{
        if(event.key === BRIDGE_STORAGE_KEY) updateWaterSavedWeeksWidget();
      });
    }

    // Enter to calculate
    ['numPlants','waterPerPlant','waterFrequency','waterCost'].forEach(id=>{
      $(id).addEventListener('keypress', e=>{ if(e.key==='Enter') calculate(); });
    });
  });
</script>
</body>
</html>
