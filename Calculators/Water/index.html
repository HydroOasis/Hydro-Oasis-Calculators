<body>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Cost Calculator</title>

<!-- SDKs (kept) -->
<script src="/_sdk/element_sdk.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&amp;display=swap" rel="stylesheet">

<style>
  /* ========= Hydro Oasis Scoped Theme (no global bleed) ========= */
  :root{
    --bg:#FDFBF4; --text:#333; --heading:#2D5C4E;
    --btn:#2D5C4E; --btn-hover:#A76DAB; --btn-text:#fff;
    --card:#fff; --card-border:#E7E5DC; --icon:#2D5C4E; --err:#BE5C5C;

    /* Results sections + tiles (matches your other calcs) */
    --sec-border:#D9E2DE;
    --sec-head-bg:#F3F7F5;
    --sec-head-text:#2D5C4E;
    --tile-bg:#FFFFFF;
    --tile-border:#E7E5DC;
    --tile-label:#5C6F69;
    --tile-value:#2D5C4E;
  }

  #water-calc, #water-calc * { box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  #water-calc { background:var(--bg); color:var(--text); padding:16px; }
  #water-calc .wrap{ max-width:1100px; margin:0 auto; }

  /* Base card + watermark */
  #water-calc .card{
    background:var(--card); border:1px solid var(--card-border); border-radius:16px;
    padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.06); position:relative; overflow:hidden;
    margin:18px 0;
  }
  #water-calc .wm-img{
    position:absolute; right:-28px; bottom:-28px; width:260px; opacity:.06;
    pointer-events:none; user-select:none; z-index:0;
    filter:saturate(.95) contrast(.95);
  }
  @media (min-width:768px){ #water-calc .wm-img{ width:320px; } }

  /* Title */
  #water-calc .title-block{ text-align:center; margin:6px 0 10px; position:relative; z-index:1; }
  #water-calc .title-block h1{ color:var(--heading); font-weight:800; font-size:clamp(26px,3.2vw,36px); margin:0; letter-spacing:.3px; }
  #water-calc .subtitle{ color:#456E62; font-size:14px; }

  /* Section titles */
  #water-calc .sec-title{ color:var(--heading); font-weight:800; font-size:18px; display:flex; align-items:center; gap:8px; margin:14px 0 12px; position:relative; z-index:1; }
  #water-calc .dot{ width:18px; height:18px; border-radius:4px; background:var(--icon); display:inline-block; }

  /* Grid + inputs */
  #water-calc .grid{ display:grid; gap:14px; position:relative; z-index:1; }
  #water-calc .g-3{ grid-template-columns: repeat(3,1fr); }
  #water-calc .g-2{ grid-template-columns: repeat(2,1fr); }
  @media (max-width:820px){ #water-calc .g-3, #water-calc .g-2{ grid-template-columns:1fr; } }

  #water-calc label{ display:block; font-size:13px; color:#516A64; margin:2px 0 6px; }
  #water-calc .input, #water-calc select{
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid #D1D1D1; background:#fff; font-size:16px;
    appearance:none; -webkit-appearance:none;
  }
  #water-calc .help{ font-size:12px; color:#6B7C77; margin-top:6px; }
  #water-calc .error{ border-color:var(--err)!important; }
  #water-calc .error-msg{ color:var(--err); font-size:12px; margin:8px 0; display:none; }
  #water-calc .error-msg.show{ display:block; }

  /* Buttons */
  #water-calc .btn{
    background:var(--btn); color:var(--btn-text); border:1px solid var(--btn);
    border-radius:12px; padding:12px 18px; font-weight:700; cursor:pointer; transition:.15s; position:relative; z-index:1;
  }
  #water-calc .btn:hover{ background:var(--btn-hover); border-color:var(--btn-hover); }
  #water-calc .btn-ghost{ background:#f3f5f1; color:#1f3b33; border-color:#d9e2de; }
  #water-calc .btn-ghost:hover{ background:#e8eee9; }
  #water-calc .center{ text-align:center; }

  /* Results section cards + tiles (same as other calcs) */
  #water-calc .sec-card{
    border:1px solid var(--sec-border); border-radius:12px; padding:12px; background:#fff; margin-top:14px;
  }
  #water-calc .sec-head{
    display:flex; align-items:center; gap:8px; background:var(--sec-head-bg); color:var(--sec-head-text);
    padding:8px 10px; border-radius:9px; font-weight:800; font-size:14px;
  }
  #water-calc .sec-head .icon{ font-size:16px; line-height:1; }
  #water-calc .stats{
    display:grid; grid-template-columns: repeat(5, minmax(120px,1fr)); gap:10px; padding:10px 6px 6px;
  }
  @media (max-width:980px){ #water-calc .stats{ grid-template-columns: repeat(2, minmax(140px,1fr)); } }
  @media (max-width:560px){ #water-calc .stats{ grid-template-columns: 1fr; } }
  #water-calc .stat{
    background:var(--tile-bg); border:1px solid var(--tile-border); border-radius:10px; padding:10px 12px; text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,.03);
  }
  #water-calc .stat .label{ font-size:12px; color:var(--tile-label); font-weight:700; letter-spacing:.2px; }
  #water-calc .stat .value{ margin-top:4px; font-size:18px; font-weight:800; color:var(--tile-value); }
</style>


<div id="water-calc">
  <div class="wrap">
    <div class="card">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">
      <div class="title-block">
        <h1 id="main-heading">Water Cost Calculator</h1>
        <div class="subtitle">Estimate water cost per litre, per plant, and totals for your grow</div>
      </div>

      <!-- Inputs -->
      <div class="sec-title">
<span class="dot" aria-hidden="true"></span><span>Input Parameters</span>
</div>
      <div class="grid g-3" style="margin-bottom:6px;">
        <div>
          <label for="numPlants">Number of Plants</label>
          <input class="input" type="number" id="numPlants" min="0" step="1" placeholder="e.g., 10">
        </div>
        <div>
          <label for="waterPerPlant">Litres per Plant per Watering</label>
          <input class="input" type="number" id="waterPerPlant" min="0" step="0.01" placeholder="e.g., 2.5">
        </div>
        <div>
          <label for="waterFrequency">Watering Frequency (days/week)</label>
          <input class="input" type="number" id="waterFrequency" min="0" max="7" step="0.1" placeholder="e.g., 3">
          <div class="help">From 0 to 7.</div>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:6px;">
        <div>
          <label for="waterProvider">Water Provider</label>
          <select class="input" id="waterProvider">
            <option value="">Select your water provider...</option>
            <option value="loading">Loading providers...</option>
          </select>
        </div>
        <div>
          <label for="waterCost">Water Cost ($/kL)</label>
          <input class="input" type="number" id="waterCost" min="0" step="0.01" placeholder="e.g., 2.50">
          <div id="rateInfo" class="help"></div>
        </div>
      </div>

      <!-- Options + actions -->
      <div class="center" style="margin-top:14px;">
        <label class="inline" style="font-size:14px;">
          <input id="roundResults" type="checkbox" checked style="margin-right:6px; vertical-align:-2px;"> Round currency to 2 decimals
        </label>
      </div>

      <div class="error-msg" id="errorMessage"></div>

      <div class="center" style="margin-top:14px;">
        <button class="btn" id="calculateBtn" type="button">Calculate</button>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsCard" class="card" style="display:none;">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">
      <div id="resultsContainer"></div>

      <div class="center" style="margin-top:12px;">
        <button id="downloadBtn" class="btn" type="button" style="display:none;">Download Results (PDF)</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* ========= Config ========= */
  const defaultConfig = {
    main_heading: "Water Cost Calculator",
    calculate_button_text: "Calculate",
    download_button_text: "Download Results (PDF)"
  };

  /* ========= Provider Data ========= */
  const australianWaterProviders = [
    // NSW
    { name: "Sydney Water (NSW)", state: "NSW", rate: 2.35, tier: "Tier 1 (0-200kL)" },
    { name: "Sydney Water (NSW) - Tier 2", state: "NSW", rate: 3.15, tier: "Tier 2 (200kL+)" },
    { name: "Hunter Water (NSW)", state: "NSW", rate: 2.28, tier: "Standard Rate" },
    { name: "Central Coast Council (NSW)", state: "NSW", rate: 2.42, tier: "Standard Rate" },

    // VIC
    { name: "Yarra Valley Water (VIC)", state: "VIC", rate: 2.18, tier: "Tier 1 (0-440L/day)" },
    { name: "Yarra Valley Water (VIC) - Tier 2", state: "VIC", rate: 3.28, tier: "Tier 2 (440L+/day)" },
    { name: "South East Water (VIC)", state: "VIC", rate: 2.31, tier: "Tier 1" },
    { name: "City West Water (VIC)", state: "VIC", rate: 2.25, tier: "Tier 1" },
    { name: "Greater Western Water (VIC)", state: "VIC", rate: 2.19, tier: "Standard Rate" },
    { name: "Barwon Water (VIC)", state: "VIC", rate: 2.45, tier: "Standard Rate" },

    // QLD
    { name: "Urban Utilities (Brisbane, QLD)", state: "QLD", rate: 2.67, tier: "Standard Rate" },
    { name: "Queensland Urban Utilities - Tier 2", state: "QLD", rate: 3.21, tier: "Tier 2 (800L+/day)" },
    { name: "Unity Water (Sunshine Coast, QLD)", state: "QLD", rate: 2.58, tier: "Standard Rate" },
    { name: "Gold Coast Water (QLD)", state: "QLD", rate: 2.73, tier: "Standard Rate" },
    { name: "Townsville Water (QLD)", state: "QLD", rate: 2.89, tier: "Standard Rate" },

    // SA
    { name: "SA Water (Adelaide)", state: "SA", rate: 2.95, tier: "Tier 1 (0-125kL)" },
    { name: "SA Water (Adelaide) - Tier 2", state: "SA", rate: 3.85, tier: "Tier 2 (125kL+)" },

    // WA
    { name: "Water Corporation (Perth, WA)", state: "WA", rate: 1.95, tier: "Tier 1 (0-150kL)" },
    { name: "Water Corporation (Perth, WA) - Tier 2", state: "WA", rate: 2.65, tier: "Tier 2 (150-500kL)" },
    { name: "Water Corporation (Perth, WA) - Tier 3", state: "WA", rate: 3.85, tier: "Tier 3 (500kL+)" },

    // TAS
    { name: "TasWater (Hobart, TAS)", state: "TAS", rate: 1.85, tier: "Standard Rate" },
    { name: "TasWater (Launceston, TAS)", state: "TAS", rate: 1.92, tier: "Standard Rate" },

    // NT
    { name: "Power and Water Corporation (Darwin, NT)", state: "NT", rate: 1.56, tier: "Standard Rate" },
    { name: "Power and Water Corporation (Alice Springs, NT)", state: "NT", rate: 2.12, tier: "Standard Rate" },

    // ACT
    { name: "Icon Water (Canberra, ACT)", state: "ACT", rate: 2.87, tier: "Tier 1 (0-200kL)" },
    { name: "Icon Water (Canberra, ACT) - Tier 2", state: "ACT", rate: 4.21, tier: "Tier 2 (200kL+)" }
  ];

  /* ========= DOM ========= */
  const $ = (id)=>document.getElementById(id);
  const els = {
    numPlants: $('numPlants'),
    waterPerPlant: $('waterPerPlant'),
    waterFrequency: $('waterFrequency'),
    waterProvider: $('waterProvider'),
    waterCost: $('waterCost'),
    rateInfo: $('rateInfo'),
    roundResults: $('roundResults'),
    errorMessage: $('errorMessage'),
    calculateBtn: $('calculateBtn'),
    downloadBtn: $('downloadBtn'),
    resultsCard: $('resultsCard'),
    resultsContainer: $('resultsContainer'),
    heading: $('main-heading')
  };

  let calculationResults = null;

  /* ========= UI Helpers (matching other calcs) ========= */
  function makeSection(title, icon){
    const sec = document.createElement('div');
    sec.className = 'sec-card';
    const head = document.createElement('div');
    head.className = 'sec-head';
    head.innerHTML = `<span class="icon">${icon||'ðŸ“Š'}</span><span>${title}</span>`;
    const stats = document.createElement('div');
    stats.className = 'stats';
    sec.append(head, stats);
    return {sec, stats};
  }
  function statTile(label, value){
    const d = document.createElement('div'); d.className='stat';
    d.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return d;
  }

  function formatNumber(value, shouldRound) {
    if (shouldRound) return value.toFixed(2);
    let s = value.toFixed(6).replace(/\.?0+$/, '');
    const parts = s.split('.');
    if (!parts[1] || parts[1].length < 2) s = value.toFixed(2);
    return s;
  }
  function formatCurrency(v, round){ return '$' + formatNumber(v, round); }

  /* ========= Providers ========= */
  function getStateName(abbrev){
    return ({
      NSW:'New South Wales', VIC:'Victoria', QLD:'Queensland', SA:'South Australia',
      WA:'Western Australia', TAS:'Tasmania', NT:'Northern Territory', ACT:'Australian Capital Territory'
    })[abbrev] || abbrev;
  }
  function loadWaterProviders(){
    // Simulate load
    setTimeout(()=>{
      els.waterProvider.innerHTML = '<option value="">Select your water provider...</option>';
      const grouped = {};
      australianWaterProviders.forEach(p=>{ (grouped[p.state]||(grouped[p.state]=[])).push(p); });
      Object.keys(grouped).sort().forEach(state=>{
        const og = document.createElement('optgroup'); og.label = getStateName(state);
        grouped[state].forEach(p=>{
          const opt = document.createElement('option');
          opt.value = JSON.stringify(p);
          opt.textContent = `${p.name} - $${p.rate}/kL (${p.tier})`;
          og.appendChild(opt);
        });
        els.waterProvider.appendChild(og);
      });
      const custom = document.createElement('option');
      custom.value = 'custom'; custom.textContent = 'Enter custom rate...';
      els.waterProvider.appendChild(custom);
    }, 400);
  }
  function handleProviderSelection(){
    const v = els.waterProvider.value;
    if(!v){ els.waterCost.value=''; els.rateInfo.textContent=''; els.waterCost.disabled=false; return; }
    if(v==='custom'){
      els.waterCost.value=''; els.waterCost.disabled=false; els.rateInfo.textContent='Enter your custom water rate per kilolitre'; els.waterCost.focus(); return;
    }
    try{
      const provider = JSON.parse(v);
      els.waterCost.value = provider.rate;
      els.waterCost.disabled = true;
      els.rateInfo.textContent = `Rate: $${provider.rate}/kL (${provider.tier}) â€“ ${provider.name}`;
    }catch(e){ els.waterCost.disabled=false; }
  }

  /* ========= Validation & Calc ========= */
  function validate(){
    const np = parseFloat(els.numPlants.value);
    const wpp = parseFloat(els.waterPerPlant.value);
    const wf = parseFloat(els.waterFrequency.value);
    const wc = parseFloat(els.waterCost.value);

    els.errorMessage.classList.remove('show');

    if(!Number.isFinite(np) || !Number.isFinite(wpp) || !Number.isFinite(wf) || !Number.isFinite(wc))
      return "Please fill in all fields with valid numbers.";
    if(!(np>0)) return "Number of plants must be greater than zero.";
    if(!(wpp>0)) return "Litres per plant must be greater than zero.";
    if(!(wf>=0 && wf<=7)) return "Watering frequency must be between 0 and 7.";
    if(!(wc>0)) return "Water cost must be greater than zero.";
    return null;
  }

  function calculate(){
    const err = validate();
    if(err){
      els.errorMessage.textContent = err;
      els.errorMessage.classList.add('show');
      els.resultsCard.style.display = 'none';
      els.downloadBtn.style.display = 'none';
      calculationResults = null;
      return;
    }

    const np = parseFloat(els.numPlants.value);
    const wpp = parseFloat(els.waterPerPlant.value);
    const wf = parseFloat(els.waterFrequency.value);
    const wc = parseFloat(els.waterCost.value);
    const round = els.roundResults.checked;

    const costPerLitre = wc / 1000;
    const perPlantDaily = wpp * costPerLitre;
    const perPlantWeekly = perPlantDaily * wf;
    const perPlantMonthly = perPlantWeekly * 4;
    const perPlantYearly = perPlantMonthly * 12;

    const totalDaily = perPlantDaily * np;
    const totalWeekly = perPlantWeekly * np;
    const totalMonthly = perPlantMonthly * np;
    const totalYearly = perPlantYearly * np;

    calculationResults = {
      inputs: { numPlants:np, waterPerPlant:wpp, waterFrequency:wf, waterCost:wc },
      costPerLitre,
      perPlant: { daily:perPlantDaily, weekly:perPlantWeekly, monthly:perPlantMonthly, yearly:perPlantYearly },
      totals:   { daily:totalDaily, weekly:totalWeekly, monthly:totalMonthly, yearly:totalYearly },
      round
    };

    renderResults();
    els.resultsCard.style.display = 'block';
    els.downloadBtn.style.display = 'inline-block';
  }

  /* ========= Render results in Hydro Oasis tiles ========= */
  function renderResults(){
    if(!calculationResults) return;
    const R = calculationResults.round;
    const root = els.resultsContainer;
    root.innerHTML = '';

    // Cost per litre section
    const s1 = makeSection('Water Cost per Litre', 'ðŸ’§');
    s1.stats.appendChild(statTile('Cost per Litre', formatCurrency(calculationResults.costPerLitre, R)));
    root.appendChild(s1.sec);

    // Per-plant section
    const s2 = makeSection('Per Plant Cost (by period)', 'ðŸŒ±');
    s2.stats.appendChild(statTile('Daily',   formatCurrency(calculationResults.perPlant.daily, R)));
    s2.stats.appendChild(statTile('Weekly',  formatCurrency(calculationResults.perPlant.weekly, R)));
    s2.stats.appendChild(statTile('Monthly', formatCurrency(calculationResults.perPlant.monthly, R)));
    s2.stats.appendChild(statTile('Yearly',  formatCurrency(calculationResults.perPlant.yearly, R)));
    root.appendChild(s2.sec);

    // Totals section
    const s3 = makeSection('Total Cost (all plants)', 'ðŸ“ˆ');
    s3.stats.appendChild(statTile('Daily Total',   formatCurrency(calculationResults.totals.daily, R)));
    s3.stats.appendChild(statTile('Weekly Total',  formatCurrency(calculationResults.totals.weekly, R)));
    s3.stats.appendChild(statTile('Monthly Total', formatCurrency(calculationResults.totals.monthly, R)));
    s3.stats.appendChild(statTile('Yearly Total',  formatCurrency(calculationResults.totals.yearly, R)));
    root.appendChild(s3.sec);
  }

  /* ========= PDF ========= */
  function generatePDF(){
    if(!calculationResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const R = calculationResults.round;

    let y = 30, line = 8, margin = 18, pageH = doc.internal.pageSize.height;
    const check = need => { if(y+need > pageH - margin){ doc.addPage(); y = 30; } };

    doc.setFont('helvetica','bold'); doc.setFontSize(22);
    const title = $('main-heading').textContent || 'Water Cost Calculator';
    const w = doc.getTextWidth(title);
    doc.text(title, (doc.internal.pageSize.width - w)/2, y); y += 16;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Input Parameters', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Number of Plants: ${calculationResults.inputs.numPlants}`, margin, y); y += line;
    doc.text(`Litres per Plant per Watering: ${calculationResults.inputs.waterPerPlant}`, margin, y); y += line;
    doc.text(`Watering Frequency: ${calculationResults.inputs.waterFrequency} days/week`, margin, y); y += line;
    doc.text(`Water Cost: $${calculationResults.inputs.waterCost} per kL`, margin, y); y += 12;

    check(30);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Water Cost per Litre', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Per Litre: ${formatCurrency(calculationResults.costPerLitre, R)}`, margin, y); y += 12;

    check(50);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Per Plant Cost', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Daily: ${formatCurrency(calculationResults.perPlant.daily, R)}`, margin, y); y += line;
    doc.text(`Weekly: ${formatCurrency(calculationResults.perPlant.weekly, R)}`, margin, y); y += line;
    doc.text(`Monthly: ${formatCurrency(calculationResults.perPlant.monthly, R)}`, margin, y); y += line;
    doc.text(`Yearly: ${formatCurrency(calculationResults.perPlant.yearly, R)}`, margin, y); y += 12;

    check(50);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Total Cost (All Plants)', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Daily Total: ${formatCurrency(calculationResults.totals.daily, R)}`, margin, y); y += line;
    doc.text(`Weekly Total: ${formatCurrency(calculationResults.totals.weekly, R)}`, margin, y); y += line;
    doc.text(`Monthly Total: ${formatCurrency(calculationResults.totals.monthly, R)}`, margin, y); y += line;
    doc.text(`Yearly Total: ${formatCurrency(calculationResults.totals.yearly, R)}`, margin, y);

    doc.save('WaterCostCalculatorResults.pdf');
  }

  /* ========= Event wiring ========= */
  function onConfigChange(cfg){
    els.heading.textContent = cfg.main_heading || defaultConfig.main_heading;
    els.calculateBtn.textContent = cfg.calculate_button_text || defaultConfig.calculate_button_text;
    els.downloadBtn.textContent  = cfg.download_button_text  || defaultConfig.download_button_text;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // SDK init (safe)
    try{
      if (window.elementSdk && typeof window.elementSdk.init === 'function') {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: onConfigChange,
          mapToEditPanelValues: (cfg)=>new Map([
            ["main_heading", cfg.main_heading || defaultConfig.main_heading],
            ["calculate_button_text", cfg.calculate_button_text || defaultConfig.calculate_button_text],
            ["download_button_text", cfg.download_button_text || defaultConfig.download_button_text]
          ])
        });
      }
    }catch(e){ console.warn('Element SDK init skipped:', e); }

    loadWaterProviders();

    els.waterProvider.addEventListener('change', handleProviderSelection);
    els.calculateBtn.addEventListener('click', calculate);
    els.downloadBtn.addEventListener('click', generatePDF);

    // Enter to calculate
    ['numPlants','waterPerPlant','waterFrequency','waterCost'].forEach(id=>{
      $(id).addEventListener('keypress', e=>{ if(e.key==='Enter') calculate(); });
    });
  });
</script>

</body>
