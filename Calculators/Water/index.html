<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Water Cost Calculator</title>

  <!-- SDKs -->
  <script>
  // Only try to load Shopify/theme SDK in production storefronts, not in GitHub preview
  (function(){
    var isPreview = /github\.io|raw\.githubusercontent\.com|htmlpreview/i.test(location.href);
    if (isPreview) return; // skip in preview environments
    var s = document.createElement('script');
    s.src = '/_sdk/element_sdk.js';
    s.defer = true;
    document.head.appendChild(s);
  })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="../../assets/cea.css">
  <link rel="stylesheet" href="../../shared/hoa-calcs.css">
  <!-- CDN fallbacks for GitHub preview / raw.githubusercontent -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HydroOasis/Hydro-Oasis-Calculators@main/assets/cea.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HydroOasis/Hydro-Oasis-Calculators@main/shared/hoa-calcs.css" media="print" onload="this.media='all'">
</head>
<body>

<div class="hoa-calc" id="water-calc">
  <div class="wrap">
    <div class="card">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">
      <div class="title-block">
        <h1 id="main-heading">Water Cost Calculator</h1>
        <div class="subtitle">Estimate water cost per litre, per plant, and totals for your grow</div>
      </div>

      <!-- Inputs -->
      <div class="sec-title"><span class="dot" aria-hidden="true"></span><span>Input Parameters</span></div>
      <div class="grid g-3" style="margin-bottom:6px;">
        <div>
          <label for="numPlants">Number of Plants</label>
          <input class="input" type="number" id="numPlants" min="0" step="1" placeholder="e.g., 10">
        </div>
        <div>
          <label for="waterPerPlant">Litres per Plant per Watering</label>
          <input class="input" type="number" id="waterPerPlant" min="0" step="0.01" placeholder="e.g., 2.5">
        </div>
        <div>
          <label for="waterFrequency">Watering Frequency (days/week)</label>
          <input class="input" type="number" id="waterFrequency" min="0" max="7" step="0.1" placeholder="e.g., 3">
          <div class="help">From 0 to 7.</div>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:6px;">
        <!-- State -->
        <div class="input">
          <label for="waterState">State</label>
          <select id="waterState">
            <option value="">All statesâ€¦</option>
          </select>
        </div>

        <!-- Provider -->
        <div class="input">
          <label for="providerSelect">Water Provider</label>
          <select id="providerSelect" disabled>
            <option value="">Select providerâ€¦</option>
          </select>
          <small class="help-text">Choose a provider or leave blank to use a custom rate.</small>
        </div>

        <!-- Tier -->
        <div class="input">
          <label for="providerTier">Tariff Tier</label>
          <select id="providerTier" disabled>
            <option value="">Select tierâ€¦</option>
          </select>
          <small class="help-text">If your provider has multiple tiers, pick the one that applies.</small>
        </div>

        <!-- Custom rate stays as-is -->
        <div>
          <label for="ratePerKL">Water Cost ($/kL)</label>
          <input class="input" type="number" id="ratePerKL" min="0" step="0.01" placeholder="e.g., 2.50">
        </div>
      </div>

      <div id="waterErrors" class="error-message" style="display:none"></div>

      <div class="center" style="margin-top:14px;">
        <label class="inline" style="font-size:14px;">
          <input id="roundResults" type="checkbox" checked style="margin-right:6px; vertical-align:-2px;"> Round currency to 2 decimals
        </label>
      </div>

      <div class="error-msg" id="errorMessage"></div>

      <div class="center" style="margin-top:14px;">
        <button class="btn" id="calculateBtn" type="button">Calculate</button>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsCard" class="card" style="display:none;">
      <img class="wm-img" src="https://cdn.shopify.com/s/files/1/0709/5261/6094/files/Cactus_Mascot.png?v=1750645317" alt="" aria-hidden="true">
      <div id="resultsContainer"></div>

      <div class="center" style="margin-top:12px;">
        <button id="downloadBtn" class="btn" type="button" style="display:none;">Download Results (PDF)</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* ========= Config (Element SDK) ========= */
  const defaultConfig = {
    main_heading: "Water Cost Calculator",
    calculate_button_text: "Calculate",
    download_button_text: "Download Results (PDF)"
  };

  /* ========= DOM ========= */
  const $ = (id)=>document.getElementById(id);
  const els = {
    numPlants: $('numPlants'),
    waterPerPlant: $('waterPerPlant'),
    waterFrequency: $('waterFrequency'),
    ratePerKL: $('ratePerKL'),
    roundResults: $('roundResults'),
    errorMessage: $('errorMessage'),
    calculateBtn: $('calculateBtn'),
    downloadBtn: $('downloadBtn'),
    resultsCard: $('resultsCard'),
    resultsContainer: $('resultsContainer'),
    heading: $('main-heading')
  };

  let calculationResults = null;

  /* ========= UI helpers ========= */
  function makeSection(title, icon){
    const sec = document.createElement('div');
    sec.className = 'sec-card';
    const head = document.createElement('div');
    head.className = 'sec-head';
    head.innerHTML = `<span class="icon">${icon||'ðŸ“Š'}</span><span>${title}</span>`;
    const stats = document.createElement('div');
    stats.className = 'stats';
    sec.append(head, stats);
    return {sec, stats};
  }
  function statTile(label, value){
    const d = document.createElement('div'); d.className='stat';
    d.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
    return d;
  }
  function formatNumber(value, shouldRound) {
    if (shouldRound) return value.toFixed(2);
    let s = value.toFixed(6).replace(/\.?0+$/, '');
    const parts = s.split('.');
    if (!parts[1] || parts[1].length < 2) s = value.toFixed(2);
    return s;
  }
  function formatCurrency(v, round){ return '$' + formatNumber(v, round); }

  /* ========= Validation & Calc ========= */
  function validate(){
    const np = parseFloat(els.numPlants.value);
    const wpp = parseFloat(els.waterPerPlant.value);
    const wf = parseFloat(els.waterFrequency.value);
    const rate = parseFloat(els.ratePerKL.value);

    els.errorMessage.classList.remove('show');

    if(!Number.isFinite(np) || !Number.isFinite(wpp) || !Number.isFinite(wf) || !Number.isFinite(rate))
      return "Please fill in all fields with valid numbers.";
    if(!(np>0)) return "Number of plants must be greater than zero.";
    if(!(wpp>0)) return "Litres per plant must be greater than zero.";
    if(!(wf>=0 && wf<=7)) return "Watering frequency must be between 0 and 7.";
    if(!(rate>0)) return "Water cost must be greater than zero.";
    return null;
  }

  function calculate(){
    const err = validate();
    if(err){
      els.errorMessage.textContent = err;
      els.errorMessage.classList.add('show');
      els.resultsCard.style.display = 'none';
      els.downloadBtn.style.display = 'none';
      calculationResults = null;
      return;
    }

    const np = parseFloat(els.numPlants.value);
    const wpp = parseFloat(els.waterPerPlant.value);
    const wf = parseFloat(els.waterFrequency.value);
    const rate = parseFloat(els.ratePerKL.value);
    const round = els.roundResults.checked;

    const costPerLitre = rate / 1000;
    const totalLitres = np * wpp * wf;
    const totalCost = totalLitres * costPerLitre;
    const perPlantDaily = wpp * costPerLitre;
    const perPlantWeekly = perPlantDaily * wf;
    const perPlantMonthly = perPlantWeekly * 4;
    const perPlantYearly = perPlantMonthly * 12;

    const totalDaily = perPlantDaily * np;
    const totalWeekly = perPlantWeekly * np;
    const totalMonthly = perPlantMonthly * np;
    const totalYearly = perPlantYearly * np;

    calculationResults = {
      inputs: { numPlants:np, waterPerPlant:wpp, waterFrequency:wf, waterCost:rate },
      costPerLitre,
      perPlant: { daily:perPlantDaily, weekly:perPlantWeekly, monthly:perPlantMonthly, yearly:perPlantYearly },
      totals:   { daily:totalDaily, weekly:totalWeekly, monthly:totalMonthly, yearly:totalYearly },
      harvestSummary: {
        // costPerL: number, totalLitres: number, costTotal: number
        costPerL: costPerLitre,
        totalLitres,
        costTotal: totalCost
      },
      round
    };

    if (window.HOA && typeof HOA.pushToHarvest === 'function') {
      HOA.pushToHarvest({
        type: 'water',
        createdAt: new Date().toISOString(),
        summary: calculationResults.harvestSummary
      });
    }

    renderResults();
    els.resultsCard.style.display = 'block';
    els.downloadBtn.style.display = 'inline-block';
  }

  function renderResults(){
    if(!calculationResults) return;
    const R = calculationResults.round;
    const root = els.resultsContainer;
    root.innerHTML = '';

    const s1 = makeSection('Water Cost per Litre', 'ðŸ’§');
    s1.stats.appendChild(statTile('Cost per Litre', formatCurrency(calculationResults.costPerLitre, R)));
    root.appendChild(s1.sec);

    const s2 = makeSection('Per Plant Cost (by period)', 'ðŸŒ±');
    s2.stats.appendChild(statTile('Daily',   formatCurrency(calculationResults.perPlant.daily, R)));
    s2.stats.appendChild(statTile('Weekly',  formatCurrency(calculationResults.perPlant.weekly, R)));
    s2.stats.appendChild(statTile('Monthly', formatCurrency(calculationResults.perPlant.monthly, R)));
    s2.stats.appendChild(statTile('Yearly',  formatCurrency(calculationResults.perPlant.yearly, R)));
    root.appendChild(s2.sec);

    const s3 = makeSection('Total Cost (all plants)', 'ðŸ“ˆ');
    s3.stats.appendChild(statTile('Daily Total',   formatCurrency(calculationResults.totals.daily, R)));
    s3.stats.appendChild(statTile('Weekly Total',  formatCurrency(calculationResults.totals.weekly, R)));
    s3.stats.appendChild(statTile('Monthly Total', formatCurrency(calculationResults.totals.monthly, R)));
    s3.stats.appendChild(statTile('Yearly Total',  formatCurrency(calculationResults.totals.yearly, R)));
    root.appendChild(s3.sec);
  }

  function generatePDF(){
    if(!calculationResults) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const R = calculationResults.round;

    let y = 30, line = 8, margin = 18, pageH = doc.internal.pageSize.height;
    const check = need => { if(y+need > pageH - margin){ doc.addPage(); y = 30; } };

    doc.setFont('helvetica','bold'); doc.setFontSize(22);
    const title = $('main-heading').textContent || 'Water Cost Calculator';
    const w = doc.getTextWidth(title);
    doc.text(title, (doc.internal.pageSize.width - w)/2, y); y += 16;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Input Parameters', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Number of Plants: ${calculationResults.inputs.numPlants}`, margin, y); y += line;
    doc.text(`Litres per Plant per Watering: ${calculationResults.inputs.waterPerPlant}`, margin, y); y += line;
    doc.text(`Watering Frequency: ${calculationResults.inputs.waterFrequency} days/week`, margin, y); y += line;
    doc.text(`Water Cost: $${calculationResults.inputs.waterCost} per kL`, margin, y); y += 12;

    check(30);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Water Cost per Litre', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Per Litre: ${formatCurrency(calculationResults.costPerLitre, R)}`, margin, y); y += 12;

    check(50);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Per Plant Cost', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Daily: ${formatCurrency(calculationResults.perPlant.daily, R)}`, margin, y); y += line;
    doc.text(`Weekly: ${formatCurrency(calculationResults.perPlant.weekly, R)}`, margin, y); y += line;
    doc.text(`Monthly: ${formatCurrency(calculationResults.perPlant.monthly, R)}`, margin, y); y += line;
    doc.text(`Yearly: ${formatCurrency(calculationResults.perPlant.yearly, R)}`, margin, y); y += 12;

    check(50);
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Total Cost (All Plants)', margin, y); y += 10;
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Daily Total: ${formatCurrency(calculationResults.totals.daily, R)}`, margin, y); y += line;
    doc.text(`Weekly Total: ${formatCurrency(calculationResults.totals.weekly, R)}`, margin, y); y += line;
    doc.text(`Monthly Total: ${formatCurrency(calculationResults.totals.monthly, R)}`, margin, y); y += line;
    doc.text(`Yearly Total: ${formatCurrency(calculationResults.totals.yearly, R)}`, margin, y);

    doc.save('WaterCostCalculatorResults.pdf');
  }

  /* ========= Wiring ========= */
  function onConfigChange(cfg){
    els.heading.textContent = cfg.main_heading || defaultConfig.main_heading;
    els.calculateBtn.textContent = cfg.calculate_button_text || defaultConfig.calculate_button_text;
    els.downloadBtn.textContent  = cfg.download_button_text  || defaultConfig.download_button_text;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      if (window.elementSdk && typeof window.elementSdk.init === 'function') {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: onConfigChange,
          mapToEditPanelValues: (cfg)=>new Map([
            ["main_heading", cfg.main_heading || defaultConfig.main_heading],
            ["calculate_button_text", cfg.calculate_button_text || defaultConfig.calculate_button_text],
            ["download_button_text", cfg.download_button_text || defaultConfig.download_button_text]
          ])
        });
      }
    }catch(e){ console.warn('Element SDK init skipped:', e); }

    els.calculateBtn.addEventListener('click', calculate);
    els.downloadBtn.addEventListener('click', generatePDF);
    ['numPlants','waterPerPlant','waterFrequency','ratePerKL'].forEach(id=>{
      $(id).addEventListener('keypress', e=>{ if(e.key==='Enter') calculate(); });
    });
  });
</script>
  <script src="../../shared/js/hoa-calcs.js"></script>
  <script>
  (function ensureHOA(){
    if (window.HOA) return;
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/gh/HydroOasis/Hydro-Oasis-Calculators@main/shared/js/hoa-calcs.js';
    s.onload = function(){ if(!window.HOA){ console.error('HOA still not available'); } };
    s.onerror = function(){ console.error('Failed to load HOA from CDN'); };
    document.head.appendChild(s);
  })();
  </script>
  <script>
(async function initWaterCalc(){
  const $state = document.getElementById('waterState');
  const $prov  = document.getElementById('providerSelect');
  const $tier  = document.getElementById('providerTier');
  const $rate  = document.getElementById('ratePerKL');
  const $err   = document.getElementById('waterErrors');
  if (!$state || !$prov || !$tier || !$rate) return;

  let providers = [];
  try {
    const data = await HOA.fetchJSON(HOA.DATA.waterProviders);
    providers = Array.isArray(data.providers) ? data.providers : [];
    // Populate states (unique, sorted)
    const states = [...new Set(providers.map(p => p.state))].sort();
    $state.innerHTML = '<option value="">All statesâ€¦</option>' + states.map(s => `<option value="${s}">${s}</option>`).join('');
    // Seed provider list
    syncProviders();
  } catch (e) {
    if ($err) { $err.textContent = 'Unable to load water provider data.'; $err.style.display = 'block'; }
    console.warn(e);
  }

  function syncProviders(){
    const chosenState = $state.value;
    const list = chosenState ? providers.filter(p => p.state === chosenState) : providers;
    $prov.innerHTML = '<option value="">Select providerâ€¦</option>' + list.map((p, idx) => {
      // store index to look back up quickly
      return `<option value="${idx}" data-name="${p.name}" data-state="${p.state}">${p.name} (${p.state})</option>`;
    }).join('');
    $prov.disabled = list.length === 0;
    $tier.innerHTML = '<option value="">Select tierâ€¦</option>';
    $tier.disabled = true;
    // Clear rate unless user overrides
    if (!$rate.dataset.userEdited) $rate.value = '';
  }

  function syncTiers(){
    const chosenState = $state.value;
    const list = chosenState ? providers.filter(p => p.state === chosenState) : providers;
    const idx = Number($prov.value);
    const prov = Number.isFinite(idx) ? list[idx] : null;
    if (!prov || !Array.isArray(prov.tariffs) || prov.tariffs.length === 0){
      $tier.innerHTML = '<option value="">Select tierâ€¦</option>';
      $tier.disabled = true;
      return;
    }
    $tier.innerHTML = '<option value="">Select tierâ€¦</option>' + prov.tariffs.map((t,i) =>
      `<option value="${i}" data-rate="${t.price_per_kL}">Tier ${t.tier} â€” $${t.price_per_kL}/kL</option>`
    ).join('');
    $tier.disabled = false;
    // If only one tier, preselect and apply rate
    if (prov.tariffs.length === 1){
      $tier.value = '0';
      const r = prov.tariffs[0].price_per_kL;
      if (r != null && !$rate.dataset.userEdited) $rate.value = Number(r);
    }
  }

  $state.addEventListener('change', syncProviders);
  $prov.addEventListener('change', syncTiers);
  $tier.addEventListener('change', () => {
    const opt = $tier.options[$tier.selectedIndex];
    const r = opt?.dataset?.rate;
    if (r != null && !$rate.dataset.userEdited) $rate.value = Number(r);
  });
  $rate.addEventListener('input', () => { $rate.dataset.userEdited = '1'; }); // remember manual override
})();
</script>
</body>
</html>
